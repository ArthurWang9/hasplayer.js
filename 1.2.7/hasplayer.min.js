/*
 * The copyright in this software module is being made available under the BSD License, included below. This software module may be subject to other third party and/or contributor rights, including patent rights, and no such rights are granted under this license.
 * The whole software resulting from the execution of this software module together with its external dependent software modules from dash.js project may be subject to Orange and/or other third party rights, including patent rights, and no such rights are granted under this license.
 * 
 * Copyright (c) 2014, Orange
 * All rights reserved.
 * 
 * Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:
 * •  Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
 * •  Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
 * •  Neither the name of the Orange nor the names of its contributors may be used to endorse or promote products derived from this software module without specific prior written permission.
 * 
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS “AS IS” AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
/* Last build : 1.4.2016_11:11:29 / git revision : caab083 */
/* jshint ignore:start */
!function(a,b){"function"==typeof define&&define.amd?define([],function(){return a.MediaPlayer=b()}):"object"==typeof exports?module.exports=b():a.MediaPlayer=b()}(this,function(){function b(a){var b;for(b=[],i=0,len=a.length;i<len;i+=1)a[i].isRoot?b.push("root"):b.push(a[i].name);var c=function(a,b){var c;if(null!==a&&null!==b)for(c in a)a.hasOwnProperty(c)&&(b.hasOwnProperty(c)||(b[c]=a[c]))},d=function(a,b,d){var e,f,g,h,i;if(null!==a&&0!==a.length)for(e=0,f=a.length;f>e;e+=1)g=a[e],b.hasOwnProperty(g.name)&&(d.hasOwnProperty(g.name)?g.merge&&(h=b[g.name],i=d[g.name],"object"==typeof h&&"object"==typeof i?c(h,i):null!=g.mergeFunction?d[g.name]=g.mergeFunction(h,i):d[g.name]=h+i):d[g.name]=b[g.name])},e=function(a,b){var c,f,g,h,i,j,k,l=a;if(null!==l.children&&0!==l.children.length)for(c=0,f=l.children.length;f>c;c+=1)if(j=l.children[c],b.hasOwnProperty(j.name))if(j.isArray)for(i=b[j.name+"_asArray"],g=0,h=i.length;h>g;g+=1)k=i[g],d(l.properties,b,k),e(j,k);else k=b[j.name],d(l.properties,b,k),e(j,k)},f=function(c){var d,g,h,i,j,k,l;if(null===c)return c;if("object"!=typeof c)return c;for(d=0,g=b.length;g>d;d+=1)"root"===b[d]&&(j=a[d],k=c,e(j,k));for(i in c)if(c.hasOwnProperty(i)){if(h=b.indexOf(i),-1!==h)if(j=a[h],j.isArray)for(l=c[i+"_asArray"],d=0,g=l.length;g>d;d+=1)k=l[d],e(j,k);else k=c[i],e(j,k);f(c[i])}return c};return{run:f}}function c(a,b,c){function d(a){var b=a.localName;return null==b&&(b=a.baseName),(null==b||""==b)&&(b=a.nodeName),b}function e(a){return a.prefix}function f(a){return"string"==typeof a?a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;"):a}function g(a){return a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#x27;/g,"'").replace(/&#x2F;/g,"/")}function h(f){if(f.nodeType==u.DOCUMENT_NODE){var i,j,k,l=f.firstChild;for(j=0,k=f.childNodes.length;k>j;j+=1)if(f.childNodes[j].nodeType!==u.COMMENT_NODE){l=f.childNodes[j];break}if(c)i=h(l);else{i={};var m=d(l);i[m]=h(l)}return i}if(f.nodeType==u.ELEMENT_NODE){var i=new Object;i.__cnt=0;for(var n=f.childNodes,o=0;o<n.length;o++){var l=n.item(o),m=d(l);if(i.__cnt++,null==i[m])i[m]=h(l),i[m+"_asArray"]=new Array(1),i[m+"_asArray"][0]=i[m];else{if(null!=i[m]&&!(i[m]instanceof Array)){var p=i[m];i[m]=new Array,i[m][0]=p,i[m+"_asArray"]=i[m]}for(var q=0;null!=i[m][q];)q++;i[m][q]=h(l)}}for(var r=0;r<f.attributes.length;r++){var s=f.attributes.item(r);i.__cnt++;for(var v=s.value,w=0,x=a.length;x>w;w++){var y=a[w];y.test.call(this,s.value)&&(v=y.converter.call(this,s.value))}i[b+s.name]=v}var z=e(f);return null!=z&&""!=z&&(i.__cnt++,i.__prefix=z),1==i.__cnt&&null!=i["#text"]&&(i=i["#text"]),null!=i["#text"]&&(i.__text=i["#text"],t&&(i.__text=g(i.__text)),delete i["#text"],delete i["#text_asArray"]),null!=i["#cdata-section"]&&(i.__cdata=i["#cdata-section"],delete i["#cdata-section"],delete i["#cdata-section_asArray"]),(null!=i.__text||null!=i.__cdata)&&(i.toString=function(){return(null!=this.__text?this.__text:"")+(null!=this.__cdata?this.__cdata:"")}),i}return f.nodeType==u.TEXT_NODE||f.nodeType==u.CDATA_SECTION_NODE?f.nodeValue:f.nodeType==u.COMMENT_NODE?null:void 0}function i(a,b,c,d){var e="<"+(null!=a&&null!=a.__prefix?a.__prefix+":":"")+b;if(null!=c)for(var f=0;f<c.length;f++){var g=c[f],h=a[g];e+=" "+g.substr(1)+"='"+h+"'"}return e+=d?"/>":">"}function j(a,b){return"</"+(null!=a.__prefix?a.__prefix+":":"")+b+">"}function k(a,b){return-1!==a.indexOf(b,a.length-b.length)}function l(a,b){return k(b.toString(),"_asArray")||0==b.toString().indexOf("_")||a[b]instanceof Function?!0:!1}function m(a){var b=0;if(a instanceof Object)for(var c in a)l(a,c)||b++;return b}function n(a){var b=[];if(a instanceof Object)for(var c in a)-1==c.toString().indexOf("__")&&0==c.toString().indexOf("_")&&b.push(c);return b}function o(a){var b="";return null!=a.__cdata&&(b+="<![CDATA["+a.__cdata+"]]>"),null!=a.__text&&(b+=t?f(a.__text):a.__text),b}function p(a){var b="";return a instanceof Object?b+=o(a):null!=a&&(b+=t?f(a):a),b}function q(a,b,c){var d="";if(0==a.length)d+=i(a,b,c,!0);else for(var e=0;e<a.length;e++)d+=i(a[e],b,n(a[e]),!1),d+=r(a[e]),d+=j(a[e],b);return d}function r(a){var b="",c=m(a);if(c>0)for(var d in a)if(!l(a,d)){var e=a[d],f=n(e);if(null==e||void 0==e)b+=i(e,d,f,!0);else if(e instanceof Object)if(e instanceof Array)b+=q(e,d,f);else{var g=m(e);g>0||null!=e.__text||null!=e.__cdata?(b+=i(e,d,f,!1),b+=r(e),b+=j(e,d)):b+=i(e,d,f,!0)}else b+=i(e,d,f,!1),b+=p(e),b+=j(e,d)}return b+=p(a)}(null===b||void 0===b)&&(b="_"),(null===c||void 0===c)&&(c=!1);var s="1.0.11",t=!1,u={ELEMENT_NODE:1,TEXT_NODE:3,CDATA_SECTION_NODE:4,COMMENT_NODE:8,DOCUMENT_NODE:9};this.parseXmlString=function(a){var b;if(window.DOMParser)try{var c=new window.DOMParser;if(b=c.parseFromString(a,"text/xml"),b.getElementsByTagName("parsererror").length>0)throw new Error("Error parsing XML")}catch(d){return null}return b},this.xml2json=function(a){return h(a)},this.xml_str2json=function(a){var b=this.parseXmlString(a);return null===b?b:this.xml2json(b)},this.json2xml_str=function(a){return r(a)},this.json2xml=function(a){var b=this.json2xml_str(a);return this.parseXmlString(b)},this.getVersion=function(){return s},this.escapeMode=function(a){t=a}}var d,e,f,g={},h={},j={},k={},l={};l.encode=function(a){for(var b=[],c=0;c<a.length;++c){var d=a.charCodeAt(c);128>d?b.push(d):2048>d?(b.push(192|d>>6),b.push(128|63&d)):65536>d?(b.push(224|d>>12),b.push(128|63&d>>6),b.push(128|63&d)):(b.push(240|d>>18),b.push(128|63&d>>12),b.push(128|63&d>>6),b.push(128|63&d))}return b},l.decode=function(a){for(var b=[],c=0;c<a.length;){var d=a[c++];128>d||(224>d?(d=(31&d)<<6,d|=63&a[c++]):240>d?(d=(15&d)<<12,d|=(63&a[c++])<<6,d|=63&a[c++]):(d=(7&d)<<18,d|=(63&a[c++])<<12,d|=(63&a[c++])<<6,d|=63&a[c++])),b.push(String.fromCharCode(d))}return b.join("")};var m={};if(function(b){var c=function(a){for(var c=0,d=[],e=0|a.length/3;0<e--;){var f=(a[c]<<16)+(a[c+1]<<8)+a[c+2];c+=3,d.push(b.charAt(63&f>>18)),d.push(b.charAt(63&f>>12)),d.push(b.charAt(63&f>>6)),d.push(b.charAt(63&f))}if(2==a.length-c){var f=(a[c]<<16)+(a[c+1]<<8);d.push(b.charAt(63&f>>18)),d.push(b.charAt(63&f>>12)),d.push(b.charAt(63&f>>6)),d.push("=")}else if(1==a.length-c){var f=a[c]<<16;d.push(b.charAt(63&f>>18)),d.push(b.charAt(63&f>>12)),d.push("==")}return d.join("")},d=function(){for(var a=[],c=0;c<b.length;++c)a[b.charCodeAt(c)]=c;return a["=".charCodeAt(0)]=0,a}(),e=function(a){for(var b=0,c=[],e=0|a.length/4;0<e--;){var f=(d[a.charCodeAt(b)]<<18)+(d[a.charCodeAt(b+1)]<<12)+(d[a.charCodeAt(b+2)]<<6)+d[a.charCodeAt(b+3)];c.push(255&f>>16),c.push(255&f>>8),c.push(255&f),b+=4}return c&&("="==a.charAt(b-2)?(c.pop(),c.pop()):"="==a.charAt(b-1)&&c.pop()),c},f={};f.encode=function(a){for(var b=[],c=0;c<a.length;++c)b.push(a.charCodeAt(c));return b},f.decode=function(b){for(var c=0;c<s.length;++c)a[c]=String.fromCharCode(a[c]);return a.join("")},m.decodeArray=function(a){var b=e(a);return new Uint8Array(b)},m.encodeASCII=function(a){var b=f.encode(a);return c(b)},m.decodeASCII=function(a){var b=e(a);return f.decode(b)},m.encode=function(a){var b=l.encode(a);return c(b)},m.decode=function(a){var b=e(a);return l.decode(b)}}("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),void 0===n)var n=m.encode;if(void 0===o)var o=m.decode;if(function(a){"use strict";var b={VERSION:"0.5.3"};b.System=function(){this._mappings={},this._outlets={},this._handlers={},this.strictInjections=!0,this.autoMapOutlets=!1,this.postInjectionHook="setup"},b.System.prototype={_createAndSetupInstance:function(a,b){var c=new b;return this.injectInto(c,a),c},_retrieveFromCacheOrCreate:function(a,b){"undefined"==typeof b&&(b=!1);var c;if(!this._mappings.hasOwnProperty(a))throw new Error(1e3);var d=this._mappings[a];return!b&&d.isSingleton?(null==d.object&&(d.object=this._createAndSetupInstance(a,d.clazz)),c=d.object):c=d.clazz?this._createAndSetupInstance(a,d.clazz):d.object,c},mapOutlet:function(a,b,c){if("undefined"==typeof a)throw new Error(1010);return b=b||"global",c=c||a,this._outlets.hasOwnProperty(b)||(this._outlets[b]={}),this._outlets[b][c]=a,this},getObject:function(a){if("undefined"==typeof a)throw new Error(1020);return this._retrieveFromCacheOrCreate(a)},mapValue:function(a,b){if("undefined"==typeof a)throw new Error(1030);return this._mappings[a]={clazz:null,object:b,isSingleton:!0},this.autoMapOutlets&&this.mapOutlet(a),this.hasMapping(a)&&this.injectInto(b,a),this},hasMapping:function(a){if("undefined"==typeof a)throw new Error(1040);return this._mappings.hasOwnProperty(a)},mapClass:function(a,b){if("undefined"==typeof a)throw new Error(1050);if("undefined"==typeof b)throw new Error(1051);return this._mappings[a]={clazz:b,object:null,isSingleton:!1},this.autoMapOutlets&&this.mapOutlet(a),this},mapSingleton:function(a,b){if("undefined"==typeof a)throw new Error(1060);if("undefined"==typeof b)throw new Error(1061);return this._mappings[a]={clazz:b,object:null,isSingleton:!0},this.autoMapOutlets&&this.mapOutlet(a),this},instantiate:function(a){if("undefined"==typeof a)throw new Error(1070);return this._retrieveFromCacheOrCreate(a,!0)},injectInto:function(a,b){if("undefined"==typeof a)throw new Error(1080);if("object"==typeof a){var c=[];this._outlets.hasOwnProperty("global")&&c.push(this._outlets.global),"undefined"!=typeof b&&this._outlets.hasOwnProperty(b)&&c.push(this._outlets[b]);for(var d in c){var e=c[d];for(var f in e){var g=e[f];(!this.strictInjections||f in a)&&(a[f]=this.getObject(g))}}"setup"in a&&a.setup.call(a)}return this},unmap:function(a){if("undefined"==typeof a)throw new Error(1090);return delete this._mappings[a],this},unmapOutlet:function(a,b){if("undefined"==typeof a)throw new Error(1100);if("undefined"==typeof b)throw new Error(1101);return delete this._outlets[a][b],this},mapHandler:function(a,b,c,d,e){if("undefined"==typeof a)throw new Error(1110);return b=b||"global",c=c||a,"undefined"==typeof d&&(d=!1),"undefined"==typeof e&&(e=!1),this._handlers.hasOwnProperty(a)||(this._handlers[a]={}),this._handlers[a].hasOwnProperty(b)||(this._handlers[a][b]=[]),this._handlers[a][b].push({handler:c,oneShot:d,passEvent:e}),this},unmapHandler:function(a,b,c){if("undefined"==typeof a)throw new Error(1120);if(b=b||"global",this._handlers.hasOwnProperty(a)&&this._handlers[a].hasOwnProperty(b)){var d=this._handlers[a][b];for(var e in d){var f=d[e];if(!c||f.handler===c){d.splice(e,1);break}}}return this},notify:function(a){if("undefined"==typeof a)throw new Error(1130);var b=Array.prototype.slice.call(arguments),c=b.slice(1);if(this._handlers.hasOwnProperty(a)){var d=this._handlers[a];for(var e in d){var f,g=d[e];"global"!==e&&(f=this.getObject(e));var h,i,j=[];for(h=0,i=g.length;i>h;h++){var k,l=g[h];k=f&&"string"==typeof l.handler?f[l.handler]:l.handler,l.oneShot&&j.unshift(h),l.passEvent?k.apply(f,b):k.apply(f,c)}for(h=0,i=j.length;i>h;h++)g.splice(j[h],1)}}return this}},a.dijon=b}(this),e={},e.math={},e.math.Long=function(a,b){this.low_=0|a,this.high_=0|b},e.math.Long.IntCache_={},e.math.Long.fromInt=function(a){if(a>=-128&&128>a){var b=e.math.Long.IntCache_[a];if(b)return b}var c=new e.math.Long(0|a,0>a?-1:0);return a>=-128&&128>a&&(e.math.Long.IntCache_[a]=c),c},e.math.Long.fromNumber=function(a){return isNaN(a)||!isFinite(a)?e.math.Long.ZERO:a<=-e.math.Long.TWO_PWR_63_DBL_?e.math.Long.MIN_VALUE:a+1>=e.math.Long.TWO_PWR_63_DBL_?e.math.Long.MAX_VALUE:0>a?e.math.Long.fromNumber(-a).negate():new e.math.Long(a%e.math.Long.TWO_PWR_32_DBL_|0,a/e.math.Long.TWO_PWR_32_DBL_|0)},e.math.Long.fromBits=function(a,b){return new e.math.Long(a,b)},e.math.Long.fromString=function(a,b){if(0==a.length)throw Error("number format error: empty string");var c=b||10;if(2>c||c>36)throw Error("radix out of range: "+c);if("-"==a.charAt(0))return e.math.Long.fromString(a.substring(1),c).negate();if(a.indexOf("-")>=0)throw Error('number format error: interior "-" character: '+a);for(var d=e.math.Long.fromNumber(Math.pow(c,8)),f=e.math.Long.ZERO,g=0;g<a.length;g+=8){var h=Math.min(8,a.length-g),i=parseInt(a.substring(g,g+h),c);if(8>h){var j=e.math.Long.fromNumber(Math.pow(c,h));f=f.multiply(j).add(e.math.Long.fromNumber(i))}else f=f.multiply(d),f=f.add(e.math.Long.fromNumber(i))}return f},e.math.Long.TWO_PWR_16_DBL_=65536,e.math.Long.TWO_PWR_24_DBL_=1<<24,e.math.Long.TWO_PWR_32_DBL_=e.math.Long.TWO_PWR_16_DBL_*e.math.Long.TWO_PWR_16_DBL_,e.math.Long.TWO_PWR_31_DBL_=e.math.Long.TWO_PWR_32_DBL_/2,e.math.Long.TWO_PWR_48_DBL_=e.math.Long.TWO_PWR_32_DBL_*e.math.Long.TWO_PWR_16_DBL_,e.math.Long.TWO_PWR_64_DBL_=e.math.Long.TWO_PWR_32_DBL_*e.math.Long.TWO_PWR_32_DBL_,e.math.Long.TWO_PWR_63_DBL_=e.math.Long.TWO_PWR_64_DBL_/2,e.math.Long.ZERO=e.math.Long.fromInt(0),e.math.Long.ONE=e.math.Long.fromInt(1),e.math.Long.NEG_ONE=e.math.Long.fromInt(-1),e.math.Long.MAX_VALUE=e.math.Long.fromBits(-1,2147483647),e.math.Long.MIN_VALUE=e.math.Long.fromBits(0,-2147483648),e.math.Long.TWO_PWR_24_=e.math.Long.fromInt(1<<24),e.math.Long.prototype.toInt=function(){return this.low_},e.math.Long.prototype.toNumber=function(){return this.high_*e.math.Long.TWO_PWR_32_DBL_+this.getLowBitsUnsigned()},e.math.Long.prototype.toString=function(a){var b=a||10;if(2>b||b>36)throw Error("radix out of range: "+b);if(this.isZero())return"0";if(this.isNegative()){if(this.equals(e.math.Long.MIN_VALUE)){var c=e.math.Long.fromNumber(b),d=this.div(c),f=d.multiply(c).subtract(this);return d.toString(b)+f.toInt().toString(b)}return"-"+this.negate().toString(b)}for(var g=e.math.Long.fromNumber(Math.pow(b,6)),f=this,h="";;){var i=f.div(g),j=f.subtract(i.multiply(g)).toInt(),k=j.toString(b);if(f=i,f.isZero())return k+h;for(;k.length<6;)k="0"+k;h=""+k+h}},e.math.Long.prototype.getHighBits=function(){return this.high_},e.math.Long.prototype.getLowBits=function(){return this.low_},e.math.Long.prototype.getLowBitsUnsigned=function(){return this.low_>=0?this.low_:e.math.Long.TWO_PWR_32_DBL_+this.low_},e.math.Long.prototype.getNumBitsAbs=function(){if(this.isNegative())return this.equals(e.math.Long.MIN_VALUE)?64:this.negate().getNumBitsAbs();for(var a=0!=this.high_?this.high_:this.low_,b=31;b>0&&0==(a&1<<b);b--);return 0!=this.high_?b+33:b+1},e.math.Long.prototype.isZero=function(){return 0==this.high_&&0==this.low_},e.math.Long.prototype.isNegative=function(){return this.high_<0},e.math.Long.prototype.isOdd=function(){return 1==(1&this.low_)},e.math.Long.prototype.equals=function(a){return this.high_==a.high_&&this.low_==a.low_},e.math.Long.prototype.notEquals=function(a){return this.high_!=a.high_||this.low_!=a.low_},e.math.Long.prototype.lessThan=function(a){return this.compare(a)<0},e.math.Long.prototype.lessThanOrEqual=function(a){return this.compare(a)<=0},e.math.Long.prototype.greaterThan=function(a){return this.compare(a)>0},e.math.Long.prototype.greaterThanOrEqual=function(a){return this.compare(a)>=0},e.math.Long.prototype.compare=function(a){if(this.equals(a))return 0;var b=this.isNegative(),c=a.isNegative();return b&&!c?-1:!b&&c?1:this.subtract(a).isNegative()?-1:1},e.math.Long.prototype.negate=function(){return this.equals(e.math.Long.MIN_VALUE)?e.math.Long.MIN_VALUE:this.not().add(e.math.Long.ONE)},e.math.Long.prototype.add=function(a){var b=this.high_>>>16,c=65535&this.high_,d=this.low_>>>16,f=65535&this.low_,g=a.high_>>>16,h=65535&a.high_,i=a.low_>>>16,j=65535&a.low_,k=0,l=0,m=0,n=0;return n+=f+j,m+=n>>>16,n&=65535,m+=d+i,l+=m>>>16,m&=65535,l+=c+h,k+=l>>>16,l&=65535,k+=b+g,k&=65535,e.math.Long.fromBits(m<<16|n,k<<16|l)},e.math.Long.prototype.subtract=function(a){return this.add(a.negate())},e.math.Long.prototype.multiply=function(a){if(this.isZero())return e.math.Long.ZERO;if(a.isZero())return e.math.Long.ZERO;if(this.equals(e.math.Long.MIN_VALUE))return a.isOdd()?e.math.Long.MIN_VALUE:e.math.Long.ZERO;if(a.equals(e.math.Long.MIN_VALUE))return this.isOdd()?e.math.Long.MIN_VALUE:e.math.Long.ZERO;if(this.isNegative())return a.isNegative()?this.negate().multiply(a.negate()):this.negate().multiply(a).negate();if(a.isNegative())return this.multiply(a.negate()).negate();if(this.lessThan(e.math.Long.TWO_PWR_24_)&&a.lessThan(e.math.Long.TWO_PWR_24_))return e.math.Long.fromNumber(this.toNumber()*a.toNumber());var b=this.high_>>>16,c=65535&this.high_,d=this.low_>>>16,f=65535&this.low_,g=a.high_>>>16,h=65535&a.high_,i=a.low_>>>16,j=65535&a.low_,k=0,l=0,m=0,n=0;return n+=f*j,m+=n>>>16,n&=65535,m+=d*j,l+=m>>>16,m&=65535,m+=f*i,l+=m>>>16,m&=65535,l+=c*j,k+=l>>>16,l&=65535,l+=d*i,k+=l>>>16,l&=65535,l+=f*h,k+=l>>>16,l&=65535,k+=b*j+c*i+d*h+f*g,k&=65535,e.math.Long.fromBits(m<<16|n,k<<16|l)},e.math.Long.prototype.div=function(a){if(a.isZero())throw Error("division by zero");if(this.isZero())return e.math.Long.ZERO;if(this.equals(e.math.Long.MIN_VALUE)){if(a.equals(e.math.Long.ONE)||a.equals(e.math.Long.NEG_ONE))return e.math.Long.MIN_VALUE;if(a.equals(e.math.Long.MIN_VALUE))return e.math.Long.ONE;var b=this.shiftRight(1),c=b.div(a).shiftLeft(1);if(c.equals(e.math.Long.ZERO))return a.isNegative()?e.math.Long.ONE:e.math.Long.NEG_ONE;var d=this.subtract(a.multiply(c)),f=c.add(d.div(a));return f}if(a.equals(e.math.Long.MIN_VALUE))return e.math.Long.ZERO;if(this.isNegative())return a.isNegative()?this.negate().div(a.negate()):this.negate().div(a).negate();if(a.isNegative())return this.div(a.negate()).negate();for(var g=e.math.Long.ZERO,d=this;d.greaterThanOrEqual(a);){for(var c=Math.max(1,Math.floor(d.toNumber()/a.toNumber())),h=Math.ceil(Math.log(c)/Math.LN2),i=48>=h?1:Math.pow(2,h-48),j=e.math.Long.fromNumber(c),k=j.multiply(a);k.isNegative()||k.greaterThan(d);)c-=i,j=e.math.Long.fromNumber(c),k=j.multiply(a);j.isZero()&&(j=e.math.Long.ONE),g=g.add(j),d=d.subtract(k)}return g},e.math.Long.prototype.modulo=function(a){return this.subtract(this.div(a).multiply(a))},e.math.Long.prototype.not=function(){return e.math.Long.fromBits(~this.low_,~this.high_)},e.math.Long.prototype.and=function(a){return e.math.Long.fromBits(this.low_&a.low_,this.high_&a.high_)},e.math.Long.prototype.or=function(a){return e.math.Long.fromBits(this.low_|a.low_,this.high_|a.high_)},e.math.Long.prototype.xor=function(a){return e.math.Long.fromBits(this.low_^a.low_,this.high_^a.high_)},e.math.Long.prototype.shiftLeft=function(a){if(a&=63,0==a)return this;var b=this.low_;if(32>a){var c=this.high_;return e.math.Long.fromBits(b<<a,c<<a|b>>>32-a)}return e.math.Long.fromBits(0,b<<a-32)},e.math.Long.prototype.shiftRight=function(a){if(a&=63,0==a)return this;var b=this.high_;if(32>a){var c=this.low_;return e.math.Long.fromBits(c>>>a|b<<32-a,b>>a)}return e.math.Long.fromBits(b>>a-32,b>=0?0:-1)},e.math.Long.prototype.shiftRightUnsigned=function(a){if(a&=63,0==a)return this;var b=this.high_;if(32>a){var c=this.low_;return e.math.Long.fromBits(c>>>a|b<<32-a,b>>>a)}return 32==a?e.math.Long.fromBits(b,0):e.math.Long.fromBits(b>>>a-32,0)},"undefined"==typeof p)var p={};"undefined"==typeof p.Math&&(p.Math={}),p.Math.to64BitNumber=function(a,b){var c,d,f;return c=new e.math.Long(0,b),d=new e.math.Long(a,0),f=c.add(d),f.toNumber()},function(a){d=a()}(function(){"use strict";function a(a){var b=Function.call;return function(){return b.apply(a,arguments)}}function b(a){return"[object StopIteration]"===ga(a)||a instanceof $}function c(a,b){b.stack&&"object"==typeof a&&null!==a&&a.stack&&-1===a.stack.indexOf(ha)&&(a.stack=d(a.stack)+"\n"+ha+"\n"+d(b.stack))}function d(a){for(var b=a.split("\n"),c=[],d=0;d<b.length;++d){var g=b[d];f(g)||e(g)||c.push(g)}return c.join("\n")}function e(a){return-1!==a.indexOf("(module.js:")||-1!==a.indexOf("(node.js:")}function f(a){var b=/at .+ \((.*):(\d+):\d+\)/.exec(a);if(!b)return!1;var c=b[1],d=b[2];return c===W&&d>=Y&&la>=d}function g(){if(Error.captureStackTrace){var a,b,c=Error.prepareStackTrace;return Error.prepareStackTrace=function(c,d){a=d[1].getFileName(),b=d[1].getLineNumber()},(new Error).stack,Error.prepareStackTrace=c,W=a,b}}function h(a){return t(a)}function i(){function a(a){c&&(b=t(a),aa(c,function(a,c){X(function(){b.promiseDispatch.apply(b,c)})},void 0),c=void 0,d=void 0)}var b,c=[],d=[],e=da(i.prototype),f=da(k.prototype);return f.promiseDispatch=function(a,e,f){var g=_(arguments);c?(c.push(g),"when"===e&&f[1]&&d.push(f[1])):X(function(){b.promiseDispatch.apply(b,g)})},f.valueOf=function(){return c?f:b=l(b)},Error.captureStackTrace&&h.longStackJumpLimit>0&&(Error.captureStackTrace(f,i),f.stack=f.stack.substring(f.stack.indexOf("\n")+1)),e.promise=f,e.resolve=a,e.fulfill=function(b){a(s(b))},e.reject=function(b){a(r(b))},e.notify=function(a){c&&aa(d,function(b,c){X(function(){c(a)})},void 0)},e}function j(a){var b=i();return F(a,b.resolve,b.reject,b.notify).fail(b.reject),b.promise}function k(a,b,c,d,e){void 0===b&&(b=function(a){return r(new Error("Promise does not support operation: "+a))});var f=da(k.prototype);return f.promiseDispatch=function(c,d,e){var g;try{g=a[d]?a[d].apply(f,e):b.call(f,d,e)}catch(h){g=r(h)}c&&c(g)},c&&(f.valueOf=c),e&&(f.exception=d),f}function l(a){return m(a)?a.valueOf():a}function m(a){return a&&"function"==typeof a.promiseDispatch}function n(a){return a&&"function"==typeof a.then}function o(a){return!p(a)&&!q(a)}function p(a){return!n(l(a))}function q(a){return a=l(a),m(a)&&"exception"in a}function r(a){var b=k({when:function(b){if(b){var c=ba(ia,this);-1!==c&&(ja.splice(c,1),ia.splice(c,1))}return b?b(a):this}},function(){return r(a)},function(){return this},a,!0);return ia.push(b),ja.push(a),b}function s(a){return k({when:function(){return a},get:function(b){return a[b]},set:function(b,c){a[b]=c},"delete":function(b){delete a[b]},post:function(b,c){return null==b?a.apply(void 0,c):a[b].apply(a,c)},apply:function(b,c){return a.apply(b,c)},keys:function(){return fa(a)}},void 0,function(){return a})}function t(a){return m(a)?a:(a=l(a),n(a)?u(a):s(a))}function u(a){var b=i();return X(function(){try{a.then(b.resolve,b.reject,b.notify)}catch(c){b.reject(c)}}),b.promise}function v(a){return k({isDef:function(){}},function(b,c){return B(a,b,c)},function(){return l(a)})}function w(a,b,d,e){function f(a){try{return"function"==typeof b?b(a):a}catch(c){return r(c)}}function g(a){if("function"==typeof d){c(a,m);try{return d(a)}catch(b){return r(b)}}return r(a)}function j(a){return"function"==typeof e?e(a):a}var k=i(),l=!1,m=t(a);return X(function(){m.promiseDispatch(function(a){l||(l=!0,k.resolve(f(a)))},"when",[function(a){l||(l=!0,k.resolve(g(a)))}])}),m.promiseDispatch(void 0,"when",[void 0,function(a){var b,c=!1;try{b=j(a)}catch(d){if(c=!0,!h.onerror)throw d;h.onerror(d)}c||k.notify(b)}]),k.promise}function x(a,b,c){return w(a,function(a){return H(a).then(function(a){return b.apply(void 0,a)},c)},c)}function y(a){return function(){function c(a,c){var g;try{g=d[a](c)}catch(h){return b(h)?h.value:r(h)}return w(g,e,f)}var d=a.apply(this,arguments),e=c.bind(c,"send"),f=c.bind(c,"throw");return e()}}function z(a){throw new $(a)}function A(a){return function(){return x([this,H(arguments)],function(b,c){return a.apply(b,c)})}}function B(a,b,c){var d=i();return X(function(){t(a).promiseDispatch(d.resolve,b,c)}),d.promise}function C(a){return function(b){var c=_(arguments,1);return B(b,a,c)}}function D(a,b){var c=_(arguments,2);return ka(a,b,c)}function E(a,b){return B(a,"apply",[void 0,b])}function F(a){var b=_(arguments,1);return E(a,b)}function G(a){var b=_(arguments,1);return function(){var c=b.concat(_(arguments));return B(a,"apply",[this,c])}}function H(a){return w(a,function(a){var b=a.length;if(0===b)return t(a);var c=i();return aa(a,function(d,e,f){p(e)?(a[f]=l(e),0===--b&&c.resolve(a)):w(e,function(d){a[f]=d,0===--b&&c.resolve(a)}).fail(c.reject)},void 0),c.promise})}function I(a){return w(a,function(a){return a=ca(a,t),w(H(ca(a,function(a){return w(a,Z,Z)})),function(){return a})})}function J(a,b){return w(a,void 0,b)}function K(a,b){return w(a,void 0,void 0,b)}function L(a,b){return w(a,function(a){return w(b(),function(){return a})},function(a){return w(b(),function(){return r(a)})})}function M(a,b,d,e){var f=function(b){X(function(){if(c(b,a),!h.onerror)throw b;h.onerror(b)})},g=b||d||e?w(a,b,d,e):a;"object"==typeof process&&process&&process.domain&&(f=process.domain.bind(f)),J(g,f)}function N(a,b){var c=i(),d=setTimeout(function(){c.reject(new Error("Timed out after "+b+" ms"))},b);return w(a,function(a){clearTimeout(d),c.resolve(a)},function(a){clearTimeout(d),c.reject(a)}),c.promise}function O(a,b){void 0===b&&(b=a,a=void 0);var c=i();return setTimeout(function(){c.resolve(a)},b),c.promise}function P(a,b){var c=_(b),d=i();return c.push(d.makeNodeResolver()),E(a,c).fail(d.reject),d.promise}function Q(a){var b=_(arguments,1),c=i();return b.push(c.makeNodeResolver()),E(a,b).fail(c.reject),c.promise}function R(a){var b=_(arguments,1);return function(){var c=b.concat(_(arguments)),d=i();return c.push(d.makeNodeResolver()),E(a,c).fail(d.reject),d.promise}}function S(a){var b=_(arguments,1);return function(){function c(){return a.apply(f,arguments)}var d=b.concat(_(arguments)),e=i();d.push(e.makeNodeResolver());var f=this;return E(c,d).fail(e.reject),e.promise}}function T(a,b,c){var d=_(c||[]),e=i();return d.push(e.makeNodeResolver()),ka(a,b,d).fail(e.reject),e.promise}function U(a,b){var c=_(arguments,2),d=i();return c.push(d.makeNodeResolver()),ka(a,b,c).fail(d.reject),d.promise}function V(a,b){return b?void a.then(function(a){X(function(){b(null,a)})},function(a){X(function(){b(a)})}):a}var W,X,Y=g(),Z=function(){};"undefined"!=typeof process?X=process.nextTick:"function"==typeof setImmediate?X="undefined"!=typeof window?setImmediate.bind(window):setImmediate:!function(){function a(){if(--f,++h>=e){h=0,e*=4;for(var a=g&&Math.min(g-1,e);a>f;)++f,b()}for(;g;){--g,c=c.next;var d=c.task;c.task=void 0,d()}h=0}var b,c={task:void 0,next:null},d=c,e=2,f=0,g=0,h=0;if(X=function(a){d=d.next={task:a,next:null},f<++g&&e>f&&(++f,b())},"undefined"!=typeof MessageChannel){var i=new MessageChannel;i.port1.onmessage=a,b=function(){i.port2.postMessage(0)}}else b=function(){setTimeout(a,0)}}();var $,_=a(Array.prototype.slice),aa=a(Array.prototype.reduce||function(a,b){var c=0,d=this.length;if(1===arguments.length)for(;;){if(c in this){b=this[c++];break}if(++c>=d)throw new TypeError}for(;d>c;c++)c in this&&(b=a(b,this[c],c));return b}),ba=a(Array.prototype.indexOf||function(a){for(var b=0;b<this.length;b++)if(this[b]===a)return b;return-1}),ca=a(Array.prototype.map||function(a,b){var c=this,d=[];return aa(c,function(e,f,g){d.push(a.call(b,f,g,c))},void 0),d}),da=Object.create||function(a){function b(){}return b.prototype=a,new b},ea=a(Object.prototype.hasOwnProperty),fa=Object.keys||function(a){var b=[];for(var c in a)ea(a,c)&&b.push(c);return b},ga=a(Object.prototype.toString);$="undefined"!=typeof ReturnValue?ReturnValue:function(a){this.value=a},h.longStackJumpLimit=1;var ha="From previous event:";h.nextTick=X,h.defer=i,i.prototype.makeNodeResolver=function(){var a=this;return function(b,c){b?a.reject(b):arguments.length>2?a.resolve(_(arguments,1)):a.resolve(c)}},h.promise=j,h.makePromise=k,k.prototype.then=function(a,b,c){return w(this,a,b,c)},k.prototype.thenResolve=function(a){return w(this,function(){return a})},aa(["isFulfilled","isRejected","isPending","dispatch","when","spread","get","put","set","del","delete","post","send","invoke","keys","fapply","fcall","fbind","all","allResolved","timeout","delay","catch","finally","fail","fin","progress","done","nfcall","nfapply","nfbind","denodeify","nbind","ncall","napply","nbind","npost","nsend","ninvoke","nodeify"],function(a,b){k.prototype[b]=function(){return h[b].apply(h,[this].concat(_(arguments)))}},void 0),k.prototype.toSource=function(){return this.toString()},k.prototype.toString=function(){return"[object Promise]"},h.nearer=l,h.isPromise=m,h.isPromiseAlike=n,h.isPending=o,h.isFulfilled=p,h.isRejected=q;var ia=[],ja=[];"undefined"!=typeof process&&process.on&&process.on("exit",function(){for(var a=0;a<ja.length;a++){var b=ja[a];b&&"undefined"!=typeof b.stack?console.warn("Unhandled rejected promise:",b.stack):console.warn("Unhandled rejected promise (no stack):",b)}}),h.reject=r,h.fulfill=s,h.resolve=t,h.master=v,h.when=w,h.spread=x,h.async=y,h["return"]=z,h.promised=A,h.dispatch=B,h.dispatcher=C,h.get=C("get"),h.set=C("set"),h["delete"]=h.del=C("delete");var ka=h.post=C("post");h.send=D,h.invoke=D,h.fapply=E,h["try"]=F,h.fcall=F,h.fbind=G,h.keys=C("keys"),h.all=H,h.allResolved=I,h["catch"]=h.fail=J,h.progress=K,h["finally"]=h.fin=L,h.done=M,h.timeout=N,h.delay=O,h.nfapply=P,h.nfcall=Q,h.nfbind=R,h.denodeify=h.nfbind,h.nbind=S,h.npost=T,h.nsend=U,h.ninvoke=h.nsend,h.nodeify=V;var la=g();return h});var q=function(){var a={boxes:{},fields:{},debug:!1,warningHandler:function(a){}},b={};return a.registerTypeBoxes=function(){b.moov=a.boxes.MovieBox,b.moof=a.boxes.MovieFragmentBox,b.ftyp=a.boxes.FileTypeBox,b.mfhd=a.boxes.MovieFragmentHeaderBox,b.mfra=a.boxes.MovieFragmentRandomAccessBox,b.udta=a.boxes.UserDataBox,b.trak=a.boxes.TrackBox,b.edts=a.boxes.EditBox,b.mdia=a.boxes.MediaBox,b.minf=a.boxes.MediaInformationBox,b.dinf=a.boxes.DataInformationBox,b.stbl=a.boxes.SampleTableBox,b.mvex=a.boxes.MovieExtendsBox,b.traf=a.boxes.TrackFragmentBox,b.meta=a.boxes.MetaBox,b.mvhd=a.boxes.MovieHeaderBox,b.mdat=a.boxes.MediaDataBox,b.free=a.boxes.FreeSpaceBox,b.sidx=a.boxes.SegmentIndexBox,b.tkhd=a.boxes.TrackHeaderBox,b.mdhd=a.boxes.MediaHeaderBox,b.mehd=a.boxes.MovieExtendsHeaderBox,b.hdlr=a.boxes.HandlerBox,b.stts=a.boxes.TimeToSampleBox,b.stsc=a.boxes.SampleToChunkBox,b.stco=a.boxes.ChunkOffsetBox,b.trex=a.boxes.TrackExtendsBox,b.vmhd=a.boxes.VideoMediaHeaderBox,b.smhd=a.boxes.SoundMediaHeaderBox,b.dref=a.boxes.DataReferenceBox,b["url "]=a.boxes.DataEntryUrlBox,b["urn "]=a.boxes.DataEntryUrnBox,b.tfhd=a.boxes.TrackFragmentHeaderBox,b.tfdt=a.boxes.TrackFragmentBaseMediaDecodeTimeBox,b.trun=a.boxes.TrackFragmentRunBox,b.stsd=a.boxes.SampleDescriptionBox,b.sdtp=a.boxes.SampleDependencyTableBox,b.avc1=a.boxes.AVC1VisualSampleEntryBox,b.encv=a.boxes.EncryptedVideoBox,b.avcC=a.boxes.AVCConfigurationBox,b.pasp=a.boxes.PixelAspectRatioBox,b.mp4a=a.boxes.MP4AudioSampleEntryBox,b.enca=a.boxes.EncryptedAudioBox,b.esds=a.boxes.ESDBox,b.stsz=a.boxes.SampleSizeBox,b.pssh=a.boxes.ProtectionSystemSpecificHeaderBox,b.saiz=a.boxes.SampleAuxiliaryInformationSizesBox,b.saio=a.boxes.SampleAuxiliaryInformationOffsetsBox,b.sinf=a.boxes.ProtectionSchemeInformationBox,b.schi=a.boxes.SchemeInformationBox,b.tenc=a.boxes.TrackEncryptionBox,b.schm=a.boxes.SchemeTypeBox,b.elst=a.boxes.EditListBox,b.hmhd=a.boxes.HintMediaHeaderBox,b.nmhd=a.boxes.NullMediaHeaderBox,b.ctts=a.boxes.CompositionOffsetBox,b.cslg=a.boxes.CompositionToDecodeBox,b.stss=a.boxes.SyncSampleBox,b.tref=a.boxes.TrackReferenceBox,b.frma=a.boxes.OriginalFormatBox,b[JSON.stringify([109,29,155,5,66,213,68,230,128,226,20,29,175,247,87,178])]=a.boxes.TfxdBox,b[JSON.stringify([212,128,126,242,202,57,70,149,142,84,38,203,158,70,167,159])]=a.boxes.TfrfBox,b[JSON.stringify([208,138,79,24,16,243,74,130,182,200,50,216,171,161,131,211])]=a.boxes.PiffProtectionSystemSpecificHeaderBox,b[JSON.stringify([137,116,219,206,123,231,76,81,132,249,113,72,249,136,37,84])]=a.boxes.PiffTrackEncryptionBox,b[JSON.stringify([162,57,79,82,90,155,79,20,162,68,108,66,124,100,141,244])]=a.boxes.PiffSampleEncryptionBox},a.constructorTypeBox=function(a){var b,c;return b=Object.create(a.prototype),c=Array.prototype.slice.call(arguments,1),a.apply(b,c),b},a.searchBox=function(c,d){var e;return e=d?b[d]:b[c],e||(e=a.boxes.UnknownBox),e},a.createBox=function(b,c,d){return a.constructorTypeBox.apply(null,[a.searchBox(b,d),c])},a.deserialize=function(b){var c=new a.boxes.File;try{c.read(b)}catch(d){return a.warningHandler(d.message),null}return c},a.serialize=function(a){var b=a.getLength(),c=new Uint8Array(b);return a.write(c),c},a.ParseException=function(a){this.message=a,this.name="ParseException"},a.DataIntegrityException=function(a){this.message=a,this.name="DataIntegrityException"},a}();"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=q:window.mp4lib=q,
q.boxes.File=function(){this.boxes=[]},q.boxes.File.prototype.getBoxByType=function(a){var b=0;for(b=0;b<this.boxes.length;b++)if(this.boxes[b].boxtype===a)return this.boxes[b];return null},q.boxes.File.prototype.getLength=function(){var a=0,b=0;for(b=0;b<this.boxes.length;b++)this.boxes[b].computeLength(),a+=this.boxes[b].size;return a},q.boxes.File.prototype.write=function(a){var b=0,c=0;for(c=0;c<this.boxes.length;c++)b=this.boxes[c].write(a,b)},q.boxes.File.prototype.read=function(a){for(var b,c=0,d=null,e=0,f=null,g=0,h=a.length;h>g;){if(c=q.fields.FIELD_UINT32.read(a,g),d=q.fields.readString(a,g+4,4),"uuid"==d&&(e=1==c?16:8,f=new q.fields.ArrayField(q.fields.FIELD_INT8,16).read(a,g+e,g+e+16),f=JSON.stringify(f)),b=q.createBox(d,c,f),"uuid"===d?(g=b.read(a,g+16*q.fields.FIELD_INT8.getLength()+8,g+c),f=null):g=b.read(a,g+8,g+c),q.debug&&(b.__sourceBuffer=a.subarray(g-b.size,g)),this.boxes.push(b),b.size<=0||null===b.size)throw new q.ParseException("Problem on size of box "+b.boxtype+", parsing stopped to avoid infinite loop");if(!b.boxtype)throw new q.ParseException("Problem on unknown box, parsing stopped to avoid infinite loop")}},q.boxes.File.prototype.getBoxOffsetByType=function(a){var b=0,c=0;for(c=0;c<this.boxes.length;c++){if(this.boxes[c].boxtype===a)return b;b+=this.boxes[c].size}return-1},q.boxes.File.prototype.getBoxIndexByType=function(a){var b=0,c=0;for(c=0;c<this.boxes.length;c++){if(this.boxes[c].boxtype===a)return b;b++}return-1},q.boxes.Box=function(a,b,c,d){this.size=b||null,this.boxtype=a,1===this.size&&d&&(this.largesize=d),c&&(this.extended_type=c),this.localPos=0,this.localEnd=0},q.boxes.Box.prototype.write=function(a,b){this.localPos=b;var c=0;if(this._writeData(a,q.fields.FIELD_UINT32,this.size),this.extended_type?this._writeData(a,q.fields.FIELD_ID,"uuid"):this._writeData(a,q.fields.FIELD_ID,this.boxtype),1===this.size&&this._writeData(a,q.fields.FIELD_INT64,this.largesize),this.extended_type)for(c=0;16>c;c++)this._writeData(a,q.fields.FIELD_INT8,this.extended_type[c])},q.boxes.Box.prototype.getBoxByType=function(a){var b=0;if(this.hasOwnProperty("boxes"))for(b=0;b<this.boxes.length;b++)if(this.boxes[b].boxtype===a)return this.boxes[b];return null},q.boxes.Box.prototype.getBoxesByType=function(a){var b=[],c=0;if(this.hasOwnProperty("boxes"))for(c=0;c<this.boxes.length;c++)this.boxes[c].boxtype===a&&b.push(this.boxes[c]);return b},q.boxes.Box.prototype.removeBoxByType=function(a){var b=0;if(this.hasOwnProperty("boxes"))for(b=0;b<this.boxes.length;b++)this.boxes[b].boxtype===a&&this.boxes.splice(b,1);else q.warningHandler(""+this.boxtype+"does not have "+a+" box, impossible to remove it")},q.boxes.Box.prototype.getBoxOffsetByType=function(a){var b=8,c=0;if(this.hasOwnProperty("boxes"))for(c=0;c<this.boxes.length;c++){if(this.boxes[c].boxtype===a)return b;b+=this.boxes[c].size}return null},q.boxes.Box.prototype.getBoxIndexByType=function(a){var b=0,c=0;if(this.hasOwnProperty("boxes"))for(c=0;c<this.boxes.length;c++){if(this.boxes[c].boxtype===a)return b;b++}return null},q.boxes.Box.prototype.computeLength=function(){this.size=q.fields.FIELD_UINT32.getLength()+q.fields.FIELD_ID.getLength(),this.extended_type&&(this.size+=16*q.fields.FIELD_INT8.getLength())},q.boxes.Box.prototype._readData=function(a,b){var c=b.read(a,this.localPos,this.localEnd);return this.localPos+=b.getLength(c),c},q.boxes.Box.prototype._writeData=function(a,b,c){if(void 0===c||null===c)throw new q.ParseException("a field to write is null or undefined for box : "+this.boxtype);b.write(a,this.localPos,c),this.localPos+=b.getLength(c)},q.boxes.Box.prototype._writeBuffer=function(a,b,c){a.set(b,this.localPos),this.localPos+=c},q.boxes.Box.prototype._writeArrayData=function(a,b,c){var d=0;if(void 0===c||null===c||0===c.length)throw new q.ParseException("an array to write is null, undefined or length = 0 for box : "+this.boxtype);for(d=0;d<c.length;d++)this._writeData(a,b,c[d])},q.boxes.Box.prototype._readArrayData=function(a,b){var c=[],d=b.getLength(),e=(this.localEnd-this.localPos)/d,f=0;for(f=0;e>f;f++)c.push(b.read(a,this.localPos)),this.localPos+=d;return c},q.boxes.Box.prototype._readArrayFieldData=function(a,b,c){var d=-1,e=[],f=0;for(f=0;c>f;f++)e.push(b.read(a,this.localPos)),-1===d&&(d=b.getLength(e[f])),this.localPos+=d;return e},q.boxes.ContainerBox=function(a,b){q.boxes.Box.call(this,a,b),this.boxes=[]},q.boxes.ContainerBox.prototype=Object.create(q.boxes.Box.prototype),q.boxes.ContainerBox.prototype.constructor=q.boxes.ContainerBox,q.boxes.ContainerBox.prototype.computeLength=function(){q.boxes.Box.prototype.computeLength.call(this);var a=0;for(a=0;a<this.boxes.length;a++)this.boxes[a].computeLength(),this.size+=this.boxes[a].size},q.boxes.ContainerBox.prototype.write=function(a,b){q.boxes.Box.prototype.write.call(this,a,b);var c=0;for(c=0;c<this.boxes.length;c++)this.localPos=this.boxes[c].write(a,this.localPos);return this.localPos},q.boxes.ContainerBox.prototype.read=function(a,b,c){for(var d,e,f=0,g=0,h=null;c>b;){if(f=q.fields.FIELD_UINT32.read(a,b),d=q.fields.readString(a,b+4,4),"uuid"===d&&(g=1==f?16:8,h=new q.fields.ArrayField(q.fields.FIELD_INT8,16).read(a,b+g,b+g+16),h=JSON.stringify(h)),e=q.createBox(d,f,h),"uuid"===d?(b=e.read(a,b+16*q.fields.FIELD_INT8.getLength()+8,b+f),h=null):b=e.read(a,b+8,b+f),q.debug&&(e.__sourceBuffer=a.subarray(b-e.size,b)),this.boxes.push(e),e.size<=0||null===e.size)throw new q.ParseException("Problem on size of box "+e.boxtype+", parsing stopped to avoid infinite loop");if(!e.boxtype)throw new q.ParseException("Problem on unknown box, parsing stopped to avoid infinite loop")}return b},q.boxes.FullBox=function(a,b,c){q.boxes.Box.call(this,a,b,c),this.version=null,this.flags=null},q.boxes.FullBox.prototype=Object.create(q.boxes.Box.prototype),q.boxes.FullBox.prototype.constructor=q.boxes.FullBox,q.boxes.FullBox.prototype.read=function(a,b,c){this.localPos=b,this.localEnd=c,this.version=this._readData(a,q.fields.FIELD_INT8),this.flags=this._readData(a,q.fields.FIELD_BIT24)},q.boxes.FullBox.prototype.write=function(a,b){q.boxes.Box.prototype.write.call(this,a,b),this._writeData(a,q.fields.FIELD_INT8,this.version),this._writeData(a,q.fields.FIELD_BIT24,this.flags)},q.boxes.FullBox.prototype.getFullBoxAttributesLength=function(){this.size+=q.fields.FIELD_INT8.getLength()+q.fields.FIELD_BIT24.getLength()},q.boxes.FullBox.prototype.computeLength=function(){q.boxes.Box.prototype.computeLength.call(this),q.boxes.FullBox.prototype.getFullBoxAttributesLength.call(this)},q.boxes.ContainerFullBox=function(a,b){q.boxes.FullBox.call(this,a,b),this.boxes=[]},q.boxes.ContainerFullBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.ContainerFullBox.prototype.constructor=q.boxes.ContainerFullBox,q.boxes.ContainerFullBox.prototype.computeLength=function(a){q.boxes.FullBox.prototype.computeLength.call(this);var b=0;for(a&&(this.size+=q.fields.FIELD_UINT32.getLength()),b=0;b<this.boxes.length;b++)this.boxes[b].computeLength(),this.size+=this.boxes[b].size},q.boxes.ContainerFullBox.prototype.read=function(a,b,c,d){q.boxes.FullBox.prototype.read.call(this,a,b,c);var e,f,g=0,h=0,i=null;for(d&&(this.entry_count=this._readData(a,q.fields.FIELD_UINT32));this.localPos<this.localEnd;){if(g=q.fields.FIELD_UINT32.read(a,this.localPos),e=q.fields.readString(a,this.localPos+4,4),"uuid"==e&&(h=1==g?16:8,i=new q.fields.ArrayField(q.fields.FIELD_INT8,16).read(a,this.localPos+h,this.localPos+h+16),i=JSON.stringify(i)),f=q.createBox(e,g,i),"uuid"===e?(this.localPos=f.read(a,this.localPos+16*q.fields.FIELD_INT8.getLength()+8,this.localPos+g),i=null):this.localPos=f.read(a,this.localPos+8,this.localPos+g),q.debug&&(f.__sourceBuffer=a.subarray(this.localPos-f.size,this.localPos)),this.boxes.push(f),f.size<=0||null===f.size)throw new q.ParseException("Problem on size of box "+f.boxtype+", parsing stopped to avoid infinite loop");if(!f.boxtype)throw new q.ParseException("Problem on unknown box, parsing stopped to avoid infinite loop")}return this.localPos},q.boxes.ContainerFullBox.prototype.write=function(a,b,c){q.boxes.FullBox.prototype.write.call(this,a,b);var d=0;for(c===!0&&this._writeData(a,q.fields.FIELD_UINT32,this.entry_count),d=0;d<this.boxes.length;d++)this.localPos=this.boxes[d].write(a,this.localPos);return this.localPos},q.boxes.UnknownBox=function(a){q.boxes.Box.call(this,null,a)},q.boxes.UnknownBox.prototype=Object.create(q.boxes.Box.prototype),q.boxes.UnknownBox.prototype.constructor=q.boxes.UnknownBox,q.boxes.UnknownBox.prototype.read=function(a,b,c){return this.localPos=b,this.localEnd=c,this.unrecognized_data=a.subarray(this.localPos,this.localEnd),this.localEnd},q.boxes.UnknownBox.prototype.write=function(a,b){return q.boxes.Box.prototype.write.call(this,a,b),this._writeBuffer(a,this.unrecognized_data,this.unrecognized_data.length),this.localPos},q.boxes.UnknownBox.prototype.computeLength=function(){q.boxes.Box.prototype.computeLength.call(this),this.size+=this.unrecognized_data.length},q.boxes.FileTypeBox=function(a){q.boxes.Box.call(this,"ftyp",a)},q.boxes.FileTypeBox.prototype=Object.create(q.boxes.Box.prototype),q.boxes.FileTypeBox.prototype.constructor=q.boxes.FileTypeBox,q.boxes.FileTypeBox.prototype.computeLength=function(){q.boxes.Box.prototype.computeLength.call(this),this.size+=2*q.fields.FIELD_INT32.getLength()+q.fields.FIELD_INT32.getLength()*this.compatible_brands.length},q.boxes.FileTypeBox.prototype.read=function(a,b,c){return this.localPos=b,this.localEnd=c,this.major_brand=this._readData(a,q.fields.FIELD_INT32),this.minor_brand=this._readData(a,q.fields.FIELD_INT32),this.compatible_brands=this._readArrayData(a,q.fields.FIELD_INT32),this.localPos},q.boxes.FileTypeBox.prototype.write=function(a,b){return q.boxes.Box.prototype.write.call(this,a,b),this._writeData(a,q.fields.FIELD_INT32,this.major_brand),this._writeData(a,q.fields.FIELD_INT32,this.minor_brand),this._writeArrayData(a,q.fields.FIELD_INT32,this.compatible_brands),this.localPos},q.boxes.MovieBox=function(a){q.boxes.ContainerBox.call(this,"moov",a)},q.boxes.MovieBox.prototype=Object.create(q.boxes.ContainerBox.prototype),q.boxes.MovieBox.prototype.constructor=q.boxes.MovieBox,q.boxes.MovieFragmentBox=function(a){q.boxes.ContainerBox.call(this,"moof",a)},q.boxes.MovieFragmentBox.prototype=Object.create(q.boxes.ContainerBox.prototype),q.boxes.MovieFragmentBox.prototype.constructor=q.boxes.MovieFragmentBox,q.boxes.MovieFragmentRandomAccessBox=function(a){q.boxes.ContainerBox.call(this,"mfra",a)},q.boxes.MovieFragmentRandomAccessBox.prototype=Object.create(q.boxes.ContainerBox.prototype),q.boxes.MovieFragmentRandomAccessBox.prototype.constructor=q.boxes.MovieFragmentRandomAccessBox,q.boxes.UserDataBox=function(a){q.boxes.ContainerBox.call(this,"udta",a)},q.boxes.UserDataBox.prototype=Object.create(q.boxes.ContainerBox.prototype),q.boxes.UserDataBox.prototype.constructor=q.boxes.UserDataBox,q.boxes.TrackBox=function(a){q.boxes.ContainerBox.call(this,"trak",a)},q.boxes.TrackBox.prototype=Object.create(q.boxes.ContainerBox.prototype),q.boxes.TrackBox.prototype.constructor=q.boxes.TrackBox,q.boxes.EditBox=function(a){q.boxes.ContainerBox.call(this,"edts",a)},q.boxes.EditBox.prototype=Object.create(q.boxes.ContainerBox.prototype),q.boxes.EditBox.prototype.constructor=q.boxes.EditBox,q.boxes.MediaBox=function(a){q.boxes.ContainerBox.call(this,"mdia",a)},q.boxes.MediaBox.prototype=Object.create(q.boxes.ContainerBox.prototype),q.boxes.MediaBox.prototype.constructor=q.boxes.MediaBox,q.boxes.MediaInformationBox=function(a){q.boxes.ContainerBox.call(this,"minf",a)},q.boxes.MediaInformationBox.prototype=Object.create(q.boxes.ContainerBox.prototype),q.boxes.MediaInformationBox.prototype.constructor=q.boxes.MediaInformationBox,q.boxes.DataInformationBox=function(a){q.boxes.ContainerBox.call(this,"dinf",a)},q.boxes.DataInformationBox.prototype=Object.create(q.boxes.ContainerBox.prototype),q.boxes.DataInformationBox.prototype.constructor=q.boxes.DataInformationBox,q.boxes.SampleTableBox=function(a){q.boxes.ContainerBox.call(this,"stbl",a)},q.boxes.SampleTableBox.prototype=Object.create(q.boxes.ContainerBox.prototype),q.boxes.SampleTableBox.prototype.constructor=q.boxes.SampleTableBox,q.boxes.MovieExtendsBox=function(a){q.boxes.ContainerBox.call(this,"mvex",a)},q.boxes.MovieExtendsBox.prototype=Object.create(q.boxes.ContainerBox.prototype),q.boxes.MovieExtendsBox.prototype.constructor=q.boxes.MovieExtendsBox,q.boxes.TrackFragmentBox=function(a){q.boxes.ContainerBox.call(this,"traf",a)},q.boxes.TrackFragmentBox.prototype=Object.create(q.boxes.ContainerBox.prototype),q.boxes.TrackFragmentBox.prototype.constructor=q.boxes.TrackFragmentBox,q.boxes.MetaBox=function(a){q.boxes.ContainerFullBox.call(this,"meta",a)},q.boxes.MetaBox.prototype=Object.create(q.boxes.ContainerFullBox.prototype),q.boxes.MetaBox.prototype.constructor=q.boxes.MetaBox,q.boxes.MetaBox.prototype.computeLength=function(){q.boxes.ContainerFullBox.prototype.computeLength.call(this,!1)},q.boxes.MetaBox.prototype.read=function(a,b,c){return q.boxes.ContainerFullBox.prototype.read.call(this,a,b,c,!1)},q.boxes.MetaBox.prototype.write=function(a,b){return q.boxes.ContainerFullBox.prototype.write.call(this,a,b,!1)},q.boxes.MovieHeaderBox=function(a){q.boxes.FullBox.call(this,"mvhd",a)},q.boxes.MovieHeaderBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.MovieHeaderBox.prototype.constructor=q.boxes.MovieHeaderBox,q.boxes.MovieHeaderBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=q.fields.FIELD_INT32.getLength()+2*q.fields.FIELD_INT16.getLength(),this.size+=2*q.fields.FIELD_INT32.getLength()+9*q.fields.FIELD_INT32.getLength(),this.size+=6*q.fields.FIELD_BIT32.getLength()+q.fields.FIELD_UINT32.getLength(),1===this.version?this.size+=3*q.fields.FIELD_UINT64.getLength()+q.fields.FIELD_UINT32.getLength():this.size+=4*q.fields.FIELD_UINT32.getLength()},q.boxes.MovieHeaderBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),1===this.version?(this._writeData(a,q.fields.FIELD_UINT64,this.creation_time),this._writeData(a,q.fields.FIELD_UINT64,this.modification_time),this._writeData(a,q.fields.FIELD_UINT32,this.timescale),this._writeData(a,q.fields.FIELD_UINT64,this.duration)):(this._writeData(a,q.fields.FIELD_UINT32,this.creation_time),this._writeData(a,q.fields.FIELD_UINT32,this.modification_time),this._writeData(a,q.fields.FIELD_UINT32,this.timescale),this._writeData(a,q.fields.FIELD_UINT32,this.duration)),this._writeData(a,q.fields.FIELD_INT32,this.rate),this._writeData(a,q.fields.FIELD_INT16,this.volume),this._writeData(a,q.fields.FIELD_INT16,this.reserved),this._writeArrayData(a,q.fields.FIELD_INT32,this.reserved_2),this._writeArrayData(a,q.fields.FIELD_INT32,this.matrix),this._writeArrayData(a,q.fields.FIELD_BIT32,this.pre_defined),this._writeData(a,q.fields.FIELD_UINT32,this.next_track_ID),this.localPos},q.boxes.MovieHeaderBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),1==this.version?(this.creation_time=this._readData(a,q.fields.FIELD_UINT64),this.modification_time=this._readData(a,q.fields.FIELD_UINT64),this.timescale=this._readData(a,q.fields.FIELD_UINT32),this.duration=this._readData(a,q.fields.FIELD_UINT64)):(this.creation_time=this._readData(a,q.fields.FIELD_UINT32),this.modification_time=this._readData(a,q.fields.FIELD_UINT32),this.timescale=this._readData(a,q.fields.FIELD_UINT32),this.duration=this._readData(a,q.fields.FIELD_UINT32)),this.rate=this._readData(a,q.fields.FIELD_INT32),this.volume=this._readData(a,q.fields.FIELD_INT16),this.reserved=this._readData(a,q.fields.FIELD_INT16),this.reserved_2=this._readArrayFieldData(a,q.fields.FIELD_INT32,2),this.matrix=this._readArrayFieldData(a,q.fields.FIELD_INT32,9),this.pre_defined=this._readArrayFieldData(a,q.fields.FIELD_BIT32,6),this.next_track_ID=this._readData(a,q.fields.FIELD_UINT32),this.localPos},q.boxes.MediaDataBox=function(a){q.boxes.Box.call(this,"mdat",a)},q.boxes.MediaDataBox.prototype=Object.create(q.boxes.Box.prototype),q.boxes.MediaDataBox.prototype.constructor=q.boxes.MediaDataBox,q.boxes.MediaDataBox.prototype.computeLength=function(){q.boxes.Box.prototype.computeLength.call(this),this.size+=this.data.length},q.boxes.MediaDataBox.prototype.read=function(a,b,c){return this.data=a.subarray(b,c),c},q.boxes.MediaDataBox.prototype.write=function(a,b){return q.boxes.Box.prototype.write.call(this,a,b),this._writeBuffer(a,this.data,this.data.length),this.localPos},q.boxes.FreeSpaceBox=function(a){q.boxes.Box.call(this,"free",a)},q.boxes.FreeSpaceBox.prototype=Object.create(q.boxes.Box.prototype),q.boxes.FreeSpaceBox.prototype.constructor=q.boxes.FreeSpaceBox,q.boxes.FreeSpaceBox.prototype.computeLength=function(){q.boxes.Box.prototype.computeLength.call(this),this.size+=this.data.length},q.boxes.FreeSpaceBox.prototype.read=function(a,b,c){return this.localPos=b,this.localEnd=c,this.data=a.subarray(this.localPos,this.localEnd),this.localEnd},q.boxes.FreeSpaceBox.prototype.write=function(a,b){return q.boxes.Box.prototype.write.call(this,a,b),this._writeBuffer(a,this.data,this.data.length),this.localPos},q.boxes.SegmentIndexBox=function(a){q.boxes.FullBox.call(this,"sidx",a)},q.boxes.SegmentIndexBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.SegmentIndexBox.prototype.constructor=q.boxes.SegmentIndexBox,q.boxes.SegmentIndexBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*q.fields.FIELD_UINT32.getLength(),1===this.version?this.size+=2*q.fields.FIELD_UINT64.getLength():this.size+=2*q.fields.FIELD_UINT32.getLength(),this.size+=q.fields.FIELD_UINT16.getLength(),this.size+=q.fields.FIELD_UINT16.getLength(),this.size+=(q.fields.FIELD_UINT64.getLength()+q.fields.FIELD_UINT32.getLength())*this.reference_count},q.boxes.SegmentIndexBox.prototype.read=function(a,b,c){q.boxes.FullBox.prototype.read.call(this,a,b,c);var d=0,e={};for(this.reference_ID=this._readData(a,q.fields.FIELD_UINT32),this.timescale=this._readData(a,q.fields.FIELD_UINT32),1===this.version?(this.earliest_presentation_time=this._readData(a,q.fields.FIELD_UINT64),this.first_offset=this._readData(a,q.fields.FIELD_UINT64)):(this.earliest_presentation_time=this._readData(a,q.fields.FIELD_UINT32),this.first_offset=this._readData(a,q.fields.FIELD_UINT32)),this.reserved=this._readData(a,q.fields.FIELD_UINT16),this.reference_count=this._readData(a,q.fields.FIELD_UINT16),this.references=[],d=0;d<this.reference_count;d++)e={},e.reference_info=this._readData(a,q.fields.FIELD_UINT64),e.SAP=this._readData(a,q.fields.FIELD_UINT32),this.references.push(e);return this.localPos},q.boxes.SegmentIndexBox.prototype.write=function(a,b){q.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,q.fields.FIELD_UINT32,this.reference_ID),this._writeData(a,q.fields.FIELD_UINT32,this.timescale),1===this.version?(this._writeData(a,q.fields.FIELD_UINT64,this.earliest_presentation_time),this._writeData(a,q.fields.FIELD_UINT64,this.first_offset)):(this._writeData(a,q.fields.FIELD_UINT32,this.earliest_presentation_time),this._writeData(a,q.fields.FIELD_UINT32,this.first_offset)),this._writeData(a,q.fields.FIELD_UINT16,this.reserved),this._writeData(a,q.fields.FIELD_UINT16,this.reference_count),c=0;c<this.reference_count;c++)this._writeData(a,q.fields.FIELD_UINT64,this.references[c].reference_info),this._writeData(a,q.fields.FIELD_UINT32,this.references[c].SAP);return this.localPos},q.boxes.TrackHeaderBox=function(a){q.boxes.FullBox.call(this,"tkhd",a)},q.boxes.TrackHeaderBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.TrackHeaderBox.prototype.constructor=q.boxes.TrackHeaderBox,q.boxes.TrackHeaderBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=4*q.fields.FIELD_INT16.getLength()+2*q.fields.FIELD_INT32.getLength()+2*q.fields.FIELD_UINT32.getLength()+9*q.fields.FIELD_INT32.getLength(),1==this.version?this.size+=3*q.fields.FIELD_UINT64.getLength()+2*q.fields.FIELD_UINT32.getLength():this.size+=5*q.fields.FIELD_UINT32.getLength()},q.boxes.TrackHeaderBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),1===this.version?(this.creation_time=this._readData(a,q.fields.FIELD_UINT64),this.modification_time=this._readData(a,q.fields.FIELD_UINT64),this.track_id=this._readData(a,q.fields.FIELD_UINT32),this.reserved=this._readData(a,q.fields.FIELD_UINT32),this.duration=this._readData(a,q.fields.FIELD_UINT64)):(this.creation_time=this._readData(a,q.fields.FIELD_UINT32),this.modification_time=this._readData(a,q.fields.FIELD_UINT32),this.track_id=this._readData(a,q.fields.FIELD_UINT32),this.reserved=this._readData(a,q.fields.FIELD_UINT32),this.duration=this._readData(a,q.fields.FIELD_UINT32)),this.reserved_2=this._readArrayFieldData(a,q.fields.FIELD_UINT32,2),this.layer=this._readData(a,q.fields.FIELD_INT16),this.alternate_group=this._readData(a,q.fields.FIELD_INT16),this.volume=this._readData(a,q.fields.FIELD_INT16),this.reserved_3=this._readData(a,q.fields.FIELD_INT16),this.matrix=this._readArrayFieldData(a,q.fields.FIELD_INT32,9),this.width=this._readData(a,q.fields.FIELD_INT32),this.height=this._readData(a,q.fields.FIELD_INT32),this.localPos},q.boxes.TrackHeaderBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),1===this.version?(this._writeData(a,q.fields.FIELD_UINT64,this.creation_time),this._writeData(a,q.fields.FIELD_UINT64,this.modification_time),this._writeData(a,q.fields.FIELD_UINT32,this.track_id),this._writeData(a,q.fields.FIELD_UINT32,this.reserved),this._writeData(a,q.fields.FIELD_UINT64,this.duration)):(this._writeData(a,q.fields.FIELD_UINT32,this.creation_time),this._writeData(a,q.fields.FIELD_UINT32,this.modification_time),this._writeData(a,q.fields.FIELD_UINT32,this.track_id),this._writeData(a,q.fields.FIELD_UINT32,this.reserved),this._writeData(a,q.fields.FIELD_UINT32,this.duration)),this._writeArrayData(a,q.fields.FIELD_UINT32,this.reserved_2),this._writeData(a,q.fields.FIELD_INT16,this.layer),this._writeData(a,q.fields.FIELD_INT16,this.alternate_group),this._writeData(a,q.fields.FIELD_INT16,this.volume),this._writeData(a,q.fields.FIELD_INT16,this.reserved_3),this._writeArrayData(a,q.fields.FIELD_INT32,this.matrix),this._writeData(a,q.fields.FIELD_INT32,this.width),this._writeData(a,q.fields.FIELD_INT32,this.height),this.localPos},q.boxes.MediaHeaderBox=function(a){q.boxes.FullBox.call(this,"mdhd",a)},q.boxes.MediaHeaderBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.MediaHeaderBox.prototype.constructor=q.boxes.MediaHeaderBox,q.boxes.MediaHeaderBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*q.fields.FIELD_UINT16.getLength(),1==this.version?this.size+=3*q.fields.FIELD_UINT64.getLength()+q.fields.FIELD_UINT32.getLength():this.size+=4*q.fields.FIELD_UINT32.getLength()},q.boxes.MediaHeaderBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),1===this.version?(this.creation_time=this._readData(a,q.fields.FIELD_UINT64),this.modification_time=this._readData(a,q.fields.FIELD_UINT64),this.timescale=this._readData(a,q.fields.FIELD_UINT32),this.duration=this._readData(a,q.fields.FIELD_UINT64)):(this.creation_time=this._readData(a,q.fields.FIELD_UINT32),this.modification_time=this._readData(a,q.fields.FIELD_UINT32),this.timescale=this._readData(a,q.fields.FIELD_UINT32),this.duration=this._readData(a,q.fields.FIELD_UINT32)),this.language=this._readData(a,q.fields.FIELD_UINT16),this.pre_defined=this._readData(a,q.fields.FIELD_UINT16),this.localPos},q.boxes.MediaHeaderBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),1===this.version?(this._writeData(a,q.fields.FIELD_UINT64,this.creation_time),this._writeData(a,q.fields.FIELD_UINT64,this.modification_time),this._writeData(a,q.fields.FIELD_UINT32,this.timescale),this._writeData(a,q.fields.FIELD_UINT64,this.duration)):(this._writeData(a,q.fields.FIELD_UINT32,this.creation_time),this._writeData(a,q.fields.FIELD_UINT32,this.modification_time),this._writeData(a,q.fields.FIELD_UINT32,this.timescale),this._writeData(a,q.fields.FIELD_UINT32,this.duration)),this._writeData(a,q.fields.FIELD_UINT16,this.language),this._writeData(a,q.fields.FIELD_UINT16,this.pre_defined),this.localPos},q.boxes.MovieExtendsHeaderBox=function(a){q.boxes.FullBox.call(this,"mehd",a)},q.boxes.MovieExtendsHeaderBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.MovieExtendsHeaderBox.prototype.constructor=q.boxes.MovieExtendsHeaderBox,q.boxes.MovieExtendsHeaderBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),1==this.version?this.size+=q.fields.FIELD_UINT64.getLength():this.size+=q.fields.FIELD_UINT32.getLength()},q.boxes.MovieExtendsHeaderBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),1===this.version?this.fragment_duration=this._readData(a,q.fields.FIELD_UINT64):this.fragment_duration=this._readData(a,q.fields.FIELD_UINT32),this.localPos},q.boxes.MovieExtendsHeaderBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),1===this.version?this._writeData(a,q.fields.FIELD_UINT64,this.fragment_duration):this._writeData(a,q.fields.FIELD_UINT32,this.fragment_duration),this.localPos},q.boxes.HandlerBox=function(a){q.boxes.FullBox.call(this,"hdlr",a)},q.boxes.HandlerBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.HandlerBox.prototype.constructor=q.boxes.HandlerBox,q.boxes.HandlerBox.prototype.HANDLERTYPEVIDEO="vide",q.boxes.HandlerBox.prototype.HANDLERTYPEAUDIO="soun",q.boxes.HandlerBox.prototype.HANDLERTYPETEXT="meta",q.boxes.HandlerBox.prototype.HANDLERVIDEONAME="Video Track",q.boxes.HandlerBox.prototype.HANDLERAUDIONAME="Audio Track",q.boxes.HandlerBox.prototype.HANDLERTEXTNAME="Text Track",q.boxes.HandlerBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*q.fields.FIELD_UINT32.getLength()+3*q.fields.FIELD_UINT32.getLength()+q.fields.FIELD_STRING.getLength(this.name)},q.boxes.HandlerBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),this.pre_defined=this._readData(a,q.fields.FIELD_UINT32),this.handler_type=this._readData(a,q.fields.FIELD_UINT32),this.reserved=this._readArrayFieldData(a,q.fields.FIELD_UINT32,3),this.name=this._readData(a,q.fields.FIELD_STRING),this.localPos},q.boxes.HandlerBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,q.fields.FIELD_UINT32,this.pre_defined),this._writeData(a,q.fields.FIELD_UINT32,this.handler_type),this._writeArrayData(a,q.fields.FIELD_UINT32,this.reserved),this._writeData(a,q.fields.FIELD_STRING,this.name),this.localPos},q.boxes.TimeToSampleBox=function(a){q.boxes.FullBox.call(this,"stts",a)},q.boxes.TimeToSampleBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.TimeToSampleBox.prototype.constructor=q.boxes.TimeToSampleBox,q.boxes.TimeToSampleBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=q.fields.FIELD_UINT32.getLength(),this.size+=this.entry_count*(2*q.fields.FIELD_UINT32.getLength())},q.boxes.TimeToSampleBox.prototype.read=function(a,b,c){q.boxes.FullBox.prototype.read.call(this,a,b,c);var d=0,e={};for(this.entry_count=this._readData(a,q.fields.FIELD_UINT32),this.entry=[],d=0;d<this.entry_count;d++)e={},e.sample_count=this._readData(a,q.fields.FIELD_UINT32),e.sample_delta=this._readData(a,q.fields.FIELD_UINT32),this.entry.push(e);return this.localPos},q.boxes.TimeToSampleBox.prototype.write=function(a,b){q.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,q.fields.FIELD_UINT32,this.entry_count),c=0;c<this.entry_count;c++)this._writeData(a,q.fields.FIELD_UINT32,this.entry[c].sample_count),this._writeData(a,q.fields.FIELD_UINT32,this.entry[c].sample_delta);return this.localPos},q.boxes.SampleToChunkBox=function(a){q.boxes.FullBox.call(this,"stsc",a)},q.boxes.SampleToChunkBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.SampleToChunkBox.prototype.constructor=q.boxes.SampleToChunkBox,q.boxes.SampleToChunkBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=q.fields.FIELD_UINT32.getLength(),this.size+=this.entry_count*(3*q.fields.FIELD_UINT32.getLength())},q.boxes.SampleToChunkBox.prototype.read=function(a,b,c){q.boxes.FullBox.prototype.read.call(this,a,b,c);var d=0,e={};for(this.entry_count=this._readData(a,q.fields.FIELD_UINT32),this.entry=[],d=0;d<this.entry_count;d++)e={},e.first_chunk=this._readData(a,q.fields.FIELD_UINT32),e.samples_per_chunk=this._readData(a,q.fields.FIELD_UINT32),e.samples_description_index=this._readData(a,q.fields.FIELD_UINT32),this.entry.push(e);return this.localPos},q.boxes.SampleToChunkBox.prototype.write=function(a,b){q.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,q.fields.FIELD_UINT32,this.entry_count),c=0;c<this.entry_count;c++)this._writeData(a,q.fields.FIELD_UINT32,this.entry[c].first_chunk),this._writeData(a,q.fields.FIELD_UINT32,this.entry[c].samples_per_chunk),this._writeData(a,q.fields.FIELD_UINT32,this.entry[c].samples_description_index);return this.localPos},q.boxes.ChunkOffsetBox=function(a){q.boxes.FullBox.call(this,"stco",a)},q.boxes.ChunkOffsetBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.ChunkOffsetBox.prototype.constructor=q.boxes.ChunkOffsetBox,q.boxes.ChunkOffsetBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=q.fields.FIELD_UINT32.getLength()+this.entry_count*q.fields.FIELD_UINT32.getLength()},q.boxes.ChunkOffsetBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),this.entry_count=this._readData(a,q.fields.FIELD_UINT32),this.chunk_offset=this._readArrayFieldData(a,q.fields.FIELD_UINT32,this.entry_count),this.localPos},q.boxes.ChunkOffsetBox.prototype.write=function(a,b){q.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,q.fields.FIELD_UINT32,this.entry_count),c=0;c<this.entry_count;c++)this._writeData(a,q.fields.FIELD_UINT32,this.chunk_offset[c]);return this.localPos},q.boxes.TrackExtendsBox=function(a){q.boxes.FullBox.call(this,"trex",a)},q.boxes.TrackExtendsBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.TrackExtendsBox.prototype.constructor=q.boxes.TrackExtendsBox,q.boxes.TrackExtendsBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=5*q.fields.FIELD_UINT32.getLength()},q.boxes.TrackExtendsBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),this.track_ID=this._readData(a,q.fields.FIELD_UINT32),this.default_sample_description_index=this._readData(a,q.fields.FIELD_UINT32),this.default_sample_duration=this._readData(a,q.fields.FIELD_UINT32),this.default_sample_size=this._readData(a,q.fields.FIELD_UINT32),this.default_sample_flags=this._readData(a,q.fields.FIELD_UINT32),this.localPos},q.boxes.TrackExtendsBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,q.fields.FIELD_UINT32,this.track_ID),this._writeData(a,q.fields.FIELD_UINT32,this.default_sample_description_index),this._writeData(a,q.fields.FIELD_UINT32,this.default_sample_duration),this._writeData(a,q.fields.FIELD_UINT32,this.default_sample_size),this._writeData(a,q.fields.FIELD_UINT32,this.default_sample_flags),this.localPos},q.boxes.VideoMediaHeaderBox=function(a){q.boxes.FullBox.call(this,"vmhd",a)},q.boxes.VideoMediaHeaderBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.VideoMediaHeaderBox.prototype.constructor=q.boxes.VideoMediaHeaderBox,q.boxes.VideoMediaHeaderBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),
this.size+=q.fields.FIELD_INT16.getLength()+3*q.fields.FIELD_UINT16.getLength()},q.boxes.VideoMediaHeaderBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),this.graphicsmode=this._readData(a,q.fields.FIELD_INT16),this.opcolor=this._readArrayFieldData(a,q.fields.FIELD_UINT16,3),this.localPos},q.boxes.VideoMediaHeaderBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,q.fields.FIELD_INT16,this.graphicsmode),this._writeArrayData(a,q.fields.FIELD_UINT16,this.opcolor),this.localPos},q.boxes.SoundMediaHeaderBox=function(a){q.boxes.FullBox.call(this,"smhd",a)},q.boxes.SoundMediaHeaderBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.SoundMediaHeaderBox.prototype.constructor=q.boxes.SoundMediaHeaderBox,q.boxes.SoundMediaHeaderBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=q.fields.FIELD_INT16.getLength()+q.fields.FIELD_UINT16.getLength()},q.boxes.SoundMediaHeaderBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),this.balance=this._readData(a,q.fields.FIELD_INT16),this.reserved=this._readData(a,q.fields.FIELD_UINT16),this.localPos},q.boxes.SoundMediaHeaderBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,q.fields.FIELD_INT16,this.balance),this._writeData(a,q.fields.FIELD_UINT16,this.reserved),this.localPos},q.boxes.DataReferenceBox=function(a){q.boxes.ContainerFullBox.call(this,"dref",a)},q.boxes.DataReferenceBox.prototype=Object.create(q.boxes.ContainerFullBox.prototype),q.boxes.DataReferenceBox.prototype.constructor=q.boxes.DataReferenceBox,q.boxes.DataReferenceBox.prototype.computeLength=function(){q.boxes.ContainerFullBox.prototype.computeLength.call(this,!0)},q.boxes.DataReferenceBox.prototype.read=function(a,b,c){return q.boxes.ContainerFullBox.prototype.read.call(this,a,b,c,!0)},q.boxes.DataReferenceBox.prototype.write=function(a,b){return this.entry_count||(this.entry_count=this.boxes.length),q.boxes.ContainerFullBox.prototype.write.call(this,a,b,!0)},q.boxes.DataEntryUrlBox=function(a){q.boxes.FullBox.call(this,"url ",a)},q.boxes.DataEntryUrlBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.DataEntryUrlBox.prototype.constructor=q.boxes.DataEntryUrlBox,q.boxes.DataEntryUrlBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),void 0!==this.location&&(this.size+=q.fields.FIELD_STRING.getLength(this.location))},q.boxes.DataEntryUrlBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),this.flags&!1&&(this.location=this._readData(a,q.fields.FIELD_STRING)),this.localPos},q.boxes.DataEntryUrlBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),void 0!==this.location&&this._writeData(a,q.fields.FIELD_STRING,this.location),this.localPos},q.boxes.DataEntryUrnBox=function(a){q.boxes.FullBox.call(this,"urn ",a)},q.boxes.DataEntryUrnBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.DataEntryUrnBox.prototype.constructor=q.boxes.DataEntryUrnBox,q.boxes.DataEntryUrnBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.flags&!1&&(this.size+=q.fields.FIELD_STRING.getLength(this.name)+q.fields.FIELD_STRING.getLength(this.location))},q.boxes.DataEntryUrnBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),this.flags&!1&&(this.name=this._readData(a,q.fields.FIELD_STRING),this.location=this._readData(a,q.fields.FIELD_STRING)),this.localPos},q.boxes.DataEntryUrnBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),this.flags&!1&&(this._writeData(a,q.fields.FIELD_STRING,this.name),this._writeData(a,q.fields.FIELD_STRING,this.location)),this.localPos},q.boxes.MovieFragmentHeaderBox=function(a){q.boxes.FullBox.call(this,"mfhd",a)},q.boxes.MovieFragmentHeaderBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.MovieFragmentHeaderBox.prototype.constructor=q.boxes.MovieFragmentHeaderBox,q.boxes.MovieFragmentHeaderBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=q.fields.FIELD_UINT32.getLength()},q.boxes.MovieFragmentHeaderBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),this.sequence_number=this._readData(a,q.fields.FIELD_UINT32),this.localPos},q.boxes.MovieFragmentHeaderBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,q.fields.FIELD_UINT32,this.sequence_number),this.localPos},q.boxes.TrackFragmentHeaderBox=function(a){q.boxes.FullBox.call(this,"tfhd",a)},q.boxes.TrackFragmentHeaderBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.TrackFragmentHeaderBox.prototype.constructor=q.boxes.TrackFragmentHeaderBox,q.boxes.TrackFragmentHeaderBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=q.fields.FIELD_UINT32.getLength(),0!==(1&this.flags)&&void 0!==this.base_data_offset&&(this.size+=q.fields.FIELD_UINT64.getLength()),0!==(2&this.flags)&&void 0!==this.sample_description_index&&(this.size+=q.fields.FIELD_UINT32.getLength()),0!==(8&this.flags)&&void 0!==this.default_sample_duration&&(this.size+=q.fields.FIELD_UINT32.getLength()),0!==(16&this.flags)&&void 0!==this.default_sample_size&&(this.size+=q.fields.FIELD_UINT32.getLength()),0!==(32&this.flags)&&void 0!==this.default_sample_flags&&(this.size+=q.fields.FIELD_UINT32.getLength())},q.boxes.TrackFragmentHeaderBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),this.track_ID=this._readData(a,q.fields.FIELD_UINT32),0!==(1&this.flags)&&(this.base_data_offset=this._readData(a,q.fields.FIELD_UINT64)),0!==(2&this.flags)&&(this.sample_description_index=this._readData(a,q.fields.FIELD_UINT32)),0!==(8&this.flags)&&(this.default_sample_duration=this._readData(a,q.fields.FIELD_UINT32)),0!==(16&this.flags)&&(this.default_sample_size=this._readData(a,q.fields.FIELD_UINT32)),0!==(32&this.flags)&&(this.default_sample_flags=this._readData(a,q.fields.FIELD_UINT32)),this.localPos},q.boxes.TrackFragmentHeaderBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,q.fields.FIELD_UINT32,this.track_ID),0!==(1&this.flags)&&this._writeData(a,q.fields.FIELD_UINT64,this.base_data_offset),0!==(2&this.flags)&&this._writeData(a,q.fields.FIELD_UINT32,this.sample_description_index),0!==(8&this.flags)&&this._writeData(a,q.fields.FIELD_UINT32,this.default_sample_duration),0!==(16&this.flags)&&this._writeData(a,q.fields.FIELD_UINT32,this.default_sample_size),0!==(32&this.flags)&&this._writeData(a,q.fields.FIELD_UINT32,this.default_sample_flags),this.localPos},q.boxes.TrackFragmentBaseMediaDecodeTimeBox=function(a){q.boxes.FullBox.call(this,"tfdt",a)},q.boxes.TrackFragmentBaseMediaDecodeTimeBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.TrackFragmentBaseMediaDecodeTimeBox.prototype.constructor=q.boxes.TrackFragmentBaseMediaDecodeTimeBox,q.boxes.TrackFragmentBaseMediaDecodeTimeBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),1===this.version?this.size+=q.fields.FIELD_UINT64.getLength():this.size+=q.fields.FIELD_UINT32.getLength()},q.boxes.TrackFragmentBaseMediaDecodeTimeBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),1===this.version?this.baseMediaDecodeTime=this._readData(a,q.fields.FIELD_UINT64):this.baseMediaDecodeTime=this._readData(a,q.fields.FIELD_UINT32),this.localPos},q.boxes.TrackFragmentBaseMediaDecodeTimeBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),1===this.version?this._writeData(a,q.fields.FIELD_UINT64,this.baseMediaDecodeTime):this._writeData(a,q.fields.FIELD_UINT32,this.baseMediaDecodeTime),this.localPos},q.boxes.TrackFragmentRunBox=function(a){q.boxes.FullBox.call(this,"trun",a)},q.boxes.TrackFragmentRunBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.TrackFragmentRunBox.prototype.constructor=q.boxes.TrackFragmentRunBox,q.boxes.TrackFragmentRunBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this);var a=0;for(this.size+=q.fields.FIELD_UINT32.getLength(),0!==(1&this.flags)&&void 0!==this.data_offset&&(this.size+=q.fields.FIELD_INT32.getLength()),0!==(4&this.flags)&&void 0!==this.first_sample_flags&&(this.size+=q.fields.FIELD_UINT32.getLength()),a=0;a<this.sample_count;a++)0!==(256&this.flags)&&void 0!==this.samples_table[a].sample_duration&&(this.size+=q.fields.FIELD_UINT32.getLength()),0!==(512&this.flags)&&void 0!==this.samples_table[a].sample_size&&(this.size+=q.fields.FIELD_UINT32.getLength()),0!==(1024&this.flags)&&void 0!==this.samples_table[a].sample_flags&&(this.size+=q.fields.FIELD_UINT32.getLength()),1===this.version?0!==(2048&this.flags)&&void 0!==this.samples_table[a].sample_composition_time_offset&&(this.size+=q.fields.FIELD_INT32.getLength()):0!==(2048&this.flags)&&void 0!==this.samples_table[a].sample_composition_time_offset&&(this.size+=q.fields.FIELD_UINT32.getLength())},q.boxes.TrackFragmentRunBox.prototype.read=function(a,b,c){q.boxes.FullBox.prototype.read.call(this,a,b,c);var d=0,e={};for(this.sample_count=this._readData(a,q.fields.FIELD_UINT32),0!==(1&this.flags)&&(this.data_offset=this._readData(a,q.fields.FIELD_INT32)),0!==(4&this.flags)&&(this.first_sample_flags=this._readData(a,q.fields.FIELD_UINT32)),this.samples_table=[],d=0;d<this.sample_count;d++)e={},0!==(256&this.flags)&&(e.sample_duration=this._readData(a,q.fields.FIELD_UINT32)),0!==(512&this.flags)&&(e.sample_size=this._readData(a,q.fields.FIELD_UINT32)),0!==(1024&this.flags)&&(e.sample_flags=this._readData(a,q.fields.FIELD_UINT32)),1===this.version?0!==(2048&this.flags)&&(e.sample_composition_time_offset=this._readData(a,q.fields.FIELD_INT32)):0!==(2048&this.flags)&&(e.sample_composition_time_offset=this._readData(a,q.fields.FIELD_UINT32)),this.samples_table.push(e);return this.localPos},q.boxes.TrackFragmentRunBox.prototype.write=function(a,b){q.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,q.fields.FIELD_UINT32,this.sample_count),0!==(1&this.flags)&&this._writeData(a,q.fields.FIELD_INT32,this.data_offset),0!==(4&this.flags)&&this._writeData(a,q.fields.FIELD_UINT32,this.first_sample_flags),c=0;c<this.sample_count;c++)0!==(256&this.flags)&&this._writeData(a,q.fields.FIELD_UINT32,this.samples_table[c].sample_duration),0!==(512&this.flags)&&this._writeData(a,q.fields.FIELD_UINT32,this.samples_table[c].sample_size),0!==(1024&this.flags)&&this._writeData(a,q.fields.FIELD_UINT32,this.samples_table[c].sample_flags),1===this.version?0!==(2048&this.flags)&&this._writeData(a,q.fields.FIELD_INT32,this.samples_table[c].sample_composition_time_offset):0!==(2048&this.flags)&&this._writeData(a,q.fields.FIELD_UINT32,this.samples_table[c].sample_composition_time_offset);return this.localPos},q.boxes.SampleDescriptionBox=function(a){q.boxes.ContainerFullBox.call(this,"stsd",a)},q.boxes.SampleDescriptionBox.prototype=Object.create(q.boxes.ContainerFullBox.prototype),q.boxes.SampleDescriptionBox.prototype.constructor=q.boxes.SampleDescriptionBox,q.boxes.SampleDescriptionBox.prototype.computeLength=function(){q.boxes.ContainerFullBox.prototype.computeLength.call(this,!0)},q.boxes.SampleDescriptionBox.prototype.read=function(a,b,c){return q.boxes.ContainerFullBox.prototype.read.call(this,a,b,c,!0)},q.boxes.SampleDescriptionBox.prototype.write=function(a,b){return this.entry_count=this.boxes.length,q.boxes.ContainerFullBox.prototype.write.call(this,a,b,!0)},q.boxes.SampleDependencyTableBox=function(a){q.boxes.FullBox.call(this,"sdtp",a)},q.boxes.SampleDependencyTableBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.SampleDependencyTableBox.prototype.constructor=q.boxes.SampleDependencyTableBox,q.boxes.SampleDependencyTableBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=q.fields.FIELD_UINT8.getLength()*this.sample_dependency_table.length},q.boxes.SampleDependencyTableBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),this.sample_dependency_table=this._readArrayData(a,q.fields.FIELD_UINT8),this.localPos},q.boxes.SampleDependencyTableBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),this._writeArrayData(a,q.fields.FIELD_UINT8,this.sample_dependency_table),this.localPos},q.boxes.SampleEntryBox=function(a,b){q.boxes.Box.call(this,a,b)},q.boxes.SampleEntryBox.prototype=Object.create(q.boxes.Box.prototype),q.boxes.SampleEntryBox.prototype.constructor=q.boxes.SampleEntryBox,q.boxes.SampleEntryBox.prototype.computeLength=function(){q.boxes.Box.prototype.computeLength.call(this),this.size+=q.fields.FIELD_UINT16.getLength()+6*q.fields.FIELD_UINT8.getLength()},q.boxes.SampleEntryBox.prototype.read=function(a,b,c){return this.localPos=b,this.localEnd=c,this.reserved=this._readArrayFieldData(a,q.fields.FIELD_UINT8,6),this.data_reference_index=this._readData(a,q.fields.FIELD_UINT16),this.localPos},q.boxes.SampleEntryBox.prototype.write=function(a,b){return q.boxes.Box.prototype.write.call(this,a,b),this._writeArrayData(a,q.fields.FIELD_UINT8,this.reserved),this._writeData(a,q.fields.FIELD_UINT16,this.data_reference_index),this.localPos},q.boxes.VisualSampleEntryBox=function(a,b){q.boxes.SampleEntryBox.call(this,a,b)},q.boxes.VisualSampleEntryBox.prototype=Object.create(q.boxes.SampleEntryBox.prototype),q.boxes.VisualSampleEntryBox.prototype.constructor=q.boxes.VisualSampleEntryBox,q.boxes.VisualSampleEntryBox.prototype.computeLength=function(){q.boxes.SampleEntryBox.prototype.computeLength.call(this),this.size+=7*q.fields.FIELD_UINT16.getLength()+3*q.fields.FIELD_UINT32.getLength(),this.size+=3*q.fields.FIELD_UINT32.getLength(),this.size+=32},q.boxes.VisualSampleEntryBox.prototype.read=function(a,b,c){return q.boxes.SampleEntryBox.prototype.read.call(this,a,b,c),this.pre_defined=this._readData(a,q.fields.FIELD_UINT16),this.reserved_2=this._readData(a,q.fields.FIELD_UINT16),this.pre_defined_2=this._readArrayFieldData(a,q.fields.FIELD_UINT32,3),this.width=this._readData(a,q.fields.FIELD_UINT16),this.height=this._readData(a,q.fields.FIELD_UINT16),this.horizresolution=this._readData(a,q.fields.FIELD_UINT32),this.vertresolution=this._readData(a,q.fields.FIELD_UINT32),this.reserved_3=this._readData(a,q.fields.FIELD_UINT32),this.frame_count=this._readData(a,q.fields.FIELD_UINT16),this.compressorname=new q.fields.FixedLenStringField(32),this.compressorname=this.compressorname.read(a,this.localPos),this.localPos+=32,this.depth=this._readData(a,q.fields.FIELD_UINT16),this.pre_defined_3=this._readData(a,q.fields.FIELD_INT16),this.localPos},q.boxes.VisualSampleEntryBox.prototype.write=function(a,b){q.boxes.SampleEntryBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,q.fields.FIELD_UINT16,this.pre_defined),this._writeData(a,q.fields.FIELD_UINT16,this.reserved_2),this._writeArrayData(a,q.fields.FIELD_UINT32,this.pre_defined_2),this._writeData(a,q.fields.FIELD_UINT16,this.width),this._writeData(a,q.fields.FIELD_UINT16,this.height),this._writeData(a,q.fields.FIELD_UINT32,this.horizresolution),this._writeData(a,q.fields.FIELD_UINT32,this.vertresolution),this._writeData(a,q.fields.FIELD_UINT32,this.reserved_3),this._writeData(a,q.fields.FIELD_UINT16,this.frame_count),c=0;32>c;c++)a[this.localPos+c]=this.compressorname.charCodeAt(c);return this.localPos+=32,this._writeData(a,q.fields.FIELD_UINT16,this.depth),this._writeData(a,q.fields.FIELD_INT16,this.pre_defined_3),this.localPos},q.boxes.VisualSampleEntryContainerBox=function(a,b){q.boxes.VisualSampleEntryBox.call(this,a,b),this.boxes=[]},q.boxes.VisualSampleEntryContainerBox.prototype=Object.create(q.boxes.VisualSampleEntryBox.prototype),q.boxes.VisualSampleEntryContainerBox.prototype.constructor=q.boxes.VisualSampleEntryContainerBox,q.boxes.VisualSampleEntryContainerBox.prototype.computeLength=function(){q.boxes.VisualSampleEntryBox.prototype.computeLength.call(this);var a=0;for(a=0;a<this.boxes.length;a++)this.boxes[a].computeLength(),this.size+=this.boxes[a].size},q.boxes.VisualSampleEntryContainerBox.prototype.read=function(a,b,c){q.boxes.VisualSampleEntryBox.prototype.read.call(this,a,b,c);for(var d,e,f=0,g=0,h=null;this.localPos<this.localEnd;){if(f=q.fields.FIELD_UINT32.read(a,this.localPos),d=q.fields.readString(a,this.localPos+4,4),"uuid"==d&&(g=1==f?16:8,h=new q.fields.ArrayField(q.fields.FIELD_INT8,16).read(a,this.localPos+g,this.localPos+g+16),h=JSON.stringify(h)),e=q.createBox(d,f,h),"uuid"===d?this.localPos=e.read(a,this.localPos+16*q.fields.FIELD_INT8.getLength()+8,this.localPos+f):this.localPos=e.read(a,this.localPos+8,this.localPos+f),q.debug&&(e.__sourceBuffer=a.subarray(this.localPos-e.size,this.localPos)),this.boxes.push(e),e.size<=0||null===e.size)throw new q.ParseException("Problem on size of box "+e.boxtype+", parsing stopped to avoid infinite loop");if(!e.boxtype)throw new q.ParseException("Problem on unknown box, parsing stopped to avoid infinite loop")}return this.localPos},q.boxes.VisualSampleEntryContainerBox.prototype.write=function(a,b){q.boxes.VisualSampleEntryBox.prototype.write.call(this,a,b);var c=0;for(c=0;c<this.boxes.length;c++)this.localPos=this.boxes[c].write(a,this.localPos);return this.localPos},q.boxes.AVC1VisualSampleEntryBox=function(a){q.boxes.VisualSampleEntryContainerBox.call(this,"avc1",a)},q.boxes.AVC1VisualSampleEntryBox.prototype=Object.create(q.boxes.VisualSampleEntryContainerBox.prototype),q.boxes.AVC1VisualSampleEntryBox.prototype.constructor=q.boxes.AVC1VisualSampleEntryBox,q.boxes.EncryptedVideoBox=function(a){q.boxes.VisualSampleEntryContainerBox.call(this,"encv",a)},q.boxes.EncryptedVideoBox.prototype=Object.create(q.boxes.VisualSampleEntryContainerBox.prototype),q.boxes.EncryptedVideoBox.prototype.constructor=q.boxes.EncryptedVideoBox,q.boxes.AVCConfigurationBox=function(a){q.boxes.Box.call(this,"avcC",a)},q.boxes.AVCConfigurationBox.prototype=Object.create(q.boxes.Box.prototype),q.boxes.AVCConfigurationBox.prototype.constructor=q.boxes.AVCConfigurationBox,q.boxes.AVCConfigurationBox.prototype.computeLength=function(){q.boxes.Box.prototype.computeLength.call(this),this.size+=4*q.fields.FIELD_UINT8.getLength()+3*q.fields.FIELD_UINT8.getLength(),this.size+=this._getNALLength(this.numOfSequenceParameterSets,this.SPS_NAL),this.size+=this._getNALLength(this.numOfPictureParameterSets,this.PPS_NAL)},q.boxes.AVCConfigurationBox.prototype._getNALLength=function(a,b){var c=0,d=0;for(d=0;a>d;d++)c+=q.fields.FIELD_UINT16.getLength()+b[d].NAL_length;return c},q.boxes.AVCConfigurationBox.prototype.read=function(a,b,c){return this.localPos=b,this.localEnd=c,this.configurationVersion=this._readData(a,q.fields.FIELD_UINT8),this.AVCProfileIndication=this._readData(a,q.fields.FIELD_UINT8),this.profile_compatibility=this._readData(a,q.fields.FIELD_UINT8),this.AVCLevelIndication=this._readData(a,q.fields.FIELD_UINT8),this.temp=this._readData(a,q.fields.FIELD_UINT8),this.lengthSizeMinusOne=3&this.temp,this.numOfSequenceParameterSets_tmp=this._readData(a,q.fields.FIELD_UINT8),this.numOfSequenceParameterSets=31&this.numOfSequenceParameterSets_tmp,this.SPS_NAL=this._readNAL(a,this.numOfSequenceParameterSets),this.numOfPictureParameterSets=this._readData(a,q.fields.FIELD_UINT8),this.PPS_NAL=this._readNAL(a,this.numOfPictureParameterSets),this.localPos},q.boxes.AVCConfigurationBox.prototype._readNAL=function(a,b){var c=[],d=0,e={};for(d=0;b>d;d++)e={},e.NAL_length=this._readData(a,q.fields.FIELD_UINT16),e.NAL=a.subarray(this.localPos,this.localPos+e.NAL_length),this.localPos+=e.NAL_length,c.push(e);return c},q.boxes.AVCConfigurationBox.prototype.write=function(a,b){return q.boxes.Box.prototype.write.call(this,a,b),this._writeData(a,q.fields.FIELD_UINT8,this.configurationVersion),this._writeData(a,q.fields.FIELD_UINT8,this.AVCProfileIndication),this._writeData(a,q.fields.FIELD_UINT8,this.profile_compatibility),this._writeData(a,q.fields.FIELD_UINT8,this.AVCLevelIndication),this.temp=252|this.lengthSizeMinusOne,this._writeData(a,q.fields.FIELD_UINT8,this.temp),this.numOfSequenceParameterSets=this.SPS_NAL.length,this.numOfSequenceParameterSets_tmp=224|this.numOfSequenceParameterSets,this._writeData(a,q.fields.FIELD_UINT8,this.numOfSequenceParameterSets_tmp),this._writeNAL(a,this.numOfSequenceParameterSets,this.SPS_NAL),this._writeData(a,q.fields.FIELD_UINT8,this.numOfPictureParameterSets),this._writeNAL(a,this.numOfPictureParameterSets,this.PPS_NAL),this.localPos},q.boxes.AVCConfigurationBox.prototype._writeNAL=function(a,b,c){var d=0;for(d=0;b>d;d++)this._writeData(a,q.fields.FIELD_UINT16,c[d].NAL_length),this._writeBuffer(a,c[d].NAL,c[d].NAL_length)},q.boxes.PixelAspectRatioBox=function(a){q.boxes.Box.call(this,"pasp",a)},q.boxes.PixelAspectRatioBox.prototype=Object.create(q.boxes.Box.prototype),q.boxes.PixelAspectRatioBox.prototype.constructor=q.boxes.PixelAspectRatioBox,q.boxes.PixelAspectRatioBox.prototype.computeLength=function(){q.boxes.Box.prototype.computeLength.call(this),this.size+=2*q.fields.FIELD_INT32.getLength()},q.boxes.PixelAspectRatioBox.prototype.read=function(a,b,c){return this.localPos=b,this.localEnd=c,this.hSpacing=this._readData(a,q.fields.FIELD_INT32),this.vSpacing=this._readData(a,q.fields.FIELD_INT32),this.localPos},q.boxes.PixelAspectRatioBox.prototype.write=function(a,b){return q.boxes.Box.prototype.write.call(this,a,b),this._writeData(a,q.fields.FIELD_INT32,this.hSpacing),this._writeData(a,q.fields.FIELD_INT32,this.vSpacing),this.localPos},q.boxes.AudioSampleEntryBox=function(a,b){q.boxes.SampleEntryBox.call(this,a,b)},q.boxes.AudioSampleEntryBox.prototype=Object.create(q.boxes.SampleEntryBox.prototype),q.boxes.AudioSampleEntryBox.prototype.constructor=q.boxes.AudioSampleEntryBox,q.boxes.AudioSampleEntryBox.prototype.computeLength=function(){q.boxes.SampleEntryBox.prototype.computeLength.call(this),this.size+=4*q.fields.FIELD_UINT16.getLength()+3*q.fields.FIELD_UINT32.getLength()},q.boxes.AudioSampleEntryBox.prototype.read=function(a,b,c){return q.boxes.SampleEntryBox.prototype.read.call(this,a,b,c),this.reserved_2=this._readArrayFieldData(a,q.fields.FIELD_UINT32,2),this.channelcount=this._readData(a,q.fields.FIELD_UINT16),this.samplesize=this._readData(a,q.fields.FIELD_UINT16),this.pre_defined=this._readData(a,q.fields.FIELD_UINT16),this.reserved_3=this._readData(a,q.fields.FIELD_UINT16),this.samplerate=this._readData(a,q.fields.FIELD_UINT32),this.localPos},q.boxes.AudioSampleEntryBox.prototype.write=function(a,b){return q.boxes.SampleEntryBox.prototype.write.call(this,a,b),this._writeArrayData(a,q.fields.FIELD_UINT32,this.reserved_2),this._writeData(a,q.fields.FIELD_UINT16,this.channelcount),this._writeData(a,q.fields.FIELD_UINT16,this.samplesize),this._writeData(a,q.fields.FIELD_UINT16,this.pre_defined),this._writeData(a,q.fields.FIELD_UINT16,this.reserved_3),this._writeData(a,q.fields.FIELD_UINT32,this.samplerate),this.localPos},q.boxes.AudioSampleEntryContainerBox=function(a,b){q.boxes.AudioSampleEntryBox.call(this,a,b),this.boxes=[]},q.boxes.AudioSampleEntryContainerBox.prototype=Object.create(q.boxes.AudioSampleEntryBox.prototype),q.boxes.AudioSampleEntryContainerBox.prototype.constructor=q.boxes.AudioSampleEntryContainerBox,q.boxes.AudioSampleEntryContainerBox.prototype.computeLength=function(){q.boxes.AudioSampleEntryBox.prototype.computeLength.call(this);var a=0;for(a=0;a<this.boxes.length;a++)this.boxes[a].computeLength(),this.size+=this.boxes[a].size},q.boxes.AudioSampleEntryContainerBox.prototype.read=function(a,b,c){q.boxes.AudioSampleEntryBox.prototype.read.call(this,a,b,c);for(var d,e,f=0,g=0,h=null;this.localPos<this.localEnd;){if(f=q.fields.FIELD_UINT32.read(a,this.localPos),d=q.fields.readString(a,this.localPos+4,4),"uuid"==d&&(g=1==f?16:8,h=new q.fields.ArrayField(q.fields.FIELD_INT8,16).read(a,this.localPos+g,this.localPos+g+16),h=JSON.stringify(h)),e=q.createBox(d,f,h),"uuid"===d?this.localPos=e.read(a,this.localPos+16*q.fields.FIELD_INT8.getLength()+8,this.localPos+f):this.localPos=e.read(a,this.localPos+8,this.localPos+f),q.debug&&(e.__sourceBuffer=a.subarray(this.localPos-e.size,this.localPos)),this.boxes.push(e),e.size<=0||null===e.size)throw new q.ParseException("Problem on size of box "+e.boxtype+", parsing stopped to avoid infinite loop");if(!e.boxtype)throw new q.ParseException("Problem on unknown box, parsing stopped to avoid infinite loop")}return this.localPos},q.boxes.AudioSampleEntryContainerBox.prototype.write=function(a,b){q.boxes.AudioSampleEntryBox.prototype.write.call(this,a,b);var c=0;for(c=0;c<this.boxes.length;c++)this.localPos=this.boxes[c].write(a,this.localPos);return this.localPos},q.boxes.MP4AudioSampleEntryBox=function(a){q.boxes.AudioSampleEntryContainerBox.call(this,"mp4a",a)},q.boxes.MP4AudioSampleEntryBox.prototype=Object.create(q.boxes.AudioSampleEntryContainerBox.prototype),q.boxes.MP4AudioSampleEntryBox.prototype.constructor=q.boxes.MP4AudioSampleEntryBox,q.boxes.EncryptedAudioBox=function(a){q.boxes.AudioSampleEntryContainerBox.call(this,"enca",a)},q.boxes.EncryptedAudioBox.prototype=Object.create(q.boxes.AudioSampleEntryContainerBox.prototype),q.boxes.EncryptedAudioBox.prototype.constructor=q.boxes.EncryptedAudioBox,q.boxes.ESDBox=function(a){q.boxes.FullBox.call(this,"esds",a)},q.boxes.ESDBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.ESDBox.prototype.constructor=q.boxes.ESDBox,q.boxes.ESDBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*q.fields.FIELD_UINT8.getLength()+this.ES_length},q.boxes.ESDBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),this.ES_tag=this._readData(a,q.fields.FIELD_UINT8),this.ES_length=this._readData(a,q.fields.FIELD_UINT8),this.ES_data=a.subarray(this.localPos,this.localPos+this.ES_length),this.localPos+=this.ES_length,this.localPos},q.boxes.ESDBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,q.fields.FIELD_UINT8,this.ES_tag),this._writeData(a,q.fields.FIELD_UINT8,this.ES_length),this._writeBuffer(a,this.ES_data,this.ES_length),this.localPos},q.boxes.SampleSizeBox=function(a){q.boxes.FullBox.call(this,"stsz",a)},q.boxes.SampleSizeBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.SampleSizeBox.prototype.constructor=q.boxes.SampleSizeBox,q.boxes.SampleSizeBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*q.fields.FIELD_UINT32.getLength()+q.fields.FIELD_UINT32.getLength()*this.sample_count},q.boxes.SampleSizeBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),this.sample_size=this._readData(a,q.fields.FIELD_UINT32),this.sample_count=this._readData(a,q.fields.FIELD_UINT32),this.entries=this._readArrayFieldData(a,q.fields.FIELD_UINT32,this.sample_count),this.localPos},q.boxes.SampleSizeBox.prototype.write=function(a,b){q.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,q.fields.FIELD_UINT32,this.sample_size),this._writeData(a,q.fields.FIELD_UINT32,this.sample_count),c=0;c<this.sample_count;c++)this._writeData(a,q.fields.FIELD_UINT32,this.entries[c]);return this.localPos},q.boxes.ProtectionSystemSpecificHeaderBox=function(a){q.boxes.FullBox.call(this,"pssh",a)},q.boxes.ProtectionSystemSpecificHeaderBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.ProtectionSystemSpecificHeaderBox.prototype.constructor=q.boxes.ProtectionSystemSpecificHeaderBox,q.boxes.ProtectionSystemSpecificHeaderBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=16*q.fields.FIELD_UINT8.getLength(),this.size+=q.fields.FIELD_UINT32.getLength(),this.size+=q.fields.FIELD_UINT8.getLength()*this.DataSize},q.boxes.ProtectionSystemSpecificHeaderBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),this.SystemID=this._readArrayFieldData(a,q.fields.FIELD_UINT8,16),this.DataSize=this._readData(a,q.fields.FIELD_UINT32),this.Data=this._readArrayFieldData(a,q.fields.FIELD_UINT8,this.DataSize),this.localPos},q.boxes.ProtectionSystemSpecificHeaderBox.prototype.write=function(a,b){q.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(c=0;16>c;c++)this._writeData(a,q.fields.FIELD_UINT8,this.SystemID[c]);for(this._writeData(a,q.fields.FIELD_UINT32,this.DataSize),c=0;c<this.DataSize;c++)this._writeData(a,q.fields.FIELD_UINT8,this.Data[c]);return this.localPos},q.boxes.SampleAuxiliaryInformationSizesBox=function(a){q.boxes.FullBox.call(this,"saiz",a)},q.boxes.SampleAuxiliaryInformationSizesBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.SampleAuxiliaryInformationSizesBox.prototype.constructor=q.boxes.SampleAuxiliaryInformationSizesBox,q.boxes.SampleAuxiliaryInformationSizesBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),1&this.flags&&(this.size+=2*q.fields.FIELD_UINT32.getLength()),this.size+=q.fields.FIELD_UINT8.getLength()+q.fields.FIELD_UINT32.getLength(),0===this.default_sample_info_size&&(this.size+=q.fields.FIELD_UINT8.getLength()*this.sample_count)},q.boxes.SampleAuxiliaryInformationSizesBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),1&this.flags&&(this.aux_info_type=this._readData(a,q.fields.FIELD_UINT32),this.aux_info_type_parameter=this._readData(a,q.fields.FIELD_UINT32)),this.default_sample_info_size=this._readData(a,q.fields.FIELD_UINT8),this.sample_count=this._readData(a,q.fields.FIELD_UINT32),0===this.default_sample_info_size&&(this.sample_info_size=this._readArrayFieldData(a,q.fields.FIELD_UINT8,this.sample_count)),this.localPos},q.boxes.SampleAuxiliaryInformationSizesBox.prototype.write=function(a,b){q.boxes.FullBox.prototype.write.call(this,a,b);var c=0;if(1&this.flags&&(this._writeData(a,q.fields.FIELD_UINT32,this.aux_info_type),this._writeData(a,q.fields.FIELD_UINT32,this.aux_info_type_parameter)),this._writeData(a,q.fields.FIELD_UINT8,this.default_sample_info_size),this._writeData(a,q.fields.FIELD_UINT32,this.sample_count),0===this.default_sample_info_size)for(c=0;c<this.sample_count;c++)this._writeData(a,q.fields.FIELD_UINT8,this.sample_info_size[c]);return this.localPos},q.boxes.SampleAuxiliaryInformationOffsetsBox=function(a){q.boxes.FullBox.call(this,"saio",a)},q.boxes.SampleAuxiliaryInformationOffsetsBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.SampleAuxiliaryInformationOffsetsBox.prototype.constructor=q.boxes.SampleAuxiliaryInformationOffsetsBox,q.boxes.SampleAuxiliaryInformationOffsetsBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),1&this.flags&&(this.size+=2*q.fields.FIELD_UINT32.getLength()),this.size+=q.fields.FIELD_UINT32.getLength(),0===this.version?this.size+=q.fields.FIELD_UINT32.getLength()*this.entry_count:this.size+=q.fields.FIELD_UINT64.getLength()*this.entry_count},q.boxes.SampleAuxiliaryInformationOffsetsBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),1&this.flags&&(this.aux_info_type=this._readData(a,q.fields.FIELD_UINT32),this.aux_info_type_parameter=this._readData(a,q.fields.FIELD_UINT32)),this.entry_count=this._readData(a,q.fields.FIELD_UINT32),0===this.version?this.offset=this._readArrayFieldData(a,q.fields.FIELD_UINT32,this.entry_count):this.offset=this._readArrayFieldData(a,q.fields.FIELD_UINT64,this.entry_count),this.localPos},q.boxes.SampleAuxiliaryInformationOffsetsBox.prototype.write=function(a,b){q.boxes.FullBox.prototype.write.call(this,a,b);var c=0;if(1&this.flags&&(this._writeData(a,q.fields.FIELD_UINT32,this.aux_info_type),this._writeData(a,q.fields.FIELD_UINT32,this.aux_info_type_parameter)),this._writeData(a,q.fields.FIELD_UINT32,this.entry_count),
0===this.version)for(c=0;c<this.entry_count;c++)this._writeData(a,q.fields.FIELD_UINT32,this.offset[c]);else for(c=0;c<this.entry_count;c++)this._writeData(a,q.fields.FIELD_UINT64,this.offset[c]);return this.localPos},q.boxes.ProtectionSchemeInformationBox=function(a){q.boxes.ContainerBox.call(this,"sinf",a)},q.boxes.ProtectionSchemeInformationBox.prototype=Object.create(q.boxes.ContainerBox.prototype),q.boxes.ProtectionSchemeInformationBox.prototype.constructor=q.boxes.ProtectionSchemeInformationBox,q.boxes.SchemeInformationBox=function(a){q.boxes.ContainerBox.call(this,"schi",a)},q.boxes.SchemeInformationBox.prototype=Object.create(q.boxes.ContainerBox.prototype),q.boxes.SchemeInformationBox.prototype.constructor=q.boxes.SchemeInformationBox,q.boxes.TrackEncryptionBox=function(a){q.boxes.FullBox.call(this,"tenc",a)},q.boxes.TrackEncryptionBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.TrackEncryptionBox.prototype.constructor=q.boxes.TrackEncryptionBox,q.boxes.TrackEncryptionBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=q.fields.FIELD_BIT24.getLength(),this.size+=q.fields.FIELD_UINT8.getLength(),this.size+=16*q.fields.FIELD_UINT8.getLength()},q.boxes.TrackEncryptionBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),this.default_IsEncrypted=this._readData(a,q.fields.FIELD_BIT24),this.default_IV_size=this._readData(a,q.fields.FIELD_UINT8),this.default_KID=this._readArrayFieldData(a,q.fields.FIELD_UINT8,16),this.localPos},q.boxes.TrackEncryptionBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,q.fields.FIELD_BIT24,this.default_IsEncrypted),this._writeData(a,q.fields.FIELD_UINT8,this.default_IV_size),this._writeArrayData(a,q.fields.FIELD_UINT8,this.default_KID),this.localPos},q.boxes.SchemeTypeBox=function(a){q.boxes.FullBox.call(this,"schm",a)},q.boxes.SchemeTypeBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.SchemeTypeBox.prototype.constructor=q.boxes.SchemeTypeBox,q.boxes.SchemeTypeBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*q.fields.FIELD_UINT32.getLength(),1&this.flags&&(this.size+=q.fields.FIELD_STRING.getLength(this.scheme_uri))},q.boxes.SchemeTypeBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),this.scheme_type=this._readData(a,q.fields.FIELD_UINT32),this.scheme_version=this._readData(a,q.fields.FIELD_UINT32),1&this.flags&&(this.scheme_uri=this._readData(a,q.fields.FIELD_STRING)),this.localPos},q.boxes.SchemeTypeBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,q.fields.FIELD_UINT32,this.scheme_type),this._writeData(a,q.fields.FIELD_UINT32,this.scheme_version),1&this.flags&&this._writeData(a,q.fields.FIELD_STRING,this.scheme_uri),this.localPos},q.boxes.EditListBox=function(a){q.boxes.FullBox.call(this,"elst",a),this.entries=[]},q.boxes.EditListBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.EditListBox.prototype.constructor=q.boxes.EditListBox,q.boxes.EditListBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=q.fields.FIELD_UINT32.getLength(),1===this.version?this.size+=(2*q.fields.FIELD_UINT64.getLength()+2*q.fields.FIELD_UINT16.getLength())*this.entry_count:this.size+=(2*q.fields.FIELD_UINT32.getLength()+2*q.fields.FIELD_UINT16.getLength())*this.entry_count},q.boxes.EditListBox.prototype.read=function(a,b,c){q.boxes.FullBox.prototype.read.call(this,a,b,c);var d=0,e={};for(this.entry_count=this._readData(a,q.fields.FIELD_UINT32),d=0;d<this.entry_count;d++)e={},1===this.version?(e.segment_duration=this._readData(a,q.fields.FIELD_UINT64),e.media_time=this._readData(a,q.fields.FIELD_UINT64)):(e.segment_duration=this._readData(a,q.fields.FIELD_UINT32),e.media_time=this._readData(a,q.fields.FIELD_UINT32)),e.media_rate_integer=this._readData(a,q.fields.FIELD_UINT16),e.media_rate_fraction=this._readData(a,q.fields.FIELD_UINT16),this.entries.push(e);return this.localPos},q.boxes.EditListBox.prototype.write=function(a,b){q.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,q.fields.FIELD_UINT32,this.entry_count),c=0;c<this.entry_count;c++)1===this.version?(this._writeData(a,q.fields.FIELD_UINT64,this.entries[c].segment_duration),this._writeData(a,q.fields.FIELD_UINT64,this.entries[c].media_time)):(this._writeData(a,q.fields.FIELD_UINT32,this.entries[c].segment_duration),this._writeData(a,q.fields.FIELD_UINT32,this.entries[c].media_time)),this._writeData(a,q.fields.FIELD_UINT16,this.entries[c].media_rate_integer),this._writeData(a,q.fields.FIELD_UINT16,this.entries[c].media_rate_fraction);return this.localPos},q.boxes.HintMediaHeaderBox=function(a){q.boxes.FullBox.call(this,"hmhd",a)},q.boxes.HintMediaHeaderBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.HintMediaHeaderBox.prototype.constructor=q.boxes.HintMediaHeaderBox,q.boxes.HintMediaHeaderBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*q.fields.FIELD_UINT16.getLength(),this.size+=3*q.fields.FIELD_UINT32.getLength()},q.boxes.HintMediaHeaderBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),this.maxPDUsize=this._readData(a,q.fields.FIELD_UINT16),this.avgPDUsize=this._readData(a,q.fields.FIELD_UINT16),this.maxbitrate=this._readData(a,q.fields.FIELD_UINT32),this.avgbitrate=this._readData(a,q.fields.FIELD_UINT32),this.reserved=this._readData(a,q.fields.FIELD_UINT32),this.localPos},q.boxes.HintMediaHeaderBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,q.fields.FIELD_UINT16,this.maxPDUsize),this._writeData(a,q.fields.FIELD_UINT16,this.avgPDUsize),this._writeData(a,q.fields.FIELD_UINT32,this.maxbitrate),this._writeData(a,q.fields.FIELD_UINT32,this.avgbitrate),this._writeData(a,q.fields.FIELD_UINT32,this.reserved),this.localPos},q.boxes.NullMediaHeaderBox=function(a){q.boxes.FullBox.call(this,"nmhd",a)},q.boxes.NullMediaHeaderBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.NullMediaHeaderBox.prototype.constructor=q.boxes.NullMediaHeaderBox,q.boxes.CompositionOffsetBox=function(a){q.boxes.FullBox.call(this,"ctts",a),this.entries=[]},q.boxes.CompositionOffsetBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.CompositionOffsetBox.prototype.constructor=q.boxes.CompositionOffsetBox,q.boxes.CompositionOffsetBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=q.fields.FIELD_UINT32.getLength(),0===this.version?this.size+=2*q.fields.FIELD_UINT32.getLength()*this.entry_count:this.size+=(q.fields.FIELD_UINT32.getLength()+q.fields.FIELD_INT32.getLength())*this.entry_count},q.boxes.CompositionOffsetBox.prototype.read=function(a,b,c){q.boxes.FullBox.prototype.read.call(this,a,b,c);var d=0,e={};for(this.entry_count=this._readData(a,q.fields.FIELD_UINT32),d=0;d<this.entry_count;d++)e={},0===this.version?(e.sample_count=this._readData(a,q.fields.FIELD_UINT32),e.sample_offset=this._readData(a,q.fields.FIELD_UINT32)):(e.sample_count=this._readData(a,q.fields.FIELD_UINT32),e.sample_offset=this._readData(a,q.fields.FIELD_INT32)),this.entries.push(e);return this.localPos},q.boxes.CompositionOffsetBox.prototype.write=function(a,b){q.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,q.fields.FIELD_UINT32,this.entry_count),c=0;c<this.entry_count;c++)0===this.version?(this._writeData(a,q.fields.FIELD_UINT32,this.entries[c].sample_count),this._writeData(a,q.fields.FIELD_UINT32,this.entries[c].sample_offset)):(this._writeData(a,q.fields.FIELD_UINT32,this.entries[c].sample_count),this._writeData(a,q.fields.FIELD_INT32,this.entries[c].sample_offset));return this.localPos},q.boxes.CompositionToDecodeBox=function(a){q.boxes.FullBox.call(this,"cslg",a)},q.boxes.CompositionToDecodeBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.CompositionToDecodeBox.prototype.constructor=q.boxes.CompositionToDecodeBox,q.boxes.CompositionToDecodeBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=5*q.fields.FIELD_INT32.getLength()},q.boxes.CompositionToDecodeBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),this.compositionToDTSShift=this._readData(a,q.fields.FIELD_INT32),this.leastDecodeToDisplayDelta=this._readData(a,q.fields.FIELD_INT32),this.greatestDecodeToDisplayDelta=this._readData(a,q.fields.FIELD_INT32),this.compositionStartTime=this._readData(a,q.fields.FIELD_INT32),this.compositionEndTime=this._readData(a,q.fields.FIELD_INT32),this.localPos},q.boxes.CompositionToDecodeBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),this._writeData(a,q.fields.FIELD_INT32,this.compositionToDTSShift),this._writeData(a,q.fields.FIELD_INT32,this.leastDecodeToDisplayDelta),this._writeData(a,q.fields.FIELD_INT32,this.greatestDecodeToDisplayDelta),this._writeData(a,q.fields.FIELD_INT32,this.compositionStartTime),this._writeData(a,q.fields.FIELD_INT32,this.compositionEndTime),this.localPos},q.boxes.SyncSampleBox=function(a){q.boxes.FullBox.call(this,"stss",a),this.entries=[]},q.boxes.SyncSampleBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.SyncSampleBox.prototype.constructor=q.boxes.SyncSampleBox,q.boxes.SyncSampleBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=q.fields.FIELD_UINT32.getLength(),this.size+=q.fields.FIELD_UINT32.getLength()*this.entry_count},q.boxes.SyncSampleBox.prototype.read=function(a,b,c){q.boxes.FullBox.prototype.read.call(this,a,b,c);var d=0,e={};for(this.entry_count=this._readData(a,q.fields.FIELD_UINT32),d=0;d<this.entry_count;d++)e={},e.sample_number=this._readData(a,q.fields.FIELD_UINT32),this.entries.push(e);return this.localPos},q.boxes.SyncSampleBox.prototype.write=function(a,b){q.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,q.fields.FIELD_UINT32,this.entry_count),c=0;c<this.entry_count;c++)this._writeData(a,q.fields.FIELD_UINT32,this.entries[c].sample_number);return this.localPos},q.boxes.TrackReferenceBox=function(a){q.boxes.FullBox.call(this,"tref",a)},q.boxes.TrackReferenceBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.TrackReferenceBox.prototype.constructor=q.boxes.TrackReferenceBox,q.boxes.TrackReferenceBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=q.fields.FIELD_UINT32.getLength()*this.track_IDs.length},q.boxes.TrackReferenceBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),this.track_IDs=this._readArrayData(a,q.fields.FIELD_UINT32),this.localPos},q.boxes.TrackReferenceBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),this._writeArrayData(a,q.fields.FIELD_UINT32,this.track_IDs),this.localPos},q.boxes.OriginalFormatBox=function(a){q.boxes.Box.call(this,"frma",a)},q.boxes.OriginalFormatBox.prototype=Object.create(q.boxes.Box.prototype),q.boxes.OriginalFormatBox.prototype.constructor=q.boxes.OriginalFormatBox,q.boxes.OriginalFormatBox.prototype.computeLength=function(){q.boxes.Box.prototype.computeLength.call(this),this.size+=q.fields.FIELD_UINT32.getLength()},q.boxes.OriginalFormatBox.prototype.read=function(a,b,c){return this.localPos=b,this.localEnd=c,this.data_format=this._readData(a,q.fields.FIELD_UINT32),this.localPos},q.boxes.OriginalFormatBox.prototype.write=function(a,b){return q.boxes.Box.prototype.write.call(this,a,b),this._writeData(a,q.fields.FIELD_UINT32,this.data_format),this.localPos},q.boxes.PiffSampleEncryptionBox=function(a){q.boxes.FullBox.call(this,"sepiff",a,[162,57,79,82,90,155,79,20,162,68,108,66,124,100,141,244])},q.boxes.PiffSampleEncryptionBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.PiffSampleEncryptionBox.prototype.constructor=q.boxes.PiffSampleEncryptionBox,q.boxes.PiffSampleEncryptionBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this);var a=0,b=0;for(this.size+=q.fields.FIELD_UINT32.getLength(),1&this.flags&&(this.size+=q.fields.FIELD_UINT8.getLength()),a=0;a<this.sample_count;a++)if(this.size+=8,2&this.flags)for(this.size+=q.fields.FIELD_UINT16.getLength(),b=0;b<this.entry[a].NumberOfEntries;b++)this.size+=q.fields.FIELD_UINT16.getLength(),this.size+=q.fields.FIELD_UINT32.getLength()},q.boxes.PiffSampleEncryptionBox.prototype.write=function(a,b){q.boxes.FullBox.prototype.write.call(this,a,b);var c=0,d=0;for(this._writeData(a,q.fields.FIELD_UINT32,this.sample_count),1&this.flags&&this._writeData(a,q.fields.FIELD_UINT8,this.IV_size),c=0;c<this.sample_count;c++)if(this._writeBuffer(a,this.entry[c].InitializationVector,8),2&this.flags)for(this._writeData(a,q.fields.FIELD_UINT16,this.entry[c].NumberOfEntries),d=0;d<this.entry[c].NumberOfEntries;d++)this._writeData(a,q.fields.FIELD_UINT16,this.entry[c].clearAndCryptedData[d].BytesOfClearData),this._writeData(a,q.fields.FIELD_UINT32,this.entry[c].clearAndCryptedData[d].BytesOfEncryptedData);return this.localPos},q.boxes.PiffSampleEncryptionBox.prototype.read=function(a,b,c){q.boxes.FullBox.prototype.read.call(this,a,b,c);var d=0,e=0,f={},g={};for(this.sample_count=this._readData(a,q.fields.FIELD_UINT32),1&this.flags&&(this.IV_size=this._readData(a,q.fields.FIELD_UINT8)),this.entry=[],d=0;d<this.sample_count;d++){if(g={},g.InitializationVector=a.subarray(this.localPos,this.localPos+8),this.localPos+=8,2&this.flags)for(g.NumberOfEntries=this._readData(a,q.fields.FIELD_UINT16),g.clearAndCryptedData=[],e=0;e<g.NumberOfEntries;e++)f={},f.BytesOfClearData=this._readData(a,q.fields.FIELD_UINT16),f.BytesOfEncryptedData=this._readData(a,q.fields.FIELD_UINT32),g.clearAndCryptedData.push(f);this.entry.push(g)}return this.localPos},q.boxes.PiffTrackEncryptionBox=function(a){q.boxes.FullBox.call(this,"tepiff",a,[137,116,219,206,123,231,76,81,132,249,113,72,249,136,37,84])},q.boxes.PiffTrackEncryptionBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.PiffTrackEncryptionBox.prototype.constructor=q.boxes.PiffTrackEncryptionBox,q.boxes.PiffProtectionSystemSpecificHeaderBox=function(a){q.boxes.FullBox.call(this,"psshpiff",a,[208,138,79,24,16,243,74,130,182,200,50,216,171,161,131,211])},q.boxes.PiffProtectionSystemSpecificHeaderBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.PiffProtectionSystemSpecificHeaderBox.prototype.constructor=q.boxes.PiffProtectionSystemSpecificHeaderBox,q.boxes.TfxdBox=function(a){q.boxes.FullBox.call(this,"tfxd",a,[109,29,155,5,66,213,68,230,128,226,20,29,175,247,87,178])},q.boxes.TfxdBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.TfxdBox.prototype.constructor=q.boxes.TfxdBox,q.boxes.TfxdBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),1===this.version?this.size+=2*q.fields.FIELD_UINT64.getLength():this.size+=2*q.fields.FIELD_UINT32.getLength()},q.boxes.TfxdBox.prototype.write=function(a,b){return q.boxes.FullBox.prototype.write.call(this,a,b),1===this.version?(this._writeData(a,q.fields.FIELD_UINT64,this.fragment_absolute_time),this._writeData(a,q.fields.FIELD_UINT64,this.fragment_duration)):(this._writeData(a,q.fields.FIELD_UINT32,this.fragment_absolute_time),this._writeData(a,q.fields.FIELD_UINT32,this.fragment_duration)),this.localPos},q.boxes.TfxdBox.prototype.read=function(a,b,c){return q.boxes.FullBox.prototype.read.call(this,a,b,c),1===this.version?(this.fragment_absolute_time=this._readData(a,q.fields.FIELD_UINT64),this.fragment_duration=this._readData(a,q.fields.FIELD_UINT64)):(this.fragment_absolute_time=this._readData(a,q.fields.FIELD_UINT32),this.fragment_duration=this._readData(a,q.fields.FIELD_UINT32)),this.localPos},q.boxes.TfrfBox=function(a){q.boxes.FullBox.call(this,"tfrf",a,[212,128,126,242,202,57,70,149,142,84,38,203,158,70,167,159])},q.boxes.TfrfBox.prototype=Object.create(q.boxes.FullBox.prototype),q.boxes.TfrfBox.prototype.constructor=q.boxes.TfrfBox,q.boxes.TfrfBox.prototype.computeLength=function(){q.boxes.FullBox.prototype.computeLength.call(this),this.size+=q.fields.FIELD_UINT8.getLength(),1===this.version?this.size+=2*q.fields.FIELD_UINT64.getLength()*this.fragment_count:this.size+=2*q.fields.FIELD_UINT32.getLength()*this.fragment_count},q.boxes.TfrfBox.prototype.write=function(a,b){q.boxes.FullBox.prototype.write.call(this,a,b);var c=0;for(this._writeData(a,q.fields.FIELD_UINT8,this.fragment_count),c=0;c<this.fragment_count;c++)1===this.version?(this._writeData(a,q.fields.FIELD_UINT64,this.entry[c].fragment_absolute_time),this._writeData(a,q.fields.FIELD_UINT64,this.entry[c].fragment_duration)):(this._writeData(a,q.fields.FIELD_UINT32,this.entry[c].fragment_absolute_time),this._writeData(a,q.fields.FIELD_UINT32,this.entry[c].fragment_duration));return this.localPos},q.boxes.TfrfBox.prototype.read=function(a,b,c){q.boxes.FullBox.prototype.read.call(this,a,b,c);var d=0,e={};for(this.fragment_count=this._readData(a,q.fields.FIELD_UINT8),this.entry=[],d=0;d<this.fragment_count;d++)e={},1===this.version?(e.fragment_absolute_time=this._readData(a,q.fields.FIELD_UINT64),e.fragment_duration=this._readData(a,q.fields.FIELD_UINT64)):(e.fragment_absolute_time=this._readData(a,q.fields.FIELD_UINT32),e.fragment_duration=this._readData(a,q.fields.FIELD_UINT32)),this.entry.push(e);return this.localPos},q.registerTypeBoxes(),q.fields.readBytes=function(a,b,c){var d=0,e=0;for(e=0;c>e;e++)d<<=8,d+=a[b],b++;return d},q.fields.writeBytes=function(a,b,c,d){var e=0;for(e=0;c>e;e++)a[b+c-e-1]=255&d,d>>=8},q.fields.readString=function(a,b,c){var d,e="";for(d=b;b+c>d;d++)e+=String.fromCharCode(a[d]);return e},q.fields.NumberField=function(a,b){this.bits=a,this.signed=b},q.fields.NumberField.prototype.read=function(a,b){return q.fields.readBytes(a,b,this.bits/8)},q.fields.NumberField.prototype.write=function(a,b,c){q.fields.writeBytes(a,b,this.bits/8,c)},q.fields.NumberField.prototype.getLength=function(){return this.bits/8},q.fields.LongNumberField=function(){},q.fields.LongNumberField.prototype.read=function(a,b){var c=q.fields.readBytes(a,b,4),d=q.fields.readBytes(a,b+4,4);return e.math.Long.fromBits(d,c).toNumber()},q.fields.LongNumberField.prototype.write=function(a,b,c){var d=e.math.Long.fromNumber(c),f=d.getLowBits(),g=d.getHighBits();q.fields.writeBytes(a,b,4,g),q.fields.writeBytes(a,b+4,4,f)},q.fields.LongNumberField.prototype.getLength=function(){return 8},q.fields.FixedLenStringField=function(a){this.size=a},q.fields.FixedLenStringField.prototype.read=function(a,b){var c="",d=0;for(d=0;d<this.size;d++)c+=String.fromCharCode(a[b+d]);return c},q.fields.FixedLenStringField.prototype.write=function(a,b,c){var d=0;for(d=0;d<this.size;d++)a[b+d]=c.charCodeAt(d)},q.fields.FixedLenStringField.prototype.getLength=function(){return this.size},q.fields.BoxTypeField=function(){},q.fields.BoxTypeField.prototype.read=function(a,b){var c="",d=0;for(d=0;4>d;d++)c+=String.fromCharCode(a[b+d]);return c},q.fields.BoxTypeField.prototype.write=function(a,b,c){var d=0;for(d=0;4>d;d++)a[b+d]=c.charCodeAt(d)},q.fields.BoxTypeField.prototype.getLength=function(){return 4},q.fields.StringField=function(){},q.fields.StringField.prototype.read=function(a,b,c){var d="",e=0;for(e=b;c>e;e++)if(d+=String.fromCharCode(a[e]),0===a[e])return d;if(255>c-b&&a[0]==String.fromCharCode(c-b))return d=d.substr(1,c-b),q.warningHandler('null-terminated string expected, but found a string "'+d+'", which seems to be length-prefixed instead. Conversion done.'),d;throw new q.ParseException('expected null-terminated string, but end of field reached without termination. Read so far:"'+d+'"')},q.fields.StringField.prototype.write=function(a,b,c){var d=0;for(d=0;d<c.length;d++)a[b+d]=c.charCodeAt(d);a[b+c.length]=0},q.fields.StringField.prototype.getLength=function(a){return a.length},q.fields.ArrayField=function(a,b){this.innerField=a,this.size=b},q.fields.ArrayField.prototype.read=function(a,b){var c=-1,d=[],e=0;for(e=0;e<this.size;e++)d.push(this.innerField.read(a,b)),-1==c&&(c=this.innerField.getLength(d[e])),b+=c;return d},q.fields.FIELD_INT8=new q.fields.NumberField(8,!0),q.fields.FIELD_INT16=new q.fields.NumberField(16,!0),q.fields.FIELD_INT32=new q.fields.NumberField(32,!0),q.fields.FIELD_INT64=new q.fields.LongNumberField,q.fields.FIELD_UINT8=new q.fields.NumberField(8,!1),q.fields.FIELD_UINT16=new q.fields.NumberField(16,!1),q.fields.FIELD_UINT32=new q.fields.NumberField(32,!1),q.fields.FIELD_UINT64=new q.fields.LongNumberField,q.fields.FIELD_BIT8=new q.fields.NumberField(8,!1),q.fields.FIELD_BIT16=new q.fields.NumberField(16,!1),q.fields.FIELD_BIT24=new q.fields.NumberField(24,!1),q.fields.FIELD_BIT32=new q.fields.NumberField(32,!1),q.fields.FIELD_ID=new q.fields.BoxTypeField(4),q.fields.FIELD_STRING=new q.fields.StringField;var r=function(){return{pes:{},si:{},binary:{},ts:{},Pts:{},aac:{},h264:{}}}();"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=r:window.mpegts=r,r.aac.SAMPLING_FREQUENCY=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],r.aac.getAudioSpecificConfig=function(a){var b=r.binary.getValueFromByte(a[2],0,2),c=r.binary.getValueFromByte(a[2],2,4),d=r.binary.getValueFrom2Bytes(a.subarray(2,5),7,3),e=new Uint8Array(2);return e[0]=b+1<<3,e[0]|=(14&c)>>1,e[1]|=(1&c)<<7,e[1]|=d<<3,e},r.aac.parseADTS=function(a,b){for(var c,d,e=[],f={},g=0;g<a.length;)d=g,f.syncword=(a[g]<<4)+((240&a[g+1])>>4),f.protection_absent=1&a[g+1],f.sampling_frequency_index=(60&a[g+2])>>2,f.channel_configuration=((1&a[g+2])<<1)+((192&a[g+3])>>6),f.aac_frame_length=((3&a[g+3])<<11)+(a[g+4]<<3)+((224&a[g+5])>>5),f.number_of_raw_data_blocks_in_frame=(3&a[g+6])>>2,g+=7,0===f.number_of_raw_data_blocks_in_frame&&(0===f.protection_absent&&(g+=2),c={},c.offset=g,c.length=f.aac_frame_length-(g-d),b&&b[d]&&(c.cts=b[d]),e.push(c),g+=c.length);return e},r.ts.AdaptationField=function(){this.m_cAFLength=null,this.m_bDiscontinuityInd=null,this.m_bRAI=null,this.m_bESPriority=null,this.m_bPCRFlag=null,this.m_bOPCRFlag=null,this.m_bSplicingPointFlag=null,this.m_bPrivateDataFlag=null,this.m_bAdaptationFieldExtFlag=null},r.ts.AdaptationField.prototype.getLength=function(){return this.m_cAFLength+1},r.ts.AdaptationField.prototype.parse=function(a){if(this.m_cAFLength=a[0],0!==this.m_cAFLength){var b=1;this.m_bDiscontinuityInd=r.binary.getBitFromByte(a[b],0),this.m_bRAI=r.binary.getBitFromByte(a[b],1),this.m_bESPriority=r.binary.getBitFromByte(a[b],2),this.m_bPCRFlag=r.binary.getBitFromByte(a[b],3),this.m_bOPCRFlag=r.binary.getBitFromByte(a[b],4),this.m_bSplicingPointFlag=r.binary.getBitFromByte(a[b],5),this.m_bPrivateDataFlag=r.binary.getBitFromByte(a[b],6),this.m_bAdaptationFieldExtFlag=r.binary.getBitFromByte(a[b],7)}},r.binary.readBytes=function(a,b,c){for(var d=0,e=0;c>e;e++)d<<=8,d+=a[b],b++;return d},r.binary.getBitFromByte=function(a,b){var c=0;return c+=1<<7-b,0!==(a&c)},r.binary.getValueFrom3Bytes=function(a,b,c){"undefined"==typeof c&&(c=-1),"undefined"==typeof b&&(b=0);var d=-1==c?-1:c-(16-b),e=-1==c?0:8-d,f=r.binary.getValueFromByte(a[0],b),g=r.binary.getValueFromByte(a[1]),h=r.binary.getValueFromByte(a[2],0,d,!1);return(f<<16&16711680|g<<8&65280|255&h)>>e},r.binary.getValueFrom2Bytes=function(a,b,c){"undefined"==typeof c&&(c=-1),"undefined"==typeof b&&(b=0);var d=-1==c?-1:c-(8-b),e=-1==c?0:8-d,f=r.binary.getValueFromByte(a[0],b),g=r.binary.getValueFromByte(a[1],0,d,!1);return(f<<8&65280|255&g)>>e},r.binary.getValueFromByte=function(a,b,c,d){var e=0,f=0;"undefined"==typeof c&&(c=-1),"undefined"==typeof b&&(b=0);var g=-1==c?7:b+c-1;for(f=b;g>=f;f++)e+=1<<7-f;var h=a&e;return(d||"undefined"==typeof d)&&(h>>=7-g),h},r.h264.getSequenceHeader=function(a){for(var b,c=-1,d=-1,e=0,f=null,g=0,h=0;e<a.length;)if(0===a[e]&&0===a[e+1]&&0===a[e+2]&&1===a[e+3]){if(b=31&a[e+4],b>=r.h264.NALUTYPE_SPS&&b<=r.h264.NALUTYPE_PPS){if(-1===c&&(c=e),b===r.h264.NALUTYPE_SPS){var i=r.h264.parseSPS(a.subarray(e+5));g=i.pic_width_in_mbs_minus1+1<<4,h=i.pic_height_in_map_units_minus1+1<<4}}else c>0&&(d=e-c);if(b===r.h264.NALUTYPE_IDR||b===r.h264.NALUTYPE_NONIDR)break;e+=4}else{if(0===a[e]&&0===a[e+1]&&1===a[e+2]){c>0&&(d=e-c);break}e++}return-1===c||-1===d?null:(f=new Uint8Array(d),f.set(a.subarray(c,c+d)),{bytes:f,width:g,height:h})},r.h264.read_ue=function(a,b){var c=1,d=0,e=0;for(b._bit=b._byte>>b._bitPos&1,b._bitPos--,b._bitPos<0&&(b._byte=a[b._bytePos],b._bytePos++,b._bitPos=7);0===b._bit;)e++,c<<=1,b._bit=b._byte>>b._bitPos&1,b._bitPos--,b._bitPos<0&&(b._byte=a[b._bytePos],b._bytePos++,b._bitPos=7);if(c-=1,d=0,e)for(;e>0;)b._bit=b._byte>>b._bitPos&1,b._bitPos--,d=(d<<1)+b._bit,e--,b._bitPos<0&&(b._byte=a[b._bytePos],b._bytePos++,b._bitPos=7);return c+=d},r.h264.read_flag=function(a,b){var c=0;return b._bit=b._byte>>b._bitPos&1,b._bitPos--,b._bitPos<0&&(b._byte=a[b._bytePos],b._bytePos++,b._bitPos=7),c=b._bit},r.h264.parseSPS=function(a){var b={profile_idc:0,constraint_set0_flag:0,constraint_set1_flag:0,constraint_set2_flag:0,constraint_set3_flag:0,level_idc:0,seq_parameter_set_id:0,chroma_format_idc:0,separate_colour_plane_flag:0,bit_depth_luma_minus8:0,bit_depth_chroma_minus8:0,qpprime_y_zero_transform_bypass_flag:0,seq_scaling_matrix_present_flag:0,log2_max_frame_num_minus4:0,pic_order_cnt_type:0,log2_max_pic_order_cnt_lsb_minus4:0,num_ref_frames:0,gaps_in_frame_num_value_allowed_flag:0,pic_width_in_mbs_minus1:0,pic_height_in_map_units_minus1:0},c={_byte:0,_bit:0,_bytePos:0,_bitPos:0};return c._bytePos=c._bitPos=0,c._byte=a[c._bytePos],c._bytePos++,b.profile_idc=c._byte,c._byte=a[c._bytePos],c._bytePos++,b.constraint_set0_flag=(128&c._byte)>>7,b.constraint_set1_flag=(64&c._byte)>>6,b.constraint_set2_flag=(32&c._byte)>>5,b.constraint_set3_flag=(16&c._byte)>>4,c._byte=a[c._bytePos],c._bytePos++,b.level_idc=c._byte,c._bitPos=7,b.seq_parameter_set_id=r.h264.read_ue(a,c),(100==b.profileIdc||110==b.profileIdc||122==b.profileIdc||244==b.profileIdc||44==b.profileIdc||83==b.profileIdc||86==b.profileIdc)&&(b.chroma_format_idc=r.h264.read_ue(a,c),3===b.chroma_format_idc&&(b.separate_colour_plane_flag=r.h264.read_flag(a,c)),b.bit_depth_luma_minus8=r.h264.read_ue(a,c),b.bit_depth_chroma_minus8=r.h264.read_ue(a,c),b.qpprime_y_zero_transform_bypass_flag=r.h264.read_flag(a,c),b.seq_scaling_matrix_present_flag=r.h264.read_flag(a,c),1===b.seq_scaling_matrix_present_flag),b.log2_max_frame_num_minus4=r.h264.read_ue(a,c),b.pic_order_cnt_type=r.h264.read_ue(a,c),0===b.pic_order_cnt_type?b.log2_max_pic_order_cnt_lsb_minus4=r.h264.read_ue(a,c):1===b.pic_order_cnt_type,b.num_ref_frames=r.h264.read_ue(a,c),b.gaps_in_frame_num_value_allowed_flag=r.h264.read_flag(a,c),b.pic_width_in_mbs_minus1=r.h264.read_ue(a,c),b.pic_height_in_map_units_minus1=r.h264.read_ue(a,c),b},r.h264.bytestreamToMp4=function(a){for(var b=0,c=a.length,d=-1,e=0;c>b;)0===a[b]&&0===a[b+1]&&0===a[b+2]&&1===a[b+3]?(d>=0&&(e=b-d-4,a[d]=(4278190080&e)>>24,a[d+1]=(16711680&e)>>16,a[d+2]=(65280&e)>>8,a[d+3]=255&e),d=b,b+=4):b++;e=b-d-4,a[d]=(4278190080&e)>>24,a[d+1]=(16711680&e)>>16,a[d+2]=(65280&e)>>8,a[d+3]=255&e},r.h264.isIDR=function(a){for(var b,c=0;c<a.length;)if(0===a[c]&&0===a[c+1]&&0===a[c+2]&&1===a[c+3]){if(b=31&a[c+4],b===r.h264.NALUTYPE_IDR)return!0;c+=4}else c++;return!1},r.h264.NALUTYPE_NONIDR=1,r.h264.NALUTYPE_IDR=5,r.h264.NALUTYPE_SEI=6,r.h264.NALUTYPE_SPS=7,r.h264.NALUTYPE_PPS=8,r.h264.NALUTYPE_AU_DELIMITER=9,r.si.PSISection=function(a){this.m_table_id=a,this.m_section_syntax_indicator=1,this.m_section_length=r.si.PSISection.prototype.SECTION_LENGTH,this.m_transport_stream_id=0,this.m_version_number=0,this.m_current_next_indicator=!0,this.m_section_number=0,this.m_last_section_number=0,this.m_bValid=null},r.si.PSISection.prototype.parse=function(a){this.m_bValid=!1;var b=0,c=a[b];return b=0===c?b+1:b+c,this.m_table_id=a[b],b++,this.m_section_syntax_indicator=r.binary.getBitFromByte(a[b],0),this.m_section_length=r.binary.getValueFrom2Bytes(a.subarray(b,b+2),4),b+=2,this.m_transport_stream_id=r.binary.getValueFrom2Bytes(a.subarray(b,b+2)),b+=2,this.m_version_number=r.binary.getValueFromByte(a[b],2,5),this.m_current_next_indicator=r.binary.getBitFromByte(a[b],7),b++,this.m_section_number=a[b],b++,this.m_last_section_number=a[b],this.m_bValid=!0,b},r.si.PSISection.prototype.getSectionLength=function(){return this.m_section_length},r.si.PSISection.prototype.SECTION_LENGTH=9,r.si.PSISection.prototype.HEADER_LENGTH=8,r.si.PAT=function(){r.si.PSISection.call(this,r.si.PAT.prototype.TABLE_ID),this.m_listOfProgramAssociation=[],this.m_network_pid=null},r.si.PAT.prototype=Object.create(r.si.PSISection.prototype),r.si.PAT.prototype.constructor=r.si.PAT,r.si.PAT.prototype.parse=function(a){var b=r.si.PSISection.prototype.parse.call(this,a);if(b++,this.m_bValid&&(this.m_bValid=!1,this.m_table_id==this.TABLE_ID)){for(var c=this.getSectionLength()-this.SECTION_LENGTH;c>=4;){var d=new r.si.ProgramAssociation(a.subarray(b,b+4));0===d.getProgramNumber()?this.m_network_pid=d.getProgramMapPid():this.m_listOfProgramAssociation.push(d),c-=4,b+=4}this.m_bValid=!0}},r.si.PAT.prototype.getPmtPid=function(){var a=r.ts.TsPacket.prototype.UNDEFINED_PID;if(this.m_listOfProgramAssociation.length>=1){var b=this.m_listOfProgramAssociation[0];a=b.getProgramMapPid()}return a},r.si.PAT.prototype.TABLE_ID=0,r.si.PAT.prototype.PID=0,r.si.ProgramAssociation=function(a){this.m_program_number=0,this.m_program_map_pid=0,this.parse(a)},r.si.ProgramAssociation.prototype.getProgramNumber=function(){return this.m_program_number},r.si.ProgramAssociation.prototype.getProgramMapPid=function(){return this.m_program_map_pid},r.si.ProgramAssociation.prototype.getLength=function(){return 4},r.si.ProgramAssociation.prototype.parse=function(a){this.m_program_number=r.binary.getValueFrom2Bytes(a.subarray(0,2)),this.m_program_map_pid=r.binary.getValueFrom2Bytes(a.subarray(2,4),3,13)},r.pes.PesPacket=function(){this.m_cStreamID=null,this.m_nPESPacketLength=null,this.m_cPESScramblingCtrl=null,this.m_bPESpriority=null,this.m_bDataAlignement=null,this.m_bCopyright=null,this.m_bOriginalOrCopy=null,this.m_cPES_header_data_length=null,this.m_cPTS_DTS_flags=null,this.m_bESCR_flag=null,this.m_bES_rate_flag=null,this.m_bDSM_trick_mode_flag=null,this.m_bAdditional_copy_info_flag=null,this.m_bPES_CRC_flag=null,this.m_bPES_extension_flag=null,this.m_pPTS=null,this.m_pDTS=null,this.m_pESCR=null,this.m_ES_rate=null,this.m_DSM_trick_mode=null,this.m_Additional_copy_info=null,this.m_PES_CRC=null,this.m_cNbStuffingBytes=null,this.m_pPESExtension=null,this.m_pPrivateData=null,this.m_payloadArray=null,this.m_nPayloadLength=null,this.m_bDirty=null,this.m_bValid=!1},r.pes.PesPacket.prototype.parse=function(a){var b=0;this.m_nLength=a.length;var c=r.binary.getValueFrom3Bytes(a.subarray(b,b+3));if(c===this.START_CODE_PREFIX){if(b=3,this.m_cStreamID=a[b],b++,this.m_nPESPacketLength=r.binary.getValueFrom2Bytes(a.subarray(b,b+2)),b+=2,this.m_cStreamID===r.ts.TsPacket.prototype.STREAM_ID_PADDING_STREAM)return void(this.m_bValid=!0);if(!this.hasOptionalPESHeader())return this.m_payloadArray=a.subarray(b+r.pes.PesPacket.prototype.FIXED_HEADER_LENGTH),this.m_nPayloadLength=this.m_nLength-r.pes.PesPacket.prototype.FIXED_HEADER_LENGTH,void(this.m_bValid=!0);var d=r.binary.getValueFromByte(a[b],0,2);if(2==d){this.m_cPESScramblingCtrl=r.binary.getValueFromByte(a[b],2,2),this.m_bPESpriority=r.binary.getBitFromByte(a[b],4),this.m_bDataAlignement=r.binary.getBitFromByte(a[b],5),this.m_bCopyright=r.binary.getBitFromByte(a[b],6),this.m_bOriginalOrCopy=r.binary.getBitFromByte(a[b],7),b++,this.m_cPTS_DTS_flags=r.binary.getValueFromByte(a[b],0,2),this.m_bESCR_flag=r.binary.getBitFromByte(a[b],2),this.m_bES_rate_flag=r.binary.getBitFromByte(a[b],3),this.m_bDSM_trick_mode_flag=r.binary.getBitFromByte(a[b],4),this.m_bAdditional_copy_info_flag=r.binary.getBitFromByte(a[b],5),
this.m_bPES_CRC_flag=r.binary.getBitFromByte(a[b],6),this.m_bPES_extension_flag=r.binary.getBitFromByte(a[b],7),b++,this.m_cPES_header_data_length=255&a[b],b++,(this.m_cPTS_DTS_flags&r.pes.PesPacket.prototype.FLAG_PTS)==r.pes.PesPacket.prototype.FLAG_PTS&&(this.m_pPTS=new r.Pts(a.subarray(b,b+5)),b+=5),(this.m_cPTS_DTS_flags&r.pes.PesPacket.prototype.FLAG_DTS)==r.pes.PesPacket.prototype.FLAG_DTS&&(this.m_pDTS=new r.Pts(a.subarray(b,b+5)),b+=5),this.m_bESCR_flag&&(b+=6),this.m_bES_rate_flag&&(this.m_ES_rate=r.binary.getValueFrom3Bytes(a.subarray(b,b+3),1,22),b+=3),this.m_bDSM_trick_mode_flag&&(this.m_DSM_trick_mode=a[b],b++),this.m_bAdditional_copy_info_flag&&(this.m_Additional_copy_info=a[b],b++),this.m_bPES_CRC_flag&&(this.m_PES_CRC=r.binary.getValueFrom2Bytes(a.subarray(b,b+2)),b+=2),this.m_bPES_extension_flag;var e=r.pes.PesPacket.prototype.FIXED_HEADER_LENGTH+r.pes.PesPacket.prototype.FIXED_OPTIONAL_HEADER_LENGTH+this.m_cPES_header_data_length;this.m_cNbStuffingBytes=e-b,b+=this.m_cNbStuffingBytes,this.m_nPayloadLength=this.m_nLength-e,this.m_payloadArray=a.subarray(e,e+this.m_nPayloadLength),this.m_bValid=!0}}},r.pes.PesPacket.prototype.hasOptionalPESHeader=function(){return this.m_cStreamID===r.ts.TsPacket.prototype.STREAM_ID_PROGRAM_STREAM_MAP||this.m_cStreamID===r.ts.TsPacket.prototype.STREAM_ID_PADDING_STREAM||this.m_cStreamID===r.ts.TsPacket.prototype.STREAM_ID_PRIVATE_STREAM_2||this.m_cStreamID===r.ts.TsPacket.prototype.STREAM_ID_ECM_STREAM||this.m_cStreamID===r.ts.TsPacket.prototype.STREAM_ID_EMM_STREAM||this.m_cStreamID===r.ts.TsPacket.prototype.STREAM_ID_PROGRAM_STREAM_DIRECTORY||this.m_cStreamID===r.ts.TsPacket.prototype.STREAM_ID_DSMCC_STREAM||this.m_cStreamID===r.ts.TsPacket.prototype.STREAM_ID_H2221_TYPE_E_STREAM?!1:!0},r.pes.PesPacket.prototype.getHeaderLength=function(){return r.pes.PesPacket.prototype.FIXED_HEADER_LENGTH+r.pes.PesPacket.prototype.FIXED_OPTIONAL_HEADER_LENGTH+this.m_cPES_header_data_length},r.pes.PesPacket.prototype.getPayload=function(){return this.m_payloadArray},r.pes.PesPacket.prototype.getPts=function(){return this.m_pPTS},r.pes.PesPacket.prototype.getDts=function(){return this.m_pDTS},r.pes.PesPacket.prototype.START_CODE_PREFIX=1,r.pes.PesPacket.prototype.FIXED_HEADER_LENGTH=6,r.pes.PesPacket.prototype.FIXED_OPTIONAL_HEADER_LENGTH=3,r.pes.PesPacket.prototype.FLAG_DTS=1,r.pes.PesPacket.prototype.FLAG_PTS=2,r.si.PMT=function(){r.si.PSISection.call(this,r.si.PMT.prototype.TABLE_ID),this.m_listOfComponents=[],this.m_PCR_PID=null,this.m_program_info_length=null},r.si.PMT.prototype=Object.create(r.si.PSISection.prototype),r.si.PMT.prototype.constructor=r.si.PMT,r.si.PMT.prototype.parse=function(a){var b=r.si.PSISection.prototype.parse.call(this,a);if(b++,this.m_bValid&&(this.m_bValid=!1,this.m_table_id==this.TABLE_ID)){var c=this.getSectionLength()-this.SECTION_LENGTH;if(!(4>c)){this.m_PCR_PID=r.binary.getValueFrom2Bytes(a.subarray(b,b+2),3),b+=2,this.m_program_info_length=r.binary.getValueFrom2Bytes(a.subarray(b,b+2),4),b+=2,b+=this.m_program_info_length,c=this.m_section_length-this.SECTION_LENGTH-4-this.m_program_info_length;for(var d=null;c>0;)d=new r.si.ESDescription(a.subarray(b,b+c)),this.m_listOfComponents.push(d),c-=d.getLength(),b+=d.getLength();this.m_bValid=!0}}},r.si.PMT.prototype.TABLE_ID=2,r.si.PMT.prototype.gStreamTypes=[{name:"Reserved",value:0,desc:"ITU-T | ISO/IEC Reserved"},{name:"MPEG1-Video",value:224,desc:"ISO/IEC 11172-2 Video"},{name:"MPEG2-Video",value:224,desc:"ITU-T Rec. H.262 | ISO/IEC 13818-2 Video or ISO/IEC 11172-2 constrained parameter video stream"},{name:"MPEG1-Audio",value:192,desc:"ISO/IEC 11172-3 Audio"},{name:"MPEG2-Audio",value:192,desc:"ISO/IEC 13818-3 Audio"},{name:"PRIVATE_SECTIONS",value:189,desc:"ITU-T Rec. H.222.0 | ISO/IEC 13818-1 private_sections"},{name:"PRIVATE",value:189,desc:"ITU-T Rec. H.222.0 | ISO/IEC 13818-1 PES packets containing private data"},{name:"MHEG",value:243,desc:"ISO/IEC 13522 MHEG"},{name:"MPEG1-DSM-CC",value:242,desc:"ITU-T Rec. H.222.0 | ISO/IEC 13818-1 Annex A DSM-CC"},{name:"H.222.1",value:244,desc:"ITU-T Rec. H.222.1"},{name:"DSM-CC_A",value:244,desc:"ISO/IEC 13818-6 type A"},{name:"DSM-CC_B",value:245,desc:"ISO/IEC 13818-6 type B"},{name:"DSM-CC_C",value:246,desc:"ISO/IEC 13818-6 type C"},{name:"DSM-CC_D",value:247,desc:"ISO/IEC 13818-6 type D"},{name:"Auxiliary",value:0,desc:"ITU-T Rec. H.222.0 | ISO/IEC 13818-1 auxiliary"},{name:"MPEG2-AAC-ADTS",value:192,desc:"ISO/IEC 13818-7 Audio with ADTS transport syntax"},{name:"MPEG4-Video",value:224,desc:"ISO/IEC 14496-2 Visual"},{name:"MPEG4-AAC-LATM",value:192,desc:"ISO/IEC 14496-3 Audio with the LATM transport syntax as defined in ISO/IEC 14496-3/AMD-1"},{name:"MPEG4-SL",value:250,desc:"ISO/IEC 14496-1 SL-packetized stream or FlexMux stream carried in PES packets"},{name:"MPEG4-SL",value:250,desc:"ISO/IEC 14496-1 SL-packetized stream or FlexMux stream carried in ISO/IEC14496_sections"},{name:"DSM-CC_SDP",value:0,desc:"ISO/IEC 13818-6 Synchronized Download Protocol"},{name:"META_PES",value:252,desc:"Metadata carried in PES packets"},{name:"META_SECTIONS",value:252,desc:"Metadata carried in metadata_sections"},{name:"META_DSM-CC",value:252,desc:"Metadata carried in ISO/IEC 13818-6 Data Carousel"},{name:"META_DSM-CC",value:252,desc:"Metadata carried in ISO/IEC 13818-6 Object Carousel"},{name:"META_DSM-CC",value:252,desc:"Metadata carried in ISO/IEC 13818-6 Synchronized Download Protocol"},{name:"MPEG2-IPMP",value:0,desc:"IPMP stream (defined in ISO/IEC 13818-11, MPEG-2 IPMP)"},{name:"H.264",value:224,desc:"AVC video stream as defined in ITU-T Rec. H.264 | ISO/IEC 14496-10 Video"},{name:"MPEG4AAC",value:192,desc:"ISO/IEC 14496-3 Audio, without using any additional transport syntax, such as DST, ALS and SLS"},{name:"MPEG4Text",value:0,desc:"ISO/IEC 14496-17 Text"},{name:"Aux. Video (23002-3)",value:30,desc:"Auxiliary video stream as defined in ISO/IEC 23002-3"},{name:"H.264-SVC",value:224,desc:"SVC video sub-bitstream of a video stream as defined in the Annex G of ITU-T Rec. H.264 | ISO/IEC 14496-10 Video"},{name:"H.264-MVC",value:224,desc:"MVC video sub-bitstream of a video stream as defined in the Annex H of ITU-T Rec. H.264 | ISO/IEC 14496-10 Video"},{name:"Reserved1",value:0,desc:"TBC Reserved"},{name:"Reserved2",value:0,desc:"TBC Reserved"},{name:"Reserved3",value:0,desc:"TBC Reserved"},{name:"HEVC",value:224,desc:"ITU.-T Rec H.26x | ISO/IEC 23008-2 video stream"}],r.si.PMT.prototype.MPEG2_VIDEO_STREAM_TYPE=2,r.si.PMT.prototype.AVC_VIDEO_STREAM_TYPE=27,r.si.PMT.prototype.MPEG1_AUDIO_STREAM_TYPE=3,r.si.PMT.prototype.MPEG2_AUDIO_STREAM_TYPE=4,r.si.PMT.prototype.AAC_AUDIO_STREAM_TYPE=17,r.si.PMT.prototype.AC3_AUDIO_STREAM_TYPE=6,r.si.PMT.prototype.SUB_STREAM_TYPE=6,r.si.PMT.prototype.STREAM_TYPE_MP1V=1,r.si.PMT.prototype.STREAM_TYPE_MP2V=2,r.si.PMT.prototype.STREAM_TYPE_MP1A=3,r.si.PMT.prototype.STREAM_TYPE_MP2A=4,r.si.PMT.prototype.STREAM_TYPE_PRIVATE=6,r.si.PMT.prototype.STREAM_TYPE_TELETEXT=6,r.si.PMT.prototype.STREAM_TYPE_DVBSUBTITLE=6,r.si.PMT.prototype.STREAM_TYPE_AC3=6,r.si.PMT.prototype.STREAM_TYPE_MP2AAC_ADTS=15,r.si.PMT.prototype.STREAM_TYPE_MP4AAC_LATM=17,r.si.PMT.prototype.STREAM_TYPE_H264=27,r.si.PMT.prototype.STREAM_TYPE_MP4AAC=28,r.si.PMT.prototype.STREAM_TYPE_AUX_23002_3=30,r.si.PMT.prototype.STREAM_TYPE_SVC=31,r.si.PMT.prototype.STREAM_TYPE_MVC=32,r.si.PMT.prototype.STREAM_TYPE_HEVC=36,r.si.ESDescription=function(a){this.m_stream_type=null,this.m_elementary_PID=null,this.m_ES_info_length=null,this.parse(a)},r.si.ESDescription.prototype.getStreamType=function(){return this.m_stream_type},r.si.ESDescription.prototype.getPID=function(){return this.m_elementary_PID},r.si.ESDescription.prototype.getLength=function(){return 5+this.m_ES_info_length},r.si.ESDescription.prototype.parse=function(a){this.m_stream_type=a[0],this.m_elementary_PID=r.binary.getValueFrom2Bytes(a.subarray(1,3),3),this.m_ES_info_length=r.binary.getValueFrom2Bytes(a.subarray(3,5),4)},r.Pts=function(a){var b,c,d=a[0]>>1&7;c=d>>2,b=(3&d)<<30>>>0;var f=a[1];b=(b|f<<22)>>>0;var g=a[2]>>1;b=(b|g<<15)>>>0;var h=a[3];b=(b|h<<7)>>>0;var i=a[4]>>1;b=(b|i)>>>0,this.m_lPTS=e.math.Long.fromBits(b,c).toNumber(),this.m_fPTS=this.m_lPTS/r.Pts.prototype.SYSTEM_CLOCK_FREQUENCY},r.Pts.prototype.getValue=function(){return this.m_lPTS},r.Pts.prototype.getValueInSeconds=function(){return this.m_fPTS},r.Pts.prototype.SYSTEM_CLOCK_FREQUENCY=9e4,r.ts.TsPacket=function(){this.m_cSync=null,this.m_bTransportError=null,this.m_bPUSI=null,this.m_bTransportPriority=null,this.m_nPID=null,this.m_cTransportScramblingCtrl=null,this.m_cAdaptationFieldCtrl=null,this.m_cContinuityCounter=null,this.m_pAdaptationField=null,this.m_payloadArray=null,this.m_cPayloadLength=null,this.m_bDirty=null,this.m_time=null,this.m_arrivalTime=null,this.m_bIgnored=null},r.ts.TsPacket.prototype.parse=function(a){var b=0;if(this.m_cSync=a[b],this.m_cSync===this.SYNC_WORD){if(b++,this.m_bTransportError=r.binary.getBitFromByte(a[b],0),this.m_bPUSI=r.binary.getBitFromByte(a[b],1),this.m_bTransportPriority=r.binary.getBitFromByte(a[b],2),this.m_nPID=r.binary.getValueFrom2Bytes(a.subarray(b,b+2),3,13),b+=2,this.m_cTransportScramblingCtrl=r.binary.getValueFromByte(a[b],0,2),this.m_cAdaptationFieldCtrl=r.binary.getValueFromByte(a[b],2,2),this.m_cContinuityCounter=r.binary.getValueFromByte(a[b],4,4),b++,2&this.m_cAdaptationFieldCtrl){var c=a[b];if(c+b>=this.TS_PACKET_SIZE)return;this.m_pAdaptationField=new r.ts.AdaptationField,this.m_pAdaptationField.parse(a.subarray(b)),b+=this.m_pAdaptationField.getLength()}0!==this.m_cAdaptationFieldCtrl&&1&this.m_cAdaptationFieldCtrl&&(this.m_cPayloadLength=this.TS_PACKET_SIZE-b,this.m_payloadArray=a.subarray(b,b+this.m_cPayloadLength))}},r.ts.TsPacket.prototype.getPid=function(){return this.m_nPID},r.ts.TsPacket.prototype.getPayload=function(){return this.m_payloadArray},r.ts.TsPacket.prototype.getPayloadLength=function(){return this.m_cPayloadLength},r.ts.TsPacket.prototype.getPusi=function(){return this.m_bPUSI},r.ts.TsPacket.prototype.hasAdaptationFieldOnly=function(){return 2===this.m_cAdaptationFieldCtrl},r.ts.TsPacket.prototype.SYNC_WORD=71,r.ts.TsPacket.prototype.TS_PACKET_SIZE=188,r.ts.TsPacket.prototype.UNDEFINED_PID=65535,r.ts.TsPacket.prototype.PAT_PID=0,r.ts.TsPacket.prototype.STREAM_ID_PROGRAM_STREAM_MAP=188,r.ts.TsPacket.prototype.STREAM_ID_PADDING_STREAM=190,r.ts.TsPacket.prototype.STREAM_ID_PADDING_STREAM=190,r.ts.TsPacket.prototype.STREAM_ID_PRIVATE_STREAM_2=191,r.ts.TsPacket.prototype.STREAM_ID_ECM_STREAM=240,r.ts.TsPacket.prototype.STREAM_ID_EMM_STREAM=241,r.ts.TsPacket.prototype.STREAM_ID_DSMCC_STREAM=242,r.ts.TsPacket.prototype.STREAM_ID_H2221_TYPE_E_STREAM=248,r.ts.TsPacket.prototype.STREAM_ID_PROGRAM_STREAM_DIRECTORY=255,k=function(a){"use strict";var b,c,d,e,g,h="1.2.0",i="1.2.7",j="caab083",l="1.4.2016_11:11:29",m=a,n=null,o=!1,p=!1,q=!1,r=!0,s=!1,t=k.dependencies.BufferExtensions.BUFFER_SIZE_REQUIRED,u="und",v="und",w=!1,x=function(){return!!c&&!!d&&!p},y=function(){if(!o)throw new Error("MediaPlayer.play(): MediaPlayer not initialized");if(!c)throw new Error("MediaPlayer.play(): Video element not attached to MediaPlayer");if(!d)throw new Error("MediaPlayer.play(): Source not attached to MediaPlayer");return this.capabilities.supportsMediaSource()?(q=!0,e||(e=b.getObject("streamController"),e.setVideoModel(g),e.setAutoPlay(r)),e.setDefaultAudioLang(u),e.setDefaultSubtitleLang(v),e.enableSubtitles(w),e.load(d,n),b.mapValue("scheduleWhilePaused",s),b.mapOutlet("scheduleWhilePaused","stream"),b.mapValue("bufferMax",t),void b.injectInto(this.bufferExt,"bufferMax")):void this.errHandler.sendError(k.dependencies.ErrorHandler.prototype.CAPABILITY_ERR_MEDIASOURCE,"MediaSource extension not supported by the browser")},z=function(){x()&&y.call(this)},A=function(){if(q&&e){if(!p){p=!0;var a={},b=this;a[k.dependencies.StreamController.eventList.ENAME_TEARDOWN_COMPLETE]=function(){e=null,q=!1,p=!1,b.debug.log("[MediaPlayer] Player is stopped"),x.call(b)&&z.call(b)},e.subscribe(k.dependencies.StreamController.eventList.ENAME_TEARDOWN_COMPLETE,a,void 0,!0),e.reset()}}else x.call(this)&&z.call(this)},B=function(){var a=this.metricsModel.getReadOnlyMetricsFor("video")||this.metricsModel.getReadOnlyMetricsFor("audio");return this.metricsExt.getCurrentDVRInfo(a)},C=function(){return B.call(this).mpd.timeShiftBufferDepth},D=function(a){var b=B.call(this),c=b.range.start+parseInt(a,10);return c>b.range.end&&(c=b.range.end),c},E=function(){var a=this.metricsModel.getReadOnlyMetricsFor("video"),b=a?this.metricsExt.getCurrentDVRInfo(a):null,c=b?b.range:null;return c},F=function(a){e.seek(a)},G=function(){var a=B.call(this);return null===a?0:Math.round(this.duration()-(a.range.end-a.time))},H=function(){var a,b=B.call(this);return null===b?0:(a=b.range.end-b.range.start,Math.round(a<b.mpd.timeShiftBufferDepth?a:b.mpd.timeShiftBufferDepth))},I=function(){var a,b,c=B.call(this);return null===c?0:(a=c.mpd.availabilityStartTime.getTime()/1e3,b=this.time()+(a+c.range.start),Math.round(b))},J=function(){var a,b,c=B.call(this);return null===c?0:(a=c.mpd.availabilityStartTime.getTime()/1e3,b=a+c.range.start+this.duration(),Math.round(b))},K=function(a,b,c){var d=new Date(1e3*a),e=d.toLocaleDateString(b),f=d.toLocaleTimeString(b,{hour12:c});return f+" "+e},L=function(a){a=Math.max(a,0);var b=Math.floor(a/3600),c=Math.floor(a%3600/60),d=Math.floor(a%3600%60);return(0===b?"":10>b?"0"+b.toString()+":":b.toString()+":")+(10>c?"0"+c.toString():c.toString())+":"+(10>d?"0"+d.toString():d.toString())};return b=new f.System,b.mapValue("system",b),b.mapOutlet("system"),b.injectInto(m),{notifier:void 0,debug:void 0,eventBus:void 0,capabilities:void 0,abrController:void 0,metricsModel:void 0,metricsExt:void 0,bufferExt:void 0,errHandler:void 0,tokenAuthentication:void 0,uriQueryFragModel:void 0,config:void 0,addEventListener:function(a,b,c){if(!o)throw"MediaPlayer not initialized!";this.eventBus.addEventListener(a,b,c)},removeEventListener:function(a,b,c){this.eventBus.removeEventListener(a,b,c)},getVersion:function(){return i},getVersionFull:function(){return-1===j.indexOf("@@")?i+"_"+j:i},getVersionDashJS:function(){return h},getBuildDate:function(){return-1===l.indexOf("@@")?l:"Not a builded version"},startup:function(){o||(b.injectInto(this),o=!0,this.debug.log("[MediaPlayer] Version: "+this.getVersionFull()+" - "+this.getBuildDate()),this.debug.log("[MediaPlayer] user-agent: "+navigator.userAgent))},getDebug:function(){return this.debug},getVideoModel:function(){return g},setAutoPlay:function(a){r=a},getAutoPlay:function(){return r},setScheduleWhilePaused:function(a){s=a},getScheduleWhilePaused:function(){return s},setTokenAuthentication:function(a,b){this.tokenAuthentication.setTokenAuthentication({name:a,type:b})},setBufferMax:function(a){t=a},getBufferMax:function(){return t},getMetricsExt:function(){return this.metricsExt},getMetricsFor:function(a){var b=this.metricsModel.getReadOnlyMetricsFor(a);return b},getQualityFor:function(a){return this.abrController.getQualityFor(a)},setQualityFor:function(a,b){this.abrController.setPlaybackQuality(a,b)},getAutoSwitchQuality:function(){return this.abrController.getAutoSwitchBitrate()},setAutoSwitchQuality:function(a){this.abrController.setAutoSwitchBitrate(a)},setConfig:function(a){this.config&&a&&(this.debug.log("[MediaPlayer] set config: "+JSON.stringify(a,null,"	")),this.config.setParams(a))},setAudioTrack:function(a){e.setAudioTrack(a)},getSelectedAudioTrack:function(){return e?e.getSelectedAudioTrack():null},getSelectedSubtitleTrack:function(){return e?e.getSelectedSubtitleTrack():null},getAudioTracks:function(){return e?e.getAudioTracks():null},setSubtitleTrack:function(a){return e?void e.setSubtitleTrack(a):null},enableSubtitles:function(a){w=a,e&&e.enableSubtitles(a)},getSubtitleTracks:function(){return e?e.getSubtitleTracks():null},attachView:function(a){if(!o)throw new Error("MediaPlayer.attachView(): MediaPlayer not initialized");c=a,g=null,c&&(g=b.getObject("videoModel"),g.setElement(c)),q&&e&&(e.reset(),q=!1)},attachSource:function(a,b){var c,e=this.getVideoModel();if(!o)throw new Error("MediaPlayer.play(): MediaPlayer not initialized");if(!e)throw new Error("MediaPlayer.play(): Video element not attached to MediaPlayer");c=e.getElement().loop,a&&this.metricsModel.addSession(null,a,c,null,"HasPlayer.js_"+this.getVersion()),this.uriQueryFragModel.reset(),d=a?this.uriQueryFragModel.parseURI(a):null,n=b,A.call(this)},refreshManifest:function(a){e&&e.refreshManifest(a)},reset:function(a){this.metricsModel.addState("video","stopped",this.getVideoModel().getCurrentTime(),a),this.attachSource(null),n=null},setDefaultAudioLang:function(a){u=a},setDefaultSubtitleLang:function(a){v=a},setTrickModeSpeed:function(a){e&&(e.getTrickModeSpeed()!==a&&1===a?g.play():e.setTrickModeSpeed(a))},getTrickModeSpeed:function(){return e?e.getTrickModeSpeed():0},play:y,isReady:x,seek:F,time:G,duration:H,timeAsUTC:I,durationAsUTC:J,getDVRWindowSize:C,getDVRSeekOffset:D,getDVRWindowRange:E,formatUTC:K,convertToTimeCode:L}},k.prototype={constructor:k},k.dependencies={},k.dependencies.protection={},k.dependencies.protection.servers={},k.utils={},k.models={},k.modules={},k.vo={},k.vo.metrics={},k.vo.protection={},k.rules={},k.rules.o={},k.di={},k.dependencies.AbrController=function(){"use strict";var a=!0,b={},c={},e="",f=function(a){var c;return b.hasOwnProperty(a)||(b[a]=0),c=b[a]},g=function(a,c){b[a]=c},h=function(a){var b;return c.hasOwnProperty(a)||(c[a]=0),b=c[a]},i=function(a,b){c[a]=b};return{debug:void 0,abrRulesCollection:void 0,manifestExt:void 0,metricsModel:void 0,metricsExt:void 0,config:void 0,getAutoSwitchBitrate:function(){return a},setAutoSwitchBitrate:function(b){a=b},getMetricsFor:function(a){var b=d.defer(),c=this;return c.manifestExt.getIsVideo(a).then(function(d){d?b.resolve(c.metricsModel.getMetricsFor("video")):c.manifestExt.getIsAudio(a).then(function(a){a?b.resolve(c.metricsModel.getMetricsFor("audio")):b.resolve(c.metricsModel.getMetricsFor("stream"))})}),b.promise},_getPlaybackQuality:function(b,c){var j,l,m,n,o,p,q=this,r=d.defer(),s=k.rules.SwitchRequest.prototype.NO_CHANGE,t=k.rules.SwitchRequest.prototype.NO_CHANGE,u=[];return o=f(b),p=h(b),a?(q.debug.log("[AbrController]["+b+"] Check rules...."),q.getMetricsFor(c).then(function(a){q.abrRulesCollection.getRules(k.rules.BaseRulesCollection.prototype.QUALITY_SWITCH_RULES).then(function(f){for(j=0,l=f.length;l>j;j+=1)u.push(f[j].checkIndex(o,a,c,e));d.all(u).then(function(a){for(n={},n[k.rules.SwitchRequest.prototype.STRONG]=k.rules.SwitchRequest.prototype.NO_CHANGE,n[k.rules.SwitchRequest.prototype.WEAK]=k.rules.SwitchRequest.prototype.NO_CHANGE,n[k.rules.SwitchRequest.prototype.DEFAULT]=k.rules.SwitchRequest.prototype.NO_CHANGE,j=0,l=a.length;l>j;j+=1)m=a[j],q.debug.log("[AbrController]["+b+"] Request for quality "+m.quality+", priority = "+m.priority),m.quality!==k.rules.SwitchRequest.prototype.NO_CHANGE&&(n[m.priority]=Math.min(n[m.priority],m.quality));n[k.rules.SwitchRequest.prototype.WEAK]!==k.rules.SwitchRequest.prototype.NO_CHANGE&&(t=k.rules.SwitchRequest.prototype.WEAK,s=n[k.rules.SwitchRequest.prototype.WEAK]),n[k.rules.SwitchRequest.prototype.DEFAULT]!==k.rules.SwitchRequest.prototype.NO_CHANGE&&(t=k.rules.SwitchRequest.prototype.DEFAULT,s=n[k.rules.SwitchRequest.prototype.DEFAULT]),n[k.rules.SwitchRequest.prototype.STRONG]!==k.rules.SwitchRequest.prototype.NO_CHANGE&&(t=k.rules.SwitchRequest.prototype.STRONG,s=n[k.rules.SwitchRequest.prototype.STRONG]),s!==k.rules.SwitchRequest.prototype.NO_CHANGE&&void 0!==s&&(o=s),t!==k.rules.SwitchRequest.prototype.NO_CHANGE&&void 0!==t&&(p=t),q.manifestExt.getRepresentationCount(c).then(function(a){0>o&&(o=0),o>=a&&(o=a-1),p!==k.rules.SwitchRequest.prototype.STRONG&&p!==k.rules.SwitchRequest.prototype.WEAK&&(p=k.rules.SwitchRequest.prototype.DEFAULT),q.debug.info("[AbrController]["+b+"] Set quality: "+o),g(b,o),i(b,p),r.resolve({quality:o,confidence:p})})})})})):r.resolve({quality:o,confidence:p}),r.promise},getPlaybackQuality:function(a,b){var c,e=this,f=d.defer(),g=e.getQualityFor(a),h=-1,i=-1,j=e.config.getParamFor(a,"ABR.switchUpIncrementally","boolean",!1);return e._getPlaybackQuality(a,b).then(function(d){if(c=d.quality,e.getAutoSwitchBitrate()){j&&c>g&&(e.debug.log("[AbrController]["+a+"] Incremental switch => quality: "+c),c=g+1);var k=e.metricsExt.getQualityBoundaries(a,b);h=k.min,i=k.max,h>c&&(c=h,e.debug.log("[AbrController]["+a+"] New quality < min => "+c)),c>i&&(c=i,e.debug.log("[AbrController]["+a+"] New quality > max => "+c)),e.setPlaybackQuality.call(e,a,c),f.resolve({quality:c,confidence:d.confidence})}else f.resolve({quality:c,confidence:d.confidence})}),f.promise},setPlaybackQuality:function(a,b){var c=f(a);this.debug.log("[AbrController]["+a+"] Set playback quality: "+b),b!==c&&g(a,b)},getQualityFor:function(a){return f(a)},setPlayerState:function(a){e=a}}},k.dependencies.AbrController.prototype={constructor:k.dependencies.AbrController},k.dependencies.AbrController.BANDWIDTH_SAFETY=.9,k.dependencies.BufferController=function(){"use strict";var a,b,c,e,f,g,h,i,l,m="READY",n=m,o=!1,p=!1,q=!1,r=!0,s=[],t=!1,u=-1,v=!0,w=!1,x=-1,y=-1,z=!1,A=!1,B=!1,C=null,D=null,E=null,F=0,G=null,H=0,I=!1,J=null,K=0,L=!1,M=null,N=null,O=!1,P=!1,Q=null,R=null,S=!0,T=!1,U=-1,V=0,W=1,X=U,Y=-1,Z=null,$=!1,_=!1,aa=3,ba=!1,ca=0,da=-1,ea=null,fa=-1,ga=NaN,ha=function(){ya.call(this)&&null!==G&&this.fragmentController.onBufferControllerStateChange()},ia=function(a,b){var c=0,d=null;S===!1&&(d=R.start,c=a.getTime()-d.getTime(),R.duration=c,R.stopreason=b,S=!0)},ja=function(a){var b=this;"text"!==e&&(b.debug.info("[BufferController]["+e+"] stalled = "+a),z=a,b.videoModel.stallStream(e,z),z&&b.abrController.setPlayerState("buffering"))},ka=function(){o&&p&&(this.debug.info("[BufferController]["+e+"] startPlayback"),ja.call(this,!0),Ma.call(this))},la=function(){var a,b=this;p!==!0&&(t===!1&&(a=new Date,ia(a,k.vo.metrics.PlayList.Trace.USER_REQUEST_STOP_REASON),Q=this.metricsModel.addPlayList(e,a,0,k.vo.metrics.PlayList.INITIAL_PLAY_START_REASON)),B&&(B=!1),p=!0,b.debug.info("[BufferController]["+e+"] START"),q=!0,X=U,Y=-1,ka.call(b))},ma=function(a){var c=this,f=new Date;(t!==!0||u!==a)&&(this.debug.info("[BufferController]["+e+"] SEEK: "+a),p===!0&&oa.call(c),this.fragmentController.clearExecutedRequests(G),Q=this.metricsModel.addPlayList(e,f,u,k.vo.metrics.PlayList.SEEK_START_REASON),t=!0,u=a,d.when(Z?Z.promise:!0).then(function(){b.segments=null,la.call(c)}))},na=function(){this.debug.info("[BufferController]["+e+"] SEEKED"),t=!1,u=-1},oa=function(){p&&(this.debug.info("[BufferController]["+e+"] STOP"),clearTimeout(h),clearTimeout(i),p=!1,q=!1,t=!1,u=-1,clearTimeout(ea),ea=null,ia(new Date,k.vo.metrics.PlayList.Trace.USER_REQUEST_STOP_REASON),this.fragmentController.abortRequestsForModel(G))},pa=function(b){return a[b]},qa=function(a){this.debug.info("[BufferController]["+e+"] Load request ",null!==a.url?a.url:a.quality)},ra=function(a,b){void 0!==a.sequenceNumber&&(fa=a.sequenceNumber),this.fragmentController.isInitializationRequest(a)?sa.call(this,a,b):ta.call(this,a,b)},sa=function(a,b){var c=this,f=b.data,g=a.quality;c.debug.log("[BufferController]["+e+"] Initialization loaded ",g),c.fragmentController.process(f).then(function(b){null!==b?(s[g]=b,c.debug.info("[BufferController]["+e+"] Buffer initialization segment ",null!==a.url?a.url:a.quality),d.when(w?Ba.call(c):!0).then(function(){w=!1,ua.call(c,b,a.quality).then(function(){c.debug.log("[BufferController]["+e+"] Initialization segment buffered"),ya()&&Fa.call(c)})})):(c.debug.log("No "+e+" bytes to push."),Fa.call(c))},function(a){za.call(c),c.errHandler.sendError(k.dependencies.ErrorHandler.prototype.INTERNAL_ERROR,"Internal error while processing media segment",a.message)})},ta=function(c,d){var f=this,g=this.manifestExt.getEventStreamForAdaptationSet(f.getData()),h=this.manifestExt.getEventStreamForRepresentation(f.getData(),b),i=null;ga=c.duration,ba=!1,ca=0,f.debug.log("[BufferController]["+e+"] Media loaded ",c.url),f.chunkAborted===!0&&(f.chunkAborted=!1),1===f.chunkMissingCount&&(f.chunkMissingCount=0),K||isNaN(c.duration)||(K=c.duration),f.fragmentController.process(d.data,c,a).then(function(a){null!==a?((g.length>0||h.length>0)&&wa.call(f,a,c,g,h).then(function(a){f.eventController.addInbandEvents(a)}),f.debug.info("[BufferController]["+e+"] Buffer segment from url ",c.url),xa.call(f,a).then(function(a){ua.call(f,a,c.quality,c.index).then(function(){$&&($=!1,f.fragmentController.hasOwnProperty("getStartTime")&&(i=f.fragmentController.getStartTime()),i?f.metricsModel.addBufferedSwitch(e,i,b.id,c.quality):f.metricsModel.addBufferedSwitch(e,c.startTime,b.id,c.quality)),b.segments=null,f.debug.log("[BufferController]["+e+"] Media segment buffered"),za.call(f),Ma.call(f)})})):(f.debug.error("[BufferController]["+e+"] Error with segment data, no bytes to push"),za.call(f),Ma.call(f))},function(a){za.call(f),f.errHandler.sendError(k.dependencies.ErrorHandler.prototype.INTERNAL_ERROR,"Internal error while processing media segment",a.message)})},ua=function(a,c,f){var g=this,h=d.defer(),i=g.videoModel.getCurrentTime(),j=new Date;return S===!0&&(S=!1,R=g.metricsModel.appendPlayListTrace(Q,b.id,null,j,i,null,1,null)),Ha()?(Aa.call(g).then(function(){d.when(D?D.promise:!0).then(function(){Ha()&&(g.debug.log("[BufferController]["+e+"] Buffering segment"),g.sourceBufferExt.append(N,a,_).then(function(){if(g.debug.log("[BufferController]["+e+"] Segment buffered"),x!=c&&($=!0,g.debug.log("[BufferController]["+e+"] set currentBufferedQuality to "+c),x=c),I=!1,A&&H>1)Ba.call(g,-1,Ja.call(g)-30).then(function(){va.call(g),h.resolve()});else if(O){var a=P?-1:Ja.call(g)+ga,b=P?Ja.call(g)-ga:-1;Ba.call(g,a,b).then(function(){va.call(g),h.resolve()})}else va.call(g),h.resolve();g.system.notify("bufferUpdated")},function(b){g.errHandler.sendError(k.dependencies.ErrorHandler.prototype.MEDIA_ERR_APPEND_SOURCEBUFFER,"Failed to append data into "+e+" source buffer",new k.vo.Error(b.err.code,b.err.name,b.err.message)),b.err.code===k.dependencies.ErrorHandler.prototype.DOM_ERR_QUOTA_EXCEEDED&&(J={data:a,quality:c,index:f},C=h,I=!0,F=0,oa.call(g))}))})}),h.promise):void 0},va=function(){var a,b,c=null;if(this.debug.getLevel()>=this.debug.INFO&&N){if(c=this.sourceBufferExt.getAllRanges(N),null===c||0===c.length)return;for(a=0,b=c.length;b>a;a+=1)this.debug.info("[BufferController]["+e+"] Buffered range ["+a+"]: "+c.start(a)+" - "+c.end(a)+" ("+this.getVideoModel().getCurrentTime()+")")}},wa=function(a,b,c,e){var f,g,h,i=[],k=0,l=Math.pow(256,2),m=Math.pow(256,3),n=Math.max(isNaN(b.startTime)?0:b.startTime,0),o=[];T=!1,h=c.concat(e);for(var p=0;p<h.length;p++)o[h[p].schemeIdUri]=h[p];for(;k<a.length&&(f=String.fromCharCode(a[k+4],a[k+5],a[k+6],a[k+7]),g=a[k]*m+a[k+1]*l+256*a[k+2]+1*a[k+3],"moov"!==f&&"moof"!==f);){if("emsg"===f){T=!0;for(var q=["","",0,0,0,0,""],r=0,s=k+12;g+k>s;)0===r||1===r||6===r?(0!==a[s]?q[r]+=String.fromCharCode(a[s]):r+=1,s+=1):(q[r]=a[s]*m+a[s+1]*l+256*a[s+2]+1*a[s+3],s+=4,r+=1);var t=q[0],u=q[1],v=q[2],w=q[3],x=q[4],y=q[5],z=q[6],A=n*v+w;if(o[t]){var B=new j.vo.Event;B.eventStream=o[t],B.eventStream.value=u,B.eventStream.timescale=v,B.duration=x,B.id=y,B.presentationTime=A,B.messageData=z,B.presentationTimeDelta=w,i.push(B)}}k+=g}return d.when(i)},xa=function(a){if(!T)return d.when(a);for(var b,c,e=a.length,f=0,g=0,h=0,i=Math.pow(256,2),j=Math.pow(256,3),k=new Uint8Array(a.length);e>f;){if(b=String.fromCharCode(a[f+4],a[f+5],a[f+6],a[f+7]),c=a[f]*j+a[f+1]*i+256*a[f+2]+1*a[f+3],"emsg"!==b)for(h=f;f+c>h;h++)k[g]=a[h],g+=1;f+=c}return d.when(k.subarray(0,g))},ya=function(){var a=this;return p?!0:(za.call(a),!1)},za=function(){Z&&(Z.resolve(),Z=null)},Aa=function(){var a,b=this,c=d.defer(),e=0;return I?(a=function(){var b,d,f=this,g=f.videoModel.getCurrentTime(),h=0;d=f.fragmentController.getExecutedRequestForTime(G,g),b=d&&!isNaN(d.startTime)?d.startTime:Math.floor(g),K=d&&!isNaN(d.duration)?d.duration:1,Ba.call(f,h,b).then(function(b){e+=b,e>=K?c.resolve():setTimeout(a,1e3*K)})},a.call(b),c.promise):d.when(!0)},Ba=function(a,b){var f,g,h=this,i=d.defer();return 0===N.buffered.length?(i.resolve(0),i.promise):(f=void 0!==a&&-1!==a?a:N.buffered.start(0),g=void 0!==b&&-1!==b?b:N.buffered.end(N.buffered.length-1),f>=g?(i.resolve(0),i.promise):(h.debug.info("[BufferController]["+e+"] Remove from "+f+" to "+g+" ("+h.getVideoModel().getCurrentTime()+")"),"text"!==e&&h.sourceBufferExt.abort(c,N),h.sourceBufferExt.remove(N,f,g,E.duration,c,_).then(function(){h.fragmentController.removeExecutedRequestsBeforeTime(G,g+1),h.fragmentController.cancelPendingRequestsForModel(G),i.resolve(g-f)},function(a){h.errHandler.sendWarning(k.dependencies.ErrorHandler.prototype.MEDIA_ERR_REMOVE_SOURCEBUFFER,"Failed to remove data from "+e+" source buffer",new k.vo.Error(a.code,a.name,a.message)),i.resolve(0)}),i.promise))},Ca=function(a){if(ya.call(this)){if(za.call(this),a.aborted)return void Pa.call(this);if("text"===e)return void this.errHandler.sendWarning(k.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_CONTENT,"Failed to download media segment",{url:a.url,status:a.status});ca+=1,ca===aa?this.errHandler.sendError(k.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_CONTENT,"Failed to download media segment",{url:a.url,status:a.status}):(this.errHandler.sendWarning(k.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_CONTENT,"Failed to download media segment",{url:a.url,status:a.status}),da=a.startTime+1.5*a.duration,X===V?Ua.call(this,1.5*a.duration):ba=!0)}},Da=function(){var a=this;a.debug.log("[BufferController]["+e+"] Stream is complete."),B=!0,ia(new Date,k.vo.metrics.PlayList.Trace.END_OF_CONTENT_STOP_REASON),za.call(a),oa.call(a),a.system.notify("bufferingCompleted")},Ea=function(b){var c=this;if(ya.call(c))return s[b]?(c.debug.info("[BufferController]["+e+"] Buffer initialization segment, quality = ",b),ua.call(this,s[b],b).then(function(){c.debug.log("[BufferController]["+e+"] Initialization segment buffered"),ya()&&Fa.call(c)}),d.when(null)):this.indexHandler.getInitRequest(a[b])},Fa=function(){var a,c,d=this,f=Ja.call(d);ya.call(d)&&(a=d.sourceBufferExt.getBufferRange(N,f),c=a?a.end:f,-1===fa||t?(d.debug.log("[BufferController]["+e+"] loadNextFragment for time: "+c),d.indexHandler.getSegmentRequestForTime(b,c).then(Ga.bind(d))):(d.debug.log("[BufferController]["+e+"] loadNextFragment for sequence number: "+fa),d.indexHandler.getNextSegmentRequestFromSN(b,fa).then(Ga.bind(d))))},Ga=function(a){var c=this,d=c.manifestModel.getValue();return null!==a&&a.action===a.ACTION_COMPLETE?void Da.call(c):void(null!==a?c.fragmentController.isFragmentLoadedOrPending(c,a)?(c.debug.log("[BufferController]["+e+"] new fragment request => already loaded or pending"),c.indexHandler.getNextSegmentRequest(b).then(Ga.bind(c))):(O&&(a=c.indexHandler.getIFrameRequest(a)),c.fragmentController.prepareFragmentForLoading(c,a,qa,ra,Ca,null).then(function(){ha.call(c)})):(c.debug.log("[BufferController]["+e+"] loadNextFragment failed"),za.call(c),A&&"M3U"===d.name&&Qa.call(c,y).then(function(){b=pa.call(c,y),Na.call(c,0)},function(a){c.errHandler.sendError(a.name,a.message,a.data)})))},Ha=function(){return!!M&&!!N},Ia=function(){var a=this.videoModel.getCurrentTime();return E.start+E.duration-a},Ja=function(){var a=-1,b=this.videoModel.getCurrentTime();return a=t?u:b},Ka=function(){var a,c=this,g=d.defer(),h=b.segmentAvailabilityRange.end;return c.debug.log("[BufferController]["+e+"] Manifest live edge = "+h),a=Math.max(h-f,b.segmentAvailabilityRange.start),this.indexHandler.getSegmentRequestForTime(b,a).then(function(a){E.liveEdge=a.startTime,c.debug.log("[BufferController]["+e+"] Live edge = "+E.liveEdge),g.resolve(E.liveEdge)}),g.promise},La=function(a){if(Ha()){var b=this,c=Ja.call(b);H=b.sourceBufferExt.getBufferLength(N,c),b.debug.log("[BufferController]["+e+"] Working time = "+c+", Buffer level = "+H.toFixed(3)),a&&b.metricsModel.addBufferLevel(e,new Date,H),
b.updateBufferState()}},Ma=function(){var a,b,c=this;ya.call(c)&&(c.debug.log("[BufferController]["+e+"] Check buffer..."),La.call(c,!1),z&&H>g&&ja.call(c,!1),a=Ia.call(c),c.debug.log("[BufferController]["+e+"] time to end = "+a),O?1>H&&Pa.call(c):w||f>H&&(a>f||f>=a&&!B)?Pa.call(c):(b=H-f,c.debug.log("[BufferController]["+e+"] Check buffer in "+b+" seconds"),Na.call(c,b)))},Na=function(a){var b=this,c=Math.max(1e3*a,2e3);b.debug.log("[BufferController]["+e+"] Check buffer delta = "+c+" ms"),clearTimeout(h),h=setTimeout(function(){h=null,Ma.call(b)},c)},Oa=function(){h&&(clearTimeout(h),h=null,Ma.call(this))},Pa=function(){var c,f=this,g=new Date,h=f.videoModel.getCurrentTime(),i=f.manifestModel.getValue(),j=null;null!==Z&&f.debug.error("[BufferController]["+e+"] deferredFragmentBuffered has not been resolved, create a new one is not correct."),Z=d.defer(),f.debug.log("[BufferController]["+e+"] Start buffering process..."),Sa.call(f).then(function(l){var m=l;f.abrController.getPlaybackQuality(e,M).then(function(l){O||f.abrController.setAutoSwitchBitrate(!0),c=l.quality,b=pa.call(f,c),c!==y&&(f.debug.log("[BufferController]["+e+"] currentDownloadQuality changed : "+c),y=c,m=!0,b.segments=null,ia(new Date,k.vo.metrics.PlayList.Trace.REPRESENTATION_SWITCH_STOP_REASON),f.debug.log("[BufferController]["+e+"] Send RepresentationSwitch with quality = "+c),f.metricsModel.addRepresentationSwitch(e,g,h,b.id,c),"M3U"!==i.name||!A&&null!==a[c].initialization||(j=d.defer(),Qa.call(f,c).then(function(){b=pa.call(f,c),j.resolve()},function(a){j.reject(a)}))),d.when(j?j.promise:!0).then(function(){m===!0?Ea.call(f,c).then(function(a){null!==a&&f.fragmentController.prepareFragmentForLoading(f,a,qa,ra,Ca,null).then(function(){ha.call(f)})},function(a){za.call(f),a.name===k.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED?f.errHandler.sendError(a.name,a.message,a.data):f.errHandler.sendError(k.dependencies.ErrorHandler.prototype.INTERNAL_ERROR,"Internal error while processing initialization segment",a.message)}):Fa.call(f)},function(a){za(),f.errHandler.sendError(a.name,a.message,a.data)})})})},Qa=function(b){var c,e=this,f=d.defer(),g=e.manifestModel.getValue();if(ya.call(e))return e.manifestExt.getDataIndex(M,g,E.index).then(function(d){c=g.Period_asArray[E.index].AdaptationSet_asArray[d].Representation_asArray[b],e.parser.hlsParser.updatePlaylist(c).then(function(){Ra.call(e,M,E).then(function(b){a=b,f.resolve()})},function(a){f.reject(a)})}),f.promise},Ra=function(a,b){var c=this,e=d.defer(),f=c.manifestModel.getValue();return c.manifestExt.getDataIndex(a,f,b.index).then(function(a){c.manifestExt.getAdaptationsForPeriod(f,b).then(function(b){c.manifestExt.getRepresentationsForAdaptation(f,b[a]).then(function(a){e.resolve(a)})})}),e.promise},Sa=function(){var b=this,c=d.defer();return v===!1?(c.resolve(!1),c.promise):(b.debug.log("[BufferController]["+e+"] updateData"),s=[],Ra.call(b,M,E).then(function(d){a=d,b.bufferExt.updateData(M,e),v=!1,c.resolve(!0)}),c.promise)},Ta=function(a){var b,c=this,d=0,e=0,f=a.data.request.streamType,g=a.data.httpRequestMetrics,h=a.data.lastTraceTime;c.abrRulesCollection.getRules(k.rules.BaseRulesCollection.prototype.ABANDON_FRAGMENT_RULES).then(function(i){var j=function(d){var e=d.quality,i=c.abrController.getQualityFor(f);i>e&&(c.debug.info("[BufferController]["+f+"] Abandon current fragment : "+a.data.request.url),b=new Date,g.tfinish=b,g.bytesLength=a.data.request.bytesLoaded,c.metricsModel.appendHttpTrace(g,b,b.getTime()-h.getTime(),[a.data.request.bytesLoaded?a.data.request.bytesLoaded:0]),c.fragmentController.abortRequestsForModel(G),c.debug.info("[BufferController]["+f+"] Segment download abandonned => Retry segment download at lowest quality"),c.abrController.setAutoSwitchBitrate(!1),c.abrController.setPlaybackQuality(f,e))};for(d=0,e=i.length;e>d;d+=1)i[d].execute(a.data.request,j)})},Ua=function(a){var b=this;null===ea&&(this.debug.info("[BufferController]["+e+"] Reload session in "+a+" s."),ea=setTimeout(function(){ea=null,b.debug.info("[BufferController]["+e+"] Reload session"),b.system.notify("needForReload")},1e3*a))};return{videoModel:void 0,metricsModel:void 0,manifestExt:void 0,manifestModel:void 0,bufferExt:void 0,sourceBufferExt:void 0,abrController:void 0,parser:void 0,fragmentExt:void 0,indexHandler:void 0,debug:void 0,system:void 0,errHandler:void 0,config:void 0,abrRulesCollection:void 0,initialize:function(a,b,c,d,e,h,i){var j=this,l=j.manifestModel.getValue();j.debug.log("[BufferController]["+a+"] Initialize"),-1!==navigator.userAgent.indexOf("Espial")&&(j.debug.log("[BufferController]["+a+"] Espial browser = sync append"),_=!0),j[k.dependencies.FragmentLoader.eventList.ENAME_LOADING_PROGRESS]=Ta,A=j.manifestExt.getIsDynamic(l),j.setMediaSource(h),j.setType(a),j.setBuffer(d),j.setFragmentController(e),j.setEventController(i),f=j.config.getParamFor(a,"BufferController.minBufferTime","number",-1),g=j.config.getParamFor(a,"BufferController.minBufferTimeForPlaying","number",0),M=c,E=b,v=!0,j.load(),o=!0},load:function(){var a=this,c=a.manifestModel.getValue();Sa.call(this).then(function(){a.abrController.getPlaybackQuality(e,M).then(function(d){b=pa.call(a,d.quality),b&&(K=b.segmentDuration,a.indexHandler.setIsDynamic(A),-1===f&&(f=a.bufferExt.decideBufferLength(c.minBufferTime,E.duration,q)),"video"===e&&(A?a.indexHandler.updateSegmentList(b).then(function(){Ka.call(a).then(function(b){a.system.notify("startTimeFound",b)})}):a.indexHandler.getCurrentTime(b).then(function(c){c<b.segmentAvailabilityRange.start&&(c=b.segmentAvailabilityRange.start),a.system.notify("startTimeFound",c)})))})})},getType:function(){return e},setType:function(a){e=a,void 0!==this.indexHandler&&this.indexHandler.setType(a)},getPeriodInfo:function(){return E},getVideoModel:function(){return this.videoModel},setVideoModel:function(a){this.videoModel=a},getFragmentController:function(){return this.fragmentController},setFragmentController:function(a){a&&(this.fragmentController=a,G=this.fragmentController.attachBufferController(this),G.fragmentLoader.subscribe(k.dependencies.FragmentLoader.eventList.ENAME_LOADING_PROGRESS,this),G.setType(e))},setEventController:function(a){this.eventController=a},getData:function(){return M},updateData:function(a,b){var c=this;c.debug.log("[BufferController]["+e+"] Update data"),w=M&&(null!==M.lang?M.lang:M.id)!==(null!==a.lang?a.lang:a.id)?!0:!1,M=a,E=b,v=!0,w&&(c.debug.log("[BufferController]["+e+"] Language changed"),Oa.call(this))},getCurrentRepresentation:function(){return b},getBuffer:function(){return N},setBuffer:function(a){N=a},getMinBufferTime:function(){return f},setMinBufferTime:function(a){f=a},setMediaSource:function(a){c=a},isReady:function(){return n===m},isBufferingCompleted:function(){return B},clearMetrics:function(){null!==e&&""!==e&&this.metricsModel.clearCurrentMetricsForType(e)},updateManifest:function(){this.system.notify("manifestUpdate")},updateBufferState:function(){var a,b=this,c=this.videoModel.getCurrentTime(),d=-1===Y?c:Y,f=c-d;if(clearTimeout(i),i=null,p!==!1&&"text"!==e&&!O){switch(X){case U:X=V,this.debug.log("[BufferController]["+e+"] BUFFERING - "+c+" - "+H),this.metricsModel.addState(e,"buffering",c);break;case V:if(!this.getVideoModel().isPaused()&&f>0&&H>=1)X=W,this.debug.log("[BufferController]["+e+"] PLAYING - "+c),this.metricsModel.addState(e,"playing",c);else if(!this.getVideoModel().isStalled()&&(a=this.sourceBufferExt.getAllRanges(N),a.length>0)){var g=Ja.call(this)-a.end(a.length-1);this.debug.log("[BufferController]["+e+"] BUFFERING - delay from current time = "+g),g>4&&(this.debug.log("[BufferController]["+e+"] BUFFERING => reload session"),Ua.call(this,1))}break;case W:if(!this.getVideoModel().isPaused()&&(0>=f&&1>=H||0===H)&&(X=V,this.debug.log("[BufferController]["+e+"] BUFFERING - "+c+" - "+H),this.metricsModel.addState(e,"buffering",c),A))if(ba)ba=!1,Ua.call(this,da-c);else{a=this.sourceBufferExt.getAllRanges(N);var h;for(h=0;h<a.length&&!(c<a.start(h));h++);h<a.length&&this.videoModel.setCurrentTime(a.start(h))}i=setTimeout(function(){i=null,La.call(b,!1)},1e3)}c>0&&(Y=c)}},updateStalledState:function(){z=this.videoModel.isStalled()},reset:function(a){var b=this,e=function(a){a&&(a.reject(),a=null)},f=d.defer();return oa.call(b),b.sourceBufferExt.abort(c,N),d.when(Z?Z.promise:!0).then(function(){e(C),e(D),e(Z),G&&(G.fragmentLoader.unsubscribe(k.dependencies.FragmentLoader.eventList.ENAME_LOADING_PROGRESS,b.abrController),b.fragmentController.abortRequestsForModel(G),b.fragmentController.detachBufferController(G),G=null),b.clearMetrics(),s=[],r=!0,I=!1,J=null,L=!1,a||b.sourceBufferExt.removeSourceBuffer(c,N),M=null,N=null,f.resolve()},function(){f.reject()}),f.promise},getSegmentDuration:function(){return ga},setTrickMode:function(a,b){var c=this,f=d.defer();return this.debug.log("[BufferController]["+e+"] setTrickMode - enabled = "+a),O===a?(f.resolve(),f.promise):(O=a,c.fragmentController.setSampleDuration(O),l=O?c.abrController.getQualityFor(e):l,c.abrController.setPlaybackQuality(e,O?0:l),O?(P=b,c.abrController.setAutoSwitchBitrate(!1),f.resolve()):Ba.call(this).then(function(){f.resolve()}),f.promise)},start:la,seek:ma,stop:oa,seeked:na,updateBufferLevel:La}},k.dependencies.BufferController.prototype={constructor:k.dependencies.BufferController},k.dependencies.BufferExtensions=function(){"use strict";var a,b,c=0,e=0,f=null,g=null,h=function(a){var b=this.metricsExt.getCurrentHttpRequest(a);return null!==b?(b.tresponse.getTime()-b.trequest.getTime())/1e3:0},i=function(){var a,b,d,h=this;return a=f?h.abrController.getQualityFor("audio"):c,b=g?h.abrController.getQualityFor("video"):e,d=a===c&&b===e};return{system:void 0,videoModel:void 0,metricsExt:void 0,metricsModel:void 0,abrController:void 0,bufferMax:void 0,updateData:function(a,b){if(a){var d=a.Representation_asArray.length-1;"audio"===b?(c=d,f=a):"video"===b&&(e=d,g=a)}},getTopQualityIndex:function(a){var b=null;return"audio"===a?b=c:"video"===a&&(b=e),b},decideBufferLength:function(b,c){return a=isNaN(c)||k.dependencies.BufferExtensions.DEFAULT_MIN_BUFFER_TIME<c&&c>b?Math.max(k.dependencies.BufferExtensions.DEFAULT_MIN_BUFFER_TIME,b):b>=c?Math.min(c,k.dependencies.BufferExtensions.DEFAULT_MIN_BUFFER_TIME):Math.min(c,b)},getLeastBufferLevel:function(){var a=this.metricsModel.getReadOnlyMetricsFor("video"),b=this.metricsExt.getCurrentBufferLevel(a),c=this.metricsModel.getReadOnlyMetricsFor("audio"),d=this.metricsExt.getCurrentBufferLevel(c),e=null;return e=null===b||null===d?null!==d?d.level:null!==b?b.level:null:Math.min(d.level,b.level)},getRequiredBufferLength:function(c,e,f,g){var j,l=this,m=l.metricsModel.getReadOnlyMetricsFor("video"),n=l.metricsModel.getReadOnlyMetricsFor("audio"),o=g>=k.dependencies.BufferExtensions.LONG_FORM_CONTENT_DURATION_THRESHOLD,p=d.defer(),q=!1;return l.bufferMax===k.dependencies.BufferExtensions.BUFFER_SIZE_MIN?(j=a,p.resolve(j)):l.bufferMax===k.dependencies.BufferExtensions.BUFFER_SIZE_INFINITY?(j=g,p.resolve(j)):l.bufferMax===k.dependencies.BufferExtensions.BUFFER_SIZE_REQUIRED?(b=a,f||c||(q=i.call(l)),q&&(b=o?k.dependencies.BufferExtensions.BUFFER_TIME_AT_TOP_QUALITY_LONG_FORM:k.dependencies.BufferExtensions.BUFFER_TIME_AT_TOP_QUALITY),j=b+e+Math.max(h.call(l,m),h.call(l,n)),p.resolve(j)):p.reject("invalid bufferMax value: "+l.bufferMax),p.promise},getBufferTarget:function(){return void 0===b?a:b}}},k.dependencies.BufferExtensions.BUFFER_SIZE_REQUIRED="required",k.dependencies.BufferExtensions.BUFFER_SIZE_MIN="min",k.dependencies.BufferExtensions.BUFFER_SIZE_INFINITY="infinity",k.dependencies.BufferExtensions.BUFFER_TIME_AT_STARTUP=1,k.dependencies.BufferExtensions.DEFAULT_MIN_BUFFER_TIME=16,k.dependencies.BufferExtensions.BUFFER_TIME_AT_TOP_QUALITY=30,k.dependencies.BufferExtensions.BUFFER_TIME_AT_TOP_QUALITY_LONG_FORM=300,k.dependencies.BufferExtensions.LONG_FORM_CONTENT_DURATION_THRESHOLD=600,k.dependencies.BufferExtensions.prototype.constructor=k.dependencies.BufferExtensions,k.utils.Capabilities=function(){"use strict"},k.utils.Capabilities.prototype={constructor:k.utils.Capabilities,system:void 0,supportsMediaSource:function(){"use strict";var a="WebKitMediaSource"in window,b="MediaSource"in window;return a||b},supportsMediaKeys:function(){"use strict";var a="WebKitMediaKeys"in window,b="MSMediaKeys"in window,c="MediaKeys"in window;return a||b||c},supportsEncryptedMedia:function(){return this.system.hasMapping("protectionModel")},supportsCodec:function(a,b){"use strict";if(!(a instanceof HTMLMediaElement))throw"element must be of type HTMLMediaElement.";var c=a.canPlayType(b);return"probably"===c||"maybe"===c}},k.utils.Config=function(){"use strict";var a=["video","audio"],b={"BufferController.minBufferTimeForPlaying":-1,"BufferController.minBufferTime":-1,"ABR.minBandwidth":-1,"ABR.maxBandwidth":-1,"ABR.minQuality":-1,"ABR.maxQuality":-1,"ABR.switchUpIncrementally":!1,"ABR.switchUpRatioSafetyFactor":-1,"ABR.latencyInBandwidth":!0,"ABR.switchDownBufferTime":-1,"ABR.switchDownBufferRatio":-1,"ABR.switchLowerBufferTime":-1,"ABR.switchLowerBufferRatio":-1,"ABR.switchUpBufferTime":-1,"ABR.switchUpBufferRatio":-1,"ABR.keepBandwidthCondition":!0,"ManifestLoader.RetryAttempts":-1,"ManifestLoader.RetryInterval":-1,"FragmentLoader.RetryAttempts":-1,"FragmentLoader.RetryInterval":-1,video:{},audio:{}},c=function(c){var d,e,f;for(d in c)if(c.hasOwnProperty(d)&&-1===d.indexOf("//"))if(a.indexOf(d)>-1){e=c[d];for(f in e)e.hasOwnProperty(f)&&(b[d][f]=c[d][f])}else b[d]=c[d]},d=function(a,b,c,d){var e=a[b];if(void 0===e||-1===e)return d;if(void 0!==c&&typeof e!==c)switch(c){case"number":e=Number(e);break;case"boolean":e="true"===e||"1"===e||1===e}return e},e=function(a,c,e){return d(b,a,c,e)},f=function(a,c,e,f){var g=b[a];return void 0!==g&&void 0!==g[c]?d(g,c,e,f):d(b,c,e,f)};return{debug:void 0,setup:function(){},setParams:function(a){c(a);var b=this.getParam("Debug.level","number",-1);-1!==b&&this.debug.setLevel(b)},getParam:function(a,b,c){return e(a,b,c)},getParamFor:function(a,b,c,d){return f(a,b,c,d)}}},k.utils.Config.prototype={constructor:k.utils.Config},k.di.Context=function(){"use strict";var a=function(){var a=document.createElement("video"),b=this.system.getObject("debug");k.models.ProtectionModel_21Jan2015.detect(a)?this.system.mapSingleton("protectionModel",k.models.ProtectionModel_21Jan2015):k.models.ProtectionModel_3Feb2014.detect(a)?this.system.mapClass("protectionModel",k.models.ProtectionModel_3Feb2014):k.models.ProtectionModel_01b.detect(a)?this.system.mapClass("protectionModel",k.models.ProtectionModel_01b):(b.log("No supported version of EME detected on this user agent!"),b.log("Attempts to play encrypted content will fail!"))};return{system:void 0,setup:function(){this.system.autoMapOutlets=!0,this.system.mapSingleton("debug",k.utils.Debug),this.system.mapClass("domParser",k.utils.DOMParser),this.system.mapSingleton("tokenAuthentication",k.utils.TokenAuthentication),this.system.mapSingleton("eventBus",k.utils.EventBus),this.system.mapSingleton("capabilities",k.utils.Capabilities),this.system.mapSingleton("textTrackExtensions",k.utils.TextTrackExtensions),this.system.mapSingleton("vttParser",k.utils.VTTParser),this.system.mapSingleton("ttmlParser",k.utils.TTMLParser),this.system.mapSingleton("videoModel",k.models.VideoModel),this.system.mapSingleton("manifestModel",k.models.ManifestModel),this.system.mapSingleton("metricsModel",k.models.MetricsModel),this.system.mapSingleton("uriQueryFragModel",k.models.URIQueryAndFragmentModel),this.system.mapSingleton("ksPlayReady",k.dependencies.protection.KeySystem_PlayReady),this.system.mapSingleton("ksWidevine",k.dependencies.protection.KeySystem_Widevine),this.system.mapSingleton("ksClearKey",k.dependencies.protection.KeySystem_ClearKey),this.system.mapSingleton("serverPlayReady",k.dependencies.protection.servers.PlayReady),this.system.mapSingleton("serverWidevine",k.dependencies.protection.servers.Widevine),this.system.mapSingleton("serverClearKey",k.dependencies.protection.servers.ClearKey),this.system.mapSingleton("serverDRMToday",k.dependencies.protection.servers.DRMToday),this.system.mapSingleton("textSourceBuffer",k.dependencies.TextSourceBuffer),this.system.mapSingleton("textTTMLXMLMP4SourceBuffer",k.dependencies.TextTTMLXMLMP4SourceBuffer),this.system.mapSingleton("mediaSourceExt",k.dependencies.MediaSourceExtensions),this.system.mapSingleton("sourceBufferExt",k.dependencies.SourceBufferExtensions),this.system.mapSingleton("bufferExt",k.dependencies.BufferExtensions),this.system.mapSingleton("abrController",k.dependencies.AbrController),this.system.mapSingleton("errHandler",k.dependencies.ErrorHandler),this.system.mapSingleton("videoExt",k.dependencies.VideoModelExtensions),this.system.mapSingleton("protectionExt",k.dependencies.ProtectionExtensions),this.system.mapClass("protectionController",k.dependencies.ProtectionController),a.call(this),this.system.mapClass("metrics",k.models.MetricsList),this.system.mapClass("abandonRequestRule",k.rules.AbandonRequestsRule),this.system.mapClass("limitSwitchesRule",k.rules.LimitSwitchesRule),this.system.mapClass("abrRulesCollection",k.rules.BaseRulesCollection),this.system.mapClass("eventController",k.dependencies.EventController),this.system.mapClass("textController",k.dependencies.TextController),this.system.mapClass("bufferController",k.dependencies.BufferController),this.system.mapClass("manifestLoader",k.dependencies.ManifestLoader),this.system.mapSingleton("manifestUpdater",k.dependencies.ManifestUpdater),this.system.mapClass("fragmentController",k.dependencies.FragmentController),this.system.mapClass("fragmentLoader",k.dependencies.FragmentLoader),this.system.mapClass("fragmentModel",k.dependencies.FragmentModel),this.system.mapSingleton("streamController",k.dependencies.StreamController),this.system.mapClass("stream",k.dependencies.Stream),this.system.mapSingleton("notifier",k.dependencies.Notifier),this.system.mapClass("indexHandler",j.dependencies.DashHandler),this.system.mapClass("baseURLExt",j.dependencies.BaseURLExtensions),this.system.mapClass("fragmentExt",j.dependencies.FragmentExtensions),this.system.mapSingleton("manifestExt",j.dependencies.DashManifestExtensions),this.system.mapSingleton("timelineConverter",j.dependencies.TimelineConverter),this.system.mapSingleton("parser",k.dependencies.Parser),this.system.mapClass("dashParser",j.dependencies.DashParser),this.system.mapClass("mssParser",g.dependencies.MssParser),this.system.mapClass("hlsParser",h.dependencies.HlsParser),this.system.mapClass("hlsDemux",h.dependencies.HlsDemux),this.system.mapSingleton("contextManager",k.modules.ContextManager),this.system.mapSingleton("metricsExt",k.dependencies.MetricsExtensions),this.system.mapSingleton("config",k.utils.Config),this.system.mapClass("downloadRatioRule",k.rules.o.DownloadRatioRule),this.system.mapClass("insufficientBufferRule",k.rules.o.InsufficientBufferRule),this.system.mapHandler("setContext","contextManager","setContext")}}},k.modules.ContextManager=function(){"use strict";return{system:void 0,debug:void 0,setContext:function(a){this.system.autoMapOutlets=!0,"MSS"===a?(this.system.mapClass("mp4Processor",k.dependencies.Mp4Processor),this.system.mapClass("indexHandler",g.dependencies.MssHandler),this.system.mapClass("fragmentController",g.dependencies.MssFragmentController)):"HLS"===a?(this.system.mapClass("mp4Processor",k.dependencies.Mp4Processor),this.system.mapClass("fragmentController",h.dependencies.HlsFragmentController),this.system.mapClass("indexHandler",h.dependencies.HlsHandler)):(this.system.mapClass("fragmentController",k.dependencies.FragmentController),this.system.mapClass("indexHandler",j.dependencies.DashHandler))}}},k.modules.ContextManager.prototype={constructor:k.modules.ContextManager},k.utils.Debug=function(){"use strict";Date.prototype.HHMMSSmmm=function(){var a=this.getHours().toString(),b=this.getMinutes().toString(),c=this.getSeconds().toString(),d=this.getMilliseconds().toString(),e=a[1]?a:"0"+a[0],f=b[1]?b:"0"+b[0],g=c[1]?c:"0"+c[0],h=d[2]?d:"0"+(d[1]?d:"0"+d[0]);return e+":"+f+":"+g+"."+h},Date.prototype.MMSSmmm=function(){var a=this.getMinutes().toString(),b=this.getSeconds().toString(),c=this.getMilliseconds().toString(),d=a[1]?a:"0"+a[0],e=b[1]?b:"0"+b[0],f=c[2]?c:"0"+(c[1]?c:"0"+c[0]);return d+":"+e+"."+f};var a=function(){this.logArray=[],this.showLevel=!0};a.prototype.error=a.prototype.warn=a.prototype.info=a.prototype.debug=function(a){this.logArray.push(a)},a.prototype.getLogs=function(){return this.logArray};var b=0,c=1,d=2,e=3,f=4,g=4,h=0,i=!0,j=!1,k=new Date,l=console,m=function(a,b){if(a<=p()){var g=n(a,b);switch(a){case c:l.error(g);break;case d:l.warn(g);break;case e:l.info(g);break;case f:l.debug(g)}}},n=function(a,b){var c="",d=null;return i&&(d=new Date,c+="["+d.HHMMSSmmm()+"]"),l&&l.showLevel&&(c+="["+o(a)+"]"),j&&(c+="["+new Date(d-k).MMSSmmm()+"]"),Array.apply(null,b).forEach(function(a){c+=a+" "}),c},o=function(a){switch(a){case c:return"ERROR";case d:return"WARN";case e:return"INFO";case f:return"DEBUG";default:return""}},p=function(){return h},q=function(){return l};return{NONE:b,ERROR:c,WARN:d,INFO:e,DEBUG:f,ALL:g,getLevel:p,getLogger:q,setLevel:function(a){h=a},setLogger:function(b){switch(b){case"log4javascript":var c=new log4javascript.PopUpAppender,d=new log4javascript.PatternLayout("%d{HH:mm:ss.SSS} %-5p - %m%n");c.setLayout(d),l.addAppender(c),l.setLevel(log4javascript.Level.ALL),l.initialized=!0;break;case"memory":l=new a;break;case"console":l=console;break;default:l=null}},error:function(){m.call(this,c,arguments)},warn:function(){m.call(this,d,arguments)},info:function(){m.call(this,e,arguments)},log:function(){m.call(this,f,arguments)}}},k.dependencies.ErrorHandler=function(){"use strict";return{eventBus:void 0,debug:void 0,sendWarning:function(a,b,c){this.eventBus.dispatchEvent({type:"warning",data:{code:a,message:b,data:c}}),this.debug.warn("[Warn] Code: "+a+", Message: "+b+", Data: "+JSON.stringify(c,null,"	"))},sendError:function(a,b,c){this.eventBus.dispatchEvent({type:"error",data:{code:a,message:b,data:c}}),this.debug.error("[Error] Code: "+a+", Message: "+b+", Data: "+JSON.stringify(c,null,"	"))}}},k.dependencies.ErrorHandler.prototype={constructor:k.dependencies.ErrorHandler},k.dependencies.ErrorHandler.prototype.INTERNAL_ERROR="INTERNAL_ERROR",k.dependencies.ErrorHandler.prototype.MEDIA_ERR_ABORTED="MEDIA_ERR_ABORTED",k.dependencies.ErrorHandler.prototype.MEDIA_ERR_NETWORK="MEDIA_ERR_NETWORK",k.dependencies.ErrorHandler.prototype.MEDIA_ERR_DECODE="MEDIA_ERR_DECODE",k.dependencies.ErrorHandler.prototype.MEDIA_ERR_SRC_NOT_SUPPORTED="MEDIA_ERR_SRC_NOT_SUPPORTED",k.dependencies.ErrorHandler.prototype.MEDIA_ERR_ENCRYPTED="MEDIA_ERR_ENCRYPTED",k.dependencies.ErrorHandler.prototype.CAPABILITY_ERR_MEDIASOURCE="CAPABILITY_ERR_MEDIASOURCE",k.dependencies.ErrorHandler.prototype.CAPABILITY_ERR_MEDIAKEYS="CAPABILITY_ERR_MEDIAKEYS",k.dependencies.ErrorHandler.prototype.MEDIA_ERR_CREATE_MEDIASOURCE="MEDIA_ERR_CREATE_MEDIASOURCE",k.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED="MEDIA_ERR_CODEC_UNSUPPORTED",k.dependencies.ErrorHandler.prototype.MEDIA_ERR_CREATE_SOURCEBUFFER="MEDIA_ERR_CREATE_SOURCEBUFFER",k.dependencies.ErrorHandler.prototype.MEDIA_ERR_APPEND_SOURCEBUFFER="MEDIA_ERR_APPEND_SOURCEBUFFER",k.dependencies.ErrorHandler.prototype.MEDIA_ERR_REMOVE_SOURCEBUFFER="MEDIA_ERR_REMOVE_SOURCEBUFFER",k.dependencies.ErrorHandler.prototype.MANIFEST_ERR_PARSE="MANIFEST_ERR_PARSE",k.dependencies.ErrorHandler.prototype.MANIFEST_ERR_NO_STREAM="MANIFEST_ERR_NO_STREAM",k.dependencies.ErrorHandler.prototype.MANIFEST_ERR_NO_VIDEO="MANIFEST_ERR_NO_VIDEO",k.dependencies.ErrorHandler.prototype.MANIFEST_ERR_NO_AUDIO="MANIFEST_ERR_NO_AUDIO",k.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_MANIFEST="DOWNLOAD_ERR_MANIFEST",k.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_SIDX="DOWNLOAD_ERR_SIDX",k.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_INIT="DOWNLOAD_ERR_INIT",k.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_CONTENT="DOWNLOAD_ERR_CONTENT",k.dependencies.ErrorHandler.prototype.CC_ERR_PARSE="CC_ERR_PARSE",k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR="MEDIA_KEYERR",k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_UNKNOWN="MEDIA_KEYERR_UNKNOWN",k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_CLIENT="MEDIA_KEYERR_CLIENT",k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_SERVICE="MEDIA_KEYERR_SERVICE",k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_OUTPUT="MEDIA_KEYERR_OUTPUT",k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_HARDWARECHANGE="MEDIA_KEYERR_HARDWARECHANGE",k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_DOMAIN="MEDIA_KEYERR_DOMAIN",k.dependencies.ErrorHandler.prototype.MEDIA_KEYSYSERR_ACCESS_DENIED="MEDIA_KEYSYSERR_ACCESS_DENIED",k.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_URL_LICENSER_UNKNOWN="MEDIA_KEYMESSERR_URL_LICENSER_UNKNOWN",k.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_NO_CHALLENGE="MEDIA_KEYMESSERR_NO_CHALLENGE",k.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_LICENSER_ERROR="MEDIA_KEYMESSERR_LICENSER_ERROR",k.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_NO_SESSION="MEDIA_KEYMESSERR_NO_SESSION",k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_SERVER_CERTIFICATE="MEDIA_KEYERR_SERVER_CERTIFICATE",k.dependencies.ErrorHandler.prototype.DOM_ERR_INDEX_SIZE=1,k.dependencies.ErrorHandler.prototype.DOM_ERR_HIERARCHY_REQUEST=3,k.dependencies.ErrorHandler.prototype.DOM_ERR_WRONG_DOCUMENT=4,k.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_CHARACTER=5,k.dependencies.ErrorHandler.prototype.DOM_ERR_NO_MODIFICATION_ALLOWED=7,k.dependencies.ErrorHandler.prototype.DOM_ERR_NOT_FOUND=8,k.dependencies.ErrorHandler.prototype.DOM_ERR_NOT_SUPPORTED=9,k.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_STATE=11,k.dependencies.ErrorHandler.prototype.DOM_ERR_SYNTAX=12,k.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_MODIFICATION=13,k.dependencies.ErrorHandler.prototype.DOM_ERR_NAMESPACE=14,k.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_ACCESS=15,k.dependencies.ErrorHandler.prototype.DOM_ERR_SECURITY=18,k.dependencies.ErrorHandler.prototype.DOM_ERR_NETWORK=19,k.dependencies.ErrorHandler.prototype.DOM_ERR_ABORT=20,k.dependencies.ErrorHandler.prototype.DOM_ERR_URL_MISMATCH=21,k.dependencies.ErrorHandler.prototype.DOM_ERR_QUOTA_EXCEEDED=22,k.dependencies.ErrorHandler.prototype.DOM_ERR_TIMEOUT=23,k.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_NODE_TYPE=24,k.dependencies.ErrorHandler.prototype.DOM_ERR_DATA_CLONE=25,k.utils.EventBus=function(){"use strict";var a,b=function(b,c){var d=(c?"1":"0")+b;return d in a||(a[d]=[]),a[d]},c=function(){a={}};return c(),{addEventListener:function(a,c,d){var e=b(a,d),f=e.indexOf(c);-1===f&&e.push(c)},removeEventListener:function(a,c,d){var e=b(a,d),f=e.indexOf(c);-1!==f&&e.splice(f,1)},dispatchEvent:function(a){var c=b(a.type,!1).slice(),d=0;for(d=0;d<c.length;d+=1)c[d].call(this,a);return!a.defaultPrevented}}},k.dependencies.EventController=function(){"use strict";var a=[],b=[],c=[],d=null,e=100,f=e/1e3,g="urn:mpeg:dash:event:2012",h=1,i=function(){null!==d&&(clearInterval(d),d=null),a=null,b=null,c=null},j=function(){null!==d&&(clearInterval(d),d=null)},k=function(){var a=this;a.debug.log("[EventController] Start Event Controller"),isNaN(e)||(d=setInterval(n.bind(this),e))},l=function(b){var c=this;a=[],b&&b.length>0&&(a=b),c.debug.log("[EventController] Added "+b.length+" inline events")},m=function(a){var c,d=this,e=0;for(e=0;e<a.length;e++)c=a[e],b[c.id]=c,d.debug.log("[EventController] Add inband event with id "+c.id)},n=function(){o.call(this,b),o.call(this,a),p.call(this)},o=function(a){var b,d,e=this,i=this.videoModel.getCurrentTime(),j=0;if(a)for(j=0;j<a.length;j++)d=a[j],void 0!==d&&(b=d.presentationTime/d.eventStream.timescale,(0===b||i>=b&&b+f>i)&&(e.debug.log("[EventController] Start Event at "+i),d.duration>0&&c.push(d),d.eventStream.schemeIdUri===g&&d.eventStream.value===h&&q.call(this),a.splice(j,1)))},p=function(){var a,b,d=this,e=0;if(c)for(a=this.videoModel.getCurrentTime(),e=0;e<c.length;e++)b=c[e],null!==b&&(b.duration+b.presentationTime)/b.eventStream.timescale<a&&(d.debug.log("[EventController] Remove Event at time "+a),b=null,c.splice(e,1))},q=function(){var a=this,b=a.manifestModel.getValue(),c=b.mpdUrl;b.hasOwnProperty("Location")&&(c=b.Location),a.debug.log("[EventController] Refresh manifest @ "+c),a.manifestLoader.load(c).then(function(b){a.manifestModel.setValue(b)})};return{manifestModel:void 0,manifestLoader:void 0,debug:void 0,system:void 0,videoModel:void 0,addInlineEvents:l,addInbandEvents:m,reset:i,clear:j,start:k}},k.dependencies.EventController.prototype={constructor:k.dependencies.EventController},k.dependencies.FragmentController=function(){"use strict";var a=[],b=function(b){var c=a.length,d=0;for(d=0;c>d;d+=1)if(a[d].getContext()===b)return a[d];return null},c=function(){var b=!0,c=a.length,d=0;for(d=0;c>d;d+=1)if(!a[d].isReady()){b=!1;break}return b},e=function(){var b=0;for(b=0;b<a.length;b+=1)a[b].executeCurrentRequest()};return{system:void 0,debug:void 0,process:function(a){var b=null;return null!==a&&void 0!==a&&a.byteLength>0&&(b=new Uint8Array(a)),d.when(b)},attachBufferController:function(c){var d;return c?(d=b(c),d||(d=this.system.getObject("fragmentModel"),d.setContext(c),a.push(d)),d):null},detachBufferController:function(b){var c=a.indexOf(b);c>-1&&a.splice(c,1)},onBufferControllerStateChange:function(){c()&&e.call(this)},isFragmentLoadedOrPending:function(a,c){var d,e=b(a);return e?d=e.isFragmentLoadedOrPending(c):!1},getPendingRequests:function(a){var c=b(a);return c?c.getPendingRequests():null},getLoadingRequests:function(a){var c=b(a);return c?c.getLoadingRequests():null},isInitializationRequest:function(a){return a&&a.type&&"initialization segment"===a.type.toLowerCase()},getLoadingTime:function(a){var c=b(a);return c?c.getLoadingTime():null},getExecutedRequestForTime:function(a,b){return a?a.getExecutedRequestForTime(b):null},removeExecutedRequest:function(a,b){a&&a.removeExecutedRequest(b)},removeExecutedRequestsBeforeTime:function(a,b){a&&a.removeExecutedRequestsBeforeTime(b)},clearExecutedRequests:function(a){a&&a.clearExecutedRequests()},cancelPendingRequestsForModel:function(a){a&&a.cancelPendingRequests()},abortRequestsForModel:function(a){a&&a.abortRequests()},prepareFragmentForLoading:function(a,c,e,f,g,h){var i=b(a);return i&&c?(i.addRequest(c),i.setCallbacks(e,f,g,h),d.when(!0)):d.when(null)}}},k.dependencies.FragmentController.prototype={constructor:k.dependencies.FragmentController},k.dependencies.FragmentLoader=function(){"use strict";var a,b=2,c=500,e=b,f=c,g=0,h=[],i=function(a){var b=new XMLHttpRequest,c=!1;b.open("HEAD",a.url,!0),b.onload=function(){b.status<200||b.status>399||(c=!0,a.deferred.resolve(a))},b.onloadend=b.onerror=function(){c||a.deferred.reject(b)},b.send()},j=function(b,c){var e=d.defer(),f=new XMLHttpRequest,g=null,i=!0,j=!0,l=null,m=this;return h.push(f),b.requestStartDate=new Date,g=m.metricsModel.addHttpRequest(b.streamType,null,b.type,b.url,null,b.range,b.requestStartDate,null,null,null,null,b.duration,b.startTime,b.quality),m.metricsModel.appendHttpTrace(g,b.requestStartDate,b.requestStartDate.getTime()-b.requestStartDate.getTime(),[0]),l=b.requestStartDate,f.open("GET",m.tokenAuthentication.addTokenAsQueryArg(b.url),!0),f.responseType="arraybuffer",f=m.tokenAuthentication.setTokenInRequestHeader(f),c&&f.setRequestHeader("Range",c),f.onprogress=function(a){var c=new Date;i&&(i=!1,(!a.lengthComputable||a.lengthComputable&&a.total!==a.loaPded)&&(b.firstByteDate=c,g.tresponse=c)),a.lengthComputable&&(b.bytesLoaded=a.loaded,b.bytesTotal=a.total),m.metricsModel.appendHttpTrace(g,c,c.getTime()-l.getTime(),[b.bytesLoaded?b.bytesLoaded:0]),l=c,m.notify(k.dependencies.FragmentLoader.eventList.ENAME_LOADING_PROGRESS,{request:b,httpRequestMetrics:g,lastTraceTime:l})},f.onload=function(){if(!(f.status<200||f.status>399)){
j=!1;var c,d,h=new Date,i=f.response;b.firstByteDate||(b.firstByteDate=b.requestStartDate),b.requestEndDate=h,c=b.firstByteDate.getTime()-b.requestStartDate.getTime(),d=b.requestEndDate.getTime()-b.firstByteDate.getTime(),m.debug.log("[FragmentLoader]["+a+"] Loaded: "+b.url+" ("+f.status+", "+c+"ms, "+d+"ms)"),g.tresponse=b.firstByteDate,g.tfinish=b.requestEndDate,g.responsecode=f.status,g.bytesLength=i?i.byteLength:0,m.metricsModel.appendHttpTrace(g,h,h.getTime()-l.getTime(),[i?i.byteLength:0]),l=h,e.resolve({data:i,request:b})}},f.onabort=function(){f.aborted=!0},f.onloadend=f.onerror=function(){if(-1!==h.indexOf(f)&&(h.splice(h.indexOf(f),1),j)){j=!1;var a,c,d=new Date,i=f.response;b.firstByteDate||(b.firstByteDate=b.requestStartDate),b.requestEndDate=d,a=b.firstByteDate.getTime()-b.requestStartDate.getTime(),c=b.requestEndDate.getTime()-b.firstByteDate.getTime(),g.tresponse=b.firstByteDate,g.tfinish=b.requestEndDate,g.responsecode=f.status,m.metricsModel.appendHttpTrace(g,d,d.getTime()-l.getTime(),[i?i.byteLength:0]),l=d,e.reject(f)}},m.debug.log("[FragmentLoader]["+a+"] Load: "+b.url),f.send(),e.promise},l=function(a,b){var c=this;g++,setTimeout(function(){j.call(c,a).then(function(a){g=0,b.resolve(a)},function(d){e>g?l.call(c,a,b):(g=0,b.reject(d))})},f)};return{metricsModel:void 0,debug:void 0,tokenAuthentication:void 0,config:void 0,notify:void 0,subscribe:void 0,unsubscribe:void 0,setup:function(){e=this.config.getParam("FragmentLoader.RetryAttempts","number",b),f=this.config.getParam("FragmentLoader.RetryInterval","number",c)},setType:function(b){a=b},load:function(a){var b=this,c=d.defer();return"Initialization Segment"===a.type&&a.data?c.resolve(a,{data:a.data}):j.call(this,a).then(function(a){c.resolve(a)},function(d){d.aborted?(a.status=0,a.aborted=!0,c.reject(a)):0>=e?(a.status=d.status,c.reject(a)):l.call(b,a,c)}),c.promise},abort:function(){var b=0;for(b=0;b<h.length;b+=1)this.debug.log("[FragmentLoader]["+a+"] Abort XHR "+(h[b].responseURL?h[b].responseURL:"")),h[b].abort();h.length=0,h=[]},checkForExistence:function(a){return a?(a.deferred=d.defer(),i.call(this,a),a.deferred.promise):d.when(null)}}},k.dependencies.FragmentLoader.prototype={constructor:k.dependencies.FragmentLoader},k.dependencies.FragmentLoader.eventList={ENAME_LOADING_PROGRESS:"loadingProgress"},k.dependencies.FragmentModel=function(){"use strict";var a,b,c,d,e,f,g=[],h=[],i=[],j=2,k=function(e){var f,h,j=this;b.call(a,e),f=function(b,d){i.splice(i.indexOf(b),1),g.push(b),c.call(a,b,d),b.deferred=null},h=function(b){i.splice(i.indexOf(b),1),d.call(a,b),b.deferred=null},j.fragmentLoader.load(e).then(f.bind(a,e),h.bind(a,e))},l=function(a,b){var c=function(a,c){return a[b]<c[b]?-1:a[b]>c[b]?1:0};a.sort(c)},m=function(a){var b=g.indexOf(a);-1!==b&&g.splice(b,1)};return{system:void 0,debug:void 0,fragmentLoader:void 0,setContext:function(b){a=b},getContext:function(){return a},setType:function(a){f=a,this.fragmentLoader&&this.fragmentLoader.setType(a)},addRequest:function(a){if(a){if(this.isFragmentLoadedOrPending(a))return;h.push(a),l.call(this,h,"index")}},setCallbacks:function(a,f,g,h){b=a,e=h,d=g,c=f},isFragmentLoadedOrPending:function(a){var b,c=!1,d=g.length,e=0;for(e=0;d>e;e++)if(b=g[e],a.startTime===b.startTime||"complete"===b.action&&a.action===b.action){if(a.url===b.url){c=!0;break}m(a)}if(!c)for(e=0,d=h.length;d>e;e+=1)b=h[e],a.url===b.url&&a.startTime===b.startTime&&(c=!0);if(!c)for(e=0,d=i.length;d>e;e+=1)b=i[e],a.url===b.url&&a.startTime===b.startTime&&(c=!0);return c},isReady:function(){return a.isReady()},getPendingRequests:function(){return h},getLoadingRequests:function(){return i},getLoadingTime:function(){var a,b,c=0;for(b=g.length-1;b>=0;b-=1)if(a=g[b],a.requestEndDate instanceof Date&&a.firstByteDate instanceof Date){c=a.requestEndDate.getTime()-a.firstByteDate.getTime();break}return c},getExecutedRequestForTime:function(a){var b,c=g.length-1,d=NaN,e=NaN,f=null;for(b=c;b>=0;b-=1)if(f=g[b],d=f.startTime,e=d+f.duration,!isNaN(d)&&!isNaN(e)&&a>d&&e>a)return f;return null},getExecutedRequestForQualityAndIndex:function(a,b){var c,d=g.length-1,e=null;for(c=d;c>=0;c-=1)if(e=g[c],e.quality===a&&e.index===b)return e;return null},removeExecutedRequest:function(a){m.call(this,a)},removeExecutedRequestsBeforeTime:function(a){var b,c=g.length-1,d=NaN,e=null;for(b=c;b>=0;b-=1)e=g[b],d=e.startTime,!isNaN(d)&&a>d&&m.call(this,e)},clearExecutedRequests:function(){g=[]},cancelPendingRequests:function(){h=[]},abortRequests:function(){this.fragmentLoader.abort(),i=[]},executeCurrentRequest:function(){var b,c=this;if(0!==h.length&&!(i.length>=j))switch(b=h.shift(),b.action){case"complete":g.push(b),e.call(a,b);break;case"download":i.push(b),k.call(c,b);break;default:this.debug.log("Unknown request action."),b.deferred?(b.deferred.reject(),b.deferred=null):d.call(a,b)}}}},k.dependencies.FragmentModel.prototype={constructor:k.dependencies.FragmentModel},k.dependencies.ManifestLoader=function(){"use strict";var a=2,b=500,c=a,e=b,f=0,g=null,h=null,i=function(a){var b,c="",d=0;if(a.length<1)return a;if(15360!==a.charCodeAt(0))return a;for(d=0;d<a.length;d+=1)b=a.charCodeAt(d),c+=String.fromCharCode((255&b)<<8|(65280&b)>>8);return c},j=function(a){var b=null;return-1!==a.indexOf("/")&&(-1!==a.indexOf("?")&&(a=a.substring(0,a.indexOf("?"))),b=a.substring(0,a.lastIndexOf("/")+1)),b},l=function(){null!==h&&h.readyState>0&&h.readyState<4&&(this.debug.log("[ManifestLoader] Manifest download abort."),h.abort()),this.parser.abort()},m=function(a){var b=j(a),d=new Date,l=null,n=!0,o=null,p=null,q=null,r=this;q=function(){h.aborted=!0},o=function(){h.status<200||h.status>299||200===h.status&&4===h.readyState&&(r.debug.log("[ManifestLoader] Manifest downloaded"),h.responseURL&&(r.debug.log("[ManifestLoader] Redirect URL: "+h.responseURL),b=j(h.responseURL)),n=!1,l=new Date,r.tokenAuthentication.checkRequestHeaderForToken(h),r.metricsModel.addHttpRequest("stream",null,"MPD",a,null,null,d,l,h.status,null,null),r.parser.parse(i(h.responseText),b).then(function(b){b.mpdUrl=a,b.mpdLoadedTime=l,r.metricsModel.addManifestUpdate("stream",b.type,d,l,b.availabilityStartTime),g.resolve(b)},function(){r.debug.error("[ManifestLoader] Manifest parsing error"),g.reject({name:k.dependencies.ErrorHandler.prototype.MANIFEST_ERR_PARSE,message:"Failed to parse manifest",data:{url:a}})}))},p=function(){n&&(n=!1,r.metricsModel.addHttpRequest("stream",null,"MPD",a,null,null,d,new Date,h.status,null,null),h.aborted?g.reject():(f++,c>0&&c>=f?setTimeout(function(){m.call(r,a)},e):g.reject({name:k.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_MANIFEST,message:"Failed to download manifest",data:{url:a,status:h.status}})))};try{h.onload=o,h.onloadend=p,h.onerror=p,h.onabort=q,h.open("GET",a,!0),h.send()}catch(s){h.onerror()}};return{debug:void 0,parser:void 0,config:void 0,metricsModel:void 0,tokenAuthentication:void 0,setup:function(){c=this.config.getParam("ManifestLoader.RetryAttempts","number",a),e=this.config.getParam("ManifestLoader.RetryInterval","number",b)},load:function(a){return g=d.defer(),h=new XMLHttpRequest,f=0,m.call(this,a),g.promise},abort:l}},k.dependencies.ManifestLoader.prototype={constructor:k.dependencies.ManifestLoader},k.dependencies.ManifestUpdater=function(){"use strict";var a,b=NaN,c=null,e=!1,f=function(){null!==c&&(clearInterval(c),c=null)},g=function(){f.call(this),isNaN(b)||(this.debug.log("Refresh manifest in "+b+" seconds."),c=setTimeout(i.bind(this),Math.min(1e3*b,Math.pow(2,31)-1),this))},h=function(){var a,c=this,d=c.manifestModel.getValue();void 0!==d&&null!==d&&c.manifestExt.getRefreshDelay(d).then(function(e){a=((new Date).getTime()-d.mpdLoadedTime.getTime())/1e3,b=Math.max(e-a,0),g.call(c)})},i=function(){var b,c,f=this;d.when(a?a.promise:!0).then(function(){a=d.defer(),b=f.manifestModel.getValue(),c=b.mpdUrl,b.hasOwnProperty("Location")&&(c=b.Location),f.manifestLoader.load(c).then(function(a){f.manifestModel.setValue(a),f.debug.log("Manifest has been refreshed."),e||h.call(f)})})},j=function(){a&&a.resolve()};return{debug:void 0,system:void 0,manifestModel:void 0,manifestExt:void 0,manifestLoader:void 0,setup:function(){h.call(this),this.system.mapHandler("streamsComposed",void 0,j.bind(this))},start:function(){e=!1,h.call(this)},stop:function(){e=!0,f.call(this)}}},k.dependencies.ManifestUpdater.prototype={constructor:k.dependencies.ManifestUpdater},k.models.ManifestModel=function(){"use strict";var a=null;return{system:void 0,eventBus:void 0,getValue:function(){return a},setValue:function(b){a=b,a&&this.system.notify("manifestUpdated"),null!==a&&this.eventBus.dispatchEvent({type:"manifestLoaded",data:b})}}},k.models.ManifestModel.prototype={constructor:k.models.ManifestModel},k.dependencies.MediaSourceExtensions=function(){"use strict"},k.dependencies.MediaSourceExtensions.prototype={constructor:k.dependencies.MediaSourceExtensions,createMediaSource:function(){"use strict";var a="WebKitMediaSource"in window,b="MediaSource"in window;return b?new MediaSource:a?new WebKitMediaSource:null},attachMediaSource:function(a,b){"use strict";return b.setSource(window.URL.createObjectURL(a)),d.when(!0)},detachMediaSource:function(a){"use strict";return a.setSource(""),d.when(!0)},setDuration:function(a,b){"use strict";return a.duration=b,d.when(a.duration)},signalEndOfStream:function(a){"use strict";return a.endOfStream(),d.when(!0)}},k.dependencies.MetricsExtensions=function(){"use strict";var a={42:"Baseline","4D":"Main",58:"Extended",64:"High"},b=function(a,b){var c,d,e,f,g,h,i,j;for(h=0;h<a.length;h+=1)for(c=a[h],e=c.AdaptationSet_asArray,i=0;i<e.length;i+=1)for(d=e[i],g=d.Representation_asArray,j=0;j<g.length;j+=1)if(f=g[j],b===f.id)return f;return null},c=function(a,b){var c=!1;return"video"===b?(this.manifestExt.getIsVideo(a),"video"===a.type&&(c=!0)):"audio"===b?(this.manifestExt.getIsAudio(a),"audio"===a.type&&(c=!0)):"text"===b?(this.manifestExt.getIsText(a),"text"===a.type&&(c=!0)):c=!1,c},d=k.utils.copyMethods(j.dependencies.DashMetricsExtensions);return d.config=void 0,d.getDuration=function(){var a=this,b=a.manifestModel.getValue(),c=b?b.Period.duration:null;return c!==1/0?c:-1},d.getFormatForType=function(a){var b,c=this,d=c.manifestModel.getValue(),e=0;for(e=0;e<d.Period.AdaptationSet.length;e++)if(b=d.Period.AdaptationSet[e],b.type===a)return b.mimeType;return null},d.getCodecForType=function(a){var b,c=this,d=c.manifestModel.getValue(),e=0;for(e=0;e<d.Period.AdaptationSet.length;e++)if(b=d.Period.AdaptationSet[e],b.type===a||b.contentType===a)return b.Representation[0].codecs;return null},d.getVideoWidthForRepresentation=function(a){var c,d,e=this,f=e.manifestModel.getValue();return f?(d=f.Period_asArray,c=b.call(e,d,a),null===c?null:c.width):null},d.getVideoHeightForRepresentation=function(a){var c,d,e=this,f=e.manifestModel.getValue();return f?(d=f.Period_asArray,c=b.call(e,d,a),null===c?null:c.height):null},d.getCodecsForRepresentation=function(a){var c,d=this,e=d.manifestModel.getValue(),f=e.Period_asArray;return c=b.call(d,f,a),null===c?null:c.codecs},d.getH264ProfileLevel=function(b){if(b.indexOf("avc1")<0)return"";var c=a[b.substr(5,2)],d=parseInt(b.substr(9,2),16)/10;return c+"@"+d.toString()},d.getBitratesForType=function(a,b){var d,e,f,g,h,i,j,k,l=this,m=l.manifestModel.getValue(),n=null,o=[];if(!(null!==m&&void 0!==m||null!==b&&void 0!==b))return null;if(b)n=b;else for(d=m.Period_asArray,f=0;f<d.length;f+=1)for(e=d[f],g=e.AdaptationSet_asArray,j=0;j<g.length;j+=1)if(n=g[j],c.call(l,g[j],a)){n=g[j];break}if(null!==n)for(n=l.manifestExt.processAdaptation(n),i=n.Representation_asArray,k=0;k<i.length;k+=1)h=i[k],o.push(h.bandwidth);return o},d.getBitratesWithResolutionForType=function(a){var b,d,e,f,g,h,i,j,k,l=this,m=l.manifestModel.getValue(),n=[];if(null===m||void 0===m)return null;for(b=m.Period_asArray,e=0;e<b.length;e+=1)for(d=b[e],g=d.AdaptationSet_asArray,j=0;j<g.length;j+=1)if(f=g[j],c.call(l,f,a)){for(f=l.manifestExt.processAdaptation(f),i=f.Representation_asArray,k=0;k<i.length;k+=1){h=i[k];var o={bitrate:h.bandwidth,width:h.width,height:h.height};n.push(o)}return n}return n},d.getQualityBoundaries=function(a,b){if(a){var c,e=d.getBitratesForType(a,b),f=d.config.getParamFor(a,"ABR.minQuality","number",-1),g=d.config.getParamFor(a,"ABR.maxQuality","number",-1),h=d.config.getParamFor(a,"ABR.minBandwidth","number",-1),i=d.config.getParamFor(a,"ABR.maxBandwidth","number",-1),j=e.length;if(-1!==h)for(c=0;c<e.length;c++)if(e[c]>=h){f=-1===f?c:Math.max(c,f);break}if(-1!==i)for(c=e.length-1;c>=0;c--)if(e[c]<=i){g=-1===g?c:Math.min(c,g);break}return f=f>=j?j-1:f,f=0>f?0:f,g=g>=j||0>g?j-1:g,{min:f,max:g}}return null},d},k.dependencies.MetricsExtensions.prototype={constructor:k.dependencies.MetricsExtensions},k.models.MetricsModel=function(){"use strict";return{system:void 0,eventBus:void 0,config:void 0,streamMetrics:{},metricsChanged:function(){this.eventBus.dispatchEvent({type:"metricsChanged",data:{}})},metricChanged:function(a){this.eventBus.dispatchEvent({type:"metricChanged",data:{stream:a}}),this.metricsChanged()},metricUpdated:function(a,b,c){this.eventBus.dispatchEvent({type:"metricUpdated",data:{stream:a,metric:b,value:c}}),this.metricChanged(a)},metricAdded:function(a,b,c){this.eventBus.dispatchEvent({type:"metricAdded",data:{stream:a,metric:b,value:c}}),this.metricChanged(a)},clearCurrentMetricsForType:function(a){var b=this.config.getParamFor(a,"ABR.keepBandwidthCondition","boolean",!0);for(var c in this.streamMetrics[a])!this.streamMetrics[a].hasOwnProperty(c)||"HttpList"===c&&b!==!1||(this.streamMetrics[a][c]=[]);this.metricChanged(a)},clearAllCurrentMetrics:function(){var a=this;for(var b in this.streamMetrics)this.streamMetrics.hasOwnProperty(b)&&"stream"===b&&delete this.streamMetrics[b];this.metricsChanged.call(a)},getReadOnlyMetricsFor:function(a){return this.streamMetrics.hasOwnProperty(a)?this.streamMetrics[a]:null},getMetricsFor:function(a){var b;return this.streamMetrics.hasOwnProperty(a)?b=this.streamMetrics[a]:(b=this.system.getObject("metrics"),this.streamMetrics[a]=b),b},addTcpConnection:function(a,b,c,d,e,f){var g=new k.vo.metrics.TCPConnection;return g.tcpid=b,g.dest=c,g.topen=d,g.tclose=e,g.tconnect=f,this.getMetricsFor(a).TcpList.push(g),this.metricAdded(a,"TcpConnection",g),g},addHttpRequest:function(a,b,c,d,e,f,g,h,i,j,l,m,n,o){var p=new k.vo.metrics.HTTPRequest;return p.stream=a,p.tcpid=b,p.type=c,p.url=d,p.actualurl=e,p.range=f,p.trequest=g,p.tresponse=h,p.tfinish=i,p.responsecode=j,p.interval=l,p.mediaduration=m,p.startTime=n,p.quality=o,this.getMetricsFor(a).HttpList.push(p),this.getMetricsFor(a).HttpList.length>10&&this.getMetricsFor(a).HttpList.shift(),this.metricAdded(a,"HttpRequest",p),p},appendHttpTrace:function(a,b,c,d){var e=new k.vo.metrics.HTTPRequest.Trace;return e.s=b,e.d=c,e.b=d,a.trace.push(e),this.metricUpdated(a.stream,"HttpRequestTrace",a),e},addRepresentationSwitch:function(a,b,c,d,e){var f=new k.vo.metrics.RepresentationSwitch;return f.t=b,f.mt=c,f.to=d,f.lto=e,this.getMetricsFor(a).RepSwitchList.push(f),this.metricAdded(a,"RepresentationSwitch",f),f},addBufferedSwitch:function(a,b,c,d){var e=new k.vo.metrics.BufferedSwitch;return e.mt=b,e.to=c,e.lto=d,this.getMetricsFor(a).BufferedSwitchList.push(e),this.metricAdded(a,"BufferedSwitch",e),e},addState:function(a,b,c,d){var e=new k.vo.metrics.State;return e.current=b,e.position=c,e.reason=d,this.metricAdded(a,"State",e),e},addSession:function(a,b,c,d,e){var f=new k.vo.metrics.Session;return f.uri=b,c?f.loopMode=1:f.loopMode=0,f.endTime=d,f.playerType=e,this.metricAdded(a,"Session",f),f},addCondition:function(a,b,c,d,e,f){var g=new k.vo.metrics.Condition;return g.isFullScreen=b,g.windowSize=c+"x"+d,g.fps=f,g.droppedFrames=e,this.metricAdded(a,"Condition",g),g},addMetaData:function(){this.metricAdded(null,"ManifestReady",null)},addBufferLevel:function(a,b,c){var d=new k.vo.metrics.BufferLevel;return d.t=b,d.level=Number(c.toFixed(3)),this.getMetricsFor(a).BufferLevel.push(d),this.getMetricsFor(a).BufferLevel.length>10&&this.getMetricsFor(a).BufferLevel.shift(),this.metricAdded(a,"BufferLevel",d),d},addDVRInfo:function(a,b,c,d){var e=new k.vo.metrics.DVRInfo;return e.time=b,e.range=d,e.mpd=c,this.getMetricsFor(a).DVRInfo.push(e),this.metricAdded(a,"DVRInfo",e),e},addDroppedFrames:function(a,b){var c=new k.vo.metrics.DroppedFrames,d=this.getMetricsFor(a).DroppedFrames;return c.time=b.creationTime,c.droppedFrames=b.droppedVideoFrames,c.decodedFrameCount=b.totalVideoFrames,d.length>0&&d[d.length-1]===c?d[d.length-1]:(d.push(c),this.metricAdded(a,"DroppedFrames",c),c)},addManifestUpdate:function(a,b,c,d,e,f,g,h,i,j){var l=new k.vo.metrics.ManifestUpdate,m=this.getMetricsFor("stream");return l.streamType=a,l.type=b,l.requestTime=c,l.fetchTime=d,l.availabilityStartTime=e,l.presentationStartTime=f,l.clientTimeOffset=g,l.currentTime=h,l.buffered=i,l.latency=j,m.ManifestUpdate.push(l),this.metricAdded(a,"ManifestUpdate",l),l},updateManifestUpdateInfo:function(a,b){if(a&&b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);this.metricUpdated(a.streamType,"ManifestUpdate",a)}},addManifestUpdatePeriodInfo:function(a,b,c,d,e){var f=new k.vo.metrics.ManifestUpdate.PeriodInfo;return f.id=b,f.index=c,f.start=d,f.duration=e,a.periodInfo.push(f),this.metricUpdated(a.streamType,"ManifestUpdatePeriodInfo",a),f},addManifestUpdateRepresentationInfo:function(a,b,c,d,e,f,g,h){var i=new k.vo.metrics.ManifestUpdate.RepresentationInfo;return i.id=b,i.index=c,i.periodIndex=d,i.streamType=e,i.startNumber=g,i.segmentInfoType=h,i.presentationTimeOffset=f,a.representationInfo.push(i),this.metricUpdated(a.streamType,"ManifestUpdateRepresentationInfo",a),i},addPlayList:function(a,b,c,d){var e=new k.vo.metrics.PlayList;return e.stream=a,e.start=b,e.mstart=c,e.starttype=d,this.getMetricsFor(a).PlayList.push(e),this.getMetricsFor(a).PlayList.length>10&&this.getMetricsFor(a).PlayList.shift(),this.metricAdded(a,"PlayList",e),e},appendPlayListTrace:function(a,b,c,d,e,f,g,h){var i=new k.vo.metrics.PlayList.Trace;return i.representationid=b,i.subreplevel=c,i.start=d,i.mstart=e,i.duration=f,i.playbackspeed=g,i.stopreason=h,a.trace.push(i),a.trace.length>10&&a.trace.shift(),this.metricUpdated(a.stream,"PlayListTrace",a),i}}},k.models.MetricsModel.prototype={constructor:k.models.MetricsModel},k.dependencies.Mp4Processor=function(){"use strict";var a=function(a){var b=new q.boxes.MovieHeaderBox,c=a[a.length-1];return b.version=1,b.creation_time=0,b.modification_time=0,b.timescale=c.timescale,b.duration=Math.round(c.duration*c.timescale),b.rate=65536,b.volume=256,b.reserved=0,b.reserved_2=[0,0],b.matrix=[65536,0,0,0,65536,0,0,0,1073741824],b.pre_defined=[0,0,0,0,0,0],b.next_track_ID=c.trackId+1,b.flags=0,b},b=function(a){var b,c,e;return b=new q.boxes.TrackBox,c=new q.boxes.TrackHeaderBox,c.version=1,c.flags=7,c.creation_time=0,c.modification_time=0,c.track_id=a.trackId,c.reserved=0,c.duration=Math.round(a.duration*a.timescale),c.reserved_2=[0,0],c.layer=0,c.alternate_group=0,c.volume=256,c.reserved_3=0,c.matrix=[65536,0,0,0,65536,0,0,0,1073741824],c.width=a.width<<16,c.height=a.height<<16,b.boxes.push(c),e=new q.boxes.MediaBox,e.boxes.push(d(a)),e.boxes.push(f(a)),e.boxes.push(g(a)),b.boxes.push(e),b},c=function(a){var b,c,d,e=0;return b=a.charCodeAt(0)-96<<10,c=a.charCodeAt(1)-96<<5,d=a.charCodeAt(2)-96,e=b|c|d},d=function(a){var b=new q.boxes.MediaHeaderBox;return b.flags=0,b.version=1,b.creation_time=0,b.modification_time=0,b.timescale=a.timescale,b.duration=Math.round(a.duration*a.timescale),b.pad=0,b.language=c(a.language),b.pre_defined=0,b},e=function(a){var b,c=0;for(b=0;b<a.length;b+=1)c|=a.charCodeAt(b)<<8*(a.length-b-1);return c},f=function(a){var b=new q.boxes.HandlerBox;switch(b.version=0,b.pre_defined=0,a.type){case"video":b.handler_type=e(b.HANDLERTYPEVIDEO),b.name=b.HANDLERVIDEONAME;break;case"audio":b.handler_type=e(b.HANDLERTYPEAUDIO),b.name=b.HANDLERAUDIONAME;break;default:b.handler_type=e(b.HANDLERTYPETEXT),b.name=b.HANDLERTEXTNAME}return b.name+="\x00",b.reserved=[0,0,0],b.flags=0,b},g=function(a){var b=new q.boxes.MediaInformationBox;switch(a.type){case"video":b.boxes.push(E(a));break;case"audio":b.boxes.push(F(a))}return b.boxes.push(h(a)),b.boxes.push(D(a)),b},h=function(){var a,b,c;return a=new q.boxes.DataInformationBox,b=new q.boxes.DataReferenceBox,b.version=0,b.entry_count=1,b.flags=0,c=new q.boxes.DataEntryUrlBox,c.location="",c.version=0,c.flags=1,b.boxes.push(c),a.boxes.push(b),a},i=function(){var a=new q.boxes.TimeToSampleBox;return a.version=0,a.entry_count=0,a.flags=0,a.entry=[],a},j=function(){var a=new q.boxes.SampleToChunkBox;return a.flags=0,a.version=0,a.entry_count=0,a.entry=[],a},l=function(){var a=new q.boxes.ChunkOffsetBox;return a.version=0,a.entry_count=0,a.flags=0,a.chunk_offset=[],a},m=function(){var a=new q.boxes.SampleSizeBox;return a.version=0,a.flags=0,a.sample_count=0,a.sample_size=0,a},n=function(a){var b,c=new Uint8Array(a.length/2);for(b=0;b<a.length/2;b+=1)c[b]=parseInt(""+a[2*b]+a[2*b+1],16);return c},o=function(a,b){var c=new Uint8Array(a.length+b.length);return c.set(a,0),c.set(b,a.length),c},p=function(a){var b,c,d,e,f,g,h,i,j,k=new RegExp("^[A-Z0-9]7","gi"),l=new RegExp("^[A-Z0-9]8","gi");for(b=new q.boxes.AVCConfigurationBox,b.configurationVersion=1,b.lengthSizeMinusOne=3,b.reserved=63,b.SPS_NAL=[],b.PPS_NAL=[],c=new Uint8Array(0),d=a.codecPrivateData,e=d.split("00000001"),e.splice(0,1),f=0,g=0,h=0;h<e.length;h+=1)i=n(e[h]),e[h].match(k)&&(b.SPS_NAL[f++]={NAL_length:i.length,NAL:i},b.AVCProfileIndication=parseInt(e[h].substr(2,2),16),b.profile_compatibility=parseInt(e[h].substr(4,2),16),b.AVCLevelIndication=parseInt(e[h].substr(6,2),16)),e[h].match(l)&&(b.PPS_NAL[g++]={NAL_length:i.length,NAL:i}),j=new Uint8Array(i.length+4),j[3]=i.length,j.set(i,4),c=o(c,j);return b.numOfSequenceParameterSets=f,b.numOfPictureParameterSets=g,b},r=function(a){var b=null;return b=void 0!==a.contentProtection?new q.boxes.EncryptedVideoBox:new q.boxes.AVC1VisualSampleEntryBox,b.data_reference_index=1,b.compressorname="AVC Coding",b.depth=24,b.reserved=[0,0,0,0,0,0],b.reserved_2=0,b.reserved_3=0,b.pre_defined=0,b.pre_defined_2=[0,0,0],b.pre_defined_3=65535,b.frame_count=1,b.horizresolution=4718592,b.vertresolution=4718592,b.height=a.height,b.width=a.width,b.boxes.push(p(a)),void 0!==a.contentProtection&&b.boxes.push(w(a)),b},s=function(a){var b=new q.boxes.OriginalFormatBox;return b.data_format=e(a.codecs.substring(0,a.codecs.indexOf("."))),b},t=function(){var a=new q.boxes.SchemeTypeBox;return a.flags=0,a.version=0,a.scheme_type=1667591779,a.scheme_version=65536,a},u=function(a){var b=new q.boxes.SchemeInformationBox;return b.boxes.push(v(a)),b},v=function(a){var b=new q.boxes.TrackEncryptionBox;return b.flags=0,b.version=0,b.default_IsEncrypted=1,b.default_IV_size=8,b.default_KID=a.contentProtection&&a.contentProtection.length>0&&a.contentProtection[0]["cenc:default_KID"]?a.contentProtection[0]["cenc:default_KID"]:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],b},w=function(a){var b=new q.boxes.ProtectionSchemeInformationBox;return b.boxes.push(s(a)),b.boxes.push(t()),b.boxes.push(u(a)),b},x=function(a){var b=a.codecs.substring(0,a.codecs.indexOf("."));switch(b){case"avc1":return r(a);default:throw{name:k.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED,message:"Codec is not supported",data:{codec:b}}}},y=function(a){for(var b=[];a.length>=2;)b.push(parseInt(a.substring(0,2),16)),a=a.substring(2,a.length);return b},z=function(a){var b,c,d,e,f,g,h;return b=y(a.codecPrivateData),c=b.length,d=new Uint8Array(2+c),d[0]=5,d[1]=c,d.set(b,2),e=13+d.length,f=new Uint8Array(2+e),f[0]=4,f[1]=e,f[2]=64,f[3]=20,f[3]|=0,f[3]|=1,f[4]=255,f[5]=255,f[6]=255,f[7]=(4278190080&a.bandwidth)>>24,f[8]=(16711680&a.bandwidth)>>16,f[9]=(65280&a.bandwidth)>>8,f[10]=255&a.bandwidth,f[11]=(4278190080&a.bandwidth)>>24,f[12]|=(16711680&a.bandwidth)>>16,f[13]|=(65280&a.bandwidth)>>8,f[14]|=255&a.bandwidth,f.set(d,15),g=3+f.length,h=new Uint8Array(2+g),h[0]=3,h[1]=g,h[2]=(65280&a.trackId)>>8,h[3]=255&a.trackId,h[4]=0,h.set(f,5),h},A=function(a){var b,c,d=null;return d=void 0!==a.contentProtection?new q.boxes.EncryptedAudioBox:new q.boxes.MP4AudioSampleEntryBox,d.reserved=[0,0,0,0,0,0],d.data_reference_index=1,d.reserved_2=[0,0],d.channelcount=a.channels,d.samplesize=16,d.pre_defined=0,d.reserved_3=0,d.samplerate=a.samplingRate<<16,b=new q.boxes.ESDBox,c=z(a),b.ES_tag=c[0],b.ES_length=c[1],b.ES_data=c.subarray(2,c.length),b.version=0,b.flags=0,d.boxes.push(b),void 0!==a.contentProtection&&d.boxes.push(w(a)),d},B=function(a){var b=a.codecs.substring(0,a.codecs.indexOf("."));switch(b){case"mp4a":return A(a);default:throw{name:k.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED,message:"Codec is not supported",data:{codec:b}}}return null},C=function(a){var b=new q.boxes.SampleDescriptionBox;switch(b.version=0,b.flags=0,a.type){case"video":b.boxes.push(x(a));break;case"audio":b.boxes.push(B(a))}return b},D=function(a){var b=new q.boxes.SampleTableBox;return b.boxes.push(i(a)),b.boxes.push(j(a)),b.boxes.push(l(a)),b.boxes.push(m(a)),b.boxes.push(C(a)),b},E=function(){var a=new q.boxes.VideoMediaHeaderBox;return a.version=0,a.flags=1,a.graphicsmode=0,a.opcolor=[0,0,0],a},F=function(){var a=new q.boxes.SoundMediaHeaderBox;return a.version=0,a.balance=0,a.reserved=0,a.flags=1,a},G=function(){var a=new q.boxes.FileTypeBox;return a.major_brand=1769172790,a.minor_brand=1,a.compatible_brands=[],a.compatible_brands[0]=1769172845,a.compatible_brands[1]=1769172790,a.compatible_brands[2]=1836278888,a},H=function(a){var b,c,d,e=a[a.length-1];for(b=new q.boxes.MovieExtendsBox,d=0;d<a.length;d+=1)e=a[d],c=new q.boxes.TrackExtendsBox,c.version=0,c.flags=0,c.track_ID=e.trackId,c.default_sample_description_index=1,c.default_sample_duration=0,c.default_sample_flags=0,c.default_sample_size=0,b.boxes.push(c);return b},I=function(a){var b,c,d,e=[];for(d=0;d<a.length;d+=1)b=new Uint8Array(a[d].initData),c=new q.boxes.ProtectionSystemSpecificHeaderBox,c.read(b,8,b.length),e.push(c);return e},J=function(c){var d,e,f,g;for(d=new q.boxes.File,e=new q.boxes.MovieBox,e.boxes.push(a(c)),g=0;g<c.length;g+=1)e.boxes.push(b(c[g]));for(e.boxes.push(H(c)),g=0;g<c.length;g++)void 0!==c[g].contentProtection&&(f=this.protectionExt.getSupportedKeySystemsFromContentProtection(c[g].contentProtection),e.boxes.push.apply(e.boxes,I(f)));return d.boxes.push(G()),d.boxes.push(e),q.serialize(d)},K=function(a){var b=new q.boxes.MovieFragmentHeaderBox;return b.version=0,b.flags=0,b.sequence_number=a,b},L=function(a){var b=new q.boxes.TrackFragmentBox;return b.version=0,b.flags=0,b.boxes.push(M(a)),b.boxes.push(N(a)),b.boxes.push(O(a)),b.boxes.push(P(a)),b},M=function(a){var b=new q.boxes.TrackFragmentHeaderBox;return b.version=0,b.flags=131072,b.track_ID=a.trackId,b},N=function(a){var b=new q.boxes.TrackFragmentBaseMediaDecodeTimeBox;return b.version=1,b.flags=0,b.baseMediaDecodeTime=a.samples.length>0?a.samples[0].dts:0,b},O=function(a){var b,c,d,e,f=new q.boxes.TrackFragmentRunBox;for(c=a.samples[0].cts,d=a.samples[0].duration>0?256:0,f.version=0,f.flags=1|d|512|1024|("video"===a.type?2048:0),f.data_offset=0,f.samples_table=[],f.sample_count=a.samples.length,b=0;b<a.samples.length;b++)e={sample_duration:a.samples[b].duration,sample_size:a.samples[b].size,sample_composition_time_offset:a.samples[b].cts-a.samples[b].dts,sample_flags:a.samples[b].flags},e.sample_composition_time_offset<0&&(f.version=1),f.samples_table.push(e);return f},P=function(a){var b,c=new q.boxes.SampleDependencyTableBox;for(c.version=0,c.flags=0,c.sample_dependency_table=[],b=0;b<a.samples.length;b++)c.sample_dependency_table.push((267386880&a.samples[b].flags)>>20);return c},Q=function(a){var b=new q.boxes.MediaDataBox;return b.data=a.data,b},R=function(a,b){var c,d,e,f,g,h,i=0,j={},k=[],l=0;if(c=new q.boxes.File,d=new q.boxes.MovieFragmentBox,d.boxes.push(K(b)),a)for(e=0;e<a.length;e+=1)d.boxes.push(L(a[e]));if(c.boxes.push(d),f=c.getLength(),h=d.getBoxesByType("traf"),f+=8,a&&a.length&&(k=[a.length]),a)for(e=0;e<a.length;e+=1)h[e].getBoxByType("trun").data_offset=f,f+=a[e].data.length,k[e]=a[e].data,i+=k[e].length;for(j.data=new Uint8Array(i),e=0;e<k.length;e++)j.data.set(k[e],l),l+=k[e].length;return c.boxes.push(Q(j)),g=q.serialize(c)};return{protectionExt:void 0,generateInitSegment:J,generateMediaSegment:R}},k.dependencies.Mp4Processor.prototype={constructor:k.dependencies.Mp4Processor},k.dependencies.Notifier=function(){"use strict";var a,b="observableId",c=0,d=function(){return this[b]||(c+=1,this[b]="_id_"+c),this[b]};return{system:void 0,setup:function(){a=this.system,a.mapValue("notify",this.notify),a.mapValue("subscribe",this.subscribe),a.mapValue("unsubscribe",this.unsubscribe)},notify:function(){var b=arguments[0]+d.call(this),c=new k.vo.Event;c.sender=this,c.type=arguments[0],c.data=arguments[1],c.error=arguments[2],c.timestamp=(new Date).getTime(),a.notify.call(a,b,c)},subscribe:function(b,c,e,f){if(!e&&c[b]&&(e=c[b]=c[b].bind(c)),!c)throw"observer object cannot be null or undefined";if(!e)throw"event handler cannot be null or undefined";b+=d.call(this),a.mapHandler(b,void 0,e,f)},unsubscribe:function(b,c,e){e=e||c[b],b+=d.call(this),a.unmapHandler(b,void 0,e)}}},k.dependencies.Notifier.prototype={constructor:k.dependencies.Notifier},k.dependencies.Parser=function(){"use strict";var a=null,b=function(b,c){if(null===a)if(b.indexOf("SmoothStreamingMedia")>-1&&"undefined"!=typeof this.mssParser)this.system.notify("setContext","MSS"),a=this.mssParser;else if(b.indexOf("#EXTM3U")>-1&&"undefined"!=typeof this.hlsParser)this.system.notify("setContext","HLS"),a=this.hlsParser;else{if(!(b.indexOf("MPD")>-1&&"undefined"!=typeof this.dashParser))return d.reject("manifest cannot be parsed, protocol is unsupported!");this.system.notify("setContext","MPD"),a=this.dashParser}return a.parse(b,c)},c=function(){null!==a&&void 0!==a.abort&&a.abort()},e=function(){a=null};return{debug:void 0,system:void 0,dashParser:void 0,mssParser:void 0,hlsParser:void 0,metricsModel:void 0,parse:b,abort:c,reset:e}},k.dependencies.Parser.prototype={constructor:k.dependencies.Parser},k.dependencies.SourceBufferExtensions=function(){"use strict";this.system=void 0,this.manifestExt=void 0},k.dependencies.SourceBufferExtensions.prototype={constructor:k.dependencies.SourceBufferExtensions,createSourceBuffer:function(a,b){"use strict";var c=d.defer(),e=this;try{a?c.resolve(a.addSourceBuffer(b)):c.reject()}catch(f){e.manifestExt.getIsTextTrack(b)?"text/vtt"===b||"text/ttml"===b?c.resolve(e.system.getObject("textSourceBuffer")):"application/ttml+xml+mp4"===b?c.resolve(e.system.getObject("textTTMLXMLMP4SourceBuffer")):c.reject(f):c.reject(f)}return c.promise},removeSourceBuffer:function(a,b){"use strict";var c=d.defer();try{c.resolve(a.removeSourceBuffer(b))}catch(e){b&&"function"==typeof b.getTextTrackExtensions?c.resolve():c.reject(e.description)}return c.promise},getBufferRange:function(a,b,c){"use strict";var d,e,f=null,g=0,h=0,i=null,j=null,k=0,l=c||.01;try{f=a.buffered}catch(m){return null}if(f){for(e=0,d=f.length;d>e;e+=1)if(g=f.start(e),h=f.end(e),null===i){if(k=Math.abs(g-b),b>=g&&h>b){i=g,j=h;continue}if(l>=k){i=g,j=h;continue}}else{if(k=g-j,!(l>=k))break;j=h}if(null!==i)return{start:i,end:j}}return null},getAllRanges:function(a){var b=null;try{return b=a.buffered}catch(c){return null}},getBufferLength:function(a,b,c){"use strict";var d,e,f=this;return d=f.getBufferRange(a,b,c),e=null===d?0:d.end-b},waitForUpdateEnd:function(a){"use strict";var b,c=d.defer(),e=50,f=function(){a.updating||(clearInterval(b),c.resolve(!0))},g=function(){a.updating||(a.removeEventListener("updateend",g,!1),c.resolve(!0))};if(!a.updating)return c.resolve(!0),c.promise;if("function"==typeof a.addEventListener)try{a.addEventListener("updateend",g,!1)}catch(h){b=setInterval(f,e)}else b=setInterval(f,e);return c.promise},append:function(a,b,c){var e=d.defer(),f=this;return f.waitForUpdateEnd(a).then(function(){try{"append"in a?a.append(b):"appendBuffer"in a&&a.appendBuffer(b),
c?e.resolve():f.waitForUpdateEnd(a).then(function(){e.resolve()})}catch(d){e.reject({err:d,data:b})}}),e.promise},remove:function(a,b,c,e,f,g){var h=d.defer(),i=this;return i.waitForUpdateEnd(a).then(function(){try{b>=0&&e>b&&c>b&&"ended"!==f.readyState&&a.remove(b,c),g?h.resolve():i.waitForUpdateEnd(a).then(function(){h.resolve()})}catch(d){h.reject(d)}}),h.promise},abort:function(a,b){"use strict";var c=d.defer();try{"open"===a.readyState&&b.abort(),c.resolve()}catch(e){c.reject(e.description)}return c.promise}},Math.sign||(Math.sign=function(a){return 0>a?-1:1}),k.dependencies.Stream=function(){"use strict";var a,b,c,e,f,g,h,i,j,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F=null,G=null,H=null,I=null,J=-1,K=null,L=-1,M=null,N=!1,O=-1,P=!0,Q=!1,R=!1,S="und",T="und",U=null,V=-1,W="Stopped",X=1,Y=!1,Z=null,$=null,_=!1,aa=-1,ba=-1,ca=function(a){this.errHandler.sendError(a.data.code,a.data.message,a.data.data)},da=function(){Q&&(this.debug.info("[Stream] Play."),this.videoModel.play())},ea=function(){this.debug.info("[Stream] Pause."),this.videoModel.pause()},fa=function(a,b){Q&&(this.debug.info("[Stream] Seek: "+a),b===!0?(t=a,this.system.mapHandler("bufferUpdated",void 0,La.bind(this)),Ca.call(this,t)):this.videoModel.setCurrentTime(a))},ga=function(a){var b=d.defer(),c=this,e=function(){a.removeEventListener("sourceopen",e),a.removeEventListener("webkitsourceopen",e),b.resolve(a)};return a.addEventListener("sourceopen",e,!1),a.addEventListener("webkitsourceopen",e,!1),c.mediaSourceExt.attachMediaSource(a,c.videoModel),b.promise},ha=function(){var c=this,e=[],f=d.defer(),g=function(){I&&e.push(I.reset(R)),K&&e.push(K.reset(R)),M&&e.push(M.reset(R)),d.all(e).then(function(){Z&&(Z.reset(),Z=void 0),b&&c.mediaSourceExt.detachMediaSource(c.videoModel),Q=!1,H=null,I=null,K=null,M=null,F=null,G=null,b=null,a=null,f.resolve()})};return d.when($?$.promise:!0).then(function(){g()},function(){g()}),f.promise},ia=function(a,b,c){this.debug.log("[Stream] checkIfInitialized videoState="+a+" audioState="+b+" textTrackState="+c),null!==a&&null!==b&&null!==c&&("ready"===a&&"ready"===b&&"ready"===c?(D?D.init(H,G,F):H&&!this.capabilities.supportsEncryptedMedia()&&(this.errHandler.sendError(k.dependencies.ErrorHandler.prototype.CAPABILITY_ERR_MEDIAKEYS,"EME is not supported/enabled",null),$.reject()),$.resolve(!0)):("error"===a||"error"===b||"error"===c)&&$.reject())},ja=function(){var c=null,e=null,f=null,g=this;return $=d.defer(),Z=g.system.getObject("eventController"),g.manifestExt.getVideoData(a,U.index).then(function(h){return g.manifestExt.getDataIndex(h,a,U.index).then(function(a){J=a}),g.manifestExt.getCodec(h).then(function(a){return g.debug.info("[Stream] Video codec: "+a),F=a,g.capabilities.supportsCodec(g.videoModel.getElement(),a)?g.manifestExt.getContentProtectionData(h).then(function(c){return H=c,b?g.sourceBufferExt.createSourceBuffer(b,a):d.reject({code:k.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_ACCESS,name:"InvalidAccessError",message:"MediaSource undefined"})}):d.reject({code:k.dependencies.ErrorHandler.prototype.DOM_ERR_NOT_SUPPORTED,name:"NotSupportedError",message:"Codec not supported"})}).then(function(a){I=g.system.getObject("bufferController"),I.initialize("video",U,h,a,g.fragmentController,b,Z),c="ready",ia.call(g,c,e,f)},function(a){c="error",ia.call(g,c,e,f),a.code&&a.code===k.dependencies.ErrorHandler.prototype.DOM_ERR_NOT_SUPPORTED?g.errHandler.sendError(k.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED,"Video codec is not supported",{codec:F}):g.errHandler.sendError(k.dependencies.ErrorHandler.prototype.MEDIA_ERR_CREATE_SOURCEBUFFER,"Failed to create video source buffer",new k.vo.Error(a.code,a.name,a.message))}),g.manifestExt.getSpecificAudioData(a,U.index,S)},function(){return c="error",ia.call(g,c,e,f),g.errHandler.sendError(k.dependencies.ErrorHandler.prototype.MANIFEST_ERR_NO_VIDEO,"No Video data in manifest"),d.reject()}).then(function(h){return g.manifestExt.getDataIndex(h,a,U.index).then(function(a){L=a}),g.manifestExt.getCodec(h).then(function(a){return g.debug.info("[Stream] Audio codec: "+a),G=a,g.capabilities.supportsCodec(g.videoModel.getElement(),a)?b?g.sourceBufferExt.createSourceBuffer(b,a):d.reject({code:k.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_ACCESS,name:"InvalidAccessError",message:"MediaSource undefined"}):d.reject({code:k.dependencies.ErrorHandler.prototype.DOM_ERR_NOT_SUPPORTED,name:"NotSupportedError",message:"Codec not supported"})}).then(function(a){K=g.system.getObject("bufferController"),K.initialize("audio",U,h,a,g.fragmentController,b,Z),e="ready",ia.call(g,c,e,f)},function(a){e="error",a.code&&a.code===k.dependencies.ErrorHandler.prototype.DOM_ERR_NOT_SUPPORTED?g.errHandler.sendError(k.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED,"Audio codec is not supported",{codec:G}):g.errHandler.sendError(k.dependencies.ErrorHandler.prototype.MEDIA_ERR_CREATE_SOURCEBUFFER,"Failed to create audio source buffer",new k.vo.Error(a.code,a.name,a.message)),ia.call(g,c,e,f)}),g.manifestExt.getSpecificTextData(a,U.index,T)},function(){return e="ready",ia.call(g,c,e,f),"error"===c?d.reject():(g.debug.log("[Stream] No audio streams."),g.errHandler.sendWarning(k.dependencies.ErrorHandler.prototype.MANIFEST_ERR_NO_AUDIO,"No audio data in manifest"),g.manifestExt.getSpecificTextData(a,U.index,T))}).then(function(h){var i;return g.manifestExt.getDataIndex(h,a,U.index).then(function(a){O=a}),g.manifestExt.getMimeType(h).then(function(a){return i=a,b?g.sourceBufferExt.createSourceBuffer(b,i):d.reject({code:k.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_ACCESS,name:"InvalidAccessError",message:"MediaSource undefined"})}).then(function(a){M=g.system.getObject("bufferController"),M.initialize("text",U,h,a,g.fragmentController,b),a.hasOwnProperty("initialize")&&a.initialize(i,M,h),f="ready",ia.call(g,c,e,f)},function(a){f="ready",M=null,ia.call(g,c,e,f),a.code&&a.code===k.dependencies.ErrorHandler.prototype.DOM_ERR_NOT_SUPPORTED?g.errHandler.sendWarning(k.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED,"Text codec is not supported",{codec:F}):g.errHandler.sendWarning(k.dependencies.ErrorHandler.prototype.MEDIA_ERR_CREATE_SOURCEBUFFER,"Failed to create text source buffer",new k.vo.Error(a.code,a.name,a.message))}),g.manifestExt.getEventsForPeriod(a,U)},function(){return f="ready",ia.call(g,c,e,f),"error"===c?d.reject():(g.debug.log("[Stream] No text tracks."),g.manifestExt.getEventsForPeriod(a,U))}).then(function(a){Z&&Z.addInlineEvents(a)}),$.promise},ka=function(){var a=this,c=d.defer();return a.manifestExt.getDuration(a.manifestModel.getValue(),U).then(function(c){return a.debug.log("[Stream] Setting duration: "+c),a.mediaSourceExt.setDuration(b,c)}).then(function(){Q=!0,c.resolve(!0)}),c.promise},la=function(){this.debug.info("[Stream] <video> loadedmetadata event")},ma=function(){this.debug.info("[Stream] <video> canplay event")},na=function(){this.debug.info("[Stream] <video> playing event"),aa=(new Date).getTime()/1e3,ba=this.getVideoModel().getCurrentTime()},oa=function(){this.debug.info("[Stream] <video> loadstart event")},pa=function(){this.debug.info("[Stream] <video> play event"),1!==X?this.setTrickModeSpeed(1):V>=0?(Ha.call(this,V),V=-1):Ca.call(this),this.metricsModel.addPlayList("video",(new Date).getTime(),this.videoModel.getCurrentTime(),"play")},qa=function(){var a=this.videoModel.getElement(),b=0;(document.webkitIsFullScreen||document.msFullscreenElement||document.mozFullScreen)&&(b=1),this.metricsModel.addCondition(null,b,a.videoWidth,a.videoHeight)},ra=function(){this.debug.info("[Stream] <video> ended event"),this.metricsModel.addState("video","stopped",this.videoModel.getCurrentTime(),1)},sa=function(){this.debug.info("[Stream] <video> pause event"),aa=-1,ba=-1,this.metricsModel.addPlayList("video",(new Date).getTime(),this.videoModel.getCurrentTime(),"pause"),Fa.call(this)},ta=function(a){var b,c=a.srcElement.error,d="[Stream] <video> error: ";if(-1!==c.code){switch(c.code){case 1:b=k.dependencies.ErrorHandler.prototype.MEDIA_ERR_ABORTED,d+="fetching process aborted";break;case 2:b=k.dependencies.ErrorHandler.prototype.MEDIA_ERR_NETWORK,d+="network error";break;case 3:b=k.dependencies.ErrorHandler.prototype.MEDIA_ERR_DECODE,d+="media decoding error";break;case 4:b=k.dependencies.ErrorHandler.prototype.MEDIA_ERR_SRC_NOT_SUPPORTED,d+="media format not supported";break;case 5:b=k.dependencies.ErrorHandler.prototype.MEDIA_ERR_ENCRYPTED,d+="media is encrypted"}R=!0,this.errHandler.sendError(b,d)}},ua=function(){var a=this.videoModel.getCurrentTime();return this.debug.info("[Stream] <video> seeking event: "+a),1!==X&&a.toFixed(3)!==C.toFixed(3)?void this.setTrickModeSpeed(1):(a=a<this.getStartTime()?this.getStartTime():a,void Ca.call(this,a))},va=function(){var a,b,c,d,e,f,g,h,i=this,k=.9,l=function(a,b){return i.videoModel.getCurrentTime()===i.getStartTime()||Y?void i.debug.log("[Stream] Trick mode (x"+X+"): stop"):(b<i.getStartTime()?b=i.getStartTime():b>=i.videoModel.getDuration()&&(b=i.videoModel.getDuration()-y,Y=!0),a>0&&i.debug.log("[Stream] Trick mode (x"+X+"): wait "+a.toFixed(3)+" s"),void(B=setTimeout(function(){A=(new Date).getTime()/1e3,i.debug.log("[Stream] Trick mode (x"+X+"): seek time = "+b.toFixed(3)),C=b,i.videoModel.setCurrentTime(b)},a>0?1e3*a:0)))};if(this.debug.info("[Stream] <video> seeked event"),Ea.call(this),1!==X){if(a=(new Date).getTime()/1e3,b=i.videoModel.getCurrentTime(),c=a-w,d=a-A,e=Math.abs(b-x),f=e/c,i.debug.log("[Stream] Trick mode (x"+X+"): elapsed time = "+c.toFixed(3)+", elapsed video time = "+e.toFixed(3)+", speed = "+f.toFixed(3)),"Changed"===W)clearTimeout(B),W="Running",w=(new Date).getTime()/1e3,x=b,i.debug.info("[Stream] Trick mode (x"+X+"): videoTime = "+x),z=Math.abs(v/X)>1?z/Math.abs(v/X):z,g=b+z*Math.sign(X),h=0;else if(f<Math.abs(X)*k){var m=Math.abs(X/f);z*=Math.round(m)+Math.round(m%y),i.debug.info("[Stream] Trick mode (x"+X+"): seek step = "+z),g=b+z*Math.sign(X),h=0}else g=b+z*Math.sign(X),h=Math.abs(g-x)/Math.abs(X)-c-d;l.call(i,h,g)}this.videoModel.listen("seeking",j),aa=-1,ba=-1},wa=function(){this.debug.info("[Stream] <video> progress event"),Ba.call(this)},xa=function(){this.debug.info("[Stream] <video> timeupdate event: "+this.videoModel.getCurrentTime()),Ba.call(this)},ya=function(){this.debug.info("[Stream] <video> durationchange event: "+this.videoModel.getDuration())},za=function(){this.debug.info("[Stream] <video> ratechange event: "+this.videoModel.getPlaybackRate()),I&&I.updateStalledState(),K&&K.updateStalledState(),M&&M.updateStalledState()},Aa=function(){ea.call(this),_=!0,this.system.notify("manifestUpdate",!0)},Ba=function(){I&&I.updateBufferLevel(!0),K&&K.updateBufferLevel(!0),M&&M.updateBufferLevel(!0)},Ca=function(a){this.debug.log("[Stream] startBuffering"+(void 0===a?"":" at time "+a)),I&&(void 0===a?I.start():I.seek(a)),K&&(void 0===a?K.start():K.seek(a)),M&&N&&1===X&&(void 0===a?M.start():M.seek(a))},Da=function(){this.debug.log("[Stream] stopBuffering"),I&&I.stop(),K&&K.stop(),M&&M.stop()},Ea=function(){I&&I.seeked(),K&&K.seeked(),M&&M.seeked()},Fa=function(){(!this.scheduleWhilePaused||this.manifestExt.getIsDynamic(a))&&Da.call(this),clearInterval(u)},Ga=function(c){var d=this;a=c,d.debug.log("[Stream] Create MediaSource");try{b=d.mediaSourceExt.createMediaSource()}catch(e){d.errHandler.sendError(k.dependencies.ErrorHandler.prototype.MEDIA_ERR_CREATE_MEDIASOURCE,"Failed to create MediaSource",{name:e.name,message:e.message})}null!==b&&(d.debug.log("[Stream] Setup MediaSource"),ga.call(d,b).then(function(a){return b=a,d.debug.log("[Stream] Initialize MediaSource"),ja.call(d)}).then(function(){return d.debug.log("[Stream] Initialize playback"),ka.call(d)}).then(function(){d.debug.log("[Stream] Playback initialized")}))},Ha=function(a){this.debug.log("[Stream] Set video model current time: "+a),this.videoModel.unlisten("seeking",j),this.videoModel.setCurrentTime(a)},Ia=function(){I&&!I.isBufferingCompleted()||K&&!K.isBufferingCompleted()||b&&(this.debug.info("[Stream] Signal end of stream"),this.mediaSourceExt.signalEndOfStream(b))},Ja=function(){Da.call(this)},Ka=function(a){this.debug.info("[Stream] Start time = "+a),fa.call(this,a,0===U.index&&P)},La=function(){var a,b,c,d=this;if(d.debug.info("[Stream] Check start time"),a=d.sourceBufferExt.getBufferRange(I.getBuffer(),t,2),null!==a){if(c=a.start,K){if(b=d.sourceBufferExt.getBufferRange(K.getBuffer(),t,2),null===b)return;if(d.debug.info("[Stream] Check start time: A["+b.start+"-"+b.end+"], V["+a.start+"-"+a.end+"]"),b.end<c)return;b.start>c&&(c=b.start)}d.debug.info("[Stream] Check start time: OK => "+c),d.system.unmapHandler("bufferUpdated"),d.videoModel.isPaused()?V=c:d.videoModel.setCurrentTime(c),da.call(d)}},Ma=function(b){var c,e,f,g,h=this,i=d.defer(),j=d.defer(),k=d.defer(),l=d.defer(),m=d.defer();return a=h.manifestModel.getValue(),U=b,h.debug.log("Manifest updated... set new data on buffers."),I?(c=I.getData(),e=c&&c.hasOwnProperty("id")?h.manifestExt.getDataForId(c.id,a,U.index):h.manifestExt.getDataForIndex(J,a,U.index),e.then(function(a){I.updateData(a,U),j.resolve()})):j.resolve(),K?(f=h.manifestExt.getDataForIndex(L,a,U.index),f.then(function(a){K.updateData(a,U),k.resolve()})):k.resolve(),M&&(g=h.manifestExt.getDataForIndex(O,a,U.index),g.then(function(a){M.updateData(a,U),l.resolve()})),Z&&h.manifestExt.getEventsForPeriod(a,U).then(function(a){Z.addInlineEvents(a),m.resolve()}),d.when(j.promise,k.promise,l.promise).then(function(){_&&I&&(_=!1,h.system.unmapHandler("bufferUpdated"),h.system.mapHandler("bufferUpdated",void 0,La.bind(h)),I.load()),i.resolve()}),i.promise},Na=function(){var a=this.videoModel.getCurrentTime();M.seek(a),M.seeked()},Oa=function(){if(document.hidden!==!0&&-1!==aa){var a=(new Date).getTime()/1e3,b=this.getVideoModel().getCurrentTime(),c=a-aa,d=b-ba;this.debug.log("[Stream] VisibilityChange: elapsedClockTime = "+c+", elapsedStreamTime = "+d+" ("+(c-d)+")"),c-d>1&&Aa.call(this)}};return{system:void 0,videoModel:void 0,manifestLoader:void 0,manifestModel:void 0,mediaSourceExt:void 0,sourceBufferExt:void 0,manifestExt:void 0,fragmentController:void 0,fragmentExt:void 0,protectionExt:void 0,capabilities:void 0,debug:void 0,metricsExt:void 0,errHandler:void 0,timelineConverter:void 0,scheduleWhilePaused:void 0,metricsModel:void 0,eventBus:void 0,notify:void 0,setup:function(){this.system.mapHandler("bufferingCompleted",void 0,Ia.bind(this)),this.system.mapHandler("segmentLoadingFailed",void 0,Ja.bind(this)),this.system.mapHandler("startTimeFound",void 0,Ka.bind(this)),this.system.mapHandler("needForReload",void 0,Aa.bind(this)),this[k.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR]=ca.bind(this),g=pa.bind(this),h=sa.bind(this),i=ta.bind(this),j=ua.bind(this),l=va.bind(this),o=wa.bind(this),p=za.bind(this),m=xa.bind(this),n=ya.bind(this),f=la.bind(this),q=ma.bind(this),r=na.bind(this),s=oa.bind(this),c=qa.bind(this),e=ra.bind(this),E=Oa.bind(this)},load:function(a,b){U=b,Ga.call(this,a)},setVideoModel:function(a){this.videoModel=a,this.videoModel.listen("play",g),this.videoModel.listen("pause",h),this.videoModel.listen("error",i),this.videoModel.listen("seeking",j),this.videoModel.listen("seeked",l),this.videoModel.listen("timeupdate",m),this.videoModel.listen("durationchange",n),this.videoModel.listen("progress",o),this.videoModel.listen("ratechange",p),this.videoModel.listen("loadedmetadata",f),this.videoModel.listen("ended",e),this.videoModel.listen("canplay",q),this.videoModel.listen("playing",r),this.videoModel.listen("loadstart",s),this.videoModel.listen("webkitfullscreenchange",c),this.videoModel.listen("fullscreenchange",c),this.videoModel.listenOnParent("fullscreenchange",c),this.videoModel.listenOnParent("webkitfullscreenchange",c)},setAudioTrack:function(a){var b=this.manifestModel.getValue(),c=this;K&&c.manifestExt.getDataIndex(a,b,U.index).then(function(a){-1!==L&&a!==L&&(L=a,c.system.notify("manifestUpdate"))})},getSelectedAudioTrack:function(){var a=this,b=a.manifestModel.getValue();return K?a.manifestExt.getDataForIndex_(L,b,U.index):void 0},setSubtitleTrack:function(a){var b=d.defer(),c=this.manifestModel.getValue(),e=this;return M?e.manifestExt.getDataIndex(a,c,U.index).then(function(a){O=a,e.system.notify("manifestUpdate")}):b.reject(),b.promise},getSelectedSubtitleTrack:function(){var a=this,b=a.manifestModel.getValue();return M&&N?a.manifestExt.getDataForIndex_(O,b,U.index):void 0},initProtection:function(a){D=a,D&&D.subscribe(k.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,this)},getVideoModel:function(){return this.videoModel},getManifestExt:function(){var a=this;return a.manifestExt},setAutoPlay:function(a){P=a},setDefaultAudioLang:function(a){S=a},setDefaultSubtitleLang:function(a){T=a},getAutoPlay:function(){return P},reset:function(){var a=d.defer(),b=this;return this.debug.info("[Stream] Reset"),Da.call(this),ea.call(this),clearTimeout(B),b.videoModel.setMute(!1),this.videoModel.unlisten("play",g),this.videoModel.unlisten("pause",h),this.videoModel.unlisten("error",i),this.videoModel.unlisten("seeking",j),this.videoModel.unlisten("seeked",l),this.videoModel.unlisten("timeupdate",m),this.videoModel.unlisten("durationchange",n),this.videoModel.unlisten("progress",o),this.videoModel.unlisten("ratechange",p),this.videoModel.unlisten("loadedmetadata",f),this.videoModel.unlisten("ended",e),this.videoModel.unlisten("canplay",q),this.videoModel.unlisten("playing",r),this.videoModel.unlisten("loadstart",s),this.videoModel.unlisten("webkitfullscreenchange",c),this.videoModel.unlisten("fullscreenchange",c),this.videoModel.unlistenOnParent("fullscreenchange",c),this.videoModel.unlistenOnParent("webkitfullscreenchange",c),this.system.unmapHandler("bufferUpdated"),this.system.unmapHandler("liveEdgeFound"),this.system.unmapHandler("bufferingCompleted"),this.system.unmapHandler("segmentLoadingFailed"),this.system.unmapHandler("needForReload"),this.system.unmapHandler("streamsComposed",void 0,Na),ha.call(this).then(function(){D&&D.unsubscribe(k.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,b),D=void 0,b.fragmentController=void 0,a.resolve()}),a.promise},getDuration:function(){return U.duration},getStartTime:function(){return U.start},getPeriodIndex:function(){return U.index},getId:function(){return U.id},getPeriodInfo:function(){return U},startEventController:function(){Z.start()},resetEventController:function(){Z.reset()},enableSubtitles:function(a){a!==N&&(N=a,M&&(a?(this.system.mapHandler("streamsComposed",void 0,Na.bind(this),!0),this.system.notify("manifestUpdate")):M.stop()))},setTrickModeSpeed:function(a){var b,c,e=[],f=this,g=1!==a?!0:!1,h=function(){f.videoModel.getCurrentTime()>b+1&&(f.videoModel.unlisten("timeupdate",h),f.debug.info("[Stream] Set mute: false"),f.videoModel.setMute(!1))};a!==X&&I&&(f.debug.info("[Stream] Trick mode: speed = "+a),g&&"Stopped"===W?(f.debug.info("[Stream] Set mute: true"),f.videoModel.setMute(!0),f.videoModel.pause()):g||(X=1,clearTimeout(B),Da.call(f)),e.push(I.setTrickMode(g,a>1)),K&&e.push(K.setTrickMode(g,a>1)),d.all(e).then(function(){v=X,X=a,b=f.videoModel.getCurrentTime(),g?"Running"===W?W="Changed":"Stopped"===W&&(Y=!1,W="Running",z=y=I.getSegmentDuration(),w=A=(new Date).getTime()/1e3,x=b,f.debug.info("[Stream] Trick mode (x"+X+"): videoTime = "+x),c=b+z*Math.sign(X),c=Math.round(1e3*(c-c%y))/1e3,f.debug.info("[Stream] Trick mode (x"+X+"): seek step = "+z),C=c,fa.call(f,c)):(f.debug.info("[Stream] Trick mode: Stopped, current time = "+b),W="Stopped",f.videoModel.listen("timeupdate",h),b=Y?f.getStartTime():b,fa.call(f,Y?f.getStartTime():b,!0))}))},getTrickModeSpeed:function(){return X},updateData:Ma,play:da,seek:fa,pause:ea}},k.dependencies.Stream.prototype={constructor:k.dependencies.Stream},k.dependencies.StreamController=function(){"use strict";var a,b,c,e,f,g,h,i,j,l,m=[],n=!1,o=6,p=.2,q=!0,r=!1,s="und",t="und",u=!1,v=!1,w=function(a,b){var c=a.getElement(),e=b.getElement();return e.parentNode||c.parentNode.insertBefore(e,c),c.style.width="0px",e.style.width="100%",z(c,e),y.call(this,a),x.call(this,b),d.when(!0)},x=function(a){a.listen("seeking",e),a.listen("progress",f),a.listen("timeupdate",c),a.listen("pause",g),a.listen("play",h)},y=function(a){a.unlisten("seeking",e),a.unlisten("progress",f),a.unlisten("timeupdate",c),a.unlisten("pause",g),a.unlisten("play",h)},z=function(a,b){["controls","loop","muted","playbackRate","volume"].forEach(function(c){b[c]=a[c]})},A=function(){var b=a.getVideoModel().getElement().buffered;if(b.length){var c=b.length-1,d=b.end(c),e=a.getStartTime()+a.getDuration()-d;o>e&&(a.getVideoModel().unlisten("progress",f),F())}},B=function(){var b=a.getStartTime()+a.getDuration(),c=a.getVideoModel().getCurrentTime(),d=this,e=a.getVideoModel().getElement(),f=d.videoExt.getPlaybackQuality(e),g=((new Date).getTime()-d.startPlayingTime)/1e3;d.metricsModel.addCondition(null,null,e.videoWidth,e.videoHeight,f.droppedVideoFrames,f.totalVideoFrames/g),G()&&(a.getVideoModel().getElement().seeking||p>b-c&&K.call(this,a,G()))},C=function(){var b=a.getVideoModel().getCurrentTime(),c=H(b);this.metricsModel.addState("video","seeking",a.getVideoModel().getCurrentTime()),c&&c!==a&&K.call(this,a,c,b)},D=function(){this.manifestUpdater.stop(),this.metricsModel.addState("video","paused",a.getVideoModel().getCurrentTime())},E=function(){this.manifestUpdater.start(),void 0===this.startPlayingTime&&(this.startPlayingTime=(new Date).getTime());var b=a.getVideoModel().getElement();this.metricsModel.addCondition(null,0,b.videoWidth,b.videoHeight)},F=function(){var a=G();a&&a.seek(a.getStartTime())},G=function(){var b=a.getPeriodIndex()+1;return b<m.length?m[b]:null},H=function(a){var b=0,c=null,d=m.length,e=0;for(d>0&&(b+=m[0].getStartTime()),e=0;d>e;e+=1)if(c=m[e],b+=c.getDuration(),b>a)return c},I=function(){var a=this.system.getObject("videoModel"),b=document.createElement("video");return a.setElement(b),a},J=function(a){a.parentNode&&a.parentNode.removeChild(a)},K=function(b,c,d){!r&&b&&c&&b!==c&&(r=!0,b.pause(),a=c,w.call(this,b.getVideoModel(),c.getVideoModel()),d?seek(b.getVideoModel().getCurrentTime()):seek(c.getStartTime()),play(),b.resetEventController(),a.startEventController(),r=!1)},L=function(){var c,e,f,g,h,i,j,k=this,o=k.manifestModel.getValue(),p=k.metricsModel.getMetricsFor("stream"),r=k.metricsExt.getCurrentManifestUpdate(p),v=d.defer(),w=[];return k.startPlayingTime=void 0,o?(k.capabilities.supportsEncryptedMedia()&&(b||(b=k.system.getObject("protectionController"),n=!0),b.setMediaElement(k.videoModel.getElement()),l&&b.setProtectionData(l)),k.manifestExt.getMpd(o).then(function(l){a&&(c=a.getPeriodInfo(),l.isClientServerTimeSyncCompleted=c.mpd.isClientServerTimeSyncCompleted,l.clientServerTimeShift=c.mpd.clientServerTimeShift),k.manifestExt.getRegularPeriods(o,l).then(function(c){if(0===c.length)return v.reject();for(g=0,e=c.length;e>g;g+=1){for(i=c[g],h=0,f=m.length;f>h;h+=1)m[h].getId()===i.id&&(j=m[h],w.push(j.updateData(i)));j||(j=k.system.getObject("stream"),j.setVideoModel(0===g?k.videoModel:I.call(k)),j.initProtection(b),j.setAutoPlay(q),j.setDefaultAudioLang(s),j.setDefaultSubtitleLang(t),j.enableSubtitles(u),j.load(o,i),m.push(j)),k.metricsModel.addManifestUpdatePeriodInfo(r,i.id,i.index,i.start,i.duration),j=null}a||(a=m[0],x.call(k,a.getVideoModel())),k.metricsModel.updateManifestUpdateInfo(r,{currentTime:k.videoModel.getCurrentTime(),buffered:k.videoModel.getElement().buffered,presentationStartTime:c[0].start,clientTimeOffset:l.clientServerTimeShift}),d.all(w).then(function(){v.resolve()})})}),v.promise):d.when(!1)},M=function(){if(a){var b=this;b.manifestExt.getAudioDatas(b.manifestModel.getValue(),a.getPeriodIndex()).then(function(a){i=a,b.system.notify("audioTracksUpdated")},function(){i=null,b.system.notify("audioTracksUpdated")})}},N=function(){if(a){var b=this;b.manifestExt.getTextDatas(b.manifestModel.getValue(),a.getPeriodIndex()).then(function(a){j=a,b.system.notify("subtitleTracksUpdated")},function(){j=null,b.system.notify("subtitleTracksUpdated")})}},O=function(a){a===!0&&(v=!0),this.refreshManifest()},P=function(){var a=this;L.call(a).then(function(){M.call(a),N.call(a),a.system.notify("streamsComposed")},function(){a.errHandler.sendError(k.dependencies.ErrorHandler.prototype.MANIFEST_ERR_NO_STREAM,"No stream/period is provided in the manifest"),a.reset()})};return{system:void 0,videoModel:void 0,parser:void 0,manifestLoader:void 0,manifestUpdater:void 0,manifestModel:void 0,manifestExt:void 0,fragmentExt:void 0,capabilities:void 0,debug:void 0,metricsModel:void 0,metricsExt:void 0,videoExt:void 0,errHandler:void 0,eventBus:void 0,notify:void 0,subscribe:void 0,unsubscribe:void 0,startTime:void 0,startPlayingTime:void 0,currentURL:void 0,setup:function(){this.system.mapHandler("manifestUpdate",void 0,O.bind(this)),this.system.mapHandler("manifestUpdated",void 0,P.bind(this)),c=B.bind(this),f=A.bind(this),e=C.bind(this),g=D.bind(this),h=E.bind(this)},getManifestExt:function(){return a.getManifestExt()},setAutoPlay:function(a){q=a},getAutoPlay:function(){return q},getVideoModel:function(){return this.videoModel},setVideoModel:function(a){this.videoModel=a},getAudioTracks:function(){return i},getSelectedAudioTrack:function(){return a?a.getSelectedAudioTrack():void 0},setAudioTrack:function(b){a&&a.setAudioTrack(b)},getSubtitleTracks:function(){return j},setSubtitleTrack:function(b){a&&a.setSubtitleTrack(b)},getSelectedSubtitleTrack:function(){return a?a.getSelectedSubtitleTrack():void 0},load:function(a,b){var c=this;c.currentURL=a,b&&(l=b),c.debug.info("[StreamController] load url: "+a),v=!1,c.manifestLoader.load(a).then(function(a){c.manifestModel.setValue(a),c.metricsModel.addMetaData(),c.debug.info("[StreamController] Manifest has loaded."),c.manifestUpdater.start()},function(a){a&&c.errHandler.sendError(a.name,a.message,a.data)})},refreshManifest:function(a){var b=this.manifestModel.getValue(),c=a?a:b.hasOwnProperty("Location")?b.Location:b.mpdUrl;this.debug.log("### Refresh manifest @ "+c);var d=this;this.manifestLoader.abort(),this.manifestLoader.load(c,!0).then(function(a){d.manifestModel.setValue(a),d.debug.log("### Manifest has been refreshed."),v=!1},function(b){void 0!==b&&(a?v&&d.errHandler.sendError(b.name,b.message,b.data):(d.errHandler.sendWarning(b.name,b.message,b.data),d.eventBus.dispatchEvent({type:"manifestUrlUpdate",data:{url:c}})))})},reset:function(){var c={},e=[],f=this;this.debug.info("[StreamController] Reset"),a&&y.call(this,a.getVideoModel()),this.pause(),this.manifestUpdater.stop(),this.manifestLoader.abort(),this.parser.reset(),this.metricsModel.clearAllCurrentMetrics(),r=!1,c[k.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE]=function(){var c,g,h=0;for(n=!1,b=null,l=null,h=0,c=m.length;c>h;h+=1)g=m[h],e.push(g.reset()),g!==a&&J(g.getVideoModel().getElement()),delete m[h];f.videoModel.reset(),d.all(e).then(function(){m=[],a=null,f.notify(k.dependencies.StreamController.eventList.ENAME_TEARDOWN_COMPLETE)}),f.manifestModel.setValue(null)},b?n?(b.protectionModel.subscribe(k.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE,c,void 0,!0),b.teardown()):(b.setMediaElement(null),c[k.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE]()):c[k.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE]()},setDefaultAudioLang:function(a){s=a},setDefaultSubtitleLang:function(a){t=a},enableSubtitles:function(b){u=b,a&&a.enableSubtitles(b)},setTrickModeSpeed:function(b){a&&a.setTrickModeSpeed(b)},getTrickModeSpeed:function(){return a?a.getTrickModeSpeed():0},play:function(){a.play()},pause:function(){a&&a.pause()},seek:function(b){a&&a.seek(b)}}},k.dependencies.StreamController.prototype={constructor:k.dependencies.StreamController},k.dependencies.StreamController.eventList={ENAME_STREAMS_COMPOSED:"streamsComposed",ENAME_TEARDOWN_COMPLETE:"streamTeardownComplete"},k.utils.TokenAuthentication=function(){"use strict";var a={type:k.utils.TokenAuthentication.TYPE_QUERY};return{debug:void 0,getTokenAuthentication:function(){return a},setTokenAuthentication:function(b){a=b},checkRequestHeaderForToken:function(b){void 0!==a.name&&null!==b.getResponseHeader(a.name)&&(a.token=b.getResponseHeader(a.name),this.debug.log(a.name+" received: "+a.token))},addTokenAsQueryArg:function(b){if(void 0!==a.name&&void 0!==a.token&&a.type===k.utils.TokenAuthentication.TYPE_QUERY){var c=-1===b.indexOf("?")?"?":"&";b+=c+a.name+"="+a.token,this.debug.log(a.name+" is being appended on the request url with a value of : "+a.token)}return b},setTokenInRequestHeader:function(b){return a.type===k.utils.TokenAuthentication.TYPE_HEADER&&(b.setRequestHeader(a.name,a.token),this.debug.log(a.name+" is being set in the request header with a value of : "+a.token)),b}}},k.utils.TokenAuthentication.TYPE_QUERY="query",k.utils.TokenAuthentication.TYPE_HEADER="header",k.models.URIQueryAndFragmentModel=function(){"use strict";var a=new k.vo.URIFragmentData,b=[],c=function(){a=new k.vo.URIFragmentData,b=[]},d=function(c){function d(a,b,c,d){var e=d[0].split(/[=]/);return d.push({key:e[0],value:e[1]}),d.shift(),d}function e(a,c,d){return c>0&&(j&&0===b.length?b=d[c].split(/[&]/):k&&(g=d[c].split(/[&]/))),d}var f,g=[],h=new RegExp(/[?]/),i=new RegExp(/[#]/),j=h.test(c),k=i.test(c);return f=c.split(/[?#]/).map(e),b.length>0&&(b=b.reduce(d,null)),g.length>0&&(g=g.reduce(d,null),g.forEach(function(b){a[b.key]=b.value})),c};return{parseURI:d,reset:c,getURIFragmentData:function(){return a},getURIQueryData:b}},k.models.URIQueryAndFragmentModel.prototype={constructor:k.models.URIQueryAndFragmentModel},k.models.VideoModel=function(){"use strict";var a,b={},c=function(){for(var a in b)if(b[a]===!0)return!0;return!1},d=function(d,e){b[d]=e,c()?(this.debug.info("<video> setPlaybackRate(0)"),a.playbackRate=0):(this.debug.info("<video> setPlaybackRate(1)"),a.playbackRate=1)};return{system:void 0,debug:void 0,setup:function(){},reset:function(){b=[]},play:function(){this.debug.info("<video> play()"),a.play()},pause:function(){this.debug.info("<video> pause()"),a.pause()},isPaused:function(){return a.paused},isSeeking:function(){return a.seeking},getDuration:function(){return a.duration},getPlaybackRate:function(){return a.playbackRate},setPlaybackRate:function(b){this.debug.info("<video> setPlaybackRate("+b+")"),a.playbackRate=b},getMute:function(){return a.muted},setMute:function(b){a.muted=b},getCurrentTime:function(){return a.currentTime},setCurrentTime:function(b){this.debug.info("<video> setCurrentTime("+b+")"),a.currentTime=b},listen:function(b,c){a.addEventListener(b,c,!1)},unlisten:function(b,c){a.removeEventListener(b,c,!1)},listenOnParent:function(b,c){a.parentElement.addEventListener(b,c,!1)},unlistenOnParent:function(b,c){a.parentElement.removeEventListener(b,c,!1)},getElement:function(){return a},setElement:function(b){a=b},setSource:function(b){a.src=b},isStalled:function(){return 0===a.playbackRate},stallStream:d}},k.models.VideoModel.prototype={constructor:k.models.VideoModel},k.dependencies.VideoModelExtensions=function(){"use strict";return{getPlaybackQuality:function(a){var b="webkitDroppedFrameCount"in a,c="getVideoPlaybackQuality"in a,d=null;return c?d=a.getVideoPlaybackQuality():b&&(d={droppedVideoFrames:a.webkitDroppedFrameCount,creationTime:new Date,totalVideoFrames:a.webkitDecodedFrameCount}),d}}},k.dependencies.VideoModelExtensions.prototype={constructor:k.dependencies.VideoModelExtensions},k.dependencies.TextController=function(){var a,b,c,e,f="LOADING",g="READY",h=!1,i=null,j=g,k=function(a){this.debug.log("TextController setState to:"+a),j=a},l=function(){if(h&&j===g){var a=this;a.indexHandler.getInitRequest(e[0]).then(function(b){a.fragmentLoader.load(b).then(o.bind(a,b),p.bind(a,b)),k.call(a,f)})}},m=function(){l.call(this)},n=function(a,b){var c=this,e=d.defer(),f=c.manifestModel.getValue();return c.manifestExt.getDataIndex(a,f,b.index).then(function(a){
c.manifestExt.getAdaptationsForPeriod(f,b).then(function(b){c.manifestExt.getRepresentationsForAdaptation(f,b[a]).then(function(a){e.resolve(a)})})}),e.promise},o=function(a,b){var d=this;d.fragmentController.process(b.data,a).then(function(a){null!==a&&d.sourceBufferExt.append(c,a,d.videoModel)})},p=function(){};return{videoModel:void 0,fragmentLoader:void 0,fragmentController:void 0,indexHandler:void 0,sourceBufferExt:void 0,manifestModel:void 0,manifestExt:void 0,debug:void 0,initialize:function(a,b,c,d,e){var f=this;f.setVideoModel(d),f.setBuffer(c),f.setMediaSource(e),f.updateData(b,a).then(function(){h=!0,l.call(f)})},setPeriodInfo:function(a){i=a},getPeriodIndex:function(){return i.index},getVideoModel:function(){return this.videoModel},setVideoModel:function(a){this.videoModel=a},getData:function(){return b},setData:function(a){b=a},getBuffer:function(){return c},setBuffer:function(a){c=a},setMediaSource:function(b){a=b},updateData:function(a,c){var f=this,h=d.defer();return b=a,i=c,n.call(f,b,i).then(function(a){e=a,k.call(f,g),l.call(f),h.resolve()}),h.promise},reset:function(b){b||(this.sourceBufferExt.abort(a,c),this.sourceBufferExt.removeSourceBuffer(a,c))},start:m}},k.dependencies.TextController.prototype={constructor:k.dependencies.TextController},k.dependencies.TextSourceBuffer=function(){var a,b,c;return{system:void 0,eventBus:void 0,errHandler:void 0,initialize:function(d,e){c=d,a=e.getVideoModel().getElement(),b=e.getData()},append:function(c){var d=this,e=String.fromCharCode.apply(null,new Uint16Array(c));d.getParser().parse(e).then(function(c){var e=b.Representation_asArray[0].id,f=b.lang;d.getTextTrackExtensions().addTextTrack(a,c,e,f,!0).then(function(){d.eventBus.dispatchEvent({type:"updateend"})})},function(a){d.errHandler.sendError(k.dependencies.ErrorHandler.prototype.CC_ERR_PARSE,a,e)})},abort:function(){this.getTextTrackExtensions().deleteCues(a)},getParser:function(){var a;return"text/vtt"===c?a=this.system.getObject("vttParser"):"application/ttml+xml"===c&&(a=this.system.getObject("ttmlParser")),a},getTextTrackExtensions:function(){return this.system.getObject("textTrackExtensions")},addEventListener:function(a,b,c){this.eventBus.addEventListener(a,b,c)},removeEventListener:function(a,b,c){this.eventBus.removeEventListener(a,b,c)}}},k.dependencies.TextSourceBuffer.prototype={constructor:k.dependencies.TextSourceBuffer},k.utils.TextTrackExtensions=function(){"use strict";var a;return{eventBus:void 0,config:void 0,setup:function(){a=window.VTTCue||window.TextTrackCue},cueEnter:function(a,b){this.eventBus.dispatchEvent({type:"cueEnter",data:{text:b,style:a}})},cueExit:function(a,b){this.eventBus.dispatchEvent({type:"cueExit",data:{text:b,style:a}})},addTextTrack:function(b,c,e,f,g){var h,i=null,j=null,k="subtitles";for(0===b.textTracks.length?(k=this.config.getParam("TextTrackExtensions.displayModeExtern","boolean")===!0?"metadata":"subtitles",i=b.addTextTrack(k,e,f),i["default"]=g,i.mode="showing"):i=b.textTracks[0],h=0;h<c.length;h+=1)j=c[h],i.addCue(new a(j.start,j.end,j.data));return d.when(i)},onCueEnter:function(a){this.cueEnter(a.currentTarget.style,a.currentTarget.text)},onCueExit:function(a){this.cueExit(a.currentTarget.style,a.currentTarget.text)},addCues:function(b,c){var d=0,e=null,f=null;for(d=0;d<c.length;d+=1)e=c[d],e.start<e.end&&(f=new a(e.start,e.end,e.data),f.onenter=this.onCueEnter.bind(this),f.onexit=this.onCueExit.bind(this),f.snapToLines=!1,f.line=e.line,e.style&&(f.style=e.style),b.addCue(f))},deleteCues:function(a,b,c,d){var e=null,f=null,g=null,h=0;if(a&&(e=a.textTracks[0])){if(f=e.cues)for(g=f.length-1,h=g;h>=0;h-=1)(void 0===d||-1===d||f[h].endTime<d)&&(void 0===c||-1===c||f[h].startTime>c)&&e.removeCue(f[h]);b&&(e.mode="disabled")}}}},k.dependencies.TextTTMLXMLMP4SourceBuffer=function(){var a,b,c,e,f={length:0,ranges:[],start:function(a){return this.ranges[a].start},end:function(a){return this.ranges[a].end},addRange:function(a,b){var c=0,d=!1,e=.01;for(c=0;c<this.ranges.length;c++)this.ranges[c].end<=a+e&&this.ranges[c].end>=a-e&&(d=!0,this.ranges[c].end=b),this.ranges[c].start<=b+e&&this.ranges[c].start>=b-e&&(d=!0,this.ranges[c].start=a);d||(this.ranges.push({start:a,end:b}),this.length=this.length+1,this.ranges.sort(function(a,b){return a.start-b.start}))},removeRange:function(a,b){var c=0;for(c=this.ranges.length-1;c>=0;c-=1)(void 0===b||-1===b||this.ranges[c].end<=b)&&(void 0===a||-1===a||this.ranges[c].start>=a)&&this.ranges.splice(c,1);this.length=this.ranges.length},reset:function(){this.length=0,this.ranges=[]}};return{updating:!1,system:void 0,eventBus:void 0,buffered:f,textTrackExtensions:void 0,ttmlParser:void 0,debug:void 0,initialize:function(d,g,h){b=d,a=g.getVideoModel().getElement(),f.reset(),c=h.lang,e=h.id},remove:function(b,c){if(0>b||b>=c)throw"INVALID_ACCESS_ERR";this.getTextTrackExtensions().deleteCues(a,!1,b,c),this.buffered.removeRange(b,c)},append:function(b){var d,f,g,h,i,j,k,l,m=this,n=q.deserialize(b),o=n.getBoxByType("moov"),p=0,r="utf-8";return o?(d=o.getBoxByType("mvhd"),m.timescale=d.timescale,void m.textTrackExtensions.addTextTrack(a,[],e,c,!0).then(function(a){m.track=a,m.eventBus.dispatchEvent({type:"updateend"})})):(f=n.getBoxByType("moof"),void(f&&(g=n.getBoxByType("mdat"),h=f.getBoxByType("traf"),i=h.getBoxByType("tfhd"),j=h.getBoxByType("tfdt"),k=h.getBoxByType("trun"),l=j.baseMediaDecodeTime/m.timescale,p=0,p=256&k.flags?k.samples_table[0].sample_duration/m.timescale:i.default_sample_duration/m.timescale,m.buffered.addRange(l,l+p),m.isUTF16(g.data)&&(r="utf-16"),m.convertUTFToString(g.data,r).then(function(a){m.ttmlParser.parse(a).then(function(a){var b;if(a){for(b=0;b<a.length;b+=1)a[b].start=a[b].start+l,a[b].end=a[b].end+l;m.textTrackExtensions.addCues(m.track,a),m.eventBus.dispatchEvent({type:"updateend"})}},function(a){})}))))},convertUTFToString:function(a,b){var c=d.defer(),e=new Blob([a],{type:"text/xml"}),f=new FileReader;return f.onload=function(a){c.resolve(a.target.result)},f.readAsText(e,b),c.promise},isUTF16:function(a){var b,c,d,e,f=0,g=a&&a.length,h=null;if(2>g){if(a[0]>255)return!1}else{if(b=a[0],c=a[1],255===b&&254===c)return!0;if(254===b&&255===c)return!0;for(;g>f;f++){if(0===a[f]){h=f;break}if(a[f]>255)return!1}if(null===h)return!1;if(d=a[h+1],void 0!==d&&d>0&&128>d)return!0;if(e=a[h-1],void 0!==e&&e>0&&128>e)return!0}return!1},abort:function(){this.getTextTrackExtensions().deleteCues(a,!0)},getTextTrackExtensions:function(){return this.textTrackExtensions},addEventListener:function(a,b,c){this.eventBus.addEventListener(a,b,c),this.updating||this.eventBus.dispatchEvent({type:"updateend"})},removeEventListener:function(a,b,c){this.eventBus.removeEventListener(a,b,c)}}},k.dependencies.TextTTMLXMLMP4SourceBuffer.prototype={constructor:k.dependencies.TextTTMLXMLMP4SourceBuffer},k.utils.TTMLParser=function(){"use strict";var a=3600,b=60,c="http://www.w3.org/2006/10/ttaf1",e="http://www.w3.org/2006/10/ttaf1#parameter",f="http://www.w3.org/2006/10/ttaf1#styling",g="http://www.w3.org/ns/ttml",h="http://www.w3.org/ns/ttml#parameter",i="http://www.w3.org/ns/ttml#styling",j="",k="",l="",m=/^(0[0-9]|1[0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])((\.[0-9][0-9][0-9])|(:[0-9][0-9]))$/,n=/^\d+(\.\d+|)(h|m|s|ms|f)$/,o=null,p=null,q=null,r=null,s=null,t=null,u=null,v=[],w=[],x=function(c){var d,e,f;if(m.test(c))return d=c.split(":"),e=parseFloat(d[0])*a+parseFloat(d[1])*b+parseFloat(d[2]),d[3]&&u&&!isNaN(u)&&(e+=parseFloat(d[3])/u),e;if(n.test(c)){switch("ms"==c.substr(c.length-2)?(e=parseFloat(c.substr(0,c.length-3)),f=c.substr(c.length-2)):(e=parseFloat(c.substr(0,c.length-2)),f=c.substr(c.length-1)),f){case"h":e=60*e*60;break;case"m":e=60*e;break;case"s":break;case"ms":e=.01*e;break;case"f":if(!u||isNaN(u))return NaN;e/=u}return e}return NaN},y=function(){var a=!1;return p=o?this.domParser.getChildNode(o,"tt"):null,q=p?this.domParser.getChildNode(p,"head"):null,r=q?this.domParser.getChildNode(q,"layout"):null,s=q?this.domParser.getChildNode(q,"styling"):null,t=p?this.domParser.getChildNode(p,"body"):null,p&&q&&r&&s&&t&&(a=!0),a},z=function(a,b){var c,d,e=0,f=0,g=0,h=0,i=0,l=0,m=0;for(f=0;f<a.length;f+=1){for(g=0;g<k.length;g+=1)if(c=this.domParser.getAttributeValue(a[f],k[g]+b))return c;for(g=0;g<j.length;g+=1)if(c=this.domParser.getAttributeValue(a[f],j[g]+"style"))for(e=0;e<v[c].length;e+=1)for(h=0;h<k.length;h+=1)if(v[c][e].name===k[h]+b)return v[c][e].nodeValue;for(g=0;g<j.length;g+=1)if(d=this.domParser.getAttributeValue(a[f],j[g]+"region"))for(e=0;e<w[d].length;e+=1){for(h=0;h<k.length;h+=1)if(w[d][e].name===k[h]+b)return w[d][e].nodeValue;for(i=0;i<j.length;i+=1)if(c=w[d][e].nodeName===j[i]+"style"?w[d][e].nodeValue:null)for(l=0;l<v[c].length;l+=1)for(m=0;m<k.length;m+=1)if(v[c][l].name===k[m]+b)return v[c][l].nodeValue}}return null},A=function(a,b){var c=null,d=0,e=0;for(d=0;d<a.length;d++)for(e=0;e<l.length;e+=1)if(c=this.domParser.getAttributeValue(a[d],l[e]+b))return c;return c},B=function(a,b){var d=null,j=null,k=null,l=0;switch(b){case"style":j=f,k=i;break;case"parameter":j=e,k=h;break;case"main":j=c,k=g}if(j&&k&&(d=this.domParser.getAttributeName(a,j),0===d.length&&(d=this.domParser.getAttributeName(a,k)),d.length>0))for(l=0;l<d.length;l+=1)d[l]=d[l].split(":").length>1?d[l].split(":")[1]+":":"";return d},C=function(a,b){var c=NaN,d=0;for(d=0;d<j.length&&isNaN(c);d+=1)c=x(this.domParser.getAttributeValue(a,j[d]+b));return c},D=function(a){var b,c,e,f,g,h,i,m,n,q,r,s,x,D,E=[],F=null,G=null,H={backgroundColor:null,color:null,fontSize:null,fontFamily:null};try{if(o=this.domParser.createXmlTree(a),!y.call(this))return b="TTML document has incorrect structure",d.reject(b);for(j=B.call(this,p,"main"),l=B.call(this,p,"parameter"),k=B.call(this,p,"style"),m=0;m<l.length;m+=1)u=this.domParser.getAttributeValue(p,l[m]+"frameRate")?parseInt(u,10):null;if(i=this.domParser.getChildNodes(t,"div"),!i||0===i.length)return b="TTML body document does not contain any div",d.reject(b);for(r=0;r<i.length;r+=1)if(c=this.domParser.getChildNodes(i[r],"p"),c&&0!==c.length)for(v=this.domParser.getAllSpecificNodes(p,"style"),w=this.domParser.getAllSpecificNodes(p,"region"),m=0;m<c.length;m+=1)if(h=null,e=c[m],j=j.concat(B.call(this,e,"main")),k=k.concat(B.call(this,e,"style")),f=C.call(this,e,"begin"),g=C.call(this,e,"end"),isNaN(f)||isNaN(g))b="TTML document has incorrect timing value";else if(n=this.domParser.getChildNodes(e,"span"),n.length>0){for(q=0;q<n.length;q++)H.backgroundColor=z.call(this,[n[q],e,i],"backgroundColor"),H.color=z.call(this,[n[q],e,i],"color"),H.fontSize=z.call(this,[n[q],e,i],"fontSize"),H.fontFamily=z.call(this,[n[q],e,i],"fontFamily"),D=z.call(this,[n[q],e,i],"extent"),H.fontSize&&"%"===H.fontSize[H.fontSize.length-1]&&D?(D=D.split(" ")[1],D=parseFloat(D.substr(0,D.length-1)),H.fontSize=parseInt(H.fontSize.substr(0,H.fontSize.length-1),10)*D/100+"%"):H.fontSize&&"c"===H.fontSize[H.fontSize.length-1]&&D&&(s=H.fontSize.replace(/\s/g,"").split("c"),x=A.call(this,[n[q],e,i,p],"cellResolution").split(" "),s.length>1?H.fontSize=x[1]/s[1]+"px":H.fontSize=x[1]/s[0]+"px"),h=0===q?{start:f,end:g,data:n[q].textContent,line:80,style:H}:{start:f,end:g,data:n[q-1].textContent+"\n"+n[q].textContent,line:80,style:H};E.push(h)}else H.backgroundColor=z.call(this,[e,i],"backgroundColor"),H.color=z.call(this,[e,i],"color"),H.fontSize=z.call(this,[e,i],"fontSize"),H.fontFamily=z.call(this,[e,i],"fontFamily"),D=z.call(this,[e,i],"extent"),H.fontSize&&"%"===H.fontSize[H.fontSize.length-1]&&D&&(D=D.split(" ")[1],D=parseFloat(D.substr(0,D.length-1)),H.fontSize=parseInt(H.fontSize.substr(0,H.fontSize.length-1),10)*D/100+"%"),m>0&&(F=C.call(this,c[m-1],"begin"),G=C.call(this,c[m-1],"end")),f===F&&g===G?(E.pop(),h={start:f,end:g,data:c[m-1].textContent+"\n"+e.textContent,line:80,style:H}):h={start:f,end:g,data:e.textContent,line:80,style:H},E.push(h);else b="TTML document does not contain any cues";return E.length>0?d.when(E):d.reject(b)}catch(I){return b=I.message,d.reject(b)}};return{domParser:void 0,parse:D}},k.utils.VTTParser=function(){"use strict";var a=function(a){var b=a.split(":"),c=b.length-1;return a=60*parseInt(b[c-1],10)+parseFloat(b[c],10),2===c&&(a+=3600*parseInt(b[0],10)),a};return{parse:function(b){var c,e=/(?:\r\n|\r|\n)/gm,f=/-->/,g=/(^[\s]+|[\s]+$)/g,h=[];b=b.split(e),c=b.length;for(var i=0;c>i;i++){var j=b[i];if(j.length>0&&"WEBVTT"!==j&&j.match(f)){var k=j.split(f),l=b[i+1];h.push({start:a(k[0].replace(g,"")),end:a(k[1].replace(g,"")),data:l})}}return d.when(h)}}},k.models.ProtectionModel=function(){},k.models.ProtectionModel.eventList={ENAME_NEED_KEY:"needkey",ENAME_KEY_SYSTEM_ACCESS_COMPLETE:"keySystemAccessComplete",ENAME_KEY_SYSTEM_SELECTED:"keySystemSelected",ENAME_VIDEO_ELEMENT_SELECTED:"videoElementSelected",ENAME_SERVER_CERTIFICATE_UPDATED:"serverCertificateUpdated",ENAME_KEY_MESSAGE:"keyMessage",ENAME_KEY_ADDED:"keyAdded",ENAME_KEY_ERROR:"keyError",ENAME_KEY_SESSION_CREATED:"keySessionCreated",ENAME_KEY_SESSION_REMOVED:"keySessionRemoved",ENAME_KEY_SESSION_CLOSED:"keySessionClosed",ENAME_KEY_STATUSES_CHANGED:"keyStatusesChanged",ENAME_TEARDOWN_COMPLETE:"protectionTeardownComplete"},k.dependencies.protection.CommonEncryption={findCencContentProtection:function(a){var b,c=null,d=0;for(d=0;d<a.length;++d)b=a[d],"urn:mpeg:dash:mp4protection:2011"===b.schemeIdUri.toLowerCase()&&"cenc"===b.value.toLowerCase()&&(c=b);return c},getPSSHData:function(a){var b=8,c=new DataView(a),d=c.getUint8(b);return b+=20,d>0&&(b+=4+16*c.getUint32(b)),b+=4,a.slice(b)},getPSSHForKeySystem:function(a,b){var c=k.dependencies.protection.CommonEncryption.parsePSSHList(b);return c.hasOwnProperty(a.uuid.toLowerCase())?c[a.uuid.toLowerCase()]:null},parseInitDataFromContentProtection:function(a){return a&&"pssh"in a?m.decodeArray(a.pssh.__text).buffer:null},readBytes:function(a,b,c){var d=0,e=0;for(e=0;c>e;e++)d<<=8,d+=a[b],b++;return d},parsePSSHList:function(a){if(null===a)return[];var b,c,d,e,f,g,h,i,j=a,k=!1,l={},m=0;for(a.buffer||(j=new Uint8Array(a));!(k||(g=m,m>=j.byteLength));)if(b=this.readBytes(j,m,4),c=m+b,m+=4,1886614376===this.readBytes(j,m,4))if(m+=4,d=this.readBytes(j,m,1),0===d||1===d){for(m+=1,m+=3,e="",h=0;4>h;h++)i=this.readBytes(j,m+h,1).toString(16),e+=1===i.length?"0"+i:i;for(m+=4,e+="-",h=0;2>h;h++)i=this.readBytes(j,m+h,1).toString(16),e+=1===i.length?"0"+i:i;for(m+=2,e+="-",h=0;2>h;h++)i=this.readBytes(j,m+h,1).toString(16),e+=1===i.length?"0"+i:i;for(m+=2,e+="-",h=0;2>h;h++)i=this.readBytes(j,m+h,1).toString(16),e+=1===i.length?"0"+i:i;for(m+=2,e+="-",h=0;6>h;h++)i=this.readBytes(j,m+h,1).toString(16),e+=1===i.length?"0"+i:i;m+=6,e=e.toLowerCase(),f=this.readBytes(j,m,4),m+=4,l[e]=j.subarray(g,c).buffer,m=c}else m=c;else m=c;return l},getKeySystemConfigurations:function(a,b,c){var d=[],e=[];return a&&e.push(new k.vo.protection.MediaCapability(a)),b&&d.push(new k.vo.protection.MediaCapability(b)),[new k.vo.protection.KeySystemConfiguration(d,e,"optional","temporary"===c?"optional":"required",[c])]}},ArrayBuffer.isView||(ArrayBuffer.isView=function(a){return a instanceof ArrayBuffer}),ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=function(a,b){var c,d,e,f=this.byteLength;return a=0|a||0,b=void 0===b?f:0|b,0>a&&(a=Math.max(a+f,0)),0>b&&(b=Math.max(b+f,0)),0===f||a>=f||a>=b?new ArrayBuffer(0):(c=Math.min(f-a,b-a),d=new ArrayBuffer(c),e=new Uint8Array(d),e.set(new Uint8Array(this,a,c)),d)}),k.dependencies.ProtectionController=function(){"use strict";var a,b,c,d=null,e=[],f=null,g=!1,h=function(a){var b=null,d=a.systemString;return c&&(b=d in c?c[d]:null),b},i=function(c,d){var f,g,h,i,j,l=this,m=[],n=[],o=0;if(l.debug.log("[DRM] Select key system"),this.keySystem){for(g=0;g<c.length;g++)if(this.keySystem===c[g].ks){f=c[g].ks.sessionType,m.push({ks:c[g].ks,configs:c[g].ks.getKeySystemConfigurations(b,a,f)}),n.push({schemeIdURI:c[g].ks.schemeIdURI,systemString:c[g].ks.systemString}),h={},h[k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE]=function(a){a.error?l.eventBus.dispatchEvent({type:k.dependencies.ProtectionController.events.KEY_SYSTEM_SELECTED,error:"[DRM] KeySystem Access Denied! -- "+a.error}):(l.debug.log("[DRM] KeySystem Access Granted"),l.eventBus.dispatchEvent({type:k.dependencies.ProtectionController.events.KEY_SYSTEM_SELECTED,data:a.data}),l.createKeySession(c[g].initData,c[g].cdmData))},this.protectionModel.subscribe(k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,h,void 0,!0),this.protectionModel.requestKeySystemAccess(m);break}}else if(void 0===this.keySystem){for(this.keySystem=null,e.push(c),o=0;o<c.length;o++)f=c[o].ks.sessionType,m.push({ks:c[o].ks,configs:c[o].ks.getKeySystemConfigurations(b,a,f)}),n.push({schemeIdURI:c[o].ks.schemeIdURI,systemString:c[o].ks.systemString});i={},i[k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE]=function(a){a.error?(l.debug.log("[DRM] KeySystem Access Denied!"),l.keySystem=void 0,l.protectionModel.unsubscribe(k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED,i),d||l.eventBus.dispatchEvent({type:k.dependencies.ProtectionController.events.KEY_SYSTEM_SELECTED,error:"[DRM] KeySystem Access Denied! -- "+a.error}),l.notify(k.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new k.vo.Error(k.dependencies.ErrorHandler.prototype.MEDIA_KEYSYSERR_ACCESS_DENIED,"No KeySystem/CDM available",{keySystems:n}))):(j=a.data,l.debug.log("[DRM] KeySystem Access ("+j.keySystem.systemString+") Granted!  Selecting key system..."),l.protectionModel.selectKeySystem(j))},i[k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED]=function(a){if(a.error)l.keySystem=void 0,d||l.eventBus.dispatchEvent({type:k.dependencies.ProtectionController.events.KEY_SYSTEM_SELECTED,error:"[DRM] Error selecting key system! -- "+a.error}),l.notify(k.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new k.vo.Error(k.dependencies.ErrorHandler.prototype.MEDIA_KEYSYSERR_ACCESS_DENIED,"No KeySystem/CDM available",{keySystems:n}));else for(l.debug.log("[DRM] KeySystem selected => create key session"),l.keySystem=l.protectionModel.keySystem,l.eventBus.dispatchEvent({type:k.dependencies.ProtectionController.events.KEY_SYSTEM_SELECTED,data:j}),o=0;o<e.length;o++)for(g=0;g<e[o].length;g++)if(l.keySystem===e[o][g].ks){l.createKeySession(e[o][g].initData,e[o][g].cdmData);break}},this.protectionModel.subscribe(k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED,i,void 0,!0),this.protectionModel.subscribe(k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,i,void 0,!0),this.protectionModel.requestKeySystemAccess(m)}else e.push(c)},j=function(a){var b,c,d=this,e=null;b=a.data,c=b.messageType?b.messageType:"license-request",this.debug.log("[DRM] Key message: type = "+c),this.eventBus.dispatchEvent({type:k.dependencies.ProtectionController.events.KEY_MESSAGE,data:b});var g=b.message,i=b.sessionToken,j=h(this.keySystem),l=this.keySystem.systemString,m=this.protectionExt.getLicenseServer(this.keySystem,j,c),n=!0;if(!m)return void this.debug.log("[DRM] License server request not required for this message (type = "+a.data.messageType+").  Session ID = "+i.getSessionID());if(this.protectionExt.isClearKey(this.keySystem)){var o=this.protectionExt.processClearKeyLicenseRequest(j,g);if(o)return this.debug.log("[DRM] ClearKey license request handled by application!"),void this.protectionModel.updateKeySession(i,o)}f=new XMLHttpRequest;var p=null;if(j)if(j.serverURL){var q=j.serverURL;"string"==typeof q&&""!==q?p=q:"object"==typeof q&&q.hasOwnProperty(c)&&(p=q[c])}else j.laURL&&""!==j.laURL&&(p=j.laURL);else p=this.keySystem.getLicenseServerURLFromInitData(k.dependencies.protection.CommonEncryption.getPSSHData(i.initData)),p||(p=a.data.defaultURL);if(p=m.getServerURLFromMessage(p,g,c),this.debug.log("[DRM] Licenser server url: "+p),!p)return void this.notify(k.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new k.vo.Error(k.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_URL_LICENSER_UNKNOWN,"No license server URL specified"));f.open(m.getHTTPMethod(c),p,!0),f.responseType=m.getResponseType(l,c),f.onload=function(){this.status<200||this.status>299||200===this.status&&4===this.readyState&&(d.debug.log("[DRM] Received license response"),n=!1,e=m.getLicenseMessage(this.response,l,c),null!==e?(n=!1,d.protectionModel.updateKeySession(i,e)):n=!0)},f.onerror=f.onloadend=function(){return n?(n=!1,this.aborted||d.notify(k.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new k.vo.Error(k.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_LICENSER_ERROR,"License request failed",{url:p,status:this.status,error:this.response&&null!==this.response?m.getErrorResponse(this.response):""})),void(f=null)):void(f=null)};var r=function(a){var b;if(a)for(b in a)"authorization"===b.toLowerCase()&&(f.withCredentials=!0),f.setRequestHeader(b,a[b])};j&&r(j.httpRequestHeaders),r(this.keySystem.getRequestHeadersFromMessage(g)),j&&j.withCredentials&&(f.withCredentials=!0),this.debug.log("[DRM] Send license request");var s=this.keySystem.getLicenseRequestFromMessage(g);null===s&&d.notify(k.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new k.vo.Error(k.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_NO_CHALLENGE,"No license challenge from CDM key message")),f.send(this.keySystem.getLicenseRequestFromMessage(g))},l=function(a){var b,c,d=this;return d.debug.log("[DRM] onNeedKey, initDataType = "+a.data.initDataType),"cenc"!==a.data.initDataType?void d.debug.log("[DRM] Only 'cenc' initData is supported!  Ignoring initData of type: "+a.data.initDataType):(b=a.data.initData,ArrayBuffer.isView(b)&&(b=b.buffer),c=this.protectionExt.getSupportedKeySystems(b),0===c.length?void d.debug.log("[DRM] Received needkey event with initData, but we don't support any of the key systems!"):void i.call(this,c,!1))},m=function(a){a.error?(this.debug.error("[DRM] Failed to set license server certificate"),this.notify(k.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new k.vo.Error(k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_SERVER_CERTIFICATE,"Failed to set server certificate",a.error))):this.debug.log("[DRM] License server certificate successfully updated")},n=function(a){a.error?(this.debug.error("[DRM] Failed to create key session"),this.notify(k.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new k.vo.Error(k.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_NO_SESSION,"Failed to create key session",a.error))):this.debug.log("[DRM] Session created.  SessionID = "+a.data.getSessionID())},o=function(){this.debug.log("[DRM] Key added")},p=function(a){this.notify(k.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new k.vo.Error(a.data.code,a.data.message,a.data.data))},q=function(a){a.error?this.debug.warn("[DRM] Failed to close session"):this.debug.log("[DRM] Session closed.  SessionID = "+a.data)},r=function(a){a.error?this.debug.warn("[DRM] Failed to remove session"):this.debug.log("[DRM] Session removed.  SessionID = "+a.data)},s=function(a){a.error||this.debug.log("[DRM] Key statuses changed. statuses = "+a.data)};return{system:void 0,debug:void 0,notify:void 0,subscribe:void 0,unsubscribe:void 0,protectionExt:void 0,keySystem:void 0,setup:function(){this[k.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE]=j.bind(this),this[k.models.ProtectionModel.eventList.ENAME_NEED_KEY]=l.bind(this),this[k.models.ProtectionModel.eventList.ENAME_SERVER_CERTIFICATE_UPDATED]=m.bind(this),this[k.models.ProtectionModel.eventList.ENAME_KEY_ADDED]=o.bind(this),this[k.models.ProtectionModel.eventList.ENAME_KEY_ERROR]=p.bind(this),this[k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED]=n.bind(this),this[k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CLOSED]=q.bind(this),this[k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_REMOVED]=r.bind(this),this[k.models.ProtectionModel.eventList.ENAME_KEY_STATUSES_CHANGED]=s.bind(this),d=this.protectionExt.getKeySystems(),this.protectionModel=this.system.getObject("protectionModel"),this.protectionModel.init(),this.eventBus=this.system.getObject("eventBus"),this.protectionModel.subscribe(k.models.ProtectionModel.eventList.ENAME_SERVER_CERTIFICATE_UPDATED,this),this.protectionModel.subscribe(k.models.ProtectionModel.eventList.ENAME_KEY_ADDED,this),this.protectionModel.subscribe(k.models.ProtectionModel.eventList.ENAME_KEY_ERROR,this),this.protectionModel.subscribe(k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,this),this.protectionModel.subscribe(k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CLOSED,this),this.protectionModel.subscribe(k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_REMOVED,this),this.protectionModel.subscribe(k.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE,this),this.protectionModel.subscribe(k.models.ProtectionModel.eventList.ENAME_KEY_STATUSES_CHANGED,this)},init:function(c,d,e){var f;g||(this.debug.log("[DRM] Initialize ProtectionController ("+e+", "+d+")"),a=d,b=e,f=this.protectionExt.getSupportedKeySystemsFromContentProtection(c),f&&f.length>0&&i.call(this,f,!0),g=!0)},addEventListener:function(a,b){this.eventBus.addEventListener(a,b)},removeEventListener:function(a,b){this.eventBus.removeEventListener(a,b)},teardown:function(){f&&(f.aborted=!0,f.abort()),this.protectionModel.unsubscribe(k.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE,this),this.protectionModel.unsubscribe(k.models.ProtectionModel.eventList.ENAME_SERVER_CERTIFICATE_UPDATED,this),this.protectionModel.unsubscribe(k.models.ProtectionModel.eventList.ENAME_KEY_ADDED,this),this.protectionModel.unsubscribe(k.models.ProtectionModel.eventList.ENAME_KEY_ERROR,this),this.protectionModel.unsubscribe(k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,this),this.protectionModel.unsubscribe(k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CLOSED,this),this.protectionModel.unsubscribe(k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_REMOVED,this),this.protectionModel.unsubscribe(k.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE,this),this.protectionModel.unsubscribe(k.models.ProtectionModel.eventList.ENAME_KEY_STATUSES_CHANGED,this),this.keySystem=void 0,this.protectionModel.teardown(),this.setMediaElement(null),this.protectionModel=void 0},createKeySession:function(a,b){this.debug.log("[DRM] Create key session");var c,d=k.dependencies.protection.CommonEncryption.getPSSHForKeySystem(this.keySystem,a),e=0;if(d){for(c=this.protectionModel.getAllInitData(),e=0;e<c.length;e++)if(this.protectionExt.initDataEquals(d,c[e]))return void this.debug.log("[DRM] Ignoring initData because we have already seen it!");try{this.protectionModel.createKeySession(d,this.keySystem.sessionType,b)}catch(f){this.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,null,{reason:"Create key session raised en exception",error:new k.vo.Error(f.code,f.name,f.message)})}}else this.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,null,{reason:"needkey/encrypted event contains no initData corresponding to that key system "+this.keySystem.systemString,error:null})},loadKeySession:function(a){this.protectionModel.loadKeySession(a)},removeKeySession:function(a){this.protectionModel.removeKeySession(a)},closeKeySession:function(a){this.protectionModel.closeKeySession(a)},setServerCertificate:function(a){this.protectionModel.setServerCertificate(a)},setMediaElement:function(a){a?(this.protectionModel.setMediaElement(a),this.protectionModel.subscribe(k.models.ProtectionModel.eventList.ENAME_NEED_KEY,this)):null===a&&(this.protectionModel.setMediaElement(a),this.protectionModel.unsubscribe(k.models.ProtectionModel.eventList.ENAME_NEED_KEY,this))},setSessionType:function(a){this.keysystem&&(this.keySystem.sessionType=a)},setProtectionData:function(a){c=a,this.protectionExt.init(a)}}},k.dependencies.ProtectionController.events={KEY_SYSTEM_SELECTED:"keySystemSelected",SERVER_CERTIFICATE_UPDATED:"serverCertificateUpdated",KEY_ADDED:"keyAdded",KEY_SESSION_CREATED:"keySessionCreated",KEY_SESSION_REMOVED:"keySessionRemoved",KEY_SESSION_CLOSED:"keySessionClosed",KEY_STATUSES_CHANGED:"keyStatusesChanged",KEY_MESSAGE:"keyMessage",LICENSE_REQUEST_COMPLETE:"licenseRequestComplete"},k.dependencies.ProtectionController.eventList={ENAME_PROTECTION_ERROR:"protectionError"},k.dependencies.ProtectionController.prototype={constructor:k.dependencies.ProtectionController},k.dependencies.ProtectionExtensions=function(){"use strict";this.system=void 0,this.debug=void 0,this.keySystems=[],this.clearkeyKeySystem=void 0},k.dependencies.ProtectionExtensions.prototype={constructor:k.dependencies.ProtectionExtensions,setup:function(){var a;a=this.system.getObject("ksPlayReady"),this.keySystems.push(a),a=this.system.getObject("ksWidevine"),this.keySystems.push(a),a=this.system.getObject("ksClearKey"),this.keySystems.push(a),this.clearkeyKeySystem=a},init:function(a){for(var b=(function(b){var c=null;return a&&(c=b in a?a[b]:null),c}),c=0;c<this.keySystems.length;c++){var d=this.keySystems[c];d.init(b(d.systemString))}},getKeySystems:function(){return this.keySystems},getKeySystemBySystemString:function(a){for(var b=0;b<this.keySystems.length;b++)if(this.keySystems[b].systemString===a)return this.keySystems[b];return null},isClearKey:function(a){return a===this.clearkeyKeySystem},initDataEquals:function(a,b){if(a.byteLength===b.byteLength){for(var c=new Uint8Array(a),d=new Uint8Array(b),e=0;e<c.length;e++)if(c[e]!==d[e])return!1;return!0}return!1},getSupportedKeySystemsFromContentProtection:function(a){var b,c,d,e,f=[];if(this.debug.log("[DRM] Get supported key systems from content protection"),a)for(d=0;d<this.keySystems.length;++d)for(c=this.keySystems[d],e=0;e<a.length;++e)if(b=a[e],b.schemeIdUri.toLowerCase()===c.schemeIdURI){var g=c.getInitData(b);g&&f.push({ks:this.keySystems[d],initData:g,cdmData:c.getCDMData()})}return f},getSupportedKeySystems:function(a){var b,c=[],d=k.dependencies.protection.CommonEncryption.parsePSSHList(a);for(this.debug.log("[DRM] Get supported key systems from init data"),b=0;b<this.keySystems.length;++b)this.keySystems[b].uuid in d&&c.push({ks:this.keySystems[b],initData:d[this.keySystems[b].uuid]});return c},getLicenseServer:function(a,b,c){if("license-release"===c||"individualization-request"==c)return null;var d=null;return b&&b.hasOwnProperty("drmtoday")?d=this.system.getObject("serverDRMToday"):"com.widevine.alpha"===a.systemString?d=this.system.getObject("serverWidevine"):"com.microsoft.playready"===a.systemString?d=this.system.getObject("serverPlayReady"):"org.w3.clearkey"===a.systemString&&(d=this.system.getObject("serverClearKey")),d},processClearKeyLicenseRequest:function(a,b){try{return k.dependencies.protection.KeySystem_ClearKey.getClearKeysFromProtectionData(a,b)}catch(c){return this.log("Failed to retrieve clearkeys from ProtectionData"),null}},autoSelectKeySystem:function(a,b,c,d){if(this.debug.log("[DRM] Auto select key system: "),this.debug.log("[DRM] ---- video codec = "+c),this.debug.log("[DRM] ---- audio codec = "+d),0===a.length)throw new Error("DRM system for this content not supported by the player!");var e=[],f=[];c&&f.push(new k.vo.protection.MediaCapability(c)),d&&e.push(new k.vo.protection.MediaCapability(d));for(var g=new k.vo.protection.KeySystemConfiguration(e,f),h=[],i=0;i<a.length;i++)h.push({ks:a[i].ks,configs:[g]});var j=this;!function(a){var b={};b[k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE]=function(b){if(a.protectionModel.unsubscribe(k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,this),b.error)j.debug.log(b.error),a.notify(k.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new k.vo.Error(k.dependencies.ErrorHandler.prototype.MEDIA_KEYSYSERR_ACCESS_DENIED,"[DRM] KeySystem Access Denied! -- "+b.error,null));else{var c=b.data;j.debug.log("[DRM] KeySystem Access Granted ("+c.keySystem.systemString+")!"),a.selectKeySystem(c);
}},a.protectionModel.subscribe(k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,b),a.requestKeySystemAccess(h)}(b)}},k.models.ProtectionModel_01b=function(){var a,b=null,c=null,d=[],e=[],f=function(){var b=this;return{handleEvent:function(f){var g=null;switch(f.type){case c.needkey:var i=ArrayBuffer.isView(f.initData)?f.initData.buffer:f.initData;b.notify(k.models.ProtectionModel.eventList.ENAME_NEED_KEY,new k.vo.protection.NeedKey(i,"cenc"));break;case c.keyerror:if(g=h(e,f.sessionId),g||(g=h(d,f.sessionId)),g){var j=k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR,l="MediakeyError";switch(f.errorCode.code){case 1:j=k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_UNKNOWN,l+="An unspecified error occurred. This value is used for errors that don't match any of the other codes.";break;case 2:j=k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_CLIENT,l+="The Key System could not be installed or updated.";break;case 3:j=k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_SERVICE,l+="The message passed into update indicated an error from the license service.";break;case 4:j=k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_OUTPUT,l+="There is no available output device with the required characteristics for the content protection system.";break;case 5:j=k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_HARDWARECHANGE,l+="A hardware configuration change caused a content protection error.";break;case 6:j=k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_DOMAIN,l+="An error occurred in a multi-device domain licensing configuration. The most common error is a failure to join the domain."}f.systemCode&&(l+="  (System Code = "+f.systemCode+")"),b.notify(k.models.ProtectionModel.eventList.ENAME_KEY_ERROR,new k.vo.protection.KeyError(j,l))}else b.log("No session token found for key error");break;case c.keyadded:g=h(e,f.sessionId),g||(g=h(d,f.sessionId)),g?b.notify(k.models.ProtectionModel.eventList.ENAME_KEY_ADDED,g):b.log("No session token found for key added");break;case c.keymessage:if(a=null!==f.sessionId&&void 0!==f.sessionId,a?(g=h(e,f.sessionId),!g&&d.length>0&&(g=d.shift(),e.push(g),g.sessionID=f.sessionId)):d.length>0&&(g=d.shift(),e.push(g),0!==d.length&&b.errHandler.mediaKeyMessageError("Multiple key sessions were creates with a user-agent that does not support sessionIDs!! Unpredictable behavior ahead!")),g){var m=ArrayBuffer.isView(f.message)?f.message.buffer:f.message;g.keyMessage=m,b.notify(k.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE,new k.vo.protection.KeyMessage(g,m,f.defaultURL))}else b.log("No session token found for key message")}}}},g=null,h=function(a,b){if(b&&a){for(var c=a.length,d=0;c>d;d++)if(a[d].sessionID===b)return a[d];return null}return null},i=function(){b.removeEventListener(c.keyerror,g),b.removeEventListener(c.needkey,g),b.removeEventListener(c.keymessage,g),b.removeEventListener(c.keyadded,g)};return{system:void 0,log:void 0,errHandler:void 0,notify:void 0,subscribe:void 0,unsubscribe:void 0,protectionExt:void 0,keySystem:null,setup:function(){g=f.call(this)},init:function(){var a=document.createElement("video");c=k.models.ProtectionModel_01b.detect(a)},teardown:function(){b&&i();for(var a=0;a<e.length;a++)this.closeKeySession(e[a]);this.notify(k.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE)},getAllInitData:function(){var a,b=[];for(a=0;a<d.length;a++)b.push(d[a].initData);for(a=0;a<e.length;a++)b.push(e[a].initData);return b},requestKeySystemAccess:function(a){var c=b;c||(c=document.createElement("video"));for(var d=!1,e=0;e<a.length;e++)for(var f=a[e].ks.systemString,g=a[e].configs,h=null,i=null,j=0;j<g.length;j++){var l=g[j].videoCapabilities;if(l&&0!==l.length){i=[];for(var m=0;m<l.length;m++)""!==c.canPlayType(l[m].contentType,f)&&i.push(l[m])}if(!(!h&&!i||h&&0===h.length||i&&0===i.length)){d=!0;var n=new k.vo.protection.KeySystemConfiguration(h,i),o=this.protectionExt.getKeySystemBySystemString(f),p=new k.vo.protection.KeySystemAccess(o,n);this.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,p);break}}d||this.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,null,"Key system access denied! -- No valid audio/video content configurations detected!")},selectKeySystem:function(a){this.keySystem=a.keySystem,this.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED)},setMediaElement:function(a){b!==a&&(b&&i(),b=a,b&&(b.addEventListener(c.keyerror,g),b.addEventListener(c.needkey,g),b.addEventListener(c.keymessage,g),b.addEventListener(c.keyadded,g),this.notify(k.models.ProtectionModel.eventList.ENAME_VIDEO_ELEMENT_SELECTED)))},createKeySession:function(f){if(!this.keySystem)throw new Error("Can not create sessions until you have selected a key system");if(a||0===e.length){var g={sessionID:null,initData:f,getSessionID:function(){return this.sessionID},getExpirationTime:function(){return NaN},getSessionType:function(){return"temporary"}};return d.push(g),b[c.generateKeyRequest](this.keySystem.systemString,new Uint8Array(f)),g}throw new Error("Multiple sessions not allowed!")},updateKeySession:function(a,d){var e=a.sessionID;if(this.protectionExt.isClearKey(this.keySystem))for(var f=0;f<d.keyPairs.length;f++)b[c.addKey](this.keySystem.systemString,d.keyPairs[f].key,d.keyPairs[f].keyID,e);else b[c.addKey](this.keySystem.systemString,new Uint8Array(d),a.initData,e)},closeKeySession:function(a){b[c.cancelKeyRequest](this.keySystem.systemString,a.sessionID)},setServerCertificate:function(){},loadKeySession:function(){},removeKeySession:function(){},checkIfEncrypted:function(){}}},k.models.ProtectionModel_01b.prototype={constructor:k.models.ProtectionModel_01b},k.models.ProtectionModel_01b.APIs=[{generateKeyRequest:"generateKeyRequest",addKey:"addKey",cancelKeyRequest:"cancelKeyRequest",needkey:"needkey",keyerror:"keyerror",keyadded:"keyadded",keymessage:"keymessage"},{generateKeyRequest:"webkitGenerateKeyRequest",addKey:"webkitAddKey",cancelKeyRequest:"webkitCancelKeyRequest",needkey:"webkitneedkey",keyerror:"webkitkeyerror",keyadded:"webkitkeyadded",keymessage:"webkitkeymessage"}],k.models.ProtectionModel_01b.detect=function(a){for(var b=k.models.ProtectionModel_01b.APIs,c=0;c<b.length;c++){var d=b[c];if("function"==typeof a[d.generateKeyRequest]&&"function"==typeof a[d.addKey]&&"function"==typeof a[d.cancelKeyRequest])return d}return null},k.models.ProtectionModel_3Feb2014=function(){var a=null,b=null,c=null,d=null,e=null,f=[],g=function(){var a=this;return{handleEvent:function(b){switch(b.type){case e.needkey:if(b.initData){var c=ArrayBuffer.isView(b.initData)?b.initData.buffer:b.initData;a.notify(k.models.ProtectionModel.eventList.ENAME_NEED_KEY,new k.vo.protection.NeedKey(c,"cenc"))}}}}},h=null,i=function(){var c=function(){a.removeEventListener("loadedmetadata",d),a[e.setMediaKeys](b),this.notify(k.models.ProtectionModel.eventList.ENAME_VIDEO_ELEMENT_SELECTED)};a.readyState>=1?c.call(this):(d=c.bind(this),a.addEventListener("loadedmetadata",d))},j=function(a){var b=k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR,c="MediakeyError";switch(a.errorCode.code){case 1:b=k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_UNKNOWN,c="An unspecified error occurred. This value is used for errors that don't match any of the other codes.";break;case 2:b=k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_CLIENT,c="The Key System could not be installed or updated.";break;case 3:b=k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_SERVICE,c="The message passed into update indicated an error from the license service.";break;case 4:b=k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_OUTPUT,c="There is no available output device with the required characteristics for the content protection system.";break;case 5:b=k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_HARDWARECHANGE,c+="A hardware configuration change caused a content protection error.";break;case 6:b=k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_DOMAIN,c="An error occurred in a multi-device domain licensing configuration. The most common error is a failure to join the domain."}return a.systemCode&&(c+="  (System Code = "+a.systemCode+")"),new k.vo.protection.KeyError(b,c)},l=function(a,b){var c=this;return{session:a,initData:b,handleEvent:function(a){switch(a.type){case e.error:c.notify(k.models.ProtectionModel.eventList.ENAME_KEY_ERROR,j(a));break;case e.message:var b=ArrayBuffer.isView(a.message)?a.message.buffer:a.message;c.notify(k.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE,new k.vo.protection.KeyMessage(this,b,a.destinationURL));break;case e.ready:c.notify(k.models.ProtectionModel.eventList.ENAME_KEY_ADDED,this);break;case e.close:c.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CLOSED,this.getSessionID())}},getSessionID:function(){return this.session.sessionId},getExpirationTime:function(){return NaN},getSessionType:function(){return"temporary"}}};return{system:void 0,notify:void 0,subscribe:void 0,unsubscribe:void 0,protectionExt:void 0,debug:void 0,keySystem:null,setup:function(){h=g.call(this)},init:function(){var a=document.createElement("video");e=k.models.ProtectionModel_3Feb2014.detect(a)},teardown:function(){try{for(var b=0;b<f.length;b++)this.closeKeySession(f[b]);a&&a.removeEventListener(e.needkey,h),this.notify(k.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE)}catch(c){this.notify(k.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE,null,"Error tearing down key sessions and MediaKeys! -- "+c.message)}},getAllInitData:function(){for(var a=[],b=0;b<f.length;b++)a.push(f[b].initData);return a},requestKeySystemAccess:function(a){for(var b=!1,c=0;c<a.length;c++){var d=a[c].ks.systemString,f=a[c].configs,g=null,h=null;this.debug.log("[DRM][3Feb2014] Request access for key system "+d);for(var i=0;i<f.length;i++){var j=f[i].audioCapabilities,l=f[i].videoCapabilities;if(j&&0!==j.length){g=[];for(var m=0;m<j.length;m++)window[e.MediaKeys].isTypeSupported(d,j[m].contentType)&&g.push(j[m])}if(l&&0!==l.length){h=[];for(var n=0;n<l.length;n++)window[e.MediaKeys].isTypeSupported(d,l[n].contentType)&&h.push(l[n])}if(!(!g&&!h||g&&0===g.length||h&&0===h.length)){b=!0;var o=new k.vo.protection.KeySystemConfiguration(g,h),p=this.protectionExt.getKeySystemBySystemString(d),q=new k.vo.protection.KeySystemAccess(p,o);this.debug.log("[DRM][3Feb2014] configuration supported = audio:"+JSON.stringify(g)+", video:"+JSON.stringify(h)),this.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,q);break}}}b||this.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,null,"[DRM][3Feb2014] Key system access denied! -- No valid audio/video content configurations detected!")},selectKeySystem:function(d){this.debug.log("[DRM][3Feb2014] Select key system "+d.keySystem.systemString);try{b=d.mediaKeys=new window[e.MediaKeys](d.keySystem.systemString),this.keySystem=d.keySystem,c=d,a&&i.call(this),this.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED)}catch(f){this.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED,null,"Error selecting keys system ("+this.keySystem.systemString+")! Could not create MediaKeys -- TODO")}},setMediaElement:function(c){a!==c&&(a&&(a.removeEventListener(e.needkey,h),a.removeEventListener("loadedmetadata",d)),a=c,a&&b&&i.call(this))},createKeySession:function(a,d,g){if(!this.keySystem||!b||!c)throw new Error("Can not create sessions until you have selected a key system");this.debug.log("[DRM][3Feb2014] Create key session");var h=c.ksConfiguration.videoCapabilities[0].contentType,i=b.createSession(h,new Uint8Array(a),g?new Uint8Array(g):null),j=l.call(this,i,a);i.addEventListener(e.error,j),i.addEventListener(e.message,j),i.addEventListener(e.ready,j),i.addEventListener(e.close,j),f.push(j),this.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,j)},updateKeySession:function(a,b){var c=a.session;this.debug.log("[DRM][3Feb2014] Update key session"),this.protectionExt.isClearKey(this.keySystem)?c.update(new Uint8Array(b.toJWK())):c.update(new Uint8Array(b))},closeKeySession:function(a){this.debug.log("[DRM][3Feb2014] Close key session, token = "+a.session.sessionId);var b=a.session;b.removeEventListener(e.error,a),b.removeEventListener(e.message,a),b.removeEventListener(e.ready,a),b.removeEventListener(e.close,a);for(var c=0;c<f.length;c++)if(f[c]===a){f.splice(c,1);break}b[e.release]()},setServerCertificate:function(){},loadKeySession:function(){},removeKeySession:function(){},checkIfEncrypted:function(){}}},k.models.ProtectionModel_3Feb2014.APIs=[{setMediaKeys:"msSetMediaKeys",MediaKeys:"MSMediaKeys",release:"close",needkey:"msneedkey",error:"mskeyerror",message:"mskeymessage",ready:"mskeyadded",close:"mskeyclose"},{setMediaKeys:"setMediaKeys",MediaKeys:"MediaKeys",release:"close",needkey:"needkey",error:"keyerror",message:"keymessage",ready:"keyadded",close:"keyclose"}],k.models.ProtectionModel_3Feb2014.detect=function(a){for(var b=k.models.ProtectionModel_3Feb2014.APIs,c=0;c<b.length;c++){var d=b[c];if("function"==typeof a[d.setMediaKeys]&&"function"==typeof window[d.MediaKeys])return d}return null},k.models.ProtectionModel_3Feb2014.prototype={constructor:k.models.ProtectionModel_3Feb2014},k.models.ProtectionModel_21Jan2015=function(){var a=null,b=null,c=null,d=[],e=function(a){var b,c="[";for(b=0;b<a.length;b++)c+="0x"+a[b].toString(16),b<a.length-1&&(c+=",");return c+="]"},f=function(a,b){var c=this;!function(b){var d=a[b].ks,e=a[b].configs;c.debug.log("[DRM][PM_21Jan2015] requestMediaKeySystemAccess: "+d.systemString),navigator.requestMediaKeySystemAccess(d.systemString,e).then(function(a){var b="function"==typeof a.getConfiguration?a.getConfiguration():null,e=new k.vo.protection.KeySystemAccess(d,b);e.mksa=a,c.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,e)})["catch"](function(){++b<a.length?f.call(c,a,b):c.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,null,"Key system access denied!")})}(b)},g=function(a){var b=a.session;return b.removeEventListener("keystatuseschange",a),b.removeEventListener("message",a),b.close()},h=function(){var b=this;return{session:null,handleEvent:function(d){switch(d.type){case"encrypted":b.debug.log("[DRM][PM_21Jan2015] 'encrypted' event");break;case"waitingforkey":b.debug.log("[DRM][PM_21Jan2015] 'waitingforkey' event"),null!==this.session&&(this.session.licenseStored=!1,this.session=null),a.removeEventListener("waitingforkey",c),b.notify(k.models.ProtectionModel.eventList.ENAME_KEY_ERROR,new k.vo.protection.KeyError(k.dependencies.ErrorHandler.prototype.MEDIA_ERR_ENCRYPTED,"Media is encrypted and no key is available"))}}}},i=function(a){for(var b=0;b<d.length;b++)if(d[b]===a){d.splice(b,1);break}},j=function(a,b,c){var f=this,g={session:a,initData:b,licenseStored:!1,handleEvent:function(a){switch(a.type){case"keystatuseschange":f.debug.log("[DRM][PM_21Jan2015] 'keystatuseschange' event: ",a),f.notify(k.models.ProtectionModel.eventList.ENAME_KEY_STATUSES_CHANGED,this),a.target.keyStatuses.forEach(function(){var a,b;switch(arguments&&arguments.length>0&&(arguments[0]&&("string"==typeof arguments[0]?a=arguments[0]:b=arguments[0]),arguments[1]&&("string"==typeof arguments[1]?a=arguments[1]:b=arguments[1])),f.debug.log("[DRM][PM_21Jan2015] status = "+a+" for KID "+e(new Uint8Array(b))),a){case"expired":f.notify(k.models.ProtectionModel.eventList.ENAME_KEY_STATUSES_CHANGED,null,new k.vo.Error(k.dependencies.ErrorHandler.prototype.MEDIA_ERR_ENCRYPTED,"License has expired!!!",null));break;default:f.notify(k.models.ProtectionModel.eventList.ENAME_KEY_STATUSES_CHANGED,{status:a,keyId:b})}});break;case"message":f.debug.log("[DRM][PM_21Jan2015] 'message' event: ",a);var b=ArrayBuffer.isView(a.message)?a.message.buffer:a.message;f.notify(k.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE,new k.vo.protection.KeyMessage(this,b,void 0,a.messageType))}},getSessionID:function(){return this.session.sessionId},getExpirationTime:function(){return this.session.expiration},getKeyStatuses:function(){return this.session.keyStatuses},getSessionType:function(){return c}};return a.addEventListener("keystatuseschange",g),a.addEventListener("message",g),a.closed.then(function(){i(g),f.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CLOSED,g.getSessionID())}),d.push(g),g};return{system:void 0,notify:void 0,subscribe:void 0,unsubscribe:void 0,protectionExt:void 0,keySystem:null,debug:null,setup:function(){c=h.call(this)},init:function(){},teardown:function(){var b,e;for(this.debug.log("[DRM][PM_21Jan2015] Teardown"),e=0;e<d.length;e++)b=d[e],b.licenseStored||(d.splice(e,1),e--);a.removeEventListener("waitingforkey",c),this.notify(k.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE)},getAllInitData:function(){for(var a=[],b=0;b<d.length;b++)a.push(d[b].initData);return a},requestKeySystemAccess:function(a){f.call(this,a,0)},selectKeySystem:function(c){var d=this;return d.debug.log("[DRM][PM_21Jan2015] Select key system, create new MediaKeys"),null!==b?(d.debug.log("[DRM][PM_21Jan2015] MediaKeys already created"),void d.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED)):void c.mksa.createMediaKeys().then(function(e){d.keySystem=c.keySystem,b=e,a&&a.setMediaKeys(b),d.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED)})["catch"](function(){d.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED,null,"Error selecting keys system ("+c.keySystem.systemString+")! Could not create MediaKeys -- TODO")})},setMediaElement:function(d){a!==d&&null!==d&&(a&&(a.removeEventListener("encrypted",c),a.removeEventListener("waitingforkey",c),a.setMediaKeys(null)),a=d,a&&(a.addEventListener("encrypted",c),b&&a.setMediaKeys(b)))},setServerCertificate:function(a){if(!this.keySystem||!b)throw new Error("Can not set server certificate until you have selected a key system");var c=this;b.setServerCertificate(a).then(function(){c.notify(k.models.ProtectionModel.eventList.ENAME_SERVER_CERTIFICATE_UPDATED)})["catch"](function(a){c.notify(k.models.ProtectionModel.eventList.ENAME_SERVER_CERTIFICATE_UPDATED,null,"Error updating server certificate -- "+a.name)})},createKeySession:function(a,c){if(!this.keySystem||!b)throw new Error("Can not create sessions until you have selected a key system");this.debug.log("[DRM][PM_21Jan2015] Create key session, type = "+c);var d=b.createSession(c),e=j.call(this,d,a,c),f=this;d.generateRequest("cenc",a).then(function(){f.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,e)})["catch"](function(a){i(e),f.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,null,{reason:"Failed to generate key request",error:new k.vo.Error(a.code,a.name,a.message)})})},updateKeySession:function(b,d){var e=b.session,f=this;f.debug.log("[DRM][PM_21Jan2015] Update key session"),this.protectionExt.isClearKey(this.keySystem)&&(d=d.toJWK()),e.update(d).then(function(){b.licenseStored=!0,c.session=b,a.addEventListener("waitingforkey",c)})["catch"](function(a){f.notify(k.models.ProtectionModel.eventList.ENAME_KEY_ERROR,new k.vo.protection.KeyError(k.dependencies.ErrorHandler.prototype.MEDIA_KEYERR,"Error while providing license to the CDM",a))})},loadKeySession:function(a){if(!this.keySystem||!b)throw new Error("Can not load sessions until you have selected a key system");this.debug.log("[DRM][PM_21Jan2015] Load key session, id = "+a);var c=b.createSession(),d=this;c.load(a).then(function(b){if(b){var e=j.call(this,c);d.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,e)}else d.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,null,{reason:"Failed to load session "+a,error:null})})["catch"](function(b){d.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,{reason:"Failed to load session "+a,error:new k.vo.Error(b.code,b.name,b.message)})})},removeKeySession:function(a){var b=a.session;this.debug.log("[DRM][PM_21Jan2015] Remove key session");var c=this;b.remove().then(function(){c.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_REMOVED,a.getSessionID())},function(b){c.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_REMOVED,null,"Error removing session ("+a.getSessionID()+"). "+b.name)})},closeKeySession:function(a){this.debug.log("[DRM][PM_21Jan2015] Close key session");var b=this;g(a)["catch"](function(c){i(a),b.notify(k.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CLOSED,null,"Error closing session ("+a.getSessionID()+") "+c.name)})},checkIfEncrypted:function(){a.addEventListener("waitingforkey",c)}}},k.models.ProtectionModel_21Jan2015.detect=function(a){return void 0===a.onencrypted||void 0===a.mediaKeys?!1:void 0===navigator.requestMediaKeySystemAccess||"function"!=typeof navigator.requestMediaKeySystemAccess?!1:window.MSMediaKeys?!1:!0},k.models.ProtectionModel_21Jan2015.prototype={constructor:k.models.ProtectionModel_21Jan2015},k.dependencies.protection.KeySystem=function(){},k.dependencies.protection.KeySystem_Access=function(){"use strict"},k.dependencies.protection.KeySystem_Access.prototype={constructor:k.dependencies.protection.KeySystem_Access},k.dependencies.protection.KeySystem_ClearKey=function(){"use strict";var a,b="org.w3.clearkey",c="1077efec-c0b2-4d02-ace3-3c1e52e2fb4b";return{system:void 0,schemeIdURI:"urn:uuid:"+c,systemString:b,uuid:c,sessionType:"temporary",init:function(b){a=b},getInitData:k.dependencies.protection.CommonEncryption.parseInitDataFromContentProtection,getKeySystemConfigurations:k.dependencies.protection.CommonEncryption.getKeySystemConfigurations,getRequestHeadersFromMessage:function(){return null},getLicenseRequestFromMessage:function(a){return new Uint8Array(a)},getLicenseServerURLFromInitData:function(){return null},getCDMData:function(){return null}}},k.dependencies.protection.KeySystem_ClearKey.prototype={constructor:k.dependencies.protection.KeySystem_ClearKey},k.dependencies.protection.KeySystem_ClearKey.getClearKeysFromProtectionData=function(a,b){var c=null;if(a){for(var d=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(b))),e=[],f=0;f<d.kids.length;f++){var g=d.kids[f],h=a.clearkeys.hasOwnProperty(g)?a.clearkeys[g]:null;if(!h)throw new Error("[DRM] ClearKey keyID ("+g+") is not known!");e.push(new k.vo.protection.KeyPair(g,h))}c=new k.vo.protection.ClearKeyKeySet(e)}return c},k.dependencies.protection.KeySystem_PlayReady=function(){"use strict";var a,b="com.microsoft.playready",c="9a04f079-9840-4286-ab92-e65be0885f95",d="utf16",e='<PlayReadyCDMData type="LicenseAcquisition"><LicenseAcquisition version="1.0" Proactive="true"><CustomData encoding="base64encoded">%CUSTOMDATA%</CustomData></LicenseAcquisition></PlayReadyCDMData>',f=function(a){var b,c,e,f,g={},h=a instanceof ArrayBuffer?a:a.buffer,i="utf16"===d?new Uint16Array(h):new Uint8Array(h),j=0;for(b=String.fromCharCode.apply(null,i),c=this.domParser.createXmlTree(b),e=c.getElementsByTagName("name"),f=c.getElementsByTagName("value"),j=0;j<e.length;j+=1)g[e[j].childNodes[0].nodeValue]=f[j].childNodes[0].nodeValue;return g.hasOwnProperty("Content")&&(g["Content-Type"]=g.Content,delete g.Content),g.hasOwnProperty("Content-Type")||(g["Content-Type"]="text/xml; charset=utf-8"),g},g=function(a){var b,c,e,f=null,g=a instanceof ArrayBuffer?a:a.buffer,h="utf16"===d?new Uint16Array(g):new Uint8Array(g);return b=String.fromCharCode.apply(null,h),c=this.domParser.createXmlTree(b),c.getElementsByTagName("Challenge")[0]?(e=c.getElementsByTagName("Challenge")[0].childNodes[0].nodeValue,e&&(f=m.decode(e))):f=b,f},h=function(a){if(a){var b,c,d,e,f,g,h,i=new DataView(a),j=i.getUint16(4,!0),k=6,l=0;for(l=0;j>l;l++)if(b=i.getUint16(k,!0),k+=2,c=i.getUint16(k,!0),k+=2,1===b){if(d=a.slice(k,k+c),e=String.fromCharCode.apply(null,new Uint16Array(d)),f=this.domParser.createXmlTree(e),f.getElementsByTagName("LA_URL")[0]&&(g=f.getElementsByTagName("LA_URL")[0].childNodes[0].nodeValue))return g;if(f.getElementsByTagName("LUI_URL")[0]&&(h=f.getElementsByTagName("LUI_URL")[0].childNodes[0].nodeValue))return h}else k+=c}return null},i=function(a){var b,c,d,e,f,g=0,h=new Uint8Array([112,115,115,104,0,0,0,0]),i=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]),j=null;if("pssh"in a)return k.dependencies.protection.CommonEncryption.parseInitDataFromContentProtection(a);if("pro"in a)j=m.decodeArray(a.pro.__text);else{if(!("prheader"in a))return null;j=m.decodeArray(a.prheader.__text)}return b=j.length,c=4+h.length+i.length+4+b,d=new ArrayBuffer(c),e=new Uint8Array(d),f=new DataView(d),f.setUint32(g,c),g+=4,e.set(h,g),g+=h.length,e.set(i,g),g+=i.length,f.setUint32(g,b),g+=4,e.set(j,g),g+=b,e.buffer},j=function(){var b,c,d,f;if(a&&a.cdmData){for(b=[],f=0;f<a.cdmData.length;++f)b.push(a.cdmData.charCodeAt(f)),b.push(0);for(b=String.fromCharCode.apply(null,b),b=m.encode(b),c=e.replace("%CUSTOMDATA%",b),d=[],f=0;f<c.length;++f)d.push(c.charCodeAt(f)),d.push(0);return new Uint8Array(d).buffer}return null};return{schemeIdURI:"urn:uuid:"+c,systemString:b,uuid:c,notify:void 0,subscribe:void 0,unsubscribe:void 0,domParser:void 0,sessionType:"temporary",init:function(b){b&&(a=b,a.sessionType&&(this.sessionType=a.sessionType))},getInitData:i,getKeySystemConfigurations:k.dependencies.protection.CommonEncryption.getKeySystemConfigurations,getRequestHeadersFromMessage:f,getLicenseRequestFromMessage:g,getLicenseServerURLFromInitData:h,getCDMData:j,setPlayReadyMessageFormat:function(a){if("utf8"!==a&&"utf16"!==a)throw new Error("Illegal PlayReady message format! -- "+a);d=a}}},k.dependencies.protection.KeySystem_PlayReady.prototype={constructor:k.dependencies.protection.KeySystem_PlayReady},k.dependencies.protection.KeySystem_Widevine=function(){"use strict";var a="com.widevine.alpha",b="edef8ba9-79d6-4ace-a3c8-27dcd51d21ed",c=null,d=function(a){return c&&c.pssh?m.decodeArray(c.pssh).buffer:k.dependencies.protection.CommonEncryption.parseInitDataFromContentProtection(a)};return{schemeIdURI:"urn:uuid:"+b,systemString:a,uuid:b,sessionType:"temporary",init:function(a){a&&(c=a,c.sessionType&&(this.sessionType=c.sessionType))},getInitData:d,getKeySystemConfigurations:k.dependencies.protection.CommonEncryption.getKeySystemConfigurations,getRequestHeadersFromMessage:function(){return null},getLicenseRequestFromMessage:function(a){return new Uint8Array(a)},getLicenseServerURLFromInitData:function(){return null},getCDMData:function(){return null}}},k.dependencies.protection.KeySystem_Widevine.prototype={constructor:k.dependencies.protection.KeySystem_Widevine},k.dependencies.protection.servers.ClearKey=function(){"use strict";return{getServerURLFromMessage:function(a,b){var c=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(b))),d=0;for(a+="/?",d=0;d<c.kids.length;d++)a+=c.kids[d]+"&";return a=a.substring(0,a.length-1)},getHTTPMethod:function(){return"GET"},getResponseType:function(){return"json"},getLicenseMessage:function(a){var b,c,d,e,f=[];if(!a.hasOwnProperty("keys"))return null;for(b=0;b<a.keys.length;b++)c=a.keys[b],d=c.kid.replace(/=/g,""),e=c.k.replace(/=/g,""),f.push(new k.vo.protection.KeyPair(d,e));return new k.vo.protection.ClearKeyKeySet(f)},getErrorResponse:function(a){return{code:0,name:"UnknownError",message:String.fromCharCode.apply(null,new Uint8Array(a))}}}},k.dependencies.protection.servers.ClearKey.prototype={constructor:k.dependencies.protection.servers.ClearKey},k.dependencies.protection.servers.DRMToday=function(){"use strict";var a={"com.widevine.alpha":{responseType:"json",getLicenseMessage:function(a){return m.decodeArray(a.license)},getErrorResponse:function(a){return a}},"com.microsoft.playready":{responseType:"arraybuffer",getLicenseMessage:function(a){return a},getErrorResponse:function(a){return String.fromCharCode.apply(null,new Uint8Array(a))}}};return{getServerURLFromMessage:function(a){return a},getHTTPMethod:function(){return"POST"},getResponseType:function(b){return a[b].responseType},getLicenseMessage:function(b,c){return a[c].getLicenseMessage(b)},getErrorResponse:function(b,c){return{code:0,name:"UnknownError",message:a[c].getErrorResponse(b)}}}},k.dependencies.protection.servers.DRMToday.prototype={constructor:k.dependencies.protection.servers.DRMToday},k.dependencies.protection.servers.LicenseServer=function(){},k.dependencies.protection.servers.PlayReady=function(){"use strict";var a=function(a){var b="",c=0,d=0,e=0,f=0,g=new Uint8Array(a);for(g.length>=3&&239===g[0]&&187===g[1]&&191===g[2]&&(c=3);c<g.length;)if(d=g[c],128>d)b+=String.fromCharCode(d),c++;else if(d>191&&224>d){if(c+1>=g.length)throw"UTF-8 Decode failed. Two byte character was truncated.";e=g[c+1],b+=String.fromCharCode((31&d)<<6|63&e),c+=2}else{if(c+2>=g.length)throw"UTF-8 Decode failed. Multi byte character was truncated.";e=g[c+1],f=g[c+2],b+=String.fromCharCode((15&d)<<12|(63&e)<<6|63&f),c+=3}return b},b=function(b){var c=a(b),d=this.domParser.createXmlTree(c),e=d?this.domParser.getChildNode(d,"soap:Envelope"):null,f=e?this.domParser.getChildNode(e,"soap:Body"):null,g=f?this.domParser.getChildNode(f,"soap:Fault"):null;return g?null:b},c=function(b){var c=a(b),d=this.domParser.createXmlTree(c),e=d?this.domParser.getChildNode(d,"soap:Envelope"):null,f=e?this.domParser.getChildNode(e,"soap:Body"):null,g=f?this.domParser.getChildNode(f,"soap:Fault"):null,h=g?this.domParser.getChildNode(g,"detail"):null,i=h?this.domParser.getChildNode(h,"Exception"):null,j=null,k="",l="",m="",n=-1,o=-1;return null===g?{code:0,name:"UnknownError",message:String.fromCharCode.apply(null,new Uint8Array(b))}:(j=this.domParser.getChildNode(g,"faultstring").firstChild,k=j?j.nodeValue:null,null!==i&&(j=this.domParser.getChildNode(i,"StatusCode"),l=j?j.firstChild.nodeValue:null,j=this.domParser.getChildNode(i,"Message"),m=j?j.firstChild.nodeValue:null,n=m?m.lastIndexOf("[")+1:-1,o=m?m.indexOf("]"):-1),{code:l,name:k,message:m?m.substring(n,o):""})};return{domParser:void 0,getServerURLFromMessage:function(a){return a},getHTTPMethod:function(){return"POST"},getResponseType:function(){return"arraybuffer"},getLicenseMessage:function(a){return b.call(this,a)},getErrorResponse:function(a){return c.call(this,a)}}},k.dependencies.protection.servers.PlayReady.prototype={constructor:k.dependencies.protection.servers.PlayReady},k.dependencies.protection.servers.Widevine=function(){"use strict";return{getServerURLFromMessage:function(a){return a},getHTTPMethod:function(){return"POST"},getResponseType:function(){return"arraybuffer"},getLicenseMessage:function(a){return a},getErrorResponse:function(a){return{code:0,name:"UnknownError",message:String.fromCharCode.apply(null,new Uint8Array(a))}}}},k.dependencies.protection.servers.Widevine.prototype={constructor:k.dependencies.protection.servers.Widevine},k.vo.protection.ClearKeyKeySet=function(a,b){if(b&&"persistent"!==b&&"temporary"!==b)throw new Error("Invalid ClearKey key set type!  Must be one of 'persistent' or 'temporary'");this.keyPairs=a,this.type=b,this.toJWK=function(){var a,b=this.keyPairs.length,c={};for(c.keys=[],a=0;b>a;a++){var d={kty:"oct",alg:"A128KW",kid:this.keyPairs[a].keyID,k:this.keyPairs[a].key};c.keys.push(d)}this.type&&(c.type=this.type);var e=JSON.stringify(c),f=e.length,g=new ArrayBuffer(f),h=new Uint8Array(g);for(a=0;f>a;a++)h[a]=e.charCodeAt(a);return g}},k.vo.protection.ClearKeyKeySet.prototype={constructor:k.vo.protection.ClearKeyKeySet},k.vo.protection.KeyError=function(a,b,c){"use strict";this.code=a,this.message=b,this.data=c},k.vo.protection.KeyError.prototype={constructor:k.vo.protection.KeyError},k.vo.protection.KeyMessage=function(a,b,c,d){"use strict";this.sessionToken=a,this.message=b,this.defaultURL=c,this.messageType=d},k.vo.protection.KeyMessage.prototype={constructor:k.vo.protection.KeyMessage},k.vo.protection.KeyPair=function(a,b){"use strict";this.keyID=a,this.key=b},k.vo.protection.KeyPair.prototype={constructor:k.vo.protection.KeyPair},k.vo.protection.KeySystemAccess=function(a,b){this.keySystem=a,
this.ksConfiguration=b},k.vo.protection.KeySystemAccess.prototype={constructor:k.vo.protection.KeySystemAccess},k.vo.protection.KeySystemConfiguration=function(a,b,c,d,e){this.initDataTypes=["cenc"],this.audioCapabilities=a,this.videoCapabilities=b,this.distinctiveIdentifier=c,this.persistentState=d,this.sessionTypes=e},k.vo.protection.KeySystemConfiguration.prototype={constructor:k.vo.protection.KeySystemConfiguration},k.vo.protection.LicenseRequestComplete=function(a,b){"use strict";this.message=a,this.requestData=b},k.vo.protection.LicenseRequestComplete.prototype={constructor:k.vo.protection.LicenseRequestComplete},k.vo.protection.MediaCapability=function(a,b){this.contentType=a,this.robustness=b},k.vo.protection.MediaCapability.prototype={constructor:k.vo.protection.MediaCapability},k.vo.protection.NeedKey=function(a,b){this.initData=a,this.initDataType=b},k.vo.protection.NeedKey.prototype={constructor:k.vo.protection.NeedKey},k.vo.protection.ProtectionData=function(a,b,c,d){this.laURL=a,this.httpRequestHeaders=b,this.bearerToken=c,this.clearkeys=d},k.vo.protection.ProtectionData.prototype={constructor:k.vo.protection.ProtectionData},k.models.SessionToken=function(){"use strict"},k.models.SessionToken.prototype={initData:null,getSessionID:function(){return""},getExpirationTime:function(){return NaN},getKeyStatuses:function(){return null}},k.rules.BaseRulesCollection=function(){"use strict";var a=[],b=[];return{downloadRatioRule:void 0,insufficientBufferRule:void 0,abandonRequestRule:void 0,getRules:function(c){switch(c){case k.rules.BaseRulesCollection.prototype.QUALITY_SWITCH_RULES:return d.when(a);case k.rules.BaseRulesCollection.prototype.ABANDON_FRAGMENT_RULES:return d.when(b);default:return null}},setup:function(){a.push(this.downloadRatioRule),a.push(this.insufficientBufferRule),b.push(this.abandonRequestRule)}}},k.rules.BaseRulesCollection.prototype={constructor:k.rules.BaseRulesCollection,QUALITY_SWITCH_RULES:"qualitySwitchRules",ABANDON_FRAGMENT_RULES:"abandonFragmentRules"},k.rules.DownloadRatioRule=function(){"use strict";var a=function(a,b,c){var e=this,f=d.defer();return e.manifestExt.getRepresentationFor(a,c).then(function(a){e.manifestExt.getBandwidth(a).then(function(a){f.resolve(a/b)})}),f.promise};return{debug:void 0,manifestExt:void 0,metricsExt:void 0,checkIndex:function(b,c,e){var f,g,h,i,j,l,m,n,o,p=this,q=p.metricsExt.getCurrentHttpRequest(c),r=.75;return c?null===q?d.when(new k.rules.SwitchRequest):(g=(q.tfinish.getTime()-q.trequest.getTime())/1e3,f=(q.tfinish.getTime()-q.tresponse.getTime())/1e3,0>=g?d.when(new k.rules.SwitchRequest):null===q.mediaduration||void 0===q.mediaduration||q.mediaduration<=0||isNaN(q.mediaduration)?d.when(new k.rules.SwitchRequest):(l=d.defer(),i=q.mediaduration/g,h=q.mediaduration/f*r,isNaN(h)||isNaN(i)?(p.debug.log("The ratios are NaN, bailing."),d.when(new k.rules.SwitchRequest)):(isNaN(h)?l.resolve(new k.rules.SwitchRequest):4>h?b>0?(p.debug.log("We are not at the lowest bitrate, so switch down."),p.manifestExt.getRepresentationFor(b-1,e).then(function(a){p.manifestExt.getBandwidth(a).then(function(a){p.manifestExt.getRepresentationFor(b,e).then(function(c){p.manifestExt.getBandwidth(c).then(function(c){j=a/c,j>h?(p.debug.log("Things must be going pretty bad, switch all the way down."),l.resolve(new k.rules.SwitchRequest(0))):(p.debug.log("Things could be better, so just switch down one index."),l.resolve(new k.rules.SwitchRequest(b-1)))})})})})):l.resolve(new k.rules.SwitchRequest(b)):p.manifestExt.getRepresentationCount(e).then(function(c){c-=1,c>b?p.manifestExt.getRepresentationFor(b+1,e).then(function(f){p.manifestExt.getBandwidth(f).then(function(f){p.manifestExt.getRepresentationFor(b,e).then(function(g){p.manifestExt.getBandwidth(g).then(function(g){if(j=f/g,h>=j)if(h>100)p.debug.log("Tons of bandwidth available, go all the way up."),l.resolve(new k.rules.SwitchRequest(c-1));else if(h>10)p.debug.log("Just enough bandwidth available, switch up one."),l.resolve(new k.rules.SwitchRequest(b+1));else{for(n=-1,m=[];(n+=1)<c;)m.push(a.call(p,n,g,e));d.all(m).then(function(a){for(n=0,o=a.length;o>n&&!(h<a[n]);n+=1);p.debug.log("Calculated ideal new quality index is: "+n),l.resolve(new k.rules.SwitchRequest(n))})}else l.resolve(new k.rules.SwitchRequest)})})})}):l.resolve(new k.rules.SwitchRequest(c))}),l.promise))):d.when(new k.rules.SwitchRequest)}}},k.rules.DownloadRatioRule.prototype={constructor:k.rules.DownloadRatioRule},k.rules.InsufficientBufferRule=function(){"use strict";var a=0,b=3;return{debug:void 0,checkIndex:function(c,e){var f,g,h=this,i=!1,j=k.rules.SwitchRequest.prototype.DEFAULT;return null===e.PlayList||void 0===e.PlayList||0===e.PlayList.length?d.when(new k.rules.SwitchRequest):(f=e.PlayList[e.PlayList.length-1],null===f||void 0===f||0===f.trace.length?d.when(new k.rules.SwitchRequest):(g=f.trace[f.trace.length-2],null===g||void 0===g||null===g.stopreason||void 0===g.stopreason?d.when(new k.rules.SwitchRequest):(g.stopreason===k.vo.metrics.PlayList.Trace.REBUFFERING_REASON&&(i=!0,a+=1,h.debug.log("Number of times the buffer has run dry: "+a)),a>b&&(j=k.rules.SwitchRequest.prototype.STRONG,h.debug.log("Apply STRONG to buffer rule.")),i?(h.debug.log("The buffer ran dry recently, switch down."),d.when(new k.rules.SwitchRequest(c-1,j))):a>b?(h.debug.log("Too many dry buffer hits, quit switching bitrates."),d.when(new k.rules.SwitchRequest(c,j))):d.when(new k.rules.SwitchRequest(k.rules.SwitchRequest.prototype.NO_CHANGE,j)))))}}},k.rules.InsufficientBufferRule.prototype={constructor:k.rules.InsufficientBufferRule},k.rules.LimitSwitchesRule=function(){"use strict";var a=10,b=2e4,c=5,e=0;return{debug:void 0,checkIndex:function(f,g){if(e>0)return e-=1,d.when(new k.rules.SwitchRequest(f,k.rules.SwitchRequest.prototype.STRONG));var h,i,j,l=this,m=!1,n=(new Date).getTime(),o=g.RepSwitchList.length;for(j=o-1;j>=0;j-=1){if(h=g.RepSwitchList[j],i=n-h.t.getTime(),i>=b){l.debug.log("Reached time limit, bailing.");break}if(j>=a){l.debug.log("Found too many switches within validation time, force the stream to not change."),m=!0;break}}return m?(l.debug.log("Wait some time before allowing another switch."),e=c,d.when(new k.rules.SwitchRequest(f,k.rules.SwitchRequest.prototype.STRONG))):d.when(new k.rules.SwitchRequest(k.rules.SwitchRequest.prototype.NO_CHANGE,k.rules.SwitchRequest.prototype.STRONG))}}},k.rules.LimitSwitchesRule.prototype={constructor:k.rules.LimitSwitchesRule},k.rules.SwitchRequest=function(a,b){"use strict";this.quality=a,this.priority=b,void 0===this.quality&&(this.quality=999),void 0===this.priority&&(this.priority=.5)},k.rules.SwitchRequest.prototype={constructor:k.rules.SwitchRequest,NO_CHANGE:999,DEFAULT:.5,STRONG:1,WEAK:0},k.rules.AbandonRequestsRule=function(){"use strict";var a=.5,b=2;return{debug:void 0,metricsExt:void 0,execute:function(c,d){var e,f,g,h=(new Date).getTime(),i=c.streamType,j=new k.rules.SwitchRequest(k.rules.SwitchRequest.prototype.NO_CHANGE,k.rules.SwitchRequest.prototype.WEAK);return null===c.firstByteDate||c.aborted?(this.debug.log("[AbandonRequestsRule]["+i+"] Request has already been aborted."),void d(j)):(e=(h-c.firstByteDate.getTime())/1e3,c.bytesLoaded<c.bytesTotal&&e>=c.duration*a&&(f=c.bytesLoaded/e,g=c.bytesTotal/f,g>c.duration*b&&(j=new k.rules.SwitchRequest(this.metricsExt.getQualityBoundaries(i).min,k.rules.SwitchRequest.prototype.STRONG),this.debug.info("[AbandonRequestsRule]["+i+"] bw = "+f+" kb/s => switch to lowest quality for "+c.url))),void d(j))}}},k.rules.AbandonRequestsRule.prototype={constructor:k.rules.AbandonRequestsRule},k.rules.o.DownloadRatioRule=function(){"use strict";return{debug:void 0,manifestExt:void 0,metricsExt:void 0,manifestModel:void 0,config:void 0,checkIndex:function(a,b,c){var e,f,g,h,i,j,l,m=this,n=m.metricsExt.getCurrentHttpRequest(b),o=m.metricsExt.getHttpRequests(b),p=[],q=k.rules.SwitchRequest.prototype.NO_CHANGE,r=0,s=k.rules.SwitchRequest.prototype.DEFAULT;if(!c||!c.hasOwnProperty("type"))return d.when(new k.rules.SwitchRequest);if(h=m.config.getParamFor(c.type,"ABR.latencyInBandwidth","boolean",!0),i=m.config.getParamFor(c.type,"ABR.switchUpRatioSafetyFactor","number",1.5),m.debug.log("[DownloadRatioRule]["+c.type+"] Checking download ratio rule... (current = "+a+")"),!b)return m.debug.log("[DownloadRatioRule]["+c.type+"]No metrics, bailing."),d.when(new k.rules.SwitchRequest);if(null===n)return m.debug.log("[DownloadRatioRule]["+c.type+"]No requests made for this stream yet, bailing."),d.when(new k.rules.SwitchRequest);if(f=(n.tfinish.getTime()-n.trequest.getTime())/1e3,e=(n.tfinish.getTime()-n.tresponse.getTime())/1e3,0>=f)return m.debug.log("[DownloadRatioRule]["+c.type+"]Don't know how long the download of the last fragment took, bailing."),d.when(new k.rules.SwitchRequest);if(null===n.mediaduration||void 0===n.mediaduration||n.mediaduration<=0||isNaN(n.mediaduration))return m.debug.log("[DownloadRatioRule]["+c.type+"] Don't know the duration of the last media fragment, bailing."),d.when(new k.rules.SwitchRequest);if(j=d.defer(),m.debug.info("[DownloadRatioRule]["+c.type+"] DL: "+Number(e.toFixed(3))+"s, Total: "+Number(f.toFixed(3))+"s"),r=n.bytesLength,o.length>=3)for(l=o.length-2;l>=o.length-3;l--)o[l].tfinish&&o[l].trequest&&o[l].tresponse&&(r+=o[l].bytesLength,f+=(o[l].tfinish.getTime()-o[l].trequest.getTime())/1e3,e+=(o[l].tfinish.getTime()-o[l].tresponse.getTime())/1e3);return r*=8,g=h?r/f:r/e,m.debug.info("[DownloadRatioRule]["+c.type+"] BW = "+Math.round(g/1e3)+" kb/s"),isNaN(g)?d.when(new k.rules.SwitchRequest):(m.manifestExt.getRepresentationCount(c).then(function(b){m.manifestExt.getRepresentationFor(a,c).then(function(e){m.manifestExt.getBandwidth(e).then(function(e){for(l=0;b>l;l+=1)p.push(m.manifestExt.getRepresentationBandwidth(c,l));d.all(p).then(function(d){if(e>=g){for(l=a-1;l>0&&!(d[l]<=g);l-=1);q=l,s=k.rules.SwitchRequest.prototype.WEAK,m.debug.info("[DownloadRatioRule]["+c.type+"] SwitchRequest: q="+q+"/"+(b-1)+" ("+d[q]+"), p="+s),j.resolve(new k.rules.SwitchRequest(q,s))}else{for(l=b-1;l>a;l-=1)if(g>d[l]*i){m.debug.log("[DownloadRatioRule]["+c.type+"] bw = "+g+" results[i] * switchUpRatioSafetyFactor ="+d[l]*i+" with i="+l);break}q=l,s=k.rules.SwitchRequest.prototype.STRONG,m.debug.info("[DownloadRatioRule]["+c.type+"] SwitchRequest: q="+q+"/"+(b-1)+" ("+d[q]+"), p="+s),j.resolve(new k.rules.SwitchRequest(q,s))}})})})}),j.promise)}}},k.rules.o.DownloadRatioRule.prototype={constructor:k.rules.o.DownloadRatioRule},k.rules.o.InsufficientBufferRule=function(){"use strict";return{debug:void 0,manifestExt:void 0,metricsExt:void 0,manifestModel:void 0,config:void 0,isStartBuffering:{},checkIndex:function(a,b,c,e){var f,g,h,i,j,l,m,n,o=this,p=o.metricsExt.getCurrentBufferLevel(b),q=a,r=k.rules.SwitchRequest.prototype.DEFAULT;return null===c?d.when(new k.rules.SwitchRequest):("buffering"===e&&(o.isStartBuffering[c.type]=!0),null===p?d.when(new k.rules.SwitchRequest):(o.debug.info("[InsufficientBufferRule]["+c.type+"] Checking buffer level ... (current = "+a+", buffer level = "+Math.round(100*p.level)/100+")"),n=d.defer(),o.manifestExt.getMpd(o.manifestModel.getValue()).then(function(b){b?(f=o.config.getParamFor(c.type,"BufferController.minBufferTime","number",b.manifest.minBufferTime),g=o.config.getParamFor(c.type,"ABR.switchLowerBufferRatio","number",.25),h=o.config.getParamFor(c.type,"ABR.switchLowerBufferTime","number",g*f),i=o.config.getParamFor(c.type,"ABR.switchDownBufferRatio","number",.5),j=o.config.getParamFor(c.type,"ABR.switchDownBufferTime","number",i*f),l=o.config.getParamFor(c.type,"ABR.switchUpBufferRatio","number",.75),m=o.config.getParamFor(c.type,"ABR.switchUpBufferTime","number",l*f),p.level<j&&o.isStartBuffering[c.type]?n.resolve(new k.rules.SwitchRequest):(p.level>=j&&(o.isStartBuffering[c.type]=!1),o.manifestExt.getRepresentationCount(c).then(function(b){b-=1,p.level<=h?(q=0,r=k.rules.SwitchRequest.prototype.STRONG):p.level<=j&&(q=a>0?a-1:0,r=k.rules.SwitchRequest.prototype.DEFAULT),o.debug.info("[InsufficientBufferRule]["+c.type+"] SwitchRequest: q="+q+", p="+r),n.resolve(new k.rules.SwitchRequest(q,r))}))):(o.debug.log("[InsufficientBufferRule]["+c.type+"] Manifest not present yet"),n.resolve(new k.rules.SwitchRequest))}),n.promise))}}},k.rules.o.InsufficientBufferRule.prototype={constructor:k.rules.o.OInsufficientBufferRule},k.vo.Error=function(a,b,c){"use strict";this.code=a||null,this.message=b||null,this.data=c||null},k.vo.Error.prototype={constructor:k.vo.Error},k.vo.Event=function(){"use strict";this.type=null,this.sender=null,this.data=null,this.error=null,this.timestamp=NaN},k.vo.Event.prototype={constructor:k.vo.Event},k.models.MetricsList=function(){"use strict";return{TcpList:[],HttpList:[],RepSwitchList:[],BufferedSwitchList:[],BufferLevel:[],PlayList:[],DroppedFrames:[],DVRInfo:[],ManifestUpdate:[]}},k.models.MetricsList.prototype={constructor:k.models.MetricsList},k.vo.Mp4Track=function(){"use strict";this.type="und",this.trackId=0,this.timescale=0,this.duration=0,this.codecs="",this.codecPrivateData="",this.bandwidth="",this.width=0,this.height=0,this.language="und",this.channels=0,this.samplingRate=0,this.contentProtection=void 0,this.samples=[],this.data=null},k.vo.Mp4Track.prototype={constructor:k.vo.Mp4Track},k.vo.Mp4Track.Sample=function(){"use strict";this.dts=0,this.cts=0,this.duration=0,this.flags=0,this.data=null,this.size=0},k.vo.Mp4Track.Sample.prototype={constructor:k.vo.Mp4Track.Sample},k.vo.SegmentRequest=function(){"use strict";this.action="download",this.startTime=NaN,this.streamType=null,this.type=null,this.duration=NaN,this.timescale=NaN,this.range=null,this.url=null,this.requestStartDate=null,this.firstByteDate=null,this.requestEndDate=null,this.deferred=null,this.quality=NaN,this.index=NaN,this.availabilityStartTime=null,this.availabilityEndTime=null,this.wallStartTime=null},k.vo.SegmentRequest.prototype={constructor:k.vo.SegmentRequest,ACTION_DOWNLOAD:"download",ACTION_COMPLETE:"complete"},k.vo.URIFragmentData=function(){"use strict";this.t=null,this.xywh=null,this.track=null,this.id=null,this.s=null},k.vo.URIFragmentData.prototype={constructor:k.vo.URIFragmentData},k.vo.metrics.BufferLevel=function(){"use strict";this.t=null,this.level=null},k.vo.metrics.BufferLevel.prototype={constructor:k.vo.metrics.BufferLevel},k.vo.metrics.BufferedSwitch=function(){"use strict";this.mt=null,this.to=null,this.lto=null},k.vo.metrics.BufferedSwitch.prototype={constructor:k.vo.metrics.BufferedSwitch},k.vo.metrics.Condition=function(){"use strict";this.isFullScreen=null,this.windowSize=null,this.droppedFrames=null,this.fps=null,this.bandwidth=null},k.vo.metrics.Condition.prototype={constructor:k.vo.metrics.Condition},k.vo.metrics.DroppedFrames=function(){"use strict";this.time=null,this.droppedFrames=null},k.vo.metrics.DroppedFrames.prototype={constructor:k.vo.metrics.DroppedFrames},k.vo.metrics.DVRInfo=function(){"use strict";this.time=null,this.range=null,this.mpd=null},k.vo.metrics.DVRInfo.prototype={constructor:k.vo.metrics.DVRInfo},k.vo.metrics.HTTPRequest=function(){"use strict";this.stream=null,this.tcpid=null,this.type=null,this.url=null,this.actualurl=null,this.range=null,this.trequest=null,this.tresponse=null,this.tfinish=null,this.responsecode=null,this.interval=null,this.mediaduration=null,this.trace=[],this.startTime=null,this.quality=null,this.bytesLength=null},k.vo.metrics.HTTPRequest.prototype={constructor:k.vo.metrics.HTTPRequest},k.vo.metrics.HTTPRequest.Trace=function(){"use strict";this.s=null,this.d=null,this.b=[]},k.vo.metrics.HTTPRequest.Trace.prototype={constructor:k.vo.metrics.HTTPRequest.Trace},k.vo.metrics.ManifestUpdate=function(){"use strict";this.streamType=null,this.type=null,this.requestTime=null,this.fetchTime=null,this.availabilityStartTime=null,this.presentationStartTime=0,this.clientTimeOffset=0,this.currentTime=null,this.buffered=null,this.latency=0,this.periodInfo=[],this.representationInfo=[]},k.vo.metrics.ManifestUpdate.PeriodInfo=function(){"use strict";this.id=null,this.index=null,this.start=null,this.duration=null},k.vo.metrics.ManifestUpdate.RepresentationInfo=function(){"use strict";this.id=null,this.index=null,this.streamType=null,this.periodIndex=null,this.presentationTimeOffset=null,this.startNumber=null,this.segmentInfoType=null},k.vo.metrics.ManifestUpdate.prototype={constructor:k.vo.metrics.ManifestUpdate},k.vo.metrics.ManifestUpdate.PeriodInfo.prototype={constructor:k.vo.metrics.ManifestUpdate.PeriodInfo},k.vo.metrics.ManifestUpdate.RepresentationInfo.prototype={constructor:k.vo.metrics.ManifestUpdate.RepresentationInfo},k.vo.metrics.PlayList=function(){"use strict";this.stream=null,this.start=null,this.mstart=null,this.starttype=null,this.trace=[]},k.vo.metrics.PlayList.Trace=function(){"use strict";this.representationid=null,this.subreplevel=null,this.start=null,this.mstart=null,this.duration=null,this.playbackspeed=null,this.stopreason=null},k.vo.metrics.PlayList.prototype={constructor:k.vo.metrics.PlayList},k.vo.metrics.PlayList.INITIAL_PLAY_START_REASON="initial_start",k.vo.metrics.PlayList.SEEK_START_REASON="seek",k.vo.metrics.PlayList.Trace.prototype={constructor:k.vo.metrics.PlayList.Trace()},k.vo.metrics.PlayList.Trace.USER_REQUEST_STOP_REASON="user_request",k.vo.metrics.PlayList.Trace.REPRESENTATION_SWITCH_STOP_REASON="representation_switch",k.vo.metrics.PlayList.Trace.END_OF_CONTENT_STOP_REASON="end_of_content",k.vo.metrics.PlayList.Trace.REBUFFERING_REASON="rebuffering",k.vo.metrics.RepresentationSwitch=function(){"use strict";this.t=null,this.mt=null,this.to=null,this.lto=null},k.vo.metrics.RepresentationSwitch.prototype={constructor:k.vo.metrics.RepresentationSwitch},k.vo.metrics.Session=function(){"use strict";this.uri=null,this.loopMode=null,this.endTime=null,this.playerType=null},k.vo.metrics.Session.prototype={constructor:k.vo.metrics.Session},k.vo.metrics.State=function(){"use strict";this.t=null,this.current=null,this.position=null,this.reason=null},k.vo.metrics.State.prototype={constructor:k.vo.metrics.State},k.vo.metrics.TCPConnection=function(){"use strict";this.tcpid=null,this.dest=null,this.topen=null,this.tclose=null,this.tconnect=null},k.vo.metrics.TCPConnection.prototype={constructor:k.vo.metrics.TCPConnection},j=function(){"use strict";return{modules:{},dependencies:{},vo:{},di:{}}}(),j.dependencies.BaseURLExtensions=function(){"use strict";var a=function(a,b){for(var c,d,e,f,g,h,i,j,k,l,m=new DataView(a),n={},o=0;"sidx"!==j&&o<m.byteLength;){for(k=m.getUint32(o),o+=4,j="",f=0;4>f;f+=1)l=m.getInt8(o),j+=String.fromCharCode(l),o+=1;"moof"!==j&&"traf"!==j&&"sidx"!==j?o+=k-8:"sidx"===j&&(o-=8)}if(e=m.getUint32(o,!1)+o,e>a.byteLength)throw"sidx terminates after array buffer";for(n.version=m.getUint8(o+8),o+=12,n.timescale=m.getUint32(o+4,!1),o+=8,0===n.version?(n.earliest_presentation_time=m.getUint32(o,!1),n.first_offset=m.getUint32(o+4,!1),o+=8):(n.earliest_presentation_time=p.Math.to64BitNumber(m.getUint32(o+4,!1),m.getUint32(o,!1)),n.first_offset=(m.getUint32(o+8,!1)<<32)+m.getUint32(o+12,!1),o+=16),n.first_offset+=e+(b||0),n.reference_count=m.getUint16(o+2,!1),o+=4,n.references=[],c=n.first_offset,d=n.earliest_presentation_time,f=0;f<n.reference_count;f+=1)h=m.getUint32(o,!1),g=h>>>31,h=2147483647&h,i=m.getUint32(o+4,!1),o+=12,n.references.push({size:h,type:g,offset:c,duration:i,time:d,timescale:n.timescale}),c+=h,d+=i;if(o!==e)throw"Error: final pos "+o+" differs from SIDX end "+e;return n},b=function(b,c,e){var f,g,h,i,k,l,m,n;for(f=a.call(this,b,e),g=f.references,h=[],k=0,l=g.length;l>k;k+=1)i=new j.vo.Segment,i.duration=g[k].duration,i.media=c,i.startTime=g[k].time,i.timescale=g[k].timescale,m=g[k].offset,n=g[k].offset+g[k].size-1,i.mediaRange=m+"-"+n,h.push(i);return this.debug.log("Parsed SIDX box: "+h.length+" segments."),d.when(h)},c=function(a,b){var e,f,g,h,i,j,k,l,m,n=d.defer(),o=new DataView(a),p=0,q="",r=0,s=!1,t=this;for(t.debug.log("Searching for initialization.");"moov"!==q&&p<o.byteLength;){for(r=o.getUint32(p),p+=4,q="",j=0;4>j;j+=1)k=o.getInt8(p),q+=String.fromCharCode(k),p+=1;"ftyp"===q&&(e=p-8),"moov"===q&&(f=p-8),"moov"!==q&&(p+=r-8)}return i=o.byteLength-p,"moov"!==q?(t.debug.log("Loading more bytes to find initialization."),b.range.start=0,b.range.end=b.bytesLoaded+b.bytesToLoad,l=new XMLHttpRequest,l.onloadend=function(){s||n.reject("Error loading initialization.")},l.onload=function(){s=!0,b.bytesLoaded=b.range.end,c.call(t,l.response).then(function(a){n.resolve(a)})},l.onerror=function(){n.reject("Error loading initialization.")},l.open("GET",t.tokenAuthentication.addTokenAsQueryArg(b.url)),l.responseType="arraybuffer",l.setRequestHeader("Range","bytes="+b.range.start+"-"+b.range.end),l=t.tokenAuthentication.setTokenInRequestHeader(l),l.send(null)):(g=void 0===e?f:e,h=f+r-1,m=g+"-"+h,t.debug.log("Found the initialization.  Range: "+m),n.resolve(m)),n.promise},e=function(a){var b=d.defer(),e=new XMLHttpRequest,f=!0,g=this,h={url:a,range:{},searching:!1,bytesLoaded:0,bytesToLoad:1500,request:e};return g.debug.log("Start searching for initialization."),h.range.start=0,h.range.end=h.bytesToLoad,e.onload=function(){e.status<200||e.status>299||(f=!1,h.bytesLoaded=h.range.end,c.call(g,e.response,h).then(function(a){b.resolve(a)}))},e.onloadend=e.onerror=function(){if(f){f=!1;var a={};a.url=h.url,a.request=e,g.errHandler.sendError(k.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_INIT,null,a),b.reject(e)}},e.open("GET",g.tokenAuthentication.addTokenAsQueryArg(h.url)),e.responseType="arraybuffer",e.setRequestHeader("Range","bytes="+h.range.start+"-"+h.range.end),e=g.tokenAuthentication.setTokenInRequestHeader(e),e.send(null),g.debug.log("Perform init search: "+h.url),b.promise},f=function(a,c){var e,g,h,i,j,l,m,n,o=d.defer(),p=new DataView(a),q=new XMLHttpRequest,r=0,s="",t=0,u=!0,v=!1,w=this;for(w.debug.log("Searching for SIDX box."),w.debug.log(c.bytesLoaded+" bytes loaded.");"sidx"!==s&&r<p.byteLength;){for(t=p.getUint32(r),r+=4,s="",j=0;4>j;j+=1)l=p.getInt8(r),s+=String.fromCharCode(l),r+=1;"sidx"!==s&&(r+=t-8)}if(e=p.byteLength-r,"sidx"!==s)o.reject();else if(t-8>e)w.debug.log("Found SIDX but we don't have all of it."),c.range.start=0,c.range.end=c.bytesLoaded+(t-e),q.onload=function(){q.status<200||q.status>299||(u=!1,c.bytesLoaded=c.range.end,f.call(w,q.response,c).then(function(a){o.resolve(a)}))},q.onloadend=q.onerror=function(){if(u){u=!1;var a={};a.url=c.url,a.request=q,w.errHandler.sendError(k.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_SIDX,null,a),o.reject(q)}},q.open("GET",w.tokenAuthentication.addTokenAsQueryArg(c.url)),q.responseType="arraybuffer",q.setRequestHeader("Range","bytes="+c.range.start+"-"+c.range.end),q=w.tokenAuthentication.setTokenInRequestHeader(q),q.send(null);else if(c.range.start=r-8,c.range.end=c.range.start+t,w.debug.log("Found the SIDX box.  Start: "+c.range.start+" | End: "+c.range.end),g=new ArrayBuffer(c.range.end-c.range.start),i=new Uint8Array(g),h=new Uint8Array(a,c.range.start,c.range.end-c.range.start),i.set(h),m=this.parseSIDX.call(this,g,c.range.start),n=m.references,null!==n&&void 0!==n&&n.length>0&&(v=1===n[0].type),v){w.debug.log("Initiate multiple SIDX load.");var x,y,z,A,B,C,D=[];for(x=0,y=n.length;y>x;x+=1)z=n[x].offset,A=n[x].offset+n[x].size-1,B=z+"-"+A,D.push(this.loadSegments.call(w,c.url,B));d.all(D).then(function(a){for(C=[],x=0,y=a.length;y>x;x+=1)C=C.concat(a[x]);o.resolve(C)},function(a){o.reject(a)})}else w.debug.log("Parsing segments from SIDX."),b.call(w,g,c.url,c.range.start).then(function(a){o.resolve(a)});return o.promise},g=function(a,c){var e,g=d.defer(),h=new XMLHttpRequest,i=!0,j=this,l={url:a,range:{},searching:!1,bytesLoaded:0,bytesToLoad:1500,request:h};return null===c?(j.debug.log("No known range for SIDX request."),l.searching=!0,l.range.start=0,l.range.end=l.bytesToLoad):(e=c.split("-"),l.range.start=parseFloat(e[0]),l.range.end=parseFloat(e[1])),h.onload=function(){h.status<200||h.status>299||(i=!1,l.searching?(l.bytesLoaded=l.range.end,f.call(j,h.response,l).then(function(a){g.resolve(a)})):b.call(j,h.response,l.url,l.range.start).then(function(a){g.resolve(a)}))},h.onloadend=h.onerror=function(){if(i){i=!1;var a={};a.url=l.url,a.request=h,j.errHandler.sendError(k.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_SIDX,null,a),g.reject(h)}},h.open("GET",j.tokenAuthentication.addTokenAsQueryArg(l.url)),h.responseType="arraybuffer",h.setRequestHeader("Range","bytes="+l.range.start+"-"+l.range.end),h=j.tokenAuthentication.setTokenInRequestHeader(h),h.send(null),j.debug.log("Perform SIDX load: "+l.url),g.promise};return{debug:void 0,errHandler:void 0,tokenAuthentication:void 0,loadSegments:g,loadInitialization:e,parseSegments:b,parseSIDX:a,findSIDX:f}},j.dependencies.BaseURLExtensions.prototype={constructor:j.dependencies.BaseURLExtensions},j.di.DashContext=function(){"use strict";return{system:void 0,setup:function(){j.di.DashContext.prototype.setup.call(this),this.system.mapClass("parser",j.dependencies.DashParser),this.system.mapClass("indexHandler",j.dependencies.DashHandler),this.system.mapClass("baseURLExt",j.dependencies.BaseURLExtensions),this.system.mapClass("fragmentExt",j.dependencies.FragmentExtensions),this.system.mapSingleton("manifestExt",j.dependencies.DashManifestExtensions),this.system.mapSingleton("metricsExt",j.dependencies.DashMetricsExtensions),this.system.mapSingleton("timelineConverter",j.dependencies.TimelineConverter)}}},j.di.DashContext.prototype=new k.di.Context,j.di.DashContext.prototype.constructor=j.di.DashContext,j.dependencies.DashHandler=function(){"use strict";var a,b,c=-1,e=null,f=null,g=function(a,b){for(;a.length<b;)a="0"+a;return a},h=function(a,b,c){for(var d,e,f,h,i=0,j=0,k=b.length,l="%0",m=l.length;;){if(i=a.indexOf("$"+b),0>i)return a;if(j=a.indexOf("$",i+k),0>j)return a;if(d=a.indexOf(l,i+k),d>i&&j>d)switch(e=a.charAt(j-1),f=parseInt(a.substring(d+m,j-1),10),e){case"d":case"i":case"u":h=g(c.toString(),f);break;case"x":h=g(c.toString(16),f);break;case"X":h=g(c.toString(16),f).toUpperCase();break;case"o":h=g(c.toString(8),f);break;default:return this.debug.log("Unsupported/invalid IEEE 1003.1 format identifier string in URL"),a}else h=c;a=a.substring(0,i)+h+a.substring(j+1)}},i=function(a){return a.split("$$").join("$")},l=function(a,b){if(null===b||-1===a.indexOf("$RepresentationID$"))return a;var c=b.toString();return a.split("$RepresentationID$").join(c)},m=function(a,b){return a.representation.startNumber+b},n=function(a,b){var c,d=b.adaptation.period.mpd.manifest.Period_asArray[b.adaptation.period.index].AdaptationSet_asArray[b.adaptation.index].Representation_asArray[b.index].BaseURL;return c=a===d?a:-1!==a.indexOf("http://")||-1!==a.indexOf("https://")?a:d+a},o=function(b,c){var d,e,f=this,g=new k.vo.SegmentRequest;return d=b.adaptation.period,g.streamType=c,g.type="Initialization Segment",g.url=n(b.initialization,b),g.range=b.range,e=d.start,g.availabilityStartTime=f.timelineConverter.calcAvailabilityStartTimeFromPresentationTime(e,b.adaptation.period.mpd,a),g.availabilityEndTime=f.timelineConverter.calcAvailabilityEndTimeFromPresentationTime(e+d.duration,d.mpd,a),g.quality=b.index,g},p=function(a){var c=d.defer(),e=null,f=null,g=this;return a?(a.initialization?(e=o.call(g,a,b),c.resolve(e)):(f=a.adaptation.period.mpd.manifest.Period_asArray[a.adaptation.period.index].AdaptationSet_asArray[a.adaptation.index].Representation_asArray[a.index].BaseURL,g.baseURLExt.loadInitialization(f).then(function(d){a.range=d,a.initialization=f,e=o.call(g,a,b),c.resolve(e)},function(a){c.reject(a)})),c.promise):d.reject("no represenation")},q=function(b){var e,g,h,i=b.adaptation.period,j=!1;return b&&b.segments&&b.segments.length>0&&(null===f||f>b.segments[0].availabilityIdx)&&(f=b.segments[0].availabilityIdx),a?j=!1:0>c?j=!1:c<b.availableSegmentsNumber+f?(g=D(c,b),g&&(h=g.presentationStartTime-i.start,e=b.adaptation.period.duration,j=h>=e)):j=!0,d.when(j)},r=function(b,c){var d,e,f,g,h=this;return e=b.segmentDuration,f=b.adaptation.period.start+c*e,g=f+e,d=new j.vo.Segment,d.representation=b,d.duration=e,d.presentationStartTime=f,d.mediaStartTime=h.timelineConverter.calcMediaTimeFromPresentationTime(d.presentationStartTime,b),d.availabilityStartTime=h.timelineConverter.calcAvailabilityStartTimeFromPresentationTime(d.presentationStartTime,b.adaptation.period.mpd,a),d.availabilityEndTime=h.timelineConverter.calcAvailabilityEndTimeFromPresentationTime(g,b.adaptation.period.mpd,a),d.wallStartTime=h.timelineConverter.calcWallTimeForSegment(d,a),d.replacementNumber=m(d,c),d.availabilityIdx=c,d},s=function(a){var b,c,f,g,h,i,j,k,l,m,n,o,p,q,r=this,s=a.adaptation.period.mpd.manifest.Period_asArray[a.adaptation.period.index].AdaptationSet_asArray[a.adaptation.index].Representation_asArray[a.index].SegmentTemplate,t=s.SegmentTimeline,u=a.availableSegmentsNumber>0,w=10,y=[],z=0,A=-1,B=function(b){return x.call(r,a,z,b.d,q,s.media,b.mediaRange,A)};for(q=a.timescale,b=t.S_asArray,l=v.call(r,a),l?(o=l.start,p=l.end):n=r.timelineConverter.calcMediaTimeFromPresentationTime(e||0,a),f=0,g=b.length;g>f;f+=1)if(c=b[f],i=0,c.hasOwnProperty("r")&&(i=c.r),c.hasOwnProperty("t")&&(z=c.t),0>i&&(k=b[f+1],j=k&&k.hasOwnProperty("t")?k.t/q:a.adaptation.period.duration,i=Math.ceil((j-z/q)/(c.d/q))-1),m){if(u)break;A+=i+1}else for(h=0;i>=h;h+=1){if(A+=1,l){if(A>p){if(m=!0,u)break;continue}A>=o&&y.push(B.call(r,c))}else{if(y.length>w){if(m=!0,u)break;continue}z/q>=n-c.d/q&&y.push(B.call(r,c))}z+=c.d}if(!u){var C,D,E=b[0];C=void 0===E.t?0:r.timelineConverter.calcPresentationTimeFromMediaTime(E.t/q,a),D=r.timelineConverter.calcPresentationTimeFromMediaTime((z-c.d)/q,a),a.segmentAvailabilityRange={start:C,end:D},a.availableSegmentsNumber=A+1}return d.when(y)},t=function(b){var c,e,f,g,i=[],j=this,k=d.defer(),l=b.adaptation.period.mpd.manifest.Period_asArray[b.adaptation.period.index].AdaptationSet_asArray[b.adaptation.index].Representation_asArray[b.index].SegmentTemplate,m=b.segmentDuration,n=null,o=Math.floor(b.adaptation.period.start/m),p=null,q=null;return g=b.startNumber,w.call(j,b).then(function(d){for(b.segmentAvailabilityRange=d,n=u.call(j,b),e=n.start,f=n.end,c=e;f>=c;c+=1)p=r.call(j,b,c-(a?o:0)),p.replacementTime=(g+c-1)*b.segmentDuration,q=l.media,q=h(q,"Number",p.replacementNumber),q=h(q,"Time",p.replacementTime),p.media=q,i.push(p),p=null;b.availableSegmentsNumber=o+Math.ceil((d.end-d.start)/m),k.resolve(i)}),k.promise},u=function(b){var d,f,g,h=this,i=b.adaptation.period.start,j=b.segmentDuration,k=b.adaptation.period.mpd.manifest.minBufferTime,l=b.segmentAvailabilityRange,m=NaN,n=null,o=b.segments,p=2*j,q=Math.max(2*k,10*j);return l||(l=h.timelineConverter.calcSegmentAvailabilityRange(b,a)),a&&!b.adaptation.period.mpd.isClientServerTimeSyncCompleted?(d=Math.floor(l.start/j),f=Math.floor(l.end/j),g={start:d,end:f}):(o?(n=D(c,b),m=n?n.presentationStartTime-i:c>0?c*j:e-i||o[0].presentationStartTime-i):m=c>0?c*j:a?l.end:l.start,d=Math.floor(Math.max(m-p,l.start)/j),f=Math.floor(Math.min(d+q/j,l.end/j)),g={start:d,end:f})},v=function(b){var d,f,g,h=NaN,i=b.segments,j=2,k=10,l=0,m=Number.POSITIVE_INFINITY;if(a&&!b.adaptation.period.mpd.isClientServerTimeSyncCompleted)return g={start:l,end:m};if(!a&&null!==e)return null;if(i){if(0>c)return null;h=c}else h=c>0?c:a?m:l;return d=Math.max(h-j,l),f=Math.min(h+k,m),g={start:d,end:f}},w=function(b){var c,e,f=this,g=d.defer(),h=function(){c=f.timelineConverter.calcSegmentAvailabilityRange(b,a),c.end>0?g.resolve(c):(e=1e3*Math.abs(c.end),setTimeout(h,e))};return h(),g.promise},x=function(b,c,d,e,f,g,i){var k,l,n,o=this,p=c/e,q=Math.min(d/e,b.adaptation.period.mpd.maxSegmentDuration);return k=o.timelineConverter.calcPresentationTimeFromMediaTime(p,b),k=p,l=k+q,n=new j.vo.Segment,n.representation=b,n.duration=q,n.mediaStartTime=p,n.presentationStartTime=k,n.availabilityStartTime=b.adaptation.period.mpd.manifest.mpdLoadedTime,n.availabilityEndTime=o.timelineConverter.calcAvailabilityEndTimeFromPresentationTime(l,b.adaptation.period.mpd,a),n.wallStartTime=o.timelineConverter.calcWallTimeForSegment(n,a),
n.replacementTime=c,n.replacementNumber=m(n,i),f=h(f,"Number",n.replacementNumber),f=h(f,"Time",n.replacementTime),n.media=f,n.mediaRange=g,n.availabilityIdx=i,n},y=function(b){var c,e,f,g,h,i=this,j=[],k=d.defer(),l=b.adaptation.period.mpd.manifest.Period_asArray[b.adaptation.period.index].AdaptationSet_asArray[b.adaptation.index].Representation_asArray[b.index].SegmentList,m=l.SegmentURL_asArray.length,n=0,o=l.SegmentURL_asArray.length;return h=b.startNumber,w.call(i,b).then(function(d){for(a||(g=u.call(i,b),n=g.start,o=g.end),c=n;o>c;c+=1)f=l.SegmentURL_asArray[c],e=r.call(i,b,c),e.replacementTime=(h+c-1)*b.segmentDuration,e.media=f.media,e.mediaRange=f.mediaRange,e.index=f.index,e.indexRange=f.indexRange,void 0!==f.sequenceNumber&&(e.sequenceNumber=f.sequenceNumber),j.push(e),e=null;b.segmentAvailabilityRange=d,b.availableSegmentsNumber=m,k.resolve(j)}),k.promise},z=function(a){var b,c,e,f,g=this,h=a.adaptation.period.mpd.manifest.Period_asArray[a.adaptation.period.index].AdaptationSet_asArray[a.adaptation.index].Representation_asArray[a.index].BaseURL,i=d.defer(),j=[],k=0,l=null;return a.indexRange&&(l=a.indexRange),this.baseURLExt.loadSegments(h,l).then(function(d){for(c=0,e=d.length;e>c;c+=1)b=d[c],f=x.call(g,a,b.startTime,b.duration,b.timescale,b.media,b.mediaRange,k),j.push(f),f=null,k+=1;a.segmentAvailabilityRange={start:j[0].presentationStartTime,end:j[e-1].presentationStartTime},a.availableSegmentsNumber=e,i.resolve(j)}),i.promise},A=function(b){var c,e,f=d.defer(),g=this;return F.call(g,b)?(c="SegmentTimeline"===b.segmentInfoType?s.call(g,b):"SegmentTemplate"===b.segmentInfoType?t.call(g,b):"SegmentList"===b.segmentInfoType?y.call(g,b):z.call(g,b),d.when(c).then(function(c){if(b.segments=c,e=c.length-1,a&&isNaN(b.adaptation.period.liveEdge)){var d=g.metricsModel.getMetricsFor("stream"),h=c[e].presentationStartTime;b.adaptation.period.liveEdge=h,g.metricsModel.updateManifestUpdateInfo(g.metricsExt.getCurrentManifestUpdate(d),{presentationStartTime:h})}f.resolve(c)}),f.promise):d.when(b.segments)},B=function(a){var c=this,e=d.defer();return a.segments=null,c.debug.log("[DashHandler]["+b+"] updateSegmentList for representation ",a.id),A.call(c,a).then(function(b){a.segments=b,e.resolve()}),e.promise},C=function(a,c){var e,f,g,h,i=null===c?null:c.segments,k=null===i?0:i.length-1,l=-1,m=this;if(m.debug.log("[DashHandler]["+b+"] getIndexForSegments for time ",a),i&&i.length>0)for(h=k;h>=0;h--){if(e=i[h],f=e.presentationStartTime,g=e.duration,a+j.dependencies.DashHandler.EPSILON>=f&&a-j.dependencies.DashHandler.EPSILON<=f+g){l=e.availabilityIdx,m.debug.log("[DashHandler]["+b+"] getIndexForSegments, idx =  ",l);break}if(-1===l&&a-j.dependencies.DashHandler.EPSILON>f+g){m.debug.log("[DashHandler]["+b+"] getIndexForSegments, (past the end) idx =  ",l),l=isNaN(c.segmentDuration)?e.availabilityIdx+1:Math.floor((a-c.adaptation.period.start)/c.segmentDuration);break}}return-1===l&&(isNaN(c.segmentDuration)?(m.debug.log("Couldn't figure out a time!"),m.debug.log("Time: "+a)):(m.debug.log("[DashHandler]["+b+"] getIndexForSegments, (segment duration) idx =  ",l),l=Math.floor((a-c.adaptation.period.start)/c.segmentDuration))),d.when(l)},D=function(a,b){if(!b||!b.segments)return null;var c,d,e=b.segments.length;for(d=0;e>d;d+=1)if(c=b.segments[d],c.availabilityIdx===a)return c;return null},E=function(a,b){if(!b||!b.segments)return null;var c,d,e=b.segments.length;for(d=0;e>d;d+=1)if(c=b.segments[d],void 0!==c.sequenceNumber&&c.sequenceNumber===a)return e-1>d?b.segments[d+1]:null;return null},F=function(a){var b,d,f,g=!1,h=a.segments;return h&&0!==h.length?(d=h[0].availabilityIdx,b=h[h.length-1].availabilityIdx,f=h[h.length-1].presentationStartTime,g=d>c||c>b||e>f):g=!0,g},G=function(a){if(null===a||void 0===a)return d.when(null);var c,e=new k.vo.SegmentRequest,f=a.representation,g=f.adaptation.period.mpd.manifest.Period_asArray[f.adaptation.period.index].AdaptationSet_asArray[f.adaptation.index].Representation_asArray[f.index].bandwidth;return c=n(a.media,f),c=h(c,"Number",a.replacementNumber),c=h(c,"Time",a.replacementTime),c=h(c,"Bandwidth",g),c=l(c,f.id),c=i(c),e.streamType=b,e.type="Media Segment",e.url=c,e.range=a.mediaRange,e.startTime=a.presentationStartTime,e.duration=a.duration,e.timescale=f.timescale,e.availabilityStartTime=a.availabilityStartTime,e.availabilityEndTime=a.availabilityEndTime,e.wallStartTime=a.wallStartTime,e.quality=f.index,e.index=a.availabilityIdx,void 0!==a.sequenceNumber&&(e.sequenceNumber=a.sequenceNumber),d.when(e)},H=function(a,f){var g,h,i,j=this;return a?(e=f,j.debug.log("[DashHandler]["+b+"] Getting the request for time: "+f),g=d.defer(),A.call(j,a).then(function(){var b;return b=C.call(j,f,a)}).then(function(d){return j.debug.log("[DashHandler]["+b+"] Index for time "+f+" is "+d),c=d,q.call(j,a)}).then(function(d){var e=null;return d?(h=new k.vo.SegmentRequest,h.action=h.ACTION_COMPLETE,h.index=c,j.debug.log("[DashHandler]["+b+"] Signal complete."),j.debug.log(h),g.resolve(h)):(i=D(c,a),e=G.call(j,i)),e}).then(function(a){g.resolve(a)}),g.promise):d.reject("no represenation")},I=function(a){var f,g,h,i=this;if(!a)return d.reject("no represenation");if(-1===c)throw"You must call getSegmentRequestForTime first.";return e=null,c+=1,f=d.defer(),i.debug.log("[DashHandler]["+b+"] Getting the next request => index = "+c),q.call(i,a).then(function(d){d?(g=new k.vo.SegmentRequest,g.action=g.ACTION_COMPLETE,g.index=c,i.debug.log("[DashHandler]["+b+"] Signal complete."),f.resolve(g)):A.call(i,a).then(function(){var b;return h=D(c,a),b=G.call(i,h)}).then(function(a){f.resolve(a)})}),f.promise},J=function(a,e){var f,g,h,i=this;if(!a)return d.reject("no represenation");if(-1===c)throw"You must call getSegmentRequestForTime first.";return f=d.defer(),i.debug.log("[DashHandler]["+b+"] Getting the next request => sn = "+e),A.call(i,a).then(function(){q.call(i,a).then(function(d){d?(g=new k.vo.SegmentRequest,g.action=g.ACTION_COMPLETE,g.index=c,i.debug.log("[DashHandler]["+b+"] Signal complete."),f.resolve(g)):(h=E(e,a),null===h?f.resolve(null):(c=h.availabilityIdx,G.call(i,h).then(function(a){f.resolve(a)})))})}),f.promise},K=function(a,c,e){var f,g=this,h=Math.max(c-e,0),i=d.defer(),j=0;return a?(g.debug.log("[DashHandler]["+b+"] getSegmentCountForDuration"),A.call(g,a).then(function(a){f=a[0].duration,j=Math.ceil(h/f),i.resolve(j)},function(){i.resolve(0)}),i.promise):d.reject("no represenation")},L=function(a){var e,f,g=this,h=d.defer();return a?(f=c,A.call(g,a).then(function(c){0>f?e=g.timelineConverter.calcPresentationStartTime(a.adaptation.period):(f=f<c[0].availabilityIdx?c[0].availabilityIdx:Math.min(c[c.length-1].availabilityIdx,f),e=D(f,a).presentationStartTime,g.debug.log("[DashHandler]["+b+"] getSegmentByIndex, index = "+f+" => time = "+e)),g.debug.log("[DashHandler]["+b+"] getCurrentTime => ",e),h.resolve(e)},function(){h.reject()}),h.promise):d.reject("no represenation")},M=function(a){};return{debug:void 0,baseURLExt:void 0,metricsModel:void 0,metricsExt:void 0,manifestModel:void 0,manifestExt:void 0,timelineConverter:void 0,capabilities:void 0,videoModel:void 0,getType:function(){return b},setType:function(a){b=a},getIsDynamic:function(){return a},setIsDynamic:function(b){a=b},getInitRequest:p,getSegmentRequestForTime:H,getNextSegmentRequest:I,getNextSegmentRequestFromSN:J,getCurrentTime:L,getSegmentCountForDuration:K,updateSegmentList:B,getIFrameRequest:M}},j.dependencies.DashHandler.EPSILON=.003,j.dependencies.DashHandler.prototype={constructor:j.dependencies.DashHandler},j.dependencies.DashManifestExtensions=function(){"use strict";this.timelineConverter=void 0},j.dependencies.DashManifestExtensions.prototype={constructor:j.dependencies.DashManifestExtensions,getIsAudio:function(a){"use strict";var b,c,e,f,g=!1,h=!1;if(a){if(e=a.ContentComponent_asArray)for(b=0,c=e.length;c>b;b+=1)"audio"===e[b].contentType&&(g=!0,h=!0);if(a.mimeType&&(g=-1!==a.mimeType.indexOf("audio"),h=!0),!h)for(b=0,c=a.Representation_asArray.length;!h&&c>b;)f=a.Representation_asArray[b],f.mimeType&&(g=-1!==f.mimeType.indexOf("audio"),h=!0),b+=1;g&&(a.type="audio")}return d.when(g)},getIsVideo:function(a){"use strict";var b,c,e,f,g=!1,h=!1;if(a){if(e=a.ContentComponent_asArray)for(b=0,c=e.length;c>b;b+=1)"video"===e[b].contentType&&(g=!0,h=!0);if(a.mimeType&&(g=-1!==a.mimeType.indexOf("video"),h=!0),!h)for(b=0,c=a.Representation_asArray.length;!h&&c>b;)f=a.Representation_asArray[b],f.mimeType&&(g=-1!==f.mimeType.indexOf("video"),h=!0),b+=1;g&&(a.type="video")}return d.when(g)},getIsText:function(a){"use strict";var b,c,e,f=a.ContentComponent_asArray,g=!1,h=!1;if(a){if(f)for(b=0,c=f.length;c>b;b+=1)"text"===f[b].contentType&&(g=!0,h=!0);if(a.mimeType&&(g=-1!==a.mimeType.indexOf("vtt")||-1!==a.mimeType.indexOf("ttml"),h=!0),!h)for(b=0,c=a.Representation_asArray.length;!h&&c>b;)e=a.Representation_asArray[b],e.mimeType&&(g=-1!==e.mimeType.indexOf("vtt")||-1!==e.mimeType.indexOf("ttml"),h=!0),b+=1;h&&(a.type="text")}return d.when(g)},getIsTextTrack:function(a){return"text/vtt"===a||"application/ttml+xml"===a||"application/ttml+xml+mp4"===a},getIsMain:function(){"use strict";return d.when(!1)},processAdaptation:function(a){"use strict";return void 0!==a.Representation_asArray&&null!==a.Representation_asArray&&a.Representation_asArray.sort(function(a,b){return a.bandwidth-b.bandwidth}),a},getDataForId:function(a,b,c){"use strict";var e,f,g=b.Period_asArray[c].AdaptationSet_asArray;for(e=0,f=g.length;f>e;e+=1)if(g[e].hasOwnProperty("id")&&g[e].id===a)return d.when(g[e]);return d.when(null)},getDataForIndex:function(a,b,c){"use strict";var e=b.Period_asArray[c].AdaptationSet_asArray;return d.when(e[a])},getDataForIndex_:function(a,b,c){"use strict";var d;return b&&c>=0&&(d=b.Period_asArray[c].AdaptationSet_asArray,d&&d.length>0&&!isNaN(a))?d[a]:[]},getIndex:function(a,b){var c,d,e,f=b.Period_asArray;for(d=0;d<f.length;d+=1)for(c=f[d].AdaptationSet_asArray,e=0;e<c.length;e+=1)if(c[e]===a)return e;return-1},getDataIndex:function(a,b,c){"use strict";var e,f,g;if(b&&c>=0)if(e=b.Period_asArray[c].AdaptationSet_asArray,a.id){for(f=0,g=e.length;g>f;f+=1)if(e[f].id&&e[f].id===a.id)return d.when(f)}else{var h,i=JSON.stringify(a);for(f=0,g=e.length;g>f;f+=1)if(h=JSON.stringify(e[f]),h===i)return d.when(f)}return d.when(-1)},getVideoData:function(a,b){"use strict";var c,e,f,g=d.defer(),h=[];if(a&&b>=0){for(c=a.Period_asArray[b].AdaptationSet_asArray,e=0,f=c.length;f>e;e+=1)h.push(this.getIsVideo(c[e]));d.all(h).then(function(a){var b=!1;for(e=0,f=a.length;f>e;e+=1)a[e]===!0&&(b=!0,g.resolve(c[e]));b||g.reject()})}else g.reject();return g.promise},getTextDatas:function(a,b){"use strict";var c,e,f,g=d.defer(),h=[];if(a&&b>=0){for(c=a.Period_asArray[b].AdaptationSet_asArray,e=0,f=c.length;f>e;e+=1)h.push(this.getIsText(c[e]));d.all(h).then(function(a){var b=[];for(e=0,f=a.length;f>e;e+=1)a[e]===!0&&b.push(c[e]),g.resolve(b)})}else g.reject();return g.promise},getAudioDatas:function(a,b){"use strict";var c,e,f,g=d.defer(),h=[];if(a&&b>=0){for(c=a.Period_asArray[b].AdaptationSet_asArray,e=0,f=c.length;f>e;e+=1)h.push(this.getIsAudio(c[e]));d.all(h).then(function(a){var b=[];for(e=0,f=a.length;f>e;e+=1)a[e]===!0&&b.push(c[e]);g.resolve(b)})}else g.reject();return g.promise},getSpecificAudioData:function(a,b,c){"use strict";var e,f,g=d.defer(),h=!1,i=this;return a&&b>=0?this.getAudioDatas(a,b).then(function(a){if(!a||0===a.length)return void g.reject();for(e=0,f=a.length;f>e&&h!==!0;e+=1)a[e].lang===c&&(h=!0,g.resolve(i.processAdaptation(a[e])));h||g.resolve(a[0])}):g.reject(),g.promise},getPrimaryAudioData:function(a,b){"use strict";var c,e,f=d.defer(),g=[],h=this;return a&&b>=0?this.getAudioDatas(a,b).then(function(a){if(!a||0===a.length)return void f.reject();for(c=0,e=a.length;e>c;c+=1)g.push(h.getIsMain(a[c]));d.all(g).then(function(b){var d=!1;for(c=0,e=b.length;e>c;c+=1)b[c]===!0&&(d=!0,f.resolve(h.processAdaptation(a[c])));d||f.resolve(a[0])})}):f.reject(),f.promise},getPrimaryTextData:function(a,b){"use strict";var c,e,f=d.defer(),g=[],h=this;return a&&b>=0?this.getTextDatas(a,b).then(function(a){if(!a||0===a.length)return void f.reject();for(c=0,e=a.length;e>c;c+=1)g.push(h.getIsMain(a[c]));d.all(g).then(function(b){var d=!1;for(c=0,e=b.length;e>c;c+=1)b[c]===!0&&(d=!0,f.resolve(h.processAdaptation(a[c])));d||f.resolve(a[0])})}):f.reject(),f.promise},getSpecificTextData:function(a,b,c){"use strict";var e,f,g=d.defer(),h=!1,i=this;return a&&b>=0?this.getTextDatas(a,b).then(function(a){if(!a||0===a.length)return void g.reject();for(e=0,f=a.length;f>e&&h!==!0;e+=1)a[e].lang===c&&(h=!0,g.resolve(i.processAdaptation(a[e])));h||g.resolve(a[0])}):g.reject(),g.promise},getCodec:function(a){"use strict";for(var b,c=0,e=null;null===e&&c<a.Representation_asArray.length;)b=a.Representation_asArray[c],null!==b.codecs&&""!==b.codecs&&(e=b.mimeType+';codecs="'+b.codecs+'"'),c++;return d.when(e)},getMimeType:function(a){"use strict";return d.when(a.Representation_asArray[0].mimeType)},getKID:function(a){"use strict";return a&&a.hasOwnProperty("cenc:default_KID")?a["cenc:default_KID"]:null},getContentProtectionData:function(a){"use strict";return a&&a.hasOwnProperty("ContentProtection_asArray")&&0!==a.ContentProtection_asArray.length?d.when(a.ContentProtection_asArray):d.when(null)},getIsDynamic:function(a){"use strict";var b=!1,c="dynamic";return a&&a.hasOwnProperty("type")&&(b=a.type===c),b},getIsDVR:function(a){"use strict";var b,c,e=this.getIsDynamic(a);return b=!isNaN(a.timeShiftBufferDepth),c=e&&b,d.when(c)},getIsOnDemand:function(a){"use strict";var b=!1;return a.profiles&&a.profiles.length>0&&(b=-1!==a.profiles.indexOf("urn:mpeg:dash:profile:isoff-on-demand:2011")),d.when(b)},getDuration:function(a){var b;return b=a&&a.hasOwnProperty("mediaPresentationDuration")?a.mediaPresentationDuration:Number.POSITIVE_INFINITY,d.when(b)},getBandwidth:function(a){"use strict";return d.when(a.bandwidth)},getRefreshDelay:function(a){"use strict";var b=NaN,c=2;return a.hasOwnProperty("minimumUpdatePeriod")&&(b=Math.max(parseFloat(a.minimumUpdatePeriod),c)),d.when(b)},getRepresentationCount:function(a){"use strict";return a?d.when(a.Representation_asArray.length):d.when(null)},getRepresentationFor:function(a,b){"use strict";return d.when(b.Representation_asArray[a])},getRepresentationsForAdaptation:function(a,b){var c,e,f,g,h,i=this,k=[],l=d.defer();if(a&&b){c=i.processAdaptation(a.Period_asArray[b.period.index].AdaptationSet_asArray[b.index]);for(var m=0;m<c.Representation_asArray.length;m+=1)h=c.Representation_asArray[m],e=new j.vo.Representation,e.index=m,e.adaptation=b,h.hasOwnProperty("id")&&(e.id=h.id),h.hasOwnProperty("SegmentBase")?(g=h.SegmentBase,e.segmentInfoType="SegmentBase"):h.hasOwnProperty("SegmentList")?(g=h.SegmentList,e.segmentInfoType="SegmentList",e.useCalculatedLiveEdgeTime=!0):h.hasOwnProperty("SegmentTemplate")?(g=h.SegmentTemplate,g.hasOwnProperty("SegmentTimeline")?e.segmentInfoType="SegmentTimeline":e.segmentInfoType="SegmentTemplate",g.hasOwnProperty("initialization")&&(e.initialization=g.initialization.split("$Bandwidth$").join(h.bandwidth).split("$RepresentationID$").join(h.id))):(g=h.BaseURL,e.segmentInfoType="BaseURL"),g.hasOwnProperty("Initialization")?(f=g.Initialization,f.hasOwnProperty("sourceURL")?e.initialization=f.sourceURL:f.hasOwnProperty("range")&&(e.initialization=h.BaseURL,e.range=f.range)):h.hasOwnProperty("mimeType")&&i.getIsTextTrack(h.mimeType)&&(e.initialization=h.BaseURL,e.range=0),g.hasOwnProperty("timescale")&&(e.timescale=g.timescale),g.hasOwnProperty("duration")&&(e.segmentDuration=g.duration/e.timescale),g.hasOwnProperty("startNumber")&&(e.startNumber=g.startNumber),g.hasOwnProperty("indexRange")&&(e.indexRange=g.indexRange),g.hasOwnProperty("presentationTimeOffset")&&(e.presentationTimeOffset=g.presentationTimeOffset/e.timescale),e.MSETimeOffset=i.timelineConverter.calcMSETimeOffset(e),k.push(e)}return l.resolve(k),l.promise},getAdaptationsForPeriod:function(a,b){var c,e=null===a?null:a.Period_asArray[b.index],f=[];if(e)for(var g=0;g<e.AdaptationSet_asArray.length;g+=1)c=new j.vo.AdaptationSet,c.index=g,c.period=b,f.push(c);return d.when(f)},getRegularPeriods:function(a,b){var c,e,f=this,g=d.defer(),h=[],i=f.getIsDynamic(a),k=null,l=null,m=null,n=null;for(c=0,e=a.Period_asArray.length;e>c;c+=1)l=a.Period_asArray[c],l.hasOwnProperty("start")?(n=new j.vo.Period,n.start=l.start):null!==k&&l.hasOwnProperty("duration")?(n=new j.vo.Period,n.start=m.start+m.duration,n.duration=l.duration):0!==c||i||(n=new j.vo.Period,n.start=0),null!==m&&isNaN(m.duration)&&(m.duration=n.start-m.start),null!==n&&l.hasOwnProperty("id")&&(n.id=l.id),null!==n&&l.hasOwnProperty("duration")&&(n.duration=l.duration),null!==n&&(n.index=c,n.mpd=b,h.push(n)),k=l,l=null,m=n,n=null;return 0===h.length?d.when(h):(f.getCheckTime(a,h[0]).then(function(a){b.checkTime=a,null!==m&&isNaN(m.duration)?f.getEndTimeForLastPeriod(b).then(function(a){m.duration=a-m.start,g.resolve(h)}):g.resolve(h)}),d.when(g.promise))},getMpd:function(a){var b=new j.vo.Mpd;return a?(b.manifest=a,a.hasOwnProperty("availabilityStartTime")?b.availabilityStartTime=new Date(a.availabilityStartTime.getTime()):b.availabilityStartTime=new Date(a.mpdLoadedTime.getTime()),a.hasOwnProperty("availabilityEndTime")&&(b.availabilityEndTime=new Date(a.availabilityEndTime.getTime())),a.hasOwnProperty("suggestedPresentationDelay")&&(b.suggestedPresentationDelay=a.suggestedPresentationDelay),a.hasOwnProperty("timeShiftBufferDepth")&&(b.timeShiftBufferDepth=a.timeShiftBufferDepth),a.hasOwnProperty("maxSegmentDuration")&&(b.maxSegmentDuration=a.maxSegmentDuration),d.when(b)):d.when(null)},getFetchTime:function(a,b){var c=this.timelineConverter.calcPresentationTimeFromWallTime(a.mpdLoadedTime,b);return d.when(c)},getCheckTime:function(a,b){var c=this,e=d.defer(),f=NaN;return a.hasOwnProperty("minimumUpdatePeriod")?c.getFetchTime(a,b).then(function(b){f=b+a.minimumUpdatePeriod,e.resolve(f)}):e.resolve(f),e.promise},getEndTimeForLastPeriod:function(a){var b;if(a.manifest.mediaPresentationDuration)b=a.manifest.mediaPresentationDuration;else{if(isNaN(a.checkTime))return d.fail(new Error("Must have @mediaPresentationDuration or @minimumUpdatePeriod on MPD or an explicit @duration on the last period."));b=a.checkTime}return d.when(b)},getEventsForPeriod:function(a,b){var c=null===a?null:a.Period_asArray,e=null===c?null:c[b.index].EventStream_asArray,f=[];if(e)for(var g=0;g<e.length;g+=1){var h=new j.vo.EventStream;if(h.period=b,h.timescale=1,!e[g].hasOwnProperty("schemeIdUri"))throw"Invalid EventStream. SchemeIdUri has to be set";h.schemeIdUri=e[g].schemeIdUri,e[g].hasOwnProperty("timescale")&&(h.timescale=e[g].timescale),e[g].hasOwnProperty("value")&&(h.value=e[g].value);for(var i=0;i<e[g].Event_asArray.length;i+=1){var k=new j.vo.Event;k.presentationTime=0,k.eventStream=h,e[g].Event_asArray[i].hasOwnProperty("presentationTime")&&(k.presentationTime=e[g].Event_asArray[i].presentationTime),e[g].Event_asArray[i].hasOwnProperty("duration")&&(k.duration=e[g].Event_asArray[i].duration),e[g].Event_asArray[i].hasOwnProperty("id")&&(k.id=e[g].Event_asArray[i].id),f.push(k)}}return d.when(f)},getEventStreamForAdaptationSet:function(a){var b,c=[];if(a&&(b=a.InbandEventStream_asArray))for(var d=0;d<b.length;d+=1){var e=new j.vo.EventStream;if(e.timescale=1,!b[d].hasOwnProperty("schemeIdUri"))throw"Invalid EventStream. SchemeIdUri has to be set";e.schemeIdUri=b[d].schemeIdUri,b[d].hasOwnProperty("timescale")&&(e.timescale=b[d].timescale),b[d].hasOwnProperty("value")&&(e.value=b[d].value),c.push(e)}return c},getEventStreamForRepresentation:function(a,b){var c,d=[];if(a&&b&&(c=a.Representation_asArray[b.index].InbandEventStream_asArray))for(var e=0;e<c.length;e++){var f=new j.vo.EventStream;if(f.timescale=1,f.representation=b,!c[e].hasOwnProperty("schemeIdUri"))throw"Invalid EventStream. SchemeIdUri has to be set";f.schemeIdUri=c[e].schemeIdUri,c[e].hasOwnProperty("timescale")&&(f.timescale=c[e].timescale),c[e].hasOwnProperty("value")&&(f.value=c[e].value),d.push(f)}return d},getRepresentationBandwidth:function(a,b){var c=this,e=d.defer();return c.getRepresentationFor(b,a).then(function(a){c.getBandwidth(a).then(function(a){e.resolve(a)})}),e.promise}},j.dependencies.DashMetricsExtensions=function(){"use strict";var a=function(a,b){var c,d,e,f,g,h,i,j;for(h=0;h<a.length;h+=1)for(c=a[h],e=c.AdaptationSet_asArray,i=0;i<e.length;i+=1)for(d=e[i],g=d.Representation_asArray,j=0;j<g.length;j+=1)if(f=g[j],b===f.id)return j;return-1},b=function(a,b){var c,d,e,f,g,h,i,j;for(h=0;h<a.length;h+=1)for(c=a[h],e=c.AdaptationSet_asArray,i=0;i<e.length;i+=1)for(d=e[i],g=d.Representation_asArray,j=0;j<g.length;j+=1)if(f=g[j],b===f.id)return f;return null},c=function(a,b){var c=!1;return"video"===b?(this.manifestExt.getIsVideo(a),"video"===a.type&&(c=!0)):"audio"===b?(this.manifestExt.getIsAudio(a),"audio"===a.type&&(c=!0)):c=!1,c},d=function(a,b){var d,e,f,g,h,i;for(h=0;h<a.length;h+=1)for(d=a[h],f=d.AdaptationSet_asArray,i=0;i<f.length;i+=1)if(e=f[i],g=e.Representation_asArray,c.call(this,e,b))return g.length;return-1},e=function(a){var c,d=this,e=d.manifestModel.getValue(),f=null===e?null:e.Period_asArray;return f?(c=b.call(d,f,a),null===c?null:c.bandwidth):null},f=function(b){var c,d=this,e=d.manifestModel.getValue(),f=null===e?null:e.Period_asArray;return f?c=a.call(d,f,b):null},g=function(a){var b,c=this,e=c.manifestModel.getValue(),f=null===e?null:e.Period_asArray;return f?b=d.call(this,f,a):null},h=function(a){if(null===a)return null;var b,c,d,e=a.RepSwitchList;return null===e||e.length<=0?null:(b=e.length,c=b-1,d=e[c])},i=function(a){if(null===a)return null;var b,c,d,e=a.BufferLevel;return null===e||e.length<=0?null:(b=e.length,c=b-1,d=e[c])},j=function(a){if(null===a)return null;var b,c,d=a.HttpList,e=null;if(null===d||d.length<=0)return null;for(b=d.length,c=b-1;c>=0;){if(d[c].responsecode){e=d[c];break}c-=1}return e},k=function(a){return null===a?[]:a.HttpList?a.HttpList:[]},l=function(a){if(null===a)return null;var b,c,d,e=a.DroppedFrames;return null===e||e.length<=0?null:(b=e.length,c=b-1,d=e[c])},m=function(a){if(null===a)return null;var b,c=a.DVRInfo,d=null;return null===c||c.length<=0?null:(b=c.length-1,d=c[b])},n=function(a){if(null===a)return null;var b,c,d,e=a.ManifestUpdate;return null===e||e.length<=0?null:(b=e.length,c=b-1,d=e[c])};return{manifestModel:void 0,manifestExt:void 0,getBandwidthForRepresentation:e,getIndexForRepresentation:f,getMaxIndexForBufferType:g,getCurrentRepresentationSwitch:h,getCurrentBufferLevel:i,getCurrentHttpRequest:j,getHttpRequests:k,getCurrentDroppedFrames:l,getCurrentDVRInfo:m,getCurrentManifestUpdate:n}},j.dependencies.DashMetricsExtensions.prototype={constructor:j.dependencies.DashMetricsExtensions},j.dependencies.DashParser=function(){"use strict";var a=31536e3,e=2592e3,f=86400,g=3600,h=60,i=60,j=1e3,k=/^P(([\d.]*)Y)?(([\d.]*)M)?(([\d.]*)D)?T?(([\d.]*)H)?(([\d.]*)M)?(([\d.]*)S)?/,l=/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2})(?::([0-9]*)(\.[0-9]*)?)?(?:([+-])([0-9]{2})([0-9]{2}))?/,m=/^[-+]?[0-9]+[.]?[0-9]*([eE][-+]?[0-9]+)?$/,n=[{type:"duration",test:function(a){return k.test(a)},converter:function(b){var c=k.exec(b);return parseFloat(c[2]||0)*a+parseFloat(c[4]||0)*e+parseFloat(c[6]||0)*f+parseFloat(c[8]||0)*g+parseFloat(c[10]||0)*h+parseFloat(c[12]||0)}},{type:"datetime",test:function(a){return l.test(a)},converter:function(a){var b,c=l.exec(a);if(b=Date.UTC(parseInt(c[1],10),parseInt(c[2],10)-1,parseInt(c[3],10),parseInt(c[4],10),parseInt(c[5],10),c[6]&&parseInt(c[6],10)||0,c[7]&&parseFloat(c[7])*j||0),c[9]&&c[10]){var d=parseInt(c[9],10)*i+parseInt(c[10],10);b+=("+"===c[8]?-1:1)*d*h*j}return new Date(b)}},{type:"numeric",test:function(a){return m.test(a)},converter:function(a){return parseFloat(a)}}],o=function(){var a,b,c,d;return d=[{name:"profiles",merge:!1},{name:"width",merge:!1},{name:"height",merge:!1},{name:"sar",merge:!1},{name:"frameRate",merge:!1},{name:"audioSamplingRate",merge:!1},{name:"mimeType",merge:!1},{name:"segmentProfiles",merge:!1},{name:"codecs",merge:!1},{name:"maximumSAPPeriod",merge:!1},{name:"startsWithSap",merge:!1},{name:"maxPlayoutRate",merge:!1},{name:"codingDependency",merge:!1},{name:"scanType",merge:!1},{name:"FramePacking",merge:!0},{name:"AudioChannelConfiguration",merge:!0},{name:"ContentProtection",merge:!0}],a={},a.name="AdaptationSet",a.isRoot=!1,a.isArray=!0,a.parent=null,a.children=[],a.properties=d,b={},b.name="Representation",b.isRoot=!1,b.isArray=!0,b.parent=a,b.children=[],b.properties=d,a.children.push(b),c={},c.name="SubRepresentation",c.isRoot=!1,c.isArray=!0,c.parent=b,c.children=[],c.properties=d,b.children.push(c),a},p=function(){var a,b,c,d;return d=[{name:"SegmentBase",merge:!0},{name:"SegmentTemplate",merge:!0},{name:"SegmentList",merge:!0}],a={},a.name="Period",a.isRoot=!1,a.isArray=!0,a.parent=null,a.children=[],a.properties=d,b={},b.name="AdaptationSet",b.isRoot=!1,b.isArray=!0,b.parent=a,b.children=[],b.properties=d,a.children.push(b),c={},c.name="Representation",c.isRoot=!1,c.isArray=!0,c.parent=b,c.children=[],c.properties=d,b.children.push(c),a},q=function(){var a,b,c,d,e;return e=[{name:"BaseURL",merge:!0,mergeFunction:function(a,b){var c;return c=0===b.indexOf("http://")?b:a+b}}],a={},a.name="mpd",a.isRoot=!0,a.isArray=!0,a.parent=null,a.children=[],a.properties=e,b={},b.name="Period",b.isRoot=!1,b.isArray=!0,b.parent=null,b.children=[],b.properties=e,a.children.push(b),c={},c.name="AdaptationSet",c.isRoot=!1,c.isArray=!0,c.parent=b,c.children=[],c.properties=e,b.children.push(c),d={},d.name="Representation",d.isRoot=!1,d.isArray=!0,d.parent=c,d.children=[],d.properties=e,c.children.push(d),a},r=function(){var a=[];return a.push(o()),a.push(p()),a.push(q()),a},s=function(a,e){var f,g=new c(n,"",!0),h=new b(r()),i=new Date,j=null,k=null;try{f=g.xml_str2json(a),j=new Date,f.hasOwnProperty("BaseURL")?(f.BaseURL=f.BaseURL_asArray[0],0!==f.BaseURL.toString().indexOf("http")&&(f.BaseURL=e+f.BaseURL)):f.BaseURL=e,h.run(f),k=new Date,this.debug.log("Parsing complete: ( xml2json: "+(j.getTime()-i.getTime())+"ms, objectiron: "+(k.getTime()-j.getTime())+"ms, total: "+(k.getTime()-i.getTime())/1e3+"s)")}catch(l){return d.reject(null)}return d.when(f)};return{debug:void 0,parse:s}},j.dependencies.DashParser.prototype={constructor:j.dependencies.DashParser},j.dependencies.FragmentExtensions=function(){"use strict";var a=function(a){for(var b,c,e,f,g,h,i=d.defer(),j=new DataView(a),k=0;"tfdt"!==f&&k<j.byteLength;){for(e=j.getUint32(k),k+=4,f="",g=0;4>g;g+=1)h=j.getInt8(k),f+=String.fromCharCode(h),k+=1;"moof"!==f&&"traf"!==f&&"tfdt"!==f&&(k+=e-8)}if(k===j.byteLength)throw"Error finding live offset.";return c=j.getUint8(k),this.debug.log("position: "+k),0===c?(k+=4,b=j.getUint32(k,!1)):(k+=e-16,b=p.Math.to64BitNumber(j.getUint32(k+4,!1),j.getUint32(k,!1))),i.resolve({version:c,base_media_decode_time:b}),i.promise},b=function(a){for(var b,c,e,f,g,h,i,j=new DataView(a),k=0;"sidx"!==g&&k<j.byteLength;){for(h=j.getUint32(k),k+=4,g="",f=0;4>f;f+=1)i=j.getInt8(k),g+=String.fromCharCode(i),k+=1;"moof"!==g&&"traf"!==g&&"sidx"!==g?k+=h-8:"sidx"===g&&(k-=8)}return b=j.getUint8(k+8),k+=12,c=j.getUint32(k+4,!1),k+=8,e=0===b?j.getUint32(k,!1):p.Math.to64BitNumber(j.getUint32(k+4,!1),j.getUint32(k,!1)),d.when({earliestPresentationTime:e,timescale:c})},c=function(b){var c,e,f,g=d.defer(),h=new XMLHttpRequest,i=!1;return c=b,h.onloadend=function(){i||(e="Error loading fragment: "+c,g.reject(e))},h.onload=function(){i=!0,f=a(h.response),g.resolve(f)},h.onerror=function(){e="Error loading fragment: "+c,g.reject(e)},h.responseType="arraybuffer",h.open("GET",c),h.send(null),g.promise};return{debug:void 0,loadFragment:c,parseTFDT:a,parseSIDX:b}},j.dependencies.FragmentExtensions.prototype={constructor:j.dependencies.FragmentExtensions},j.dependencies.TimelineConverter=function(){"use strict";var a=0,b=function(a,b,c,d){var e=NaN;return e=d?c&&b.timeShiftBufferDepth!==Number.POSITIVE_INFINITY?new Date(b.availabilityStartTime.getTime()+1e3*(a+b.timeShiftBufferDepth)):b.availabilityEndTime:c?new Date(b.availabilityStartTime.getTime()+1e3*a):b.availabilityStartTime},c=function(a,c,d){return b.call(this,a,c,d)},d=function(a,c,d){return b.call(this,a,c,d,!0)},e=function(a){var b,c="dynamic"===a.mpd.manifest.type,d=parseInt(this.uriQueryFragModel.getURIFragmentData().s,10);return c?(!isNaN(d)&&d>1262304e3&&(b=d-a.mpd.availabilityStartTime.getTime()/1e3,(b>a.liveEdge||b<a.liveEdge-a.mpd.timeShiftBufferDepth)&&(b=null)),b=b||a.liveEdge):b=!isNaN(d)&&d<a.duration&&d>=0?d:a.start,b},f=function(a,b){return(a.getTime()-b.mpd.availabilityStartTime.getTime())/1e3},g=function(a,b){var c=b.presentationTimeOffset;return a-c},h=function(a,b){var c=b.presentationTimeOffset;return c+a},i=function(a,b){var c,d,e;return b&&(c=a.representation.adaptation.period.mpd.suggestedPresentationDelay,d=a.presentationStartTime+c,e=new Date(a.availabilityStartTime.getTime()+1e3*d)),e},j=function(a,b,c){var d,e=this,f=e.calcSegmentAvailabilityRange(a,c);return b>=f.start&&b<=f.end?b:d=Math.max(f.end-2*a.adaptation.period.mpd.manifest.minBufferTime,f.start)},k=function(b,c){var d,e,g=b.segmentDuration,h=0,i=b.adaptation.period.duration,j={start:h,end:i};return c?b.adaptation.period.mpd.isClientServerTimeSyncCompleted&&!isNaN(g)||!b.segmentAvailabilityRange?(d=b.adaptation.period.mpd.checkTime,e=f(new Date((new Date).getTime()+a),b.adaptation.period),h=Math.max(e-b.adaptation.period.mpd.timeShiftBufferDepth,0),d+=a/1e3,i=isNaN(d)?e:Math.min(d,e),j={start:h,end:i}):b.segmentAvailabilityRange:j},l=function(a){var b=a.presentationTimeOffset;return-b};return{system:void 0,debug:void 0,uriQueryFragModel:void 0,setup:function(){},calcAvailabilityStartTimeFromPresentationTime:c,calcAvailabilityEndTimeFromPresentationTime:d,calcPresentationTimeFromWallTime:f,calcPresentationTimeFromMediaTime:g,calcPresentationStartTime:e,calcActualPresentationTime:j,calcMediaTimeFromPresentationTime:h,calcSegmentAvailabilityRange:k,calcWallTimeForSegment:i,calcMSETimeOffset:l}},j.dependencies.TimelineConverter.prototype={constructor:j.dependencies.TimelineConverter},j.vo.AdaptationSet=function(){"use strict";this.period=null,this.index=-1},j.vo.AdaptationSet.prototype={constructor:j.vo.AdaptationSet},j.vo.Event=function(){"use strict";this.duration=NaN,this.presentationTime=NaN,this.id=NaN,this.messageData="",this.eventStream=null,this.presentationTimeDelta=NaN},j.vo.Event.prototype={constructor:j.vo.Event},j.vo.EventStream=function(){"use strict";this.adaptionSet=null,this.representation=null,this.period=null,this.timescale=1,this.value="",this.schemeIdUri=""},j.vo.EventStream.prototype={constructor:j.vo.EventStream},j.vo.Mpd=function(){"use strict";this.manifest=null,this.suggestedPresentationDelay=0,this.availabilityStartTime=null,this.availabilityEndTime=Number.POSITIVE_INFINITY,this.timeShiftBufferDepth=Number.POSITIVE_INFINITY,this.maxSegmentDuration=Number.POSITIVE_INFINITY,this.checkTime=NaN,this.clientServerTimeShift=0,this.isClientServerTimeSyncCompleted=!1},j.vo.Mpd.prototype={constructor:j.vo.Mpd},j.vo.Period=function(){"use strict";this.id=null,this.index=-1,this.duration=NaN,this.start=NaN,this.mpd=null,this.liveEdge=NaN},j.vo.Period.prototype={constructor:j.vo.Period},j.vo.Representation=function(){"use strict";this.id=null,this.index=-1,this.adaptation=null,this.segmentInfoType=null,this.initialization=null,this.segmentDuration=NaN,this.timescale=1,this.startNumber=1,this.indexRange=null,this.range=null,this.presentationTimeOffset=0,this.MSETimeOffset=NaN,this.segmentAvailabilityRange=null,this.availableSegmentsNumber=0},j.vo.Representation.prototype={constructor:j.vo.Representation},j.vo.Segment=function(){"use strict";this.indexRange=null,this.index=null,this.mediaRange=null,this.media=null,this.duration=NaN,this.replacementTime=null,this.replacementNumber=NaN,this.mediaStartTime=NaN,this.presentationStartTime=NaN,this.availabilityStartTime=NaN,
this.availabilityEndTime=NaN,this.availabilityIdx=NaN,this.wallStartTime=NaN,this.representation=null},j.vo.Segment.prototype={constructor:j.vo.Segment},h=function(){"use strict";return{dependencies:{}}}(),h.dependencies.HlsDemux=function(){"use strict";var a=function(a,b){var c=new Uint8Array(a.byteLength+b.byteLength);return c.set(a,0),c.set(b,a.byteLength),c},b=null,c=null,d=[],e=[],f=-1,g=-1,h=function(a,b,c,d){for(var e,f=b;f<a.length;){if(e=new r.ts.TsPacket,e.parse(a.subarray(f,f+r.ts.TsPacket.prototype.TS_PACKET_SIZE)),e.getPid()===c&&(void 0===d||e.getPusi()===d))return{offset:f,packet:e};f+=r.ts.TsPacket.prototype.TS_PACKET_SIZE}return null},i=function(a){var c=h.call(this,a,0,r.ts.TsPacket.prototype.PAT_PID);return null===c?null:(b=new r.si.PAT,b.parse(c.packet.getPayload()),b)},j=function(a,b){var f,g,i,j=h.call(this,a,0,b),l=0,m=1;if(null===j)return null;for(c=new r.si.PMT,c.parse(j.packet.getPayload()),l=0;l<c.m_listOfComponents.length;l++){if(f=c.m_listOfComponents[l],g=new k.vo.Mp4Track,i=c.gStreamTypes[f.m_stream_type],null!==i)switch(g.streamType=i.name,i.value){case 224:g.type="video";break;case 192:g.type="audio";break;case 252:g.type="data";break;default:g.type="und"}else this.debug.log("[HlsDemux] Stream Type "+f.m_stream_type+" unknown!");g.timescale=r.Pts.prototype.SYSTEM_CLOCK_FREQUENCY,g.pid=f.m_elementary_PID,g.trackId=m,d[f.m_elementary_PID]=m,e.push(g),m++}return c},l=function(a){var b,c,h,i,j,l=null,m=null;b=new r.ts.TsPacket,b.parse(a),b.hasAdaptationFieldOnly()||(c=b.getPid(),h=d[c],void 0!==h&&(i=e[h-1],b.getPusi()?(j=new r.pes.PesPacket,j.parse(b.getPayload()),l=new k.vo.Mp4Track.Sample,l.cts=j.getPts().getValue(),l.dts=null!==j.getDts()?j.getDts().getValue():l.cts,l.size=0,l.duration=0,l.subSamples=[],-1===f&&(f=l.dts),l.dts-=f,l.cts-=f,l.dts+=g,l.cts+=g,m=j.getPayload(),"audio"===i.type&&(l.flags=16777216),"video"===i.type&&-1!==i.streamType.search("H.264")&&(l.flags=r.h264.isIDR(m)?33554432:16842752),l.subSamples.push(m),i.samples.push(l)):(i.samples.length>0&&(l=i.samples[i.samples.length-1]),l.subSamples.push(b.getPayload()))))},m=function(a){var b,c,d,e,f=0,g=0;for(d=0;d<a.samples.length;d++){for(c=0,b=a.samples[d],e=0;e<b.subSamples.length;e++)c+=b.subSamples[e].length;d>0&&(a.samples[d-1].duration=a.samples[d].dts-a.samples[d-1].dts),b.size=c,f+=c}for(a.samples[a.samples.length-1].duration=a.samples[a.samples.length-2].duration,a.data=new Uint8Array(f),a.dataCTS=[],d=0;d<a.samples.length;d++)for(b=a.samples[d],-1!==a.streamType.search("ADTS")&&(a.dataCTS[g]=b.cts),e=0;e<b.subSamples.length;e++)a.data.set(b.subSamples[e],g),g+=b.subSamples[e].length;if(-1!==a.streamType.search("H.264")&&r.h264.bytestreamToMp4(a.data),-1!==a.streamType.search("ADTS")&&n.call(this,a),a.previousCts&&a.previousDuration){b=a.samples[0];var h=b.cts-(a.previousCts+a.previousDuration);h>0&&(b.cts-=h,b.dts-=h,b.duration+=h,this.debug.log("[HlsDemux]["+a.type+"] Patch sample duration, cts = "+(b.cts/9e4).toFixed(3)+", duration = "+(b.duration/9e4).toFixed(3)))}},n=function(a){var b,c,d,e,f,g,h,i,j=[];for(b=r.aac.parseADTS(a.data,a.dataCTS),c=0,i=0;i<b.length;i++)c+=b[i].length;for(e=new Uint8Array(c),g=a.samples[0].cts,h=1024*a.timescale/a.samplingRate,d=0,i=0;i<b.length;i++)f=new k.vo.Mp4Track.Sample,f.cts=f.dts=b[i].cts?b[i].cts:g,f.size=b[i].length,f.duration=h,f.flags=16777216,j.push(f),g=f.cts+h,i>0&&(j[i-1].duration=j[i].cts-j[i-1].cts,j[i-1].duration>h&&this.debug.log("[HlsDemux]["+a.type+"] Patch sample duration, cts = "+(j[i-1].cts/9e4).toFixed(3)+", duration = "+(j[i-1].duration/9e4).toFixed(3))),e.set(a.data.subarray(b[i].offset,b[i].offset+b[i].length),d),d+=b[i].length;a.data=e,a.samples=j},o=function(a){var b="",c=0,d=0;for(c=0;c<a.length;c++)d=a[c].toString(16),d.length<2&&(d="0"+d),b+=d;return b},p=function(a){for(var b=0;b<e.length;b++)e[b].codecs="";-1===g&&(g=a)},q=function(b,c){var d,e,f,g,i,j,k,l;if(""!==c.codecs)return c;if(d=h.call(this,b,0,c.pid,!0),null===d)return null;if(e=new r.pes.PesPacket,e.parse(d.packet.getPayload()),f=e.getPayload(),-1!==c.streamType.search("H.264")){for(g=r.h264.getSequenceHeader(f);null===g;)d=h.call(this,b,d.offset+r.ts.TsPacket.prototype.TS_PACKET_SIZE,c.pid,!1),f=a(f,d.packet.getPayload()),g=r.h264.getSequenceHeader(f);c.codecPrivateData=o(g.bytes),c.codecs="avc1.",i=/00000001[0-9]7/.exec(c.codecPrivateData),i&&i[0]&&(c.codecs+=c.codecPrivateData.substr(c.codecPrivateData.indexOf(i[0])+10,6)),c.width=g.width,c.height=g.height}return-1!==c.streamType.search("AAC")&&(j=r.aac.getAudioSpecificConfig(f),k=(248&j[0])>>3,c.codecPrivateData=o(j),c.codecs="mp4a.40."+k,l=(7&j[0])<<1|(128&j[1])>>7,c.samplingRate=r.aac.SAMPLING_FREQUENCY[l],c.channels=(120&j[1])>>3,c.bandwidth=0),this.debug.log("[HlsDemux]["+c.type+"] track codecPrivateData = "+c.codecPrivateData),this.debug.log("[HlsDemux]["+c.type+"] track codecs = "+c.codecs),c},s=function(a){var d=0;if(!(null===b&&(b=i.call(this,a),null===b)||null===c&&(c=j.call(this,a,b.getPmtPid()),null===c))){for(d=e.length-1;d>=0;d--)q.call(this,a,e[d]),""===e[d].codecs&&e.splice(d,1);return e}},t=function(a){var b,d=a.length/r.ts.TsPacket.prototype.TS_PACKET_SIZE,f=0;if(this.debug.log("[HlsDemux] Demux chunk, size = "+a.length+", nb packets = "+d),null===s.call(this,a))return null;if(null===c)return e;for(f=0;f<e.length;f++)b=e[f],b.samples.length>0&&(b.previousCts=b.samples[b.samples.length-1].cts,b.previousDuration=b.samples[b.samples.length-1].duration),e[f].samples=[],e[f].data=null;for(f=0;f<a.length;)l.call(this,a.subarray(f,f+r.ts.TsPacket.prototype.TS_PACKET_SIZE)),f+=r.ts.TsPacket.prototype.TS_PACKET_SIZE;for(f=0;f<e.length;f++)b=e[f],m.call(this,b),this.debug.log("[HlsDemux]["+b.type+"] Demux: 1st PTS = "+b.samples[0].dts+" ("+b.samples[0].dts/9e4+")");return e};return{debug:void 0,reset:p,getTracks:s,demux:t}},h.dependencies.HlsDemux.prototype={constructor:h.dependencies.HlsDemux},h.dependencies.HlsParser=function(){var a="#EXTM3U",b="#EXTINF",c="#EXT-X-VERSION",e="#EXT-X-TARGETDURATION",f="#EXT-X-MEDIA-SEQUENCE",g="#EXT-X-STREAM-INF",h="#EXT-X-ENDLIST",i="BANDWIDTH",j="PROGRAM-ID",l="AUDIO",m="SUBTITLES",n="RESOLUTION",o="CODECS",p=2,q=500,r=p,s=q,t=0,u=null,v=new XMLHttpRequest,w=function(a){var b=0;for(a=a.split("\n"),b=0;b<a.length;b+=1)(""===a[b]||" "===a[b])&&(a.splice(b,1),b--);return a},x=function(a,b){return a.indexOf(b)>-1},y=function(a,b){return a.substring(b.length+1,a.length)},z=function(a){return a.substring(a.indexOf(":")+1).split(",")},A=function(a){return 0===a.indexOf("http://")||0===a.indexOf("https://")},B=function(a){var b,c={programId:"",bandwidth:0,resolution:"0x0",codecs:""},d="",e="",f=z(a[0]);for(b=f.length-1;b>=0;b-=1)if(-1===f[b].indexOf("=")&&b>0)f[b-1]+=","+f[b];else switch(d=f[b].trim().split("=")[0],e=f[b].trim().split("=")[1],d){case j:c.programId=e;break;case i:c.bandwidth=parseInt(e,10);break;case n:c.resolution=e;break;case o:c.codecs=e.replace(/"/g,"");break;case l:c.audioId=e;break;case m:c.subtitlesId=e}return c.uri=a[1],c},C=function(a){var b={},c=z(a[0]);return b.duration=parseInt(c[0],10),b.title=c[1],b.uri=a[1],b},D=function(a){var b=[],c=0;for(c=0;c<a.length;c+=1)x(a[c],g)&&b.push(B([a[c],a[c+1]]));return b},E=function(d,g){var i,j,k,l,m,n,o,p=0,q=0,r=this;if(!d||d&&d.length<0)return!1;if(r.debug.log(d),d=w(d),d[0].trim()!==a)return!1;for(i={name:"SegmentList",isRoot:!1,isArray:!1,duration:0,startNumber:0,timescale:1,BaseURL:g.BaseURL,SegmentURL_asArray:[]},g[i.name]=i,j=i.SegmentURL_asArray,g.duration=1/0,o=1;o<d.length;o++)x(d[o],c)?m=y(d[o],c):x(d[o],e)?i.duration=parseInt(y(d[o],e),10):x(d[o],f)?i.startNumber=parseInt(y(d[o],f),10):x(d[o],b)?(n=C([d[o],d[o+1]]),k={name:"SegmentURL",isRoot:!1,isArray:!0,media:A(n.uri)?n.uri:i.BaseURL+n.uri,sequenceNumber:i.startNumber+q,time:0===j.length?0:j[j.length-1].time+j[j.length-1].duration,duration:n.duration},j.push(k),p+=n.duration,q++):x(d[o],h)&&(g.duration=p);return l={name:"Initialization",sourceURL:g.SegmentList.SegmentURL_asArray[0].media},g.SegmentList.Initialization=l,!0},F=function(a,b){var c,e,f=d.defer(),g=a.Period_asArray[0],h=g.AdaptationSet_asArray[0],i=h.Representation_asArray[b],j=new k.vo.SegmentRequest,l=this;g.start=0,h.duration=i.duration,g.duration=i.duration,i.duration!==1/0&&(a.mediaPresentationDuration=i.duration),a.type=i.duration===1/0?"dynamic":"static",c=i.SegmentList.duration*i.SegmentList.SegmentURL_asArray.length,"dynamic"===a.type&&(e=new Date,a.availabilityStartTime=new Date(e.getTime()-1e3*c),a.timeShiftBufferDepth=c),a.minBufferTime=3*i.SegmentList.duration,i=h.Representation_asArray[b],j.type="Initialization Segment",j.url=i.SegmentList.Initialization.sourceURL;var m=function(a,b){var c=this.hlsDemux.getTracks(new Uint8Array(b.data)),d=0;for(a.codecs="",d=0;d<c.length;d++)a.codecs+=c[d].codecs,d<c.length-1&&(a.codecs+=",");f.resolve()},n=function(){f.resolve()};return""===i.codecs?(l.debug.log("[HlsParser]","Load initialization segment: "+j.url),l.fragmentLoader.load(j).then(m.bind(l,i),n.bind(l))):f.resolve(),f.promise},G=function(a){var b=null;return-1!==a.indexOf("/")&&(-1!==a.indexOf("?")&&(a=a.substring(0,a.indexOf("?"))),b=a.substring(0,a.lastIndexOf("/")+1)),b},H=function(a){var b=!0,c=this,d=function(){v.aborted=!0},e=function(){v.status<200||v.status>299||200===v.status&&4===v.readyState&&(b=!1,E.call(c,v.response,a)?u.resolve():u.reject({name:k.dependencies.ErrorHandler.prototype.MANIFEST_ERR_PARSE,message:"Failed to parse variant stream playlist",data:{url:a.url}}))},f=function(){return!b||v.aborted?void u.resolve():(t++,void(r>0&&r>=t?setTimeout(function(){H.call(c,a)},s):u.reject({name:k.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_MANIFEST,message:"Failed to download variant stream playlist",data:{url:a.url,status:v.status}})))};try{v.onload=e,v.onloadend=f,v.onerror=f,v.onabort=d,v.open("GET",a.url,!0),v.send()}catch(g){v.onerror()}},I=function(b,c){var e,f,g,h,i,j=d.defer(),k=[],l=[],m=0,n=[],o=this,p=0;if(!b||b.length<=0||b[0].trim()!==a)return j.reject(new Error("Can't parse manifest")),j.promise;for(e={},e.name="M3U",e.isRoot=!0,e.isArray=!0,e.parent=null,e.BaseURL=c,e.profiles="urn:mpeg:dash:profile:isoff-live:2011",e.type="static",f={},f.name="Period",f.isRoot=!1,f.isArray=!1,f.parent=e,f.duration=0,f.BaseURL=e.BaseURL,e.Period=f,e.Period_asArray=[f],k=[],f.AdaptationSet=k,f.AdaptationSet_asArray=k,n=D(b.slice(1)),n.sort(function(a,b){return a.bandwidth-b.bandwidth}),g={name:"AdaptationSet",isRoot:!1,isArray:!0,id:"video",lang:"",contentType:"video",mimeType:"video/mp4",maxWidth:0,maxHeight:0,BaseURL:f.BaseURL,Representation:l,Representation_asArray:l},p=0;p<n.length;p+=1)i=n[p],i.bandwidth>64e3&&(h={name:"Representation",isRoot:!1,isArray:!0,id:m.toString(),mimeType:"video/mp4",codecs:i.codecs,bandwidth:i.bandwidth,width:parseInt(i.resolution.split("x")[0],10),height:parseInt(i.resolution.split("x")[1],10),url:A(i.uri)?i.uri:g.BaseURL+i.uri},h.BaseURL=G(h.url),l.push(h),m++);return 0===n.length?(o.debug.error("[HlsParser] no stream in HLS manifest"),j.reject(),j.promise):(k.push(g),o.abrController.getPlaybackQuality("video",g).then(function(a){h=g.Representation_asArray[a.quality],o.updatePlaylist(h).then(function(){F.call(o,e,a.quality).then(function(){j.resolve(e)})},function(a){j.reject(a)})}),j.promise)},J=function(a,b){return this.debug.log("[HlsParser]","Doing parse."),this.debug.log("[HlsParser]",a),I.call(this,w(a),b)},K=function(){null!==v&&v.readyState>0&&v.readyState<4&&(this.debug.log("[HlsParser] Playlist manifest download abort."),v.abort())};return{debug:void 0,config:void 0,manifestModel:void 0,fragmentLoader:void 0,abrController:void 0,hlsDemux:void 0,parse:J,updatePlaylist:function(a){return r=this.config.getParam("ManifestLoader.RetryAttempts","number",p),s=this.config.getParam("ManifestLoader.RetryInterval","number",q),t=0,u=d.defer(),H.call(this,a),u.promise},abort:K}},h.dependencies.HlsParser.prototype={constructor:h.dependencies.HlsParser},h.dependencies.HlsHandler=function(){"use strict";var a=function(a){var c,e,f,g=null,h=this,i=null,j=d.defer();return g=a.adaptation.period,i=g.start,c=b.manifestModel.getValue(),e=b.manifestExt.getIsDynamic(c),f=new k.vo.SegmentRequest,f.streamType=b.getType(),f.type="Initialization Segment",f.url=null,f.data=1,f.range=a.range,f.availabilityStartTime=h.timelineConverter.calcAvailabilityStartTimeFromPresentationTime(i,a.adaptation.period.mpd,e),f.availabilityEndTime=h.timelineConverter.calcAvailabilityEndTimeFromPresentationTime(i+g.duration,g.mpd,e),f.quality=a.index,j.resolve(f),j.promise},b=k.utils.copyMethods(j.dependencies.DashHandler);return b.getInitRequest=a,b},h.dependencies.HlsHandler.prototype={constructor:h.dependencies.HlsHandler},h.dependencies.HlsFragmentController=function(){"use strict";var a=null,b=function(a){var b=0,c=e.manifestModel.getValue(),d=e.hlsDemux.getTracks(new Uint8Array(a));for(b=0;b<d.length;b+=1)d[b].duration=c.mediaPresentationDuration;return e.mp4Processor.generateInitSegment(d)},c=function(a){var b=0,c=e.hlsDemux.demux(new Uint8Array(a));for(b=0;b<c.length;b+=1)"video"===c[b].type&&(e.startTime=c[b].samples[0].cts/c[b].timescale);return e.mp4Processor.generateMediaSegment(c,e.sequenceNumber)},e=k.utils.copyMethods(k.dependencies.FragmentController);return e.manifestModel=void 0,e.hlsDemux=void 0,e.mp4Processor=void 0,e.sequenceNumber=1,e.segmentStartTime=null,e.process=function(f,g,h){var i=null,j=null,k=null;return null===f||void 0===f||0===f.byteLength?d.when(f):(g&&"Media Segment"===g.type&&h&&h.length>0&&((null===a||a!==g.quality)&&(e.hlsDemux.reset(9e4*g.startTime),j=b(f),g.index=void 0,a=g.quality),i=c(f),null!==j&&(k=new Uint8Array(j.length+i.length),k.set(j,0),k.set(i,j.length),i=k),e.sequenceNumber++),d.when(i))},e.getStartTime=function(){return e.startTime},e},h.dependencies.HlsFragmentController.prototype={constructor:h.dependencies.HlsFragmentController},g=function(){"use strict";return{dependencies:{}}}(),g.dependencies.MssParser=function(){"use strict";var a=1e7,b={96e3:0,88200:1,64e3:2,48e3:3,44100:4,32e3:5,24e3:6,22050:7,16e3:8,12e3:9,11025:10,8e3:11,7350:12},c={video:"video/mp4",audio:"audio/mp4",text:"application/ttml+xml+mp4"},e=null,f=null,g=function(){var b,c,d={},g=[],i=this.domParser.getChildNode(e,"SmoothStreamingMedia");for(d.duration=0===parseFloat(this.domParser.getAttributeValue(i,"Duration"))?1/0:parseFloat(this.domParser.getAttributeValue(i,"Duration"))/a,d.BaseURL=f,c=0;c<i.childNodes.length;c++)"StreamIndex"===i.childNodes[c].nodeName&&(b=h.call(this,i.childNodes[c]),null!==b&&g.push(b));return g.length>0&&(d.AdaptationSet=g.length>1?g:g[0]),d.AdaptationSet_asArray=g,d},h=function(a){var b,d,e,g={},h=[],j={},k=null;for(g.id=this.domParser.getAttributeValue(a,"Name"),g.lang=this.domParser.getAttributeValue(a,"Language"),g.contentType=this.domParser.getAttributeValue(a,"Type"),g.mimeType=c[g.contentType],g.maxWidth=this.domParser.getAttributeValue(a,"MaxWidth"),g.maxHeight=this.domParser.getAttributeValue(a,"MaxHeight"),g.BaseURL=f,j=n.call(this,a),k=this.domParser.getChildNodes(a,"QualityLevel"),e=0;e<k.length;e++)k[e].BaseURL=g.BaseURL,k[e].mimeType=g.mimeType,k[e].Id=g.id+"_"+this.domParser.getAttributeValue(k[e],"Index"),b=i.call(this,k[e],a),null!==b&&(b.SegmentTemplate=j,h.push(b));return 0===h.length?null:(g.Representation=h.length>1?h:h[0],g.Representation_asArray=h,g.SegmentTemplate=j,d=j.SegmentTimeline.S_asArray,this.metricsModel.addDVRInfo(g.contentType,0,null,{start:d[0].t/j.timescale,end:(d[d.length-1].t+d[d.length-1].d)/j.timescale}),g)},i=function(a,b){var c={},d=null;return c.id=a.Id,c.bandwidth=parseInt(this.domParser.getAttributeValue(a,"Bitrate"),10),c.mimeType=a.mimeType,c.width=parseInt(this.domParser.getAttributeValue(a,"MaxWidth"),10),c.height=parseInt(this.domParser.getAttributeValue(a,"MaxHeight"),10),d=this.domParser.getAttributeValue(a,"FourCC"),null===d&&(d=this.domParser.getAttributeValue(b,"FourCC")),d.indexOf("AACH")>=0?null:("H264"===d||"AVC1"===d?c.codecs=j.call(this,a):(d.indexOf("AAC")>=0||""===d)&&(c.codecs=l.call(this,a,d),c.audioSamplingRate=parseInt(this.domParser.getAttributeValue(a,"SamplingRate"),10),c.audioChannels=parseInt(this.domParser.getAttributeValue(a,"Channels"),10)),c.codecPrivateData=""+this.domParser.getAttributeValue(a,"CodecPrivateData"),c.BaseURL=a.BaseURL,c)},j=function(a){var b,c,d=this.domParser.getAttributeValue(a,"CodecPrivateData").toString();return b=/00000001[0-9]7/.exec(d),c=b&&b[0]?d.substr(d.indexOf(b[0])+10,6):void 0,"avc1."+c},l=function(a,c){var d,e,f,g,h=0,i=this.domParser.getAttributeValue(a,"CodecPrivateData").toString(),j=parseInt(this.domParser.getAttributeValue(a,"SamplingRate"),10);return"AACH"===c&&(h=5),void 0===i||""===i?(h=2,f=b[j],"AACH"===c?(h=5,i=new Uint8Array(4),g=b[2*j],i[0]=h<<3|f>>1,i[1]=f<<7|a.Channels<<3|g>>1,i[2]=g<<7|8,i[3]=0,e=new Uint16Array(2),e[0]=(i[0]<<8)+i[1],e[1]=(i[2]<<8)+i[3],d=e[0].toString(16),d=e[0].toString(16)+e[1].toString(16)):(i=new Uint8Array(2),i[0]=h<<3|f>>1,i[1]=f<<7|parseInt(this.domParser.getAttributeValue(a,"Channels"),10)<<3,e=new Uint16Array(1),e[0]=(i[0]<<8)+i[1],d=e[0].toString(16)),i=""+d,i=i.toUpperCase(),a.setAttribute("CodecPrivateData",i)):0===h&&(h=(248&parseInt(i.substr(0,2),16))>>3),"mp4a.40."+h},n=function(b){var c,d={};return c=this.domParser.getAttributeValue(b,"Url").replace("{bitrate}","$Bandwidth$"),c=c.replace("{start time}","$Time$"),d.media=c,d.timescale=a,d.SegmentTimeline=o.call(this,b),d},o=function(a){var b,c,d,e={},f=this.domParser.getChildNodes(a,"c"),g=[];for(b=0;b<f.length;b++)c=parseFloat(this.domParser.getAttributeValue(f[b],"t")),d=parseFloat(this.domParser.getAttributeValue(f[b],"d")),0!==b||c||(c=0),b>0&&(g[g.length-1].d||(g[g.length-1].d=c-g[g.length-1].t),c||(c=g[g.length-1].t+g[g.length-1].d)),g.push({d:d,t:c});return e.S=g,e.S_asArray=g,e},p=function(a){var b,c,d,e;return b=m.decodeArray(a.firstChild.data),c=q(b),c=new Uint16Array(c.buffer),c=String.fromCharCode.apply(null,c),d=(new DOMParser).parseFromString(c,"application/xml"),e=d.querySelector("KID").textContent,e=m.decodeArray(e),r(e),e},q=function(a){var b,c,d,e,f,g=0;for(b=(a[g+3]<<24)+(a[g+2]<<16)+(a[g+1]<<8)+a[g],g+=4,c=(a[g+1]<<8)+a[g],g+=2;g<a.length;)if(d=(a[g+1]<<8)+a[g],g+=2,1===d)return e=(a[g+1]<<8)+a[g],g+=2,f=new Uint8Array(e),f.set(a.subarray(g,g+e)),f;return null},r=function(a){s(a,0,3),s(a,1,2),s(a,4,5),s(a,6,7)},s=function(a,b,c){var d=a[b];a[b]=a[c],a[c]=d},t=function(a){var b,c={},d=this.system.getObject("ksPlayReady");return b={__text:a.firstChild.data,__prefix:"mspr"},c.schemeIdUri=d.schemeIdURI,c.value=d.systemString,c.pro=b,c.pro_asArray=b,c},u=function(a){var b={},c=this.system.getObject("ksWidevine");return b.schemeIdUri=c.schemeIdURI,b.value=c.systemString,b},v=function(b){var c,d,h,i,j,l,m,n={},o=[],q=this.domParser.getChildNode(e,"SmoothStreamingMedia"),r=this.domParser.getChildNode(q,"Protection"),s=null;for(n.profiles="urn:mpeg:dash:profile:isoff-live:2011",n.type=Boolean(this.domParser.getAttributeValue(q,"IsLive"))?"dynamic":"static",n.timeShiftBufferDepth=parseFloat(this.domParser.getAttributeValue(q,"DVRWindowLength"))/a,n.mediaPresentationDuration=0===parseFloat(this.domParser.getAttributeValue(q,"Duration"))?1/0:parseFloat(this.domParser.getAttributeValue(q,"Duration"))/a,n.BaseURL=f,n.minBufferTime=k.dependencies.BufferExtensions.DEFAULT_MIN_BUFFER_TIME,"dynamic"===n.type&&(n.availabilityStartTime=new Date(b.getTime()-1e3*n.timeShiftBufferDepth)),n.Period=g.call(this),n.Period_asArray=[n.Period],c=n.Period,c.start=0,void 0!==r&&(s=this.domParser.getChildNode(r,"ProtectionHeader"),s.firstChild.data=s.firstChild.data.replace(/\n|\r/g,""),i=p(s),h=t.call(this,s),h["cenc:default_KID"]=i,o.push(h),navigator.userAgent.indexOf("Chrome")>=0&&(h=u.call(this,s),h["cenc:default_KID"]=i,o.push(h)),n.ContentProtection=o.length>1?o:o[0],n.ContentProtection_asArray=o),d=c.AdaptationSet_asArray,m=0;m<d.length;m+=1)"static"===n.type&&"text"!==d[m].contentType&&(j=d[m].SegmentTemplate.SegmentTimeline.S_asArray[0],l=parseFloat(j.t)/a,c.start=0===c.start?l:Math.max(c.start,l)),void 0!==n.ContentProtection&&(d[m].ContentProtection=n.ContentProtection,d[m].ContentProtection_asArray=n.ContentProtection_asArray);return delete n.ContentProtection,delete n.ContentProtection_asArray,n},w=function(a,b){this.debug.info("[MssParser]","Doing parse.");var c=new Date,g=null,h=null,i=null;return e=this.domParser.createXmlTree(a),g=new Date,null===e?d.reject(null):(f=b,h=v.call(this,c),i=new Date,this.debug.info("[MssParser]","Parsing complete (xmlParser: "+(g.getTime()-c.getTime())+"ms, mss2dash: "+(i.getTime()-g.getTime())+"ms, total: "+((new Date).getTime()-c.getTime())/1e3+"s)"),d.when(h))};return{debug:void 0,system:void 0,errHandler:void 0,domParser:void 0,metricsModel:void 0,parse:w}},g.dependencies.MssParser.prototype={constructor:g.dependencies.MssParser},g.dependencies.MssHandler=function(){"use strict";var a=function(a,b){var c=1;return a.audioChannels?c=a.audioChannels:b.audioChannels&&(c=b.audioChannels),c},b=function(a,b){var c=1;return c=a.audioSamplingRate?a.audioSamplingRate:b.audioSamplingRate},c=function(c){var d,f,g,h,i,j=e.manifestModel.getValue();if(c.initData)return c.initData;if(d=c.adaptation,f=j.Period_asArray[d.period.index].AdaptationSet_asArray[d.index],g=f.Representation_asArray[c.index],h=new k.vo.Mp4Track,h.type=e.getType()||"und",h.trackId=d.index+1,h.timescale=c.timescale,h.duration=c.adaptation.period.duration,h.codecs=g.codecs,h.codecPrivateData=g.codecPrivateData,h.bandwidth=g.bandwidth,"text"!==h.type&&(i=g.mimeType+';codecs="'+g.codecs+'"',!this.capabilities.supportsCodec(this.videoModel.getElement(),i)))throw{name:k.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED,message:"Codec is not supported",data:{codec:i}};return f.ContentProtection_asArray&&f.ContentProtection_asArray.length>0&&(h.contentProtection=f.ContentProtection_asArray),h.width=g.width||f.maxWidth,h.height=g.height||f.maxHeight,h.language=f.lang?f.lang:"und",h.channels=a(f,g),h.samplingRate=b(f,g),c.initData=e.mp4Processor.generateInitSegment([h]),c.initData},e=k.utils.copyMethods(j.dependencies.DashHandler);return e.mp4Processor=void 0,e.getInitRequest=function(a){var b=null,f=this,g=null,h=null,i=d.defer();if(!a)throw new Error("MssHandler.getInitRequest(): representation is undefined");b=a.adaptation.period,g=b.start,h=new k.vo.SegmentRequest,h.streamType=e.getType(),h.type="Initialization Segment",h.url=null;try{h.data=c.call(this,a)}catch(j){return i.reject(j),i.promise}return h.range=a.range,h.availabilityStartTime=f.timelineConverter.calcAvailabilityStartTimeFromPresentationTime(g,a.adaptation.period.mpd,e.getIsDynamic()),h.availabilityEndTime=f.timelineConverter.calcAvailabilityEndTimeFromPresentationTime(g+b.duration,b.mpd,e.getIsDynamic()),h.quality=a.index,i.resolve(h),i.promise},e.getIFrameRequest=function(a){return a&&a.url&&("video"===a.streamType||"audio"===a.streamType)&&(a.url=a.url.replace("Fragments","KeyFrames")),a},e},g.dependencies.MssHandler.prototype={constructor:g.dependencies.MssHandler},g.dependencies.MssFragmentController=function(){"use strict";var a=function(a,b,c){for(var d=this.manifestModel.getValue(),e=!1,f=c.SegmentTemplate.SegmentTimeline.S,g=a.entry,h=0,i=0,j=null,k=0,l=0,m=0,n=-1,o=null;l<g.length;)h=g[l].fragment_absolute_time,i=g[l].fragment_duration,j=f[f.length-1],k=j.t,h>k&&(this.debug.log("[MssFragmentController] Add new segment - t = "+h/1e7),f.push({t:h,d:i}),e=!0),l+=1;for(m=f.length-1;m>=0;m-=1)if(f[m].t===b.baseMediaDecodeTime){n=m;break}if(n>=0)for(l=0;l<g.length;l+=1)n+l<f.length&&(k=f[n+l].t,k+f[n+l].d!=g[l].fragment_absolute_time&&(f[n+l].t=g[l].fragment_absolute_time,f[n+l].d=g[l].fragment_duration,this.debug.log("[MssFragmentController] Correct tfrf time  = "+g[l].fragment_absolute_time+"and duration = "+g[l].fragment_duration+"! ********"),e=!0));if(e&&d.timeShiftBufferDepth&&d.timeShiftBufferDepth>0){for(j=f[f.length-1],k=j.t,o=k-1e7*d.timeShiftBufferDepth,j=f[0];j.t<o;)this.debug.log("[MssFragmentController] Remove segment  - t = "+j.t/1e7),f.splice(0,1),j=f[0];this.metricsModel.addDVRInfo(c.type,0,null,{start:f[0].t/c.SegmentTemplate.timescale,end:(f[f.length-1].t+f[f.length-1].d)/c.SegmentTemplate.timescale})}},b=function(b,c,d){var e=0,f=this.manifestModel.getValue(),g=f?this.manifestExt.getIndex(d,f)+1:-1,h=q.deserialize(b),i=null,j=null,k=null,l=null,m=null,n=null,o=null,p=null,r=null,s=null,t=!1,u=-1,v=0,w=0,x=0,y=0,z=null;if(!h)return null;if(i=h.getBoxByType("moof"),j=h.getBoxByType("mdat"),k=i.getBoxByType("traf"),l=k.getBoxByType("trun"),m=k.getBoxByType("tfhd"),o=k.getBoxByType("sepiff"),null!==o&&(o.boxtype="senc",o.extended_type=void 0,n=k.getBoxByType("saio"),null===n)){if(n=new q.boxes.SampleAuxiliaryInformationOffsetsBox,n.version=0,n.flags=0,n.entry_count=1,n.offset=[],p=new q.boxes.SampleAuxiliaryInformationSizesBox,p.version=0,p.flags=0,p.sample_count=o.sample_count,p.default_sample_info_size=0,p.sample_info_size=[],2&o.flags){for(e=0;e<o.sample_count;e+=1)p.sample_info_size[e]=8+6*o.entry[e].NumberOfEntries+2,e>0&&p.sample_info_size[e]!==p.sample_info_size[e-1]&&(t=!0);t===!1&&(p.default_sample_info_size=p.sample_info_size[0],p.sample_info_size=[])}else p.default_sample_info_size=8;k.boxes.push(p),k.boxes.push(n)}if(m.track_ID=g,k.removeBoxByType("tfxd"),r=k.getBoxByType("tfdt"),null===r&&(r=new q.boxes.TrackFragmentBaseMediaDecodeTimeBox,r.version=1,r.flags=0,r.baseMediaDecodeTime=Math.floor(c.startTime*c.timescale),u=k.getBoxIndexByType("tfhd"),k.boxes.splice(u+1,0,r)),s=k.getBoxesByType("tfrf"),0!==s.length)for(e=0;e<s.length;e+=1)a.call(this,s[e],r,d),k.removeBoxByType("tfrf");if(m.flags&=16777214,m.flags|=131072,l.flags|=1,l.data_offset=0,this.fixDuration&&1===l.samples_table.length){var A,B=c.duration*c.timescale,C=0,D=j.data;A=void 0===l.samples_table[0].sample_duration?m.default_sample_duration:l.samples_table[0].sample_duration;var E=Math.floor(B/A);for(e=0;E-1>e;e++)l.samples_table.push({sample_duration:l.samples_table[0].sample_duration,sample_size:l.samples_table[0].sample_size,sample_composition_time_offset:l.samples_table[0].sample_composition_time_offset,sample_flags:l.samples_table[0].sample_flags});if(void 0!==l.samples_table[0].sample_duration){for(e=0;e<l.samples_table.length;e++)C+=l.samples_table[e].sample_duration;C>B?l.samples_table[l.samples_table.length-1].sample_duration-=C-B:l.samples_table[l.samples_table.length-1].sample_duration+=B-C}if(null!==o){for(o.sample_count>1&&(o.entry=o.entry.slice(0,1)),e=0;E-1>e;e+=1)o.entry.push(o.entry[0]);if(null===p&&(p=k.getBoxByType("saiz")),0===p.default_sample_info_size)for(p.sample_count>1&&(p.sample_info_size=p.sample_info_size.slice(0,1)),e=0;E-1>e;e+=1)p.sample_info_size.push(p.sample_info_size[0]);o.sample_count=o.entry.length,p.sample_count=o.entry.length}for(l.sample_count=l.samples_table.length,j.data=new Uint8Array(D.length*l.sample_count),e=0;e<l.sample_count;e+=1)j.data.set(D,D.length*e)}return v=h.getLength(),l.data_offset=v-j.size+8,null!==o&&(w=h.getBoxOffsetByType("moof"),x=i.getBoxOffsetByType("traf"),y=k.getBoxOffsetByType("senc"),n.offset[0]=w+x+y+16),z=q.serialize(h)},c=k.utils.copyMethods(k.dependencies.FragmentController);return c.manifestModel=void 0,c.manifestExt=void 0,c.metricsModel=void 0,c.fixDuration=!1,c.process=function(a,c,e){var f=null,g=this.manifestModel.getValue(),h=null;if(!(null!==a&&void 0!==a&&a.byteLength>0))return d.when(null);if(f=new Uint8Array(a),c&&"Media Segment"===c.type&&g&&e&&e.length>0){h=g.Period_asArray[e[0].adaptation.period.index].AdaptationSet_asArray[e[0].adaptation.index];try{f=b.call(this,f,c,h)}catch(i){return d.reject(i)}if(!f)return d.when(null)}return d.when(f)},c.setSampleDuration=function(a){this.fixDuration=a},c},g.dependencies.MssFragmentController.prototype={constructor:g.dependencies.MssFragmentController};var t=t||[];return t.push(["trackPageView"]),t.push(["enableLinkTracking"]),function(){var a="//tv-has.orange-labs.fr/piwik/";t.push(["setTrackerUrl",a+"piwik.php"]),t.push(["setSiteId",1]);var b=document,c=b.createElement("script"),d=b.getElementsByTagName("script")[0];c.type="text/javascript",c.async=!0,c.defer=!0,c.src=a+"piwik.js",d.parentNode.insertBefore(c,d)}(),k.utils.copyMethods=function(a){var b=new a;b.parent={};for(var c in b)b.parent[c]=b[c];return b.setup=function(){for(var a in this.parent)void 0===this.parent[a]&&(this.parent[a]=this[a])},b},k.utils.DOMParser=function(){"use strict";var a=null,b=null;return{getAllSpecificNodes:function(a,b){var c,d,e=0,f=[];if(a&&(d=a.querySelectorAll(b)))for(e=0;e<d.length;e++)c=this.getAttributeValue(d[e],"xml:id"),c&&(f[c]=d[e].attributes);return f},getAttributeName:function(a,b){var c=[],d=null,e=0,f=null;if(a&&a.attributes&&(f=a.attributes))for(e=0;e<f.length;e++)d=f[e],d.value===b&&c.push(d.name);return c},getAttributeValue:function(a,b){var c=null,d=null,e=null;return a&&a.attributes&&(e=a.attributes,e&&(d=e.getNamedItem(b)))?c=d.value:c},getChildNode:function(a,b){var c,d=0;if(a&&a.childNodes)for(d=0;d<a.childNodes.length;d++){if(c=a.childNodes[d],c.nodeName===b)return c;c=void 0}return c},getChildNodes:function(a,b){var c=0,d=[];if(a&&a.childNodes)for(c=0;c<a.childNodes.length;c++)a.childNodes[c].nodeName===b&&d.push(a.childNodes[c]);return d},createXmlTree:function(c){if(window.DOMParser)try{if(a||(a=new window.DOMParser),b=a.parseFromString(c,"text/xml"),b.getElementsByTagName("parsererror").length>0)throw new Error("Error parsing XML")}catch(d){b=null}return b}}},k.utils.ObjectIron=function(a){var b;b=[];for(var c=0,d=a.length;d>c;c+=1)a[c].isRoot?b.push("root"):b.push(a[c].name);var e=function(a,b){var c;if(null!==a&&null!==b)for(c in a)a.hasOwnProperty(c)&&(b.hasOwnProperty(c)||(b[c]=a[c]))},f=function(a,b,c){var d,f,g,h,i;if(null!==a&&0!==a.length)for(d=0,f=a.length;f>d;d+=1)g=a[d],b.hasOwnProperty(g.name)&&(c.hasOwnProperty(g.name)?g.merge&&(h=b[g.name],i=c[g.name],"object"==typeof h&&"object"==typeof i?e(h,i):null!==g.mergeFunction?c[g.name]=g.mergeFunction(h,i):c[g.name]=h+i):c[g.name]=b[g.name])},g=function(a,b){var c,d,e,h,i,j,k,l=a;if(a.transformFunc&&(b=a.transformFunc(b)),null===l.children||0===l.children.length)return b;for(c=0,d=l.children.length;d>c;c+=1){j=l.children[c];var m=null;if(b.hasOwnProperty(j.name))if(j.isArray)for(i=b[j.name+"_asArray"],e=0,h=i.length;h>e;e+=1)k=i[e],f(l.properties,b,k),m=g(j,k),b[j.name+"_asArray"][e]=m,b[j.name][e]=m;else k=b[j.name],f(l.properties,b,k),m=g(j,k),b[j.name]=m,b[j.name+"_asArray"]=[m]}return b},h=function(c){var d,e,f,i,j,k,l;if(null===c)return c;if("object"!=typeof c)return c;for(d=0,e=b.length;e>d;d+=1)"root"===b[d]&&(j=a[d],k=c,c=g(j,k));for(i in c)if(c.hasOwnProperty(i)){if(f=b.indexOf(i),-1!==f)if(j=a[f],j.isArray)for(l=c[i+"_asArray"],d=0,e=l.length;e>d;d+=1)k=l[d],c[i][d]=g(j,k),c[i+"_asArray"][d]=g(j,k);else k=c[i],c[i]=g(j,k),c[i+"_asArray"]=[g(j,k)];c[i]=h(c[i])}return c};return{run:h}},f=this.dijon,k});
/* jshint ignore:end */
